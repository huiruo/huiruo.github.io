"use strict";(self.webpackChunkprogramming_technology=self.webpackChunkprogramming_technology||[]).push([[2710],{3905:(e,n,r)=>{r.d(n,{Zo:()=>s,kt:()=>f});var i=r(67294);function l(e,n,r){return n in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r,e}function t(e,n){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n&&(i=i.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),r.push.apply(r,i)}return r}function d(e){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?t(Object(r),!0).forEach((function(n){l(e,n,r[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):t(Object(r)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(r,n))}))}return e}function a(e,n){if(null==e)return{};var r,i,l=function(e,n){if(null==e)return{};var r,i,l={},t=Object.keys(e);for(i=0;i<t.length;i++)r=t[i],n.indexOf(r)>=0||(l[r]=e[r]);return l}(e,n);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);for(i=0;i<t.length;i++)r=t[i],n.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(l[r]=e[r])}return l}var c=i.createContext({}),o=function(e){var n=i.useContext(c),r=n;return e&&(r="function"==typeof e?e(n):d(d({},n),e)),r},s=function(e){var n=o(e.components);return i.createElement(c.Provider,{value:n},e.children)},u="mdxType",b={inlineCode:"code",wrapper:function(e){var n=e.children;return i.createElement(i.Fragment,{},n)}},p=i.forwardRef((function(e,n){var r=e.components,l=e.mdxType,t=e.originalType,c=e.parentName,s=a(e,["components","mdxType","originalType","parentName"]),u=o(r),p=l,f=u["".concat(c,".").concat(p)]||u[p]||b[p]||t;return r?i.createElement(f,d(d({ref:n},s),{},{components:r})):i.createElement(f,d({ref:n},s))}));function f(e,n){var r=arguments,l=n&&n.mdxType;if("string"==typeof e||l){var t=r.length,d=new Array(t);d[0]=p;var a={};for(var c in n)hasOwnProperty.call(n,c)&&(a[c]=n[c]);a.originalType=e,a[u]="string"==typeof e?e:l,d[1]=a;for(var o=2;o<t;o++)d[o]=r[o];return i.createElement.apply(null,d)}return i.createElement.apply(null,r)}p.displayName="MDXCreateElement"},16889:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>d,default:()=>b,frontMatter:()=>t,metadata:()=>a,toc:()=>o});var i=r(87462),l=(r(67294),r(3905));const t={title:"diff",sidebar_position:8},d=void 0,a={unversionedId:"React/diff",id:"React/diff",title:"diff",description:"\u56fe",source:"@site/programming-tech/React/08-diff.md",sourceDirName:"React",slug:"/React/diff",permalink:"/React/diff",draft:!1,editUrl:"https://github.com/huiruo/programming-tech-website/edit/main/programming-tech/React/08-diff.md",tags:[],version:"current",sidebarPosition:8,frontMatter:{title:"diff",sidebar_position:8},sidebar:"docs",previous:{title:"commit\u9636\u6bb5-useLayoutEffect-useEffect",permalink:"/React/commit\u9636\u6bb5-useLayoutEffect-useEffect"},next:{title:"dispatchSetState-hooks\u6e90\u7801",permalink:"/React/dispatchSetState-hooks\u6e90\u7801"}},c={},o=[{value:"\u56fe",id:"\u56fe",level:2},{value:"diff\u7b97\u6cd5:\u6bd4\u8f83\u4e24\u9897DOM\u6811\u7684\u5dee\u5f02",id:"diff\u7b97\u6cd5\u6bd4\u8f83\u4e24\u9897dom\u6811\u7684\u5dee\u5f02",level:2},{value:"1-3.\u57fa\u4e8e\u6761\u4ef6\u4e0b\u7684 O(n)",id:"1-3\u57fa\u4e8e\u6761\u4ef6\u4e0b\u7684-on",level:3},{value:"1.\u6df1\u5ea6\u4f18\u5148\u904d\u5386\uff0c\u8bb0\u5f55\u5dee\u5f02",id:"1\u6df1\u5ea6\u4f18\u5148\u904d\u5386\u8bb0\u5f55\u5dee\u5f02",level:3},{value:"2.\u53ea\u8003\u8651\u76f8\u540c\u7b49\u7ea7diff\uff0c\u53ef\u4ee5\u5206\u4e3a\u4e0b\u97624\u4e2d\u60c5\u51b5\uff1a",id:"2\u53ea\u8003\u8651\u76f8\u540c\u7b49\u7ea7diff\u53ef\u4ee5\u5206\u4e3a\u4e0b\u97624\u4e2d\u60c5\u51b5",level:3},{value:"3.\u5dee\u5f02\u7c7b\u578b",id:"3\u5dee\u5f02\u7c7b\u578b",level:3},{value:"\u6700\u540e\u628a\u5dee\u5f02\u5e94\u7528\u5230\u771f\u6b63\u7684DOM\u6811\u4e0a",id:"\u6700\u540e\u628a\u5dee\u5f02\u5e94\u7528\u5230\u771f\u6b63\u7684dom\u6811\u4e0a",level:2},{value:"React Diff\u4e09\u5927\u7b56\u7565",id:"react-diff\u4e09\u5927\u7b56\u7565",level:2},{value:"effectTag",id:"effecttag",level:3},{value:"Diff\u7684\u5165\u53e3\u51fd\u6570\u4e3a reconcileChildren",id:"diff\u7684\u5165\u53e3\u51fd\u6570\u4e3a-reconcilechildren",level:2},{value:"reconcileChildFibers\u662fReact Diff\u771f\u6b63\u7684\u5165\u53e3\u51fd\u6570",id:"reconcilechildfibers\u662freact-diff\u771f\u6b63\u7684\u5165\u53e3\u51fd\u6570",level:2},{value:"\u4e09.\u5355\u8282\u70b9\u7684Diff",id:"\u4e09\u5355\u8282\u70b9\u7684diff",level:2},{value:"3-1.\u5f53\u524d\u5c42\u7ea7\u7684current fiber\u5728sibling\u65b9\u5411\u7684\u94fe\u8868\u4e0d\u4e3a\u7a7a",id:"3-1\u5f53\u524d\u5c42\u7ea7\u7684current-fiber\u5728sibling\u65b9\u5411\u7684\u94fe\u8868\u4e0d\u4e3a\u7a7a",level:3},{value:"3-2.\u5f53\u524d\u5c42\u7ea7\u7684current fiber\u5728sibling\u65b9\u5411\u7684\u94fe\u8868\u4e3a\u7a7a",id:"3-2\u5f53\u524d\u5c42\u7ea7\u7684current-fiber\u5728sibling\u65b9\u5411\u7684\u94fe\u8868\u4e3a\u7a7a",level:3},{value:"3-2.reconcileSingleElement\u7684\u5177\u4f53\u5b9e\u73b0",id:"3-2reconcilesingleelement\u7684\u5177\u4f53\u5b9e\u73b0",level:3},{value:"\u56db.\u591a\u8282\u70b9\u7684Diff",id:"\u56db\u591a\u8282\u70b9\u7684diff",level:2},{value:"4-1.\u7b2c\u4e00\u8f6e\u904d\u5386",id:"4-1\u7b2c\u4e00\u8f6e\u904d\u5386",level:3},{value:"4-2.\u7b2c\u4e8c\u8f6e\u904d\u5386",id:"4-2\u7b2c\u4e8c\u8f6e\u904d\u5386",level:3},{value:"4-2-1.oldFiber\u904d\u5386\u5b8c\u4e86\uff0c\u4f46newChildren\u8fd8\u6ca1\u904d\u5386\u5b8c",id:"4-2-1oldfiber\u904d\u5386\u5b8c\u4e86\u4f46newchildren\u8fd8\u6ca1\u904d\u5386\u5b8c",level:3},{value:"4-2-2 newChildren\u904d\u5386\u5b8c\u4e86\uff0c\u4f46oldFiber\u8fd8\u6ca1\u904d\u5386\u5b8c",id:"4-2-2-newchildren\u904d\u5386\u5b8c\u4e86\u4f46oldfiber\u8fd8\u6ca1\u904d\u5386\u5b8c",level:3},{value:"4-2-2 newChildren\u4e0eoldFiber\u90fd\u6ca1\u5b8c\u6210\u904d\u5386",id:"4-2-2-newchildren\u4e0eoldfiber\u90fd\u6ca1\u5b8c\u6210\u904d\u5386",level:3},{value:"\u7136\u540e\u5f00\u59cb\u7b2c\u4e8c\u8f6e\u7684\u904d\u5386",id:"\u7136\u540e\u5f00\u59cb\u7b2c\u4e8c\u8f6e\u7684\u904d\u5386",level:3},{value:"diff\u5b8c\u6210\uff0c\u6211\u4eec\u4e5f\u5f97\u5230\u4e86\u8be5\u5c42\u7ea7\u4e2d\u5b8c\u6574\u7684newFiberList\uff0c\u4f5c\u4e3aworkInProgress fiber tree\u5728\u8be5\u5c42\u7ea7\u7684fiber\u8282\u70b9\u3002",id:"diff\u5b8c\u6210\u6211\u4eec\u4e5f\u5f97\u5230\u4e86\u8be5\u5c42\u7ea7\u4e2d\u5b8c\u6574\u7684newfiberlist\u4f5c\u4e3aworkinprogress-fiber-tree\u5728\u8be5\u5c42\u7ea7\u7684fiber\u8282\u70b9",level:3},{value:"reconcileChildrenArray\u7684\u5177\u4f53\u5b9e\u73b0",id:"reconcilechildrenarray\u7684\u5177\u4f53\u5b9e\u73b0",level:2}],s={toc:o},u="wrapper";function b(e){let{components:n,...t}=e;return(0,l.kt)(u,(0,i.Z)({},s,t,{components:n,mdxType:"MDXLayout"}),(0,l.kt)("h2",{id:"\u56fe"},"\u56fe"),(0,l.kt)("mermaid",{value:"flowchart BR\nA1(reconcileChildren)\nA1--\x3eA1if{{workInProgress!==null}}\nA1if--\u4e3anull\u521d\u59cb\u5316--\x3eA2A(mountChildFibers)--true--\x3eA3\nA1if--\u4e0d\u4e3anull\u66f4\u65b0--\x3eA2B(reconcileChildFibers)--false--\x3eA3\n\n%% \u53c2\u8003\uff1a06_\u8f853_ChildReconciler\u5b8c\u6574\u51fd\u6570.js\n%% reconcileChildFibers\u5185\u90e8\u4f1a\u6839\u636enewChild\uff08\u5373\u65b0\u751f\u6210\u7684ReactElement\uff09\u7684\u7c7b\u578b\n%% \u548c$$typeof\u5c5e\u6027\u8c03\u7528\u4e0d\u540c\u7684\u5904\u7406\u51fd\u6570\nA3(ChildReconciler)--\u8c03\u7528\u5185\u90e8\u51fd\u6570--\x3eA4(reconcileChildFibers)"}),(0,l.kt)("h2",{id:"diff\u7b97\u6cd5\u6bd4\u8f83\u4e24\u9897dom\u6811\u7684\u5dee\u5f02"},"diff\u7b97\u6cd5:\u6bd4\u8f83\u4e24\u9897DOM\u6811\u7684\u5dee\u5f02"),(0,l.kt)("p",null,"\u751f\u6210\u5c06\u4e00\u68f5\u6811\u8f6c\u6362\u6210\u53e6\u4e00\u68f5\u6811\u7684\u6700\u5c0f\u64cd\u4f5c\u6b21\u6570\u3002\u5373\u4f7f\u4f7f\u7528\u6700\u4f18\u7684\u7b97\u6cd5\uff0c\u8be5\u7b97\u6cd5\u7684\u590d\u6742\u7a0b\u5ea6\u4ecd\u4e3a O(n^3 )\uff0c\u5176\u4e2d n \u662f\u6811\u4e2d\u5143\u7d20\u7684\u6570\u91cf\u3002"),(0,l.kt)("h3",{id:"1-3\u57fa\u4e8e\u6761\u4ef6\u4e0b\u7684-on"},"1-3.\u57fa\u4e8e\u6761\u4ef6\u4e0b\u7684 O(n)"),(0,l.kt)("p",null,"React \u5728\u4ee5\u4e0b\u4e09\u4e2a\u5047\u8bbe\u7684\u57fa\u7840\u4e4b\u4e0a\u63d0\u51fa\u4e86\u4e00\u5957 O(n) :"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"\u53ea\u5bf9\u540c\u7ea7\u5143\u7d20\u8fdb\u884cDiff\uff1b")),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"\u4e24\u4e2a\u4e0d\u540c\u7c7b\u578b\u7684\u5143\u7d20\u4f1a\u4ea7\u751f\u51fa\u4e0d\u540c\u7684\u6811\uff1b")),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"\u5f00\u53d1\u8005\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e key \u5c5e\u6027\uff0c\u6765\u544a\u77e5\u6e32\u67d3\u54ea\u4e9b\u5b50\u5143\u7d20\u5728\u4e0d\u540c\u7684\u6e32\u67d3\u4e0b\u53ef\u4ee5\u4fdd\u5b58\u4e0d\u53d8\uff1b"))),(0,l.kt)("p",null,"diff\u7b97\u6cd5\u590d\u6742\u5ea6\u8fbe\u5230 O(n),\u5fc5\u987b\u4fdd\u6301Virtual DOM \u53ea\u4f1a\u5bf9\u540c\u4e00\u4e2a\u5c42\u7ea7\u7684\u5143\u7d20\u8fdb\u884c\u5bf9\u6bd4\uff1a\n",(0,l.kt)("img",{src:r(34887).Z,width:"810",height:"434"})),(0,l.kt)("p",null,"\u4f8b\u5b50\u4e2d\uff1adiv\u53ea\u4f1a\u548c\u540c\u4e00\u5c42\u7ea7\u7684div\u5bf9\u6bd4\uff0c\u7b2c\u4e8c\u5c42\u7ea7\u7684\u53ea\u4f1a\u8ddf\u7b2c\u4e8c\u5c42\u7ea7\u5bf9\u6bd4\u3002"),(0,l.kt)("p",null,"\u5047\u8bbe\u73b0\u5728\u53ef\u4ee5\u82f1\u6587\u5b57\u6bcd\u552f\u4e00\u5730\u6807\u8bc6\u6bcf\u4e00\u4e2a\u5b50\u8282\u70b9\uff1a\n\u65e7\u7684\u8282\u70b9\u987a\u5e8f\uff1aa b c d e f g h i"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"\u73b0\u5728\u5bf9\u8282\u70b9\u8fdb\u884c\u4e86\u5220\u9664\u3001\u63d2\u5165\u3001\u79fb\u52a8\u7684\u64cd\u4f5c\u3002\u65b0\u589ej\u8282\u70b9\uff0c\u5220\u9664e\u8282\u70b9\uff0c\u79fb\u52a8h\u8282\u70b9\uff1a\n\u65b0\u7684\u8282\u70b9\u987a\u5e8f\uff1aa b c h d f g i j\n")),(0,l.kt)("p",null,"\u73b0\u5728\u77e5\u9053\u4e86\u65b0\u65e7\u7684\u987a\u5e8f\uff0c\u6c42\u6700\u5c0f\u7684\u63d2\u5165\u3001\u5220\u9664\u64cd\u4f5c\uff08\u79fb\u52a8\u53ef\u4ee5\u770b\u6210\u662f\u5220\u9664\u548c\u63d2\u5165\u64cd\u4f5c\u7684\u7ed3\u5408\uff09\u3002\n\u8fd9\u4e2a\u95ee\u9898\u62bd\u8c61\u51fa\u6765\u5176\u5b9e\u662f\u5b57\u7b26\u4e32\u7684\u6700\u5c0f\u7f16\u8f91\u8ddd\u79bb\u95ee\u9898\uff08Edition Distance\uff09\uff0c\u6700\u5e38\u89c1\u7684\u89e3\u51b3\u7b97\u6cd5\u662f Levenshtein Distance\uff0c\u901a\u8fc7\u52a8\u6001\u89c4\u5212\u6c42\u89e3\uff0c\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a O(M * N)\u3002\n\u4f46\u662f\u6211\u4eec\u5e76\u4e0d\u9700\u8981\u771f\u7684\u8fbe\u5230\u6700\u5c0f\u7684\u64cd\u4f5c\uff0c\u6211\u4eec\u53ea\u9700\u8981\u4f18\u5316\u4e00\u4e9b\u6bd4\u8f83\u5e38\u89c1\u7684\u79fb\u52a8\u60c5\u51b5\uff0c\u727a\u7272\u4e00\u5b9aDOM\u64cd\u4f5c\uff0c\u8ba9\u7b97\u6cd5\u65f6\u95f4\u590d\u6742\u5ea6\u8fbe\u5230\u7ebf\u6027\u7684\uff08O(max(M, N))\u3002"),(0,l.kt)("p",null,"\u4f46\u662f\u8981\u6ce8\u610f\u7684\u662f\uff0c\u56e0\u4e3atagName\u662f\u53ef\u91cd\u590d\u7684\uff0c\u4e0d\u80fd\u7528\u8fd9\u4e2a\u6765\u8fdb\u884c\u5bf9\u6bd4\u3002\n\u6240\u4ee5\u9700\u8981\u7ed9\u5b50\u8282\u70b9\u52a0\u4e0a\u552f\u4e00\u6807\u8bc6key\uff0c\u5217\u8868\u5bf9\u6bd4\u7684\u65f6\u5019\uff0c\u4f7f\u7528key\u8fdb\u884c\u5bf9\u6bd4\uff0c\u8fd9\u6837\u624d\u80fd\u590d\u7528\u8001\u7684 DOM \u6811\u4e0a\u7684\u8282\u70b9\u3002"),(0,l.kt)("p",null,"\u8fd9\u6837\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7\u6df1\u5ea6\u4f18\u5148\u904d\u5386\u4e24\u68f5\u6811\uff0c\u6bcf\u5c42\u7684\u8282\u70b9\u8fdb\u884c\u5bf9\u6bd4\uff0c\u8bb0\u5f55\u4e0b\u6bcf\u4e2a\u8282\u70b9\u7684\u5dee\u5f02\u4e86"),(0,l.kt)("h3",{id:"1\u6df1\u5ea6\u4f18\u5148\u904d\u5386\u8bb0\u5f55\u5dee\u5f02"},"1.\u6df1\u5ea6\u4f18\u5148\u904d\u5386\uff0c\u8bb0\u5f55\u5dee\u5f02"),(0,l.kt)("p",null,"\u5bf9\u65b0\u65e7\u4e24\u68f5\u6811\u8fdb\u884c\u4e00\u4e2a\u6df1\u5ea6\u4f18\u5148\u7684\u904d\u5386\uff0c\u8fd9\u6837\u6bcf\u4e2a\u8282\u70b9\u90fd\u4f1a\u6709\u4e00\u4e2a\u552f\u4e00\u7684\u6807\u8bb0\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"\u5728\u6df1\u5ea6\u4f18\u5148\u904d\u5386\u7684\u65f6\u5019\uff0c\u6bcf\u904d\u5386\u5230\u4e00\u4e2a\u8282\u70b9\u5c31\u628a\u8be5\u8282\u70b9\u548c\u65b0\u7684\u7684\u6811\u8fdb\u884c\u5bf9\u6bd4\u3002\u5982\u679c\u6709\u5dee\u5f02\u7684\u8bdd\u5c31\u8bb0\u5f55\u5230\u4e00\u4e2a\u5bf9\u8c61\u91cc\u9762\u3002\n")),(0,l.kt)("p",null,(0,l.kt)("img",{src:r(97997).Z,width:"549",height:"426"})),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"// diff\u51fd\u6570,\u5bf9\u6bd4\u4e24\u68f5\u6811\nfunction diff(oldTree,newTree){\n    let index = 0;  // \u5f53\u524d\u8282\u70b9\u7684\u6807\u5fd7\n    let patches = {};   //\u8bb0\u5f55\u6bcf\u4e2a\u8282\u70b9\u7684\u5dee\u5f02\u5bf9\u8c61\n    dfsWalk(oldTree, newTree, index, patches);\n    return patches;\n}\n\n// \u5bf9\u4e24\u68f5\u6811\u8fdb\u884c\u6df1\u5ea6\u4f18\u5148\u904d\u5386\nfunction dfsWalk(oldNode,newNode,index,patches){\n    // \u5bf9\u6bd4oldNode\u548cnewNode\u7684\u4e0d\u540c,\u8bb0\u5f55\u4e0b\u6765\n    patches[index] = [...]\n    diffChildren(oldNode.children, newNode.children, index, patches)\n}\n\n// \u904d\u5386\u5b50\u8282\u70b9\nfunction diffChildren(oldChildren, newChildren, index, patches){\n    let leftNode = null;\n    let currentNodeIndex = index;\n    oldChildren.forEach(function(child,i){\n        let newChild = newChildren[i];\n        currentNodeIndex = (leftNode && leftNode.count) // \u8ba1\u7b97\u8282\u70b9\u7684\u6807\u8bc6\n      ? currentNodeIndex + leftNode.count + 1\n      : currentNodeIndex + 1\n        dfsWalk(child, newChild, currentNodeIndex, patches) // \u6df1\u5ea6\u904d\u5386\u5b50\u8282\u70b9\n        leftNode = child\n    });\n}\n")),(0,l.kt)("p",null,"\u4f8b\u5982\uff0c\u4e0a\u9762\u7684div\u548c\u65b0\u7684div\u6709\u5dee\u5f02\uff0c\u5f53\u524d\u7684\u6807\u8bb0\u662f0\uff0c\u90a3\u4e48\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"patches[0] = [{difference}, {difference}, ...] // \u7528\u6570\u7ec4\u5b58\u50a8\u65b0\u65e7\u8282\u70b9\u7684\u4e0d\u540c\n// \u540c\u7406p\u662fpatches[1]\uff0cul\u662fpatches[3]\uff0c\u7c7b\u63a8\u3002\n")),(0,l.kt)("h3",{id:"2\u53ea\u8003\u8651\u76f8\u540c\u7b49\u7ea7diff\u53ef\u4ee5\u5206\u4e3a\u4e0b\u97624\u4e2d\u60c5\u51b5"},"2.\u53ea\u8003\u8651\u76f8\u540c\u7b49\u7ea7diff\uff0c\u53ef\u4ee5\u5206\u4e3a\u4e0b\u97624\u4e2d\u60c5\u51b5\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"1. \u66ff\u6362\u6389\u539f\u6765\u7684\u8282\u70b9\uff0c\u4f8b\u5982\u628a\u4e0a\u9762\u7684div\u6362\u6210\u4e86section\n2. \u4fee\u6539\u4e86\u8282\u70b9\u7684\u5c5e\u6027\n3. \u79fb\u52a8\u3001\u5220\u9664\u3001\u65b0\u589e\u5b50\u8282\u70b9\uff0c\u4f8b\u5982\u4e0a\u9762div\u7684\u5b50\u8282\u70b9\uff0c\u628ap\u548cul\u987a\u5e8f\u4e92\u6362\n4. \u5bf9\u4e8e\u6587\u672c\u8282\u70b9\uff0c\u6587\u672c\u5185\u5bb9\u53ef\u80fd\u4f1a\u6539\u53d8\u3002\u4f8b\u5982\u4fee\u6539\u4e0a\u9762\u7684\u6587\u672c\u8282\u70b92\u5185\u5bb9\u4e3aVirtual DOM 2\u3002\n")),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"\u7b2c\u4e00\u79cd\u3002\u5982\u679c\u8282\u70b9\u7c7b\u578b\u53d8\u4e86\uff0c\u6bd4\u5982\u4e0b\u9762\u7684p\u6807\u7b7e\u53d8\u6210\u4e86h3\u6807\u7b7e\uff0c\u5219\u76f4\u63a5\u5378\u8f7d\u65e7\u8282\u70b9\u88c5\u8f7d\u65b0\u8282\u70b9\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u79f0\u4e3aREPLACE\u3002")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"renderA: <ul>\nrenderB: <ul class: 'marginLeft10'>\n=> [addAttribute class \"marginLeft10\"]\n")),(0,l.kt)("ol",{start:2},(0,l.kt)("li",{parentName:"ol"},"\u7b2c\u4e8c\u79cd\u60c5\u51b5\u3002\u8282\u70b9\u7c7b\u578b\u4e00\u6837\uff0c\u4ec5\u4ec5\u662f\u5c5e\u6027\u53d8\u5316\u4e86\uff0c\u8fd9\u4e00\u8fc7\u7a0b\u53ebPROPS\u3002\u6bd4\u5982")),(0,l.kt)("p",null,"\u8fd9\u4e00\u8fc7\u7a0b\u53ea\u4f1a\u6267\u884c\u8282\u70b9\u7684\u66f4\u65b0\u64cd\u4f5c\uff0c\u4e0d\u4f1a\u89e6\u53d1\u8282\u70b9\u7684\u5378\u8f7d\u548c\u88c5\u8f7d\u64cd\u4f5c\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"renderA: <ul>\nrenderB: <ul class: 'marginLeft10'>\n=> [addAttribute class \"marginLeft10\"]\n")),(0,l.kt)("ol",{start:3},(0,l.kt)("li",{parentName:"ol"},"\u7b2c\u4e09\u79cd\u3002\u8282\u70b9\u53d1\u751f\u4e86\u79fb\u52a8\uff0c\u589e\u52a0\uff0c\u6216\u8005\u5220\u9664\u64cd\u4f5c\u3002\u8be5\u8fc7\u7a0b\u79f0\u4e3aREOREDR\u3002\u865a\u62dfDOM Diff\u7b97\u6cd5\u89e3\u6790"),(0,l.kt)("li",{parentName:"ol"},"\u7b2c\u56db\u79cd\u3002\u53ea\u662f\u6587\u672c\u53d8\u5316\u4e86\uff0cTEXT\u8fc7\u7a0b\u3002\u8be5\u8fc7\u7a0b\u53ea\u4f1a\u66ff\u6362\u6587\u672c\u3002"),(0,l.kt)("li",{parentName:"ol"},"\u5982\u679c\u5728\u4e00\u4e9b\u8282\u70b9\u4e2d\u95f4\u63d2\u5165\u4e00\u4e2aF\u8282\u70b9\uff0c\u7b80\u5355\u7c97\u66b4\u7684\u505a\u6cd5\u662f\uff1a\u5378\u8f7dC\uff0c\u88c5\u8f7dF\uff0c\u5378\u8f7dD\uff0c\u88c5\u8f7dC\uff0c\u5378\u8f7dE\uff0c\u88c5\u8f7dD\uff0c\u88c5\u8f7dE\u3002\u5982\u4e0b\u56fe\uff1a\n\u8fd9\u79cd\u65b9\u6cd5\u663e\u7136\u662f\u4e0d\u9ad8\u6548\u7684\u3002 \u800c\u5982\u679c\u7ed9\u6bcf\u4e2a\u8282\u70b9\u552f\u4e00\u7684\u6807\u8bc6(key)\uff0c\u90a3\u4e48\u5c31\u80fd\u627e\u5230\u6b63\u786e\u7684\u4f4d\u7f6e\u53bb\u63d2\u5165\u65b0\u7684\u8282\u70b9\u3002")),(0,l.kt)("h3",{id:"3\u5dee\u5f02\u7c7b\u578b"},"3.\u5dee\u5f02\u7c7b\u578b"),(0,l.kt)("p",null,"\u5047\u8bbe\u5b9a\u4e49\u5982\u4e0b\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"var REPLACE = 0\nvar REORDER = 1\nvar PROPS = 2\nvar TEXT = 3\n")),(0,l.kt)("p",null,"\u5bf9\u4e8e\u8282\u70b9\u66ff\u6362\uff0c\u5f88\u7b80\u5355\u3002\u5224\u65ad\u65b0\u65e7\u8282\u70b9\u7684tagName\u548c\u662f\u4e0d\u662f\u4e00\u6837\u7684\uff0c\u5982\u679c\u4e0d\u4e00\u6837\u7684\u8bf4\u660e\u9700\u8981\u66ff\u6362\u6389\u3002\u5982div\u6362\u6210section\uff0c\u5c31\u8bb0\u5f55\u4e0b\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"patches[0] = [{\n  type: REPALCE,\n  node: newNode // el('section', props, children)\n}]\n")),(0,l.kt)("p",null,"\u5982\u679c\u7ed9div\u65b0\u589e\u4e86\u5c5e\u6027id\u4e3acontainer\uff0c\u5c31\u8bb0\u5f55\u4e0b\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"patches[0] = [{\n  type: REPALCE,\n  node: newNode // el('section', props, children)\n}, {\n  type: PROPS,\n  props: {\n    id: \"container\"\n  }\n}]\n")),(0,l.kt)("p",null,"\u5982\u679c\u662f\u6587\u672c\u8282\u70b9\uff0c\u5982\u4e0a\u9762\u7684\u6587\u672c\u8282\u70b92\uff0c\u5c31\u8bb0\u5f55\u4e0b\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},'patches[2] = [{\n  type: TEXT,\n  content: "Virtual DOM2"\n}]\n')),(0,l.kt)("p",null,"\u90a3\u5982\u679c\u628a\u6211div\u7684\u5b50\u8282\u70b9\u91cd\u65b0\u6392\u5e8f\u5462\uff1f\u4f8b\u5982p, ul, div\u7684\u987a\u5e8f\u6362\u6210\u4e86div, p, ul\u3002\u8fd9\u4e2a\u8be5\u600e\u4e48\u5bf9\u6bd4\uff1f"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"\u5982\u679c\u6309\u7167\u540c\u5c42\u7ea7\u8fdb\u884c\u987a\u5e8f\u5bf9\u6bd4\u7684\u8bdd\uff0c\u5b83\u4eec\u90fd\u4f1a\u88ab\u66ff\u6362\u6389\u3002\u5982p\u548cdiv\u7684tagName\u4e0d\u540c\uff0cp\u4f1a\u88abdiv\u6240\u66ff\u4ee3\u3002\n\n\u6700\u7ec8\uff0c\u4e09\u4e2a\u8282\u70b9\u90fd\u4f1a\u88ab\u66ff\u6362\uff0c\u8fd9\u6837DOM\u5f00\u9500\u5c31\u975e\u5e38\u5927\u3002\n\n\u800c\u5b9e\u9645\u4e0a\u662f\u4e0d\u9700\u8981\u66ff\u6362\u8282\u70b9\uff0c\u800c\u53ea\u9700\u8981\u7ecf\u8fc7\u8282\u70b9\u79fb\u52a8\u5c31\u53ef\u4ee5\u8fbe\u5230\uff0c\u6211\u4eec\u53ea\u9700\u77e5\u9053\u600e\u4e48\u8fdb\u884c\u79fb\u52a8\u3002\n")),(0,l.kt)("h2",{id:"\u6700\u540e\u628a\u5dee\u5f02\u5e94\u7528\u5230\u771f\u6b63\u7684dom\u6811\u4e0a"},"\u6700\u540e\u628a\u5dee\u5f02\u5e94\u7528\u5230\u771f\u6b63\u7684DOM\u6811\u4e0a"),(0,l.kt)("p",null,"\u56e0\u4e3a\u6b65\u9aa4\u4e00\u6240\u6784\u5efa\u7684 JavaScript \u5bf9\u8c61\u6811\u548crender\u51fa\u6765\u771f\u6b63\u7684DOM\u6811\u7684\u4fe1\u606f\u3001\u7ed3\u6784\u662f\u4e00\u6837\u7684\u3002"),(0,l.kt)("p",null,"\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u5bf9\u90a3\u68f5DOM\u6811\u4e5f\u8fdb\u884c\u6df1\u5ea6\u4f18\u5148\u7684\u904d\u5386\uff0c\u904d\u5386\u7684\u65f6\u5019\u4ece\u6b65\u9aa4\u4e8c\u751f\u6210\u7684patches\u5bf9\u8c61\u4e2d\u627e\u51fa\u5f53\u524d\u904d\u5386\u7684\u8282\u70b9\u5dee\u5f02\uff0c\u7136\u540e\u8fdb\u884c DOM \u64cd\u4f5c"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"function patch (node, patches) {\n  var walker = {index: 0}\n  dfsWalk(node, walker, patches)\n}\n\nfunction dfsWalk (node, walker, patches) {\n  var currentPatches = patches[walker.index] // \u4ecepatches\u62ff\u51fa\u5f53\u524d\u8282\u70b9\u7684\u5dee\u5f02\n\n  var len = node.childNodes\n    ? node.childNodes.length\n    : 0\n  for (var i = 0; i < len; i++) { // \u6df1\u5ea6\u904d\u5386\u5b50\u8282\u70b9\n    var child = node.childNodes[i]\n    walker.index++\n    dfsWalk(child, walker, patches)\n  }\n\n  if (currentPatches) {\n    applyPatches(node, currentPatches) // \u5bf9\u5f53\u524d\u8282\u70b9\u8fdb\u884cDOM\u64cd\u4f5c\n  }\n}\n")),(0,l.kt)("p",null,"applyPatches\uff0c\u6839\u636e\u4e0d\u540c\u7c7b\u578b\u7684\u5dee\u5f02\u5bf9\u5f53\u524d\u8282\u70b9\u8fdb\u884c DOM \u64cd\u4f5c\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"function applyPatches (node, currentPatches) {\n  currentPatches.forEach(function (currentPatch) {\n    switch (currentPatch.type) {\n      case REPLACE:\n        node.parentNode.replaceChild(currentPatch.node.render(), node)\n        break\n      case REORDER:\n        reorderChildren(node, currentPatch.moves)\n        break\n      case PROPS:\n        setProps(node, currentPatch.props)\n        break\n      case TEXT:\n        node.textContent = currentPatch.content\n        break\n      default:\n        throw new Error('Unknown patch type ' + currentPatch.type)\n    }\n  })\n}\n")),(0,l.kt)("h2",{id:"react-diff\u4e09\u5927\u7b56\u7565"},"React Diff\u4e09\u5927\u7b56\u7565"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"tree diff;"),(0,l.kt)("li",{parentName:"ol"},"component diff;"),(0,l.kt)("li",{parentName:"ol"},"element diff;")),(0,l.kt)("p",null,"PS: \u4e4b\u524dH5\u5f00\u53d1\u9047\u5230\u7684State \u4e2d\u53d8\u91cf\u66f4\u65b0\u4f46\u89c6\u56fe\u672a\u66f4\u65b0\u7684Bug\u5c31\u662felement diff\u68c0\u6d4b\u5bfc\u81f4\u3002\u89e3\u51b3\u65b9\u6848\uff1a"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"\u4e24\u79cd\u4e1a\u52a1\u573a\u666f\u4e0b\u7684DOM\u8282\u70b9\u5c3d\u91cf\u907f\u514d\u96f7\u540c\uff1b "),(0,l.kt)("li",{parentName:"ol"},"\u4e24\u79cd\u4e1a\u52a1\u573a\u666f\u4e0b\u7684DOM\u8282\u70b9\u6837\u5f0f\u907f\u514d\u96f7\u540c\uff1b")),(0,l.kt)("p",null,"\u5f53\u524d\u5b58\u5728\u4e00\u4e2aDOM\u8282\u70b9\uff0c\u89e6\u53d1\u4e86\u4e00\u6b21\u66f4\u65b0\uff0c\u90a3\u4e48\u5728\u534f\u8c03\u7684\u8fc7\u7a0b\u4e2d\uff0c\u4f1a\u6709\u56db\u79cd\u8282\u70b9\u548c\u8be5\u8282\u70b9\u76f8\u5173\u8054\uff1a"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"\u8be5DOM\u8282\u70b9\u672c\u8eab"),(0,l.kt)("li",{parentName:"ol"},"workInProgress fiber\uff0c\u66f4\u65b0\u8fc7\u7a0b\u4e2d\u4ea7\u751f\u7684workInProgress Tree\u4e2d\u7684fiber\u8282\u70b9\uff08\u5373current fiber.alternate\uff09"),(0,l.kt)("li",{parentName:"ol"},"current fiber\uff0c\u5728\u9875\u9762\u4e2d\u5df2\u7ecf\u6e32\u67d3\u4e86\u7684DOM\u8282\u70b9\u5bf9\u5e94\u7684fiber\u8282\u70b9\uff08\u5373workInProgress fiber.alternate\uff0c\u4e5f\u5c31\u662f\u4e0a\n\u4e00\u6b21\u66f4\u65b0\u4e2d\u4ea7\u751f\u7684workInProgress fiber\uff09"),(0,l.kt)("li",{parentName:"ol"},"ReactElement\uff0c\u66f4\u65b0\u8fc7\u7a0b\u4e2d\uff0cClassComponent\u7684render\u65b9\u6cd5\u6216FunctionComponent\u7684\u8c03\u7528\u7ed3\u679c\u3002 ReactElement\u4e2d\u5305\u542b\u63cf\u8ff0DOM\u8282\u70b9\u7684\u4fe1\u606f\u3002")),(0,l.kt)("h3",{id:"effecttag"},"effectTag"),(0,l.kt)("p",null,"\u7528\u4e8e\u4fdd\u5b58\u8981\u6267\u884cDOM\u64cd\u4f5c\u7684\u5177\u4f53\u7c7b\u578b\u7684\u3002 effectTag\u901a\u8fc7\u4e8c\u8fdb\u5236\u8868\u793a\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"//...\n// \u610f\u5473\u7740\u8be5Fiber\u8282\u70b9\u5bf9\u5e94\u7684DOM\u8282\u70b9\u9700\u8981\u63d2\u5165\u5230\u9875\u9762\u4e2d\u3002\nexport const Placement = /*                    */ 0b000000000000010;\n//\u610f\u5473\u7740\u8be5Fiber\u8282\u70b9\u9700\u8981\u66f4\u65b0\u3002\nexport const Update = /*                       */ 0b000000000000100;\nexport const PlacementAndUpdate = /*           */ 0b000000000000110;\n//\u610f\u5473\u7740\u8be5Fiber\u8282\u70b9\u5bf9\u5e94\u7684DOM\u8282\u70b9\u9700\u8981\u4ece\u9875\u9762\u4e2d\u5220\u9664\u3002\nexport const Deletion = /*                     */ 0b000000000001000;\n//...\n")),(0,l.kt)("h2",{id:"diff\u7684\u5165\u53e3\u51fd\u6570\u4e3a-reconcilechildren"},"Diff\u7684\u5165\u53e3\u51fd\u6570\u4e3a reconcileChildren"),(0,l.kt)("p",null,"ChildReconciler\u5185\u90e8\u5b9a\u4e49\u4e86\u8bb8\u591a\u534f\u8c03\u76f8\u5173\u7684\u51fd\u6570\uff0c\u5e76\u5c06reconcileChildFibers\u4f5c\u4e3a\u51fd\u6570\u7684\u8fd4\u56de\u503c\u3002"),(0,l.kt)("p",null,"\u5185\u90e8\u4f1a\u901a\u8fc7current === null \u533a\u5206\u5f53\u524dfiber\u8282\u70b9\u662fmount\u8fd8\u662fupdate:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"mount--\x3emountChildFibers\nupdate--\x3ereconcileChildFibers\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"/*\n* shouldTrackSideEffects\u4e3atrue\u65f6\u4f1a\u4e3a\u751f\u6210\u7684fiber\u8282\u70b9\u6536\u96c6effectTag\u5c5e\u6027\uff0c\u53cd\u4e4b\u4e0d\u4f1a\u8fdb\u884c\u6536\u96c6effectTag\u5c5e\u6027\u3002\n* */\nexport const reconcileChildFibers = ChildReconciler(true);\nexport const mountChildFibers = ChildReconciler(false);\n\nfunction ChildReconciler(shouldTrackSideEffects) {\n    //...\n\n    function reconcileChildrenArray(\n        returnFiber: Fiber,\n        currentFirstChild: Fiber | null,\n        newChildren: Array<*>,\n        lanes: Lanes,\n    ): Fiber | null {\n        //...\n    }\n\n    function reconcileChildrenIterator(\n        returnFiber: Fiber,\n        currentFirstChild: Fiber | null,\n        newChildrenIterable: Iterable<*>,\n        lanes: Lanes,\n    ): Fiber | null {\n        //...\n    }\n\n    function reconcileSingleTextNode(\n        returnFiber: Fiber,\n        currentFirstChild: Fiber | null,\n        textContent: string,\n        lanes: Lanes,\n    ): Fiber {\n        //...\n    }\n\n    function reconcileSingleElement(\n        returnFiber: Fiber,\n        currentFirstChild: Fiber | null,\n        element: ReactElement,\n        lanes: Lanes,\n    ): Fiber {\n        //...\n    }\n\n    function reconcileSinglePortal(\n        returnFiber: Fiber,\n        currentFirstChild: Fiber | null,\n        portal: ReactPortal,\n        lanes: Lanes,\n    ): Fiber {\n        //...\n    }\n\n    // This API will tag the children with the side-effect of the reconciliation\n    // itself. They will be added to the side-effect list as we pass through the\n    // children and the parent.\n    function reconcileChildFibers(\n        returnFiber: Fiber,\n        currentFirstChild: Fiber | null,\n        newChild: any,\n        lanes: Lanes,\n    ): Fiber | null {\n        //...\n    }\n\n    return reconcileChildFibers;\n}\n")),(0,l.kt)("h2",{id:"reconcilechildfibers\u662freact-diff\u771f\u6b63\u7684\u5165\u53e3\u51fd\u6570"},"reconcileChildFibers\u662fReact Diff\u771f\u6b63\u7684\u5165\u53e3\u51fd\u6570"),(0,l.kt)("p",null,"reconcileChildFibers\u5185\u90e8\u4f1a\u6839\u636enewChild\uff08\u5373\u65b0\u751f\u6210\u7684ReactElement\uff09\u7684\u7c7b\u578b\u548c$$typeof\u5c5e\u6027\u8c03\u7528\u4e0d\u540c\u7684\u5904\u7406\u51fd\u6570\u3002"),(0,l.kt)("p",null,"\u636enewChild\u4e2d\u8282\u70b9\u7684\u6570\u91cf\u628aDiff\u5206\u4e3a\u4e24\u79cd\u7c7b\u578b\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"1. \u5f53newChild\u53ea\u6709\u4e00\u4e2a\u8282\u70b9\uff0c\u4e5f\u5373newChild\u7c7b\u578b\u4e3aobject\u3001number\u3001string\u65f6\uff0c\u6211\u4eec\u4f1a\u8fdb\u5165\u5355\u8282\u70b9\u7684Diff\n2. \u5f53newChild\u6709\u591a\u4e2a\u8282\u70b9\uff0c\u4e5f\u5373\u7c7b\u578b\u4e3aArray\u65f6\uff0c\u8fdb\u5165\u591a\u8282\u70b9\u7684Diff\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"// \u6839\u636enewChild\u8fdb\u5165\u4e0d\u540cDiff\u51fd\u6570\u5904\u7406\nfunction reconcileChildFibers(\n  returnFiber: Fiber,\n  currentFirstChild: Fiber | null,\n  newChild: any,\n): Fiber | null {\n  //...\n\n  if (typeof newChild === 'object' && newChild !== null) {\n    // object\u7c7b\u578b\uff0c\u53ef\u80fd\u662f REACT_ELEMENT_TYPE \u6216 REACT_PORTAL_TYPE\n    switch (newChild.$$typeof) {\n      case REACT_ELEMENT_TYPE:\n        // \u8c03\u7528 reconcileSingleElement \u5904\u7406\n      // ...\n    }\n  }\n\n  if (typeof newChild === 'string' || typeof newChild === 'number') {\n    // \u8c03\u7528 reconcileSingleTextNode \u5904\u7406\n    // ...\n  }\n\n  if (isArray(newChild)) {\n    // \u8c03\u7528 reconcileChildrenArray \u5904\u7406\n    // ...\n  }\n\n  if (getIteratorFn(newChild)) {\n    // \u8c03\u7528 reconcileChildrenIterator\u5904\u7406\n    // ... \n  }\n\n  // ...\n\n  // \u5982\u679c\u4ee5\u4e0a\u5206\u652f\u90fd\u6ca1\u6709\u547d\u4e2d\uff0c\u5219\u5220\u9664\u8282\u70b9\n  return deleteRemainingChildren(returnFiber, currentFirstChild);\n}\n")),(0,l.kt)("h2",{id:"\u4e09\u5355\u8282\u70b9\u7684diff"},"\u4e09.\u5355\u8282\u70b9\u7684Diff"),(0,l.kt)("p",null,"\u6839\u636enewChild\uff08\u5373\u65b0\u751f\u6210\u7684ReactElement\uff09\u4e3a\u5355\u4e00\u8282\u70b9\uff0c\u4f46\u6b64\u8282\u70b9\u5728current fiber tree\u4e2d\u5bf9\u5e94\u7684\u5c42\u7ea7\u5177\u6709\u591a\u5c11\u4e2a\u8282\u70b9\u6211\u4eec\u662f\u4e0d\u786e\u5b9a\u7684\uff0c\n\u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u6b64\u8282\u70b9\u5728current fiber tree\u4e2d\u5bf9\u5e94\u7684\u5c42\u7ea7\u7684\u8282\u70b9\u6570\u91cf\u5206\u4e3a\u4e09\u79cd\u573a\u666f\uff1a"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"\u5bf9\u5e94\u5c42\u7ea7\u5b58\u5728\u5355\u4e2a\u65e7\u8282\u70b9")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"\u65e7\uff1a A\n\u65b0\uff1a A'\n")),(0,l.kt)("ol",{start:2},(0,l.kt)("li",{parentName:"ol"},"\u5bf9\u5e94\u5c42\u7ea7\u5b58\u5728\u591a\u4e2a\u65e7\u8282\u70b9")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"\u65e7\uff1a A -> B -> C\n\u65b0\uff1a A'\n")),(0,l.kt)("ol",{start:3},(0,l.kt)("li",{parentName:"ol"},"\u5bf9\u5e94\u5c42\u7ea7\u65e0\u65e7\u8282\u70b9")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"\u65e7\uff1a null\n\u65b0\uff1a A'\n")),(0,l.kt)("p",null,"\u573a\u666f1\u548c\u573a\u666f2\u6211\u4eec\u53ef\u4ee5\u5f52\u4e3a\u4e00\u7c7b\uff08\u5373\u5728\u5f53\u524d\u5c42\u7ea7\u4e2d\uff0ccurrent fiber\u5728sibling\u65b9\u5411\u7684\u94fe\u8868\u4e2d\u81f3\u5c11\u5b58\u5728\u4e00\u4e2a\u8282\u70b9\uff09\uff0c\n\u573a\u666f3\u5355\u72ec\u4e3a\u4e00\u7c7b\uff08\u5f53\u524d\u5c42\u7ea7\u65e0current fiber\u8282\u70b9\uff09\u3002"),(0,l.kt)("h3",{id:"3-1\u5f53\u524d\u5c42\u7ea7\u7684current-fiber\u5728sibling\u65b9\u5411\u7684\u94fe\u8868\u4e0d\u4e3a\u7a7a"},"3-1.\u5f53\u524d\u5c42\u7ea7\u7684current fiber\u5728sibling\u65b9\u5411\u7684\u94fe\u8868\u4e0d\u4e3a\u7a7a"),(0,l.kt)("p",null,"\u6b64\u65f6\u6211\u4eec\u9700\u8981\u5faa\u73af\u904d\u5386\u5f53\u524d\u5c42\u7ea7\u5728sibling\u65b9\u5411\u7684\u94fe\u8868\u7684\u6240\u6709current fiber\u8282\u70b9\uff0c\u5224\u65ad\u662f\u5426\u53ef\u4ee5\u590d\u7528\uff08key\u76f8\u540c\u4e14type\u76f8\u540c\uff09."),(0,l.kt)("p",null,"\u5f53\u524d\u5c42\u7ea7\u7684current fiber\u8282\u70b9\u7684stateNode\uff08\u5373\u590d\u7528fiber\u8282\u70b9\u5bf9\u5e94\u7684DOM\u8282\u70b9\uff09,\u53ef\u4ee5\u5219\u4ee5current fiber\u4f5c\u4e3a\u526f\u672c\u751f\u6210\nworkInProgress fiber\u3002\u5f53\u524d\u5c42\u7ea7\u6240\u6709\u7684current fiber\u8282\u70b9\u90fd\u65e0\u6cd5\u590d\u7528\u65f6\uff0c\u76f4\u63a5\u751f\u6210\u4e00\u4e2a\u65b0\u7684fiber\u8282\u70b9\u4f5c\u4e3aworkInProgress fiber\u3002"),(0,l.kt)("h3",{id:"3-2\u5f53\u524d\u5c42\u7ea7\u7684current-fiber\u5728sibling\u65b9\u5411\u7684\u94fe\u8868\u4e3a\u7a7a"},"3-2.\u5f53\u524d\u5c42\u7ea7\u7684current fiber\u5728sibling\u65b9\u5411\u7684\u94fe\u8868\u4e3a\u7a7a"),(0,l.kt)("p",null,"\u7531\u4e8e\u4e0d\u5b58\u5728\u5bf9\u5e94\u7684current fiber\u8282\u70b9\uff0c\u6240\u4ee5\u76f4\u63a5\u751f\u6210\u4e00\u4e2a\u65b0\u7684fiber\u8282\u70b9\u4f5c\u4e3aworkInProgress fiber\u3002"),(0,l.kt)("h3",{id:"3-2reconcilesingleelement\u7684\u5177\u4f53\u5b9e\u73b0"},"3-2.reconcileSingleElement\u7684\u5177\u4f53\u5b9e\u73b0"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"function reconcileSingleElement(\n  returnFiber: Fiber,\n  currentFirstChild: Fiber | null,\n  element: ReactElement,\n  lanes: Lanes,\n): Fiber {\n  const key = element.key;\n  let child = currentFirstChild;\n  \n  //\u5faa\u73af\u904d\u5386\u5f53\u524d\u8fd9\u4e00\u5c42\u7ea7\u7684current fiber\u8282\u70b9\n  while (child !== null) {\n    if (child.key === key) {\n      //  key\u76f8\u540c, \u5224\u65ad\u5f53\u524d current fiber.elementType \u662f\u5426\u7b49\u4e8e ReactElement.type\n      switch (child.tag) {\n        //...\n        default: {\n          if (child.elementType === element.type) {\n            //  type\u76f8\u540c,\u8868\u793a\u53ef\u4ee5\u590d\u7528\u5f53\u524dfiber\u8282\u70b9, \u7531\u4e8e\u662f\u5355\u8282\u70b9\uff0c\u6240\u4ee5\u5982\u679c\u5f53\u524d\u8282\u70b9\u5b58\u5728\u5144\u5f1f\u8282\u70b9, \u9700\u8981\u7ed9\u5144\u5f1f\u8282\u70b9\u6253\u4e0aDeletion effectTag\uff08\u5220\u9664\u5144\u5f1f\u8282\u70b9\uff09\n            deleteRemainingChildren(returnFiber, child.sibling);\n            // \u6784\u9020workInProgress fiber\u8282\u70b9,\u6784\u9020\u8fc7\u7a0b\u4e2d\u4f1a\u590d\u7528\u5f53\u524dfiber\u8282\u70b9\u7684stateNode, \u5373\u590d\u7528DOM\u5bf9\u8c61\n            const existing = useFiber(child, element.props);\n            existing.ref = coerceRef(returnFiber, child, element);\n            existing.return = returnFiber;\n            return existing;\n          }\n          break;\n        }\n      }\n      // key\u76f8\u540c\u4f46type\u4e0d\u76f8\u540c\uff0c\u5219\u627e\u5230\u4e86\u5f53\u524d\u8282\u70b9\u5728\u4e0a\u6b21\u66f4\u65b0\u65f6\u5bf9\u5e94\u7684\u8282\u70b9\uff0c\u4f46\u4e24\u4e2a\u8282\u70b9\u7684type\u5df2\u7ecf\u4e0d\u4e00\u81f4\uff0c\u5e76\u4e14\u540e\u7eed\u8282\u70b9\u4e5f\u6ca1\u6709\u53ef\u80fd\u8fdb\u884c\u590d\u7528\uff0c\u6240\u4ee5\u5220\u9664\u5f53\u524dcurrent fiber\u8282\u70b9\u4ee5\u53ca\u8282\u70b9\u7684\u5269\u4f59\u5144\u5f1f\u8282\u70b9\n      deleteRemainingChildren(returnFiber, child);\n      break;\n    } else {\n      // key\u4e0d\u4e00\u81f4\u5219\u7ed9\u5f53\u524dcurrent fiber\u8282\u70b9\u6253\u4e0aDeletion effectTag\uff0c\u5220\u9664\u5f53\u524d\u8282\u70b9\uff0c\u5e76\u7ee7\u7eed\u5f80\u4e0b\u4e00\u4e2a\u5144\u5f1f\u8282\u70b9\u904d\u5386\uff0c\u5c1d\u8bd5\u5339\u914d\n      deleteChild(returnFiber, child);\n    }\n    child = child.sibling;\n  }\n\n  //DOM\u8282\u70b9\u4e0d\u53ef\u590d\u7528 \u65b0\u5efafiber\u4f5c\u4e3aReactElement\u5bf9\u5e94\u7684WorkInProgress Fiber\n  const created = createFiberFromElement(element, returnFiber.mode, lanes);\n  created.ref = coerceRef(returnFiber, currentFirstChild, element);\n  created.return = returnFiber;\n  return created;\n}\n")),(0,l.kt)("p",null,"\u6ce8\u610f\uff0c\u5728\u4e3acurrent fiber\u8282\u70b9\u4e0d\u5339\u914d\u5e76\u6253\u4e0aDeletion effectTag\u65f6, \u4f1a\u540c\u65f6\u5c06\u5176\u6dfb\u52a0\u5230\u7236\u8282\u70b9\u7684effectList\u4e2d\n(\u6b63\u5e38effectList\u7684\u6536\u96c6\u662f\u5728completeWork\u4e2d\u8fdb\u884c\u7684, \u4f46\u662f\u88ab\u5220\u9664\u7684\u8282\u70b9\u4f1a\u8131\u79bbfiber\u6811,\n\u65e0\u6cd5\u8fdb\u5165completeWork\u7684\u6d41\u7a0b, \u6240\u4ee5\u5728beginWork\u9636\u6bb5\u63d0\u524d\u52a0\u5165\u7236\u8282\u70b9\u7684effectList)\uff1b"),(0,l.kt)("h2",{id:"\u56db\u591a\u8282\u70b9\u7684diff"},"\u56db.\u591a\u8282\u70b9\u7684Diff"),(0,l.kt)("p",null,"\u5f53newChild\u4e3a\u591a\u8282\u70b9\u65f6\uff0c\u4ee5\u4e0b\u7684\u51e0\u79cd\u573a\u666f\u4e2d\u4f1a\u89e6\u53d1\u591a\u8282\u70b9\u7684Diff\u3002"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"\u8282\u70b9\u66f4\u65b0")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},'//\u8282\u70b9\u5c5e\u6027\u53d1\u751f\u53d8\u66f4\uff1b\n//\u65e7\n<div key="a">a</div>\n<div key="b">b</div>\n<div key="c">c</div>\n\n//\u65b0\n<div key="a" className="a">a</div>\n<div key="b">b</div>\n<div key="c">c</div>\n\n//\u8282\u70b9\u7684\u7c7b\u578b\u53d1\u751f\u53d8\u66f4\uff1b\n//\u65e7\n<div key="a">a</div>\n<div key="b">b</div>\n<div key="c">c</div>\n\n//\u65b0\n<span key="a">a</div>\n<div key="b">b</div>\n<div key="c">c</div>\n')),(0,l.kt)("ol",{start:2},(0,l.kt)("li",{parentName:"ol"},"\u8282\u70b9\u7684\u6570\u91cf\u53d1\u751f\u6539\u53d8\uff1b")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},'//\u8282\u70b9\u5c5e\u6027\u53d1\u751f\u53d8\u66f4\uff1b\n//\u65e7\n<div key="a">a</div>\n<div key="b">b</div>\n<div key="c">c</div>\n\n//\u65b0\n<div key="a" className="a">a</div>\n<div key="b">b</div>\n<div key="c">c</div>\n\n//\u8282\u70b9\u7684\u7c7b\u578b\u53d1\u751f\u53d8\u66f4\uff1b\n//\u65e7\n<div key="a">a</div>\n<div key="b">b</div>\n<div key="c">c</div>\n\n//\u65b0\n<span key="a">a</div>\n<div key="b">b</div>\n<div key="c">c</div>\n')),(0,l.kt)("ol",{start:3},(0,l.kt)("li",{parentName:"ol"},"\u8282\u70b9\u7684\u4f4d\u7f6e\u53d1\u751f\u6539\u53d8\uff1b")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},'//\u65e7\n<div key="a">a</div>\n<div key="b">b</div>\n<div key="c">c</div>\n<div key="e">e</div>\n\n//\u65b0\n<div key="a">a</div>\n<div key="c">c</div>\n<div key="b">b</div>\n<div key="e">e</div>\n')),(0,l.kt)("p",null,"\u5728reconcileChildFibers\u7684\u5206\u6790\u4e2d\u53ef\u4ee5\u770b\u5230\uff0cReact\u4f7f\u7528\u4e24\u4e2a\u51fd\u6570reconcileChildrenArray(\u9488\u5bf9\u6570\u7ec4\u7c7b\u578b)\u548c\nreconcileChildrenIterator(\u9488\u5bf9\u53ef\u8fed\u4ee3\u7c7b\u578b)\u6765\u8fdb\u884c\u591a\u8282\u70b9\u7684diff\uff0c\u6211\u4eec\u91cd\u70b9\u770b\u770breconcileChildrenArray\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"/*\n* \u5176\u4e2d\u53c2\u6570currentFirstChild\u6307\u7684\u662fcurrent fiber tree\u5728\u8be5\u5c42\u7ea7\u4e2d\u7684\u7b2c\u4e00\u4e2afiber\uff0c\u901a\u8fc7 fiber.sibling\n* \u53ef\u4ee5\u5f97\u5230\u4e00\u6761\u4ece\u5de6\u5230\u53f3\u4e32\u8054currentFirstChild\u5728\u5f53\u524d\u5c42\u7ea7\u7684\u6240\u6709fiber\u8282\u70b9\u7684\u94fe\u8868\uff0c\u6211\u4eec\u4f7f\u7528oldFiber\u6765\u8868\u793a\u8fd9\u6761\u94fe\u8868\u3002\n* \n* \u53c2\u6570newChildren\u662f\u4e00\u4e2a\u6570\u7ec4\uff0c\u5305\u542b\u4e86\u5f53\u524d\u5c42\u7ea7\u7684\u6240\u6709ReactElement\u5bf9\u8c61\u3002\n* */\nfunction reconcileChildrenArray(\n  returnFiber: Fiber,\n  currentFirstChild: Fiber | null,\n  newChildren: Array<*>,\n  lanes: Lanes,\n): Fiber | null {\n  //...\n}\n")),(0,l.kt)("p",null,"reconcileChildrenArray\u4f1a\u5bf9\u6bd4\u8fd9\u4e24\u4e2a\u5e8f\u5217\u4e4b\u95f4\u7684\u5dee\u5f02\uff0c\u5e76\u751f\u6210workInProgress fiber tree\u5728\u5f53\u524d\u5c42\u7ea7\u7684fiber\u8282\u70b9\u94fe\u8868\uff0c\n\u5e76\u4f7f\u7528resultingFirstChild\u4f5c\u4e3a\u5934\u8282\u70b9\u3002\u5bf9\u6bd4\u7684\u8fc7\u7a0b\u4f1a\u7ecf\u5386\u4e24\u8f6e\u7684\u904d\u5386\u3002"),(0,l.kt)("h3",{id:"4-1\u7b2c\u4e00\u8f6e\u904d\u5386"},"4-1.\u7b2c\u4e00\u8f6e\u904d\u5386"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"\u904d\u5386\u6bd4\u8f83newChildren\u4e0eoldFiber\uff0c\u5224\u65adDOM\u8282\u70b9\u662f\u5426\u53ef\u590d\u7528\u3002"),(0,l.kt)("li",{parentName:"ol"},"\u5982\u679c\u53ef\u590d\u7528\uff0c\u5219\u590d\u7528oldFiber\u751f\u6210newFiber\u5e76\u52a0\u5165\u5230\u4ee5resultingFirstChild\n\u4f5c\u4e3a\u5934\u8282\u70b9\u7684\u5e8f\u5217\uff08\u540e\u7eed\u6211\u4eec\u4f7f\u7528newFiberList\u8868\u793a\u6b64\u5e8f\u5217\uff09\u4e2d\uff0c\u4e24\u4e2a\u5e8f\u5217\u90fd\u8df3\u5230\u4e0b\u4e00\u4e2a\u8282\u70b9\u3002"),(0,l.kt)("li",{parentName:"ol"},"\u5982\u679c\u4e0d\u53ef\u590d\u7528\uff0c\u5206\u4e24\u79cd\u60c5\u51b5\u8fdb\u884c\u5904\u7406\uff1a",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u82e5key\u4e0d\u4e00\u81f4\uff0c\u5219\u7acb\u5373\u7ec8\u6b62\u7b2c\u4e00\u8f6e\u904d\u5386\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u82e5key\u76f8\u540c\u4f46type\u4e0d\u540c\uff0c\u5219\u5220\u9664\u5f53\u524doldFiber\u8282\u70b9\uff0c\u751f\u6210\u65b0\u7684fiber\u8282\u70b9\u52a0\u5165\u5230newFiberList\u4e2d\uff0c\u4e24\u4e2a\u5e8f\u5217\u90fd\u8df3\u5230\u4e0b\u4e00\u4e2a\u8282\u70b9\uff0c\u7ee7\u7eed\u904d\u5386\u3002"))),(0,l.kt)("li",{parentName:"ol"},"\u5f53\u4e24\u4e2a\u5e8f\u5217\u4e2d\u7684\u4efb\u610f\u4e00\u4e2a\u5e8f\u5217\u5b8c\u6210\u904d\u5386\uff08\u5373newIdx >= newChildren.length - 1 || oldFiber.sibling === null\uff09\uff0c\u5219\u7ed3\u675f\u7b2c\u4e00\u8f6e\u904d\u5386\u3002")),(0,l.kt)("h3",{id:"4-2\u7b2c\u4e8c\u8f6e\u904d\u5386"},"4-2.\u7b2c\u4e8c\u8f6e\u904d\u5386"),(0,l.kt)("p",null,"\u7b2c\u4e00\u8f6e\u904d\u5386\u540e\uff0c\u4f1a\u4ea7\u751f\u56db\u79cd\u7ed3\u679c\u3002"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"oldFiber\u4e0enewChildren\u90fd\u5b8c\u6210\u904d\u5386\u4e86")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"\u6b64\u65f6\u672c\u8f6ediff\u5df2\u7ecf\u5b8c\u6210\u4e86\u3002\u8fd9\u79cd\u60c5\u51b5\u662f\u6700\u7406\u60f3\u7684\u60c5\u51b5\uff0c\u53ea\u9700\u8981\u8fdb\u884c\u7b2c\u4e00\u8f6e\u904d\u5386\u4e2d\u5bf9\u5e94\u7684\u66f4\u65b0\u64cd\u4f5c\u3002\n")),(0,l.kt)("ol",{start:2},(0,l.kt)("li",{parentName:"ol"},"oldFiber\u904d\u5386\u5b8c\u4e86\uff0c\u4f46newChildren\u8fd8\u6ca1\u904d\u5386\u5b8c\u3002"),(0,l.kt)("li",{parentName:"ol"},"newChildren\u904d\u5386\u5b8c\u4e86\uff0c\u4f46oldFiber\u8fd8\u6ca1\u904d\u5386\u5b8c"),(0,l.kt)("li",{parentName:"ol"},"newChildren\u4e0eoldFiber\u90fd\u6ca1\u5b8c\u6210\u904d\u5386")),(0,l.kt)("h3",{id:"4-2-1oldfiber\u904d\u5386\u5b8c\u4e86\u4f46newchildren\u8fd8\u6ca1\u904d\u5386\u5b8c"},"4-2-1.oldFiber\u904d\u5386\u5b8c\u4e86\uff0c\u4f46newChildren\u8fd8\u6ca1\u904d\u5386\u5b8c"),(0,l.kt)("p",null,"\u5047\u8bbenewFiberList\u4e2d\u6240\u6709\u8282\u70b9\u90fd\u53ef\u4ee5\u662f\u53ef\u4ee5\u76f4\u63a5\u590d\u7528\u7684\uff0c\u90a3\u4e48\u5f53\u524d\u573a\u666f\u548c\u6211\u4eec\u4e4b\u524d\u8ba8\u8bba\u8fc7\u7684\u65b0\u589e\u8282\u70b9\u7684\u573a\u666f\u662f\u4e00\u81f4\u7684\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},'//\u65b0\u589e\u8282\u70b9\n//\u65e7\n<div key="a">a</div>\n<div key="b">b</div>\n<div key="c">c</div>\n\n//\u65b0\n<div key="a">a</div>\n<div key="b">b</div>\n<div key="c">c</div>\n<div key="d">d</div>\n<div key="e">e</div>\n')),(0,l.kt)("p",null,"\u8fd9\u610f\u5473\u7740\u672a\u904d\u5386\u5b8c\u7684newChildren\u8282\u70b9\u90fd\u662f\u65b0\u589e\u7684\uff0c\u6211\u4eec\u9700\u8981\u904d\u5386\u5269\u4e0b\u7684newChildren\uff0c\u751f\u6210\u5bf9\u5e94\u7684workInProgress fiber\u5e76\u6807\u8bb0\u4e0aPlacement\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"\u6b64\u5904\u53ea\u662f\u5047\u8bbe\u7b2c\u4e00\u8f6e\u904d\u5386\u4e2d\u6240\u6709\u52a0\u5165\u5230newFiberList\u7684\u8282\u70b9\u90fd\u662f\u53ef\u4ee5\u590d\u7528\u7684\uff0c\u4fbf\u4e8e\u5927\u5bb6\u7406\u89e3\uff0c\u4f46\u524d\u9762\u6211\u4eec\u6709\u5206\u6790\u8fc7\uff0c\u5728\u7b2c\u4e00\u8f6e\u904d\u5386\u4e2d\u80fd\u591f\u52a0\u5165\u5230\nnewFiberList\u7684\u8282\u70b9\u6709\u4e24\u79cd\uff1a\n1. \u53ef\u4ee5\u76f4\u63a5\u590d\u7528\u7684\u8282\u70b9\uff1b\n2. key\u76f8\u540c\u4f46type\u4e0d\u540c\u7684\u8282\u70b9\uff1b\n")),(0,l.kt)("h3",{id:"4-2-2-newchildren\u904d\u5386\u5b8c\u4e86\u4f46oldfiber\u8fd8\u6ca1\u904d\u5386\u5b8c"},"4-2-2 newChildren\u904d\u5386\u5b8c\u4e86\uff0c\u4f46oldFiber\u8fd8\u6ca1\u904d\u5386\u5b8c"),(0,l.kt)("p",null,"\u6211\u4eec\u518d\u6b21\u5047\u8bbe\u52a0\u5165\u5230newFiberList\u4e2d\u6240\u6709\u8282\u70b9\u90fd\u53ef\u4ee5\u662f\u53ef\u4ee5\u76f4\u63a5\u590d\u7528\u7684\uff0c\u8fd9\u6b21\u5c31\u548c\u6211\u4eec\u4e4b\u524d\u8ba8\u8bba\u8fc7\u7684\u5220\u9664\u8282\u70b9\u7684\u573a\u666f\u662f\u4e00\u81f4\u7684\u4e86"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},'//\u65e7\n<div key="a">a</div>\n<div key="b">b</div>\n<div key="c">c</div>\n\n//\u65b0\n<div key="a">a</div>\n')),(0,l.kt)("p",null,"\u6b64\u65f6newChildren\u8282\u70b9\u90fd\u5df2\u7ecf\u627e\u5230\u4e86\u53ef\u590d\u7528\u7684\u8282\u70b9\uff0c\u6211\u4eec\u9700\u8981\u904d\u5386\u5269\u4e0b\u7684oldFiber\uff0c\u5e76\u6807\u8bb0\u4e0aDeletion\u3002"),(0,l.kt)("h3",{id:"4-2-2-newchildren\u4e0eoldfiber\u90fd\u6ca1\u5b8c\u6210\u904d\u5386"},"4-2-2 newChildren\u4e0eoldFiber\u90fd\u6ca1\u5b8c\u6210\u904d\u5386"),(0,l.kt)("p",null,"\u8fd9\u610f\u5473\u7740\u8fd9\u6b21\u66f4\u65b0\u4e2d\u6709\u53ef\u80fd\u5b58\u5728\u8282\u70b9\u6539\u53d8\u4e86\u4f4d\u7f6e\u3002\u6211\u4eec\u4ee5\u524d\u9762\u63d0\u5230\u7684\u4f4d\u7f6e\u79fb\u52a8\u7684\u4f8b\u5b50\u6765\u8fdb\u884c\u5206\u6790\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},'//\u65e7\n<div key="a">a</div>\n<div key="b">b</div>\n<div key="c">c</div>\n<div key="e">e</div>\n\n//\u65b0\n<div key="a">a</div>\n<div key="c">c</div>\n<div key="b">b</div>\n<div key="e">e</div>\n')),(0,l.kt)("p",null,"\u7ecf\u8fc7\u7b2c\u4e00\u8f6e\u904d\u5386\u540e\uff0ckey\u503c\u4e3aa\u7684\u8282\u70b9\u590d\u7528oldFiber\u8282\u70b9\u751f\u6210newFiber\u8282\u70b9\uff0c\u5e76\u52a0\u5165\u5230\u4e86newFiberList\u4e2d\u3002\u5728\u8fdb\u884c\u7b2c\u4e8c\u4e2a\u8282\u70b9\u7684\u6bd4\u8f83\u65f6\uff0c\n\u65b0\u8282\u70b9c\u548c\u65e7\u8282\u70b9b\u7684key\u503c\u4e0d\u4e00\u81f4\uff0c\u6b64\u65f6\u6211\u4eec\u4f1a\u7ec8\u6b62\u7b2c\u4e00\u8f6e\u904d\u5386\uff0c\u8fdb\u5165\u7b2c\u4e8c\u8f6e\u904d\u5386\u3002\n\u7531\u4e8e\u53ef\u80fd\u5b58\u5728\u79fb\u52a8\u7684\u8282\u70b9\uff0c\u6240\u4ee5\u8282\u70b9\u7684\u7d22\u5f15\u503c\u4e0d\u80fd\u591f\u627e\u51fa\u4e24\u4e2a\u5bf9\u5e94\u7684\u8282\u70b9\uff0c\u6211\u4eec\u9700\u8981\u4e00\u4e2a\u627e\u5230\u65b0\u65e7\u8282\u70b9\u5bf9\u7684\u65b9\u6cd5\u3002\u8fd9\u65f6\uff0c\u8282\u70b9\u7684key\u503c\u5c31\u8d77\u4f5c\u7528\u4e86\u3002\n\u6211\u4eec\u524d\u9762\u63d0\u5230\uff1a"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"\u5f00\u53d1\u8005\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e key \u5c5e\u6027\uff0c\u6765\u544a\u77e5\u6e32\u67d3\u54ea\u4e9b\u5b50\u5143\u7d20\u5728\u4e0d\u540c\u7684\u6e32\u67d3\u4e0b\u53ef\u4ee5\u4fdd\u5b58\u4e0d\u53d8\uff1b")),(0,l.kt)("p",null,"React\u4f1a\u5c06\u8fd8\u672a\u5904\u7406\u7684oldFiber\u8282\u70b9\u5b58\u5165\u4ee5\u8282\u70b9key\u4e3akey\uff0coldFiber\u4e3avalue\u7684Map\u4e2d\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"//existingChildren \u662f\u4e00\u4e2a\u4ee5\u8282\u70b9key\u4e3akey\uff0coldFiber\u4e3avalue\u7684Map\nconst existingChildren = mapRemainingChildren(returnFiber, oldFiber);\n")),(0,l.kt)("p",null,"\u7136\u540e\u7ee7\u7eed\u904d\u5386newChildren\u5e8f\u5217\uff0c\u5e76\u901a\u8fc7newChildren\u8282\u70b9\u7684key\u6765\u67e5\u8be2existingChildren\u4e2d\u662f\u5426\u5b58\u5728key\u76f8\u540c\u7684oldFiber\u8282\u70b9\u3002"),(0,l.kt)("p",null,"\u63a5\u4e0b\u6765\u6211\u4eec\u9700\u8981\u901a\u8fc7\u7b2c\u4e8c\u8f6e\u904d\u5386\u53bb\u6807\u8bb0\u54ea\u4e9b\u8282\u70b9\u53ef\u4ee5\u590d\u7528\uff0c\u54ea\u4e9b\u8282\u70b9\u9700\u8981\u79fb\u52a8\u3002\u6b64\u65f6\u6211\u4eec\u9700\u8981\u4e00\u4e2a\u53c2\u7167\u7d22\u5f15\u6765\u5224\u65ad\u8282\u70b9\u662f\u5426\u9700\u8981\u79fb\u52a8\u3002"),(0,l.kt)("p",null,"\u6211\u4eec\u4ee5newFiberList\u4e2d\u6700\u9760\u53f3\u7684\u8282\u70b9\u5bf9\u5e94\u7684oldFiber\u5728oldFiber\u94fe\u8868\u4e2d\u7684\u4f4d\u7f6e\u7d22\u5f15oldIndex\u4f5c\u4e3a\u53c2\u7167\u7d22\u5f15\uff0c\u5e76\u4f7f\u7528lastPlacedIndex\u8868\u793a\u53c2\u7167\u7d22\u5f15\u3002"),(0,l.kt)("p",null,"\u4e0a\u9762\u5206\u6790\u7684\u4f8b\u5b50\u4e2d\uff0c\u5728\u7ed3\u675f\u7b2c\u4e00\u8f6e\u904d\u5386\u540e\uff0clastPlacedIndex\u5c31\u662fnewFiberList\u7684\u6700\u53f3\u4e00\u4e2a\u8282\u70b9a\u7684oldIndex\uff0c\u4e5f\u5c31\u662f0\u3002"),(0,l.kt)("h3",{id:"\u7136\u540e\u5f00\u59cb\u7b2c\u4e8c\u8f6e\u7684\u904d\u5386"},"\u7136\u540e\u5f00\u59cb\u7b2c\u4e8c\u8f6e\u7684\u904d\u5386"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"newChildren\u8282\u70b9c")),(0,l.kt)("p",null,"newChildren\u8282\u70b9c\u901a\u8fc7existingChildren\u67e5\u8be2\u5230\u4e86oldFiber\u8282\u70b9c\uff0c\u53d1\u73b0oldFiber\u8282\u70b9c\u7684\u7d22\u5f15oldIndex\u4e3a 2 \uff0c\u5927\u4e8elastPlacedIndex=0\u3002"),(0,l.kt)("p",null,"\u7531lastPlacedIndex\u7684\u5b9a\u4e49\u53ef\u77e5\uff0c\u82e5\u5f53\u524d\u7684oldIndex\u5927\u4e8elastPlacedIndex\uff0c\u610f\u5473\u7740oldFiber\u8282\u70b9c\u7684\u4f4d\u7f6e\u662f\u5728newFiberList\u7684\u6700\u53f3\u4e00\u4e2a\u8282\u70b9\u5bf9\u5e94\u7684\noldFiber\u8282\u70b9\u7684\u53f3\u8fb9\u3002\u540c\u65f6\uff0c\u7531\u4e8enewChildren\u5e8f\u5217\u662f\u6309\u987a\u5e8f\u904d\u5386\u7684\uff0c\u6240\u4ee5\u5f53\u524d\u7684newChildren\u751f\u6210\u7684newFiber\u8282\u70b9\u4e00\u5b9a\u662f\u5728newFiberList\u7684\u6700\u53f3\u4e00\u4e2a\u8282\u70b9\u5bf9\u5e94\u7684newFiber\u8282\u70b9\u7684\u53f3\u8fb9\u3002\u56e0\u6b64\uff0c\u8282\u70b9c\u66f4\u65b0\u524d\u540e\u7684\u4f4d\u7f6e\u6ca1\u6709\u53d1\u751f\u3002"),(0,l.kt)("p",null,"\u6b64\u65f6\uff0c\u56e0\u4e3a\u8282\u70b9c\u7684oldIndex > lastPlacedIndex\uff0c\u6240\u4ee5\u6211\u4eec\u628alastPlacedIndex\u7684\u503c\u66f4\u65b0\u4e3a\u8282\u70b9c\u7684oldIndex=2\u3002\u540c\u65f6\u628a\u8282\u70b9c\u751f\u6210\u7684newFiber\u52a0\u5165\u5230newFiberList\u4e2d\uff0c\u7ee7\u7eed\u904d\u5386\u3002"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"newChildren\u8282\u70b9b\nnewChildren\u8282\u70b9b\u901a\u8fc7existingChildren\u67e5\u8be2\u5230\u4e86oldFiber\u8282\u70b9b\uff0c\u53d1\u73b0oldFiber\u8282\u70b9b\u7684\u7d22\u5f15oldIndex\u4e3a 1\uff0c\u5c0f\u4e8elastPlacedIndex=2\u3002oldFiber\u8282\u70b9b\u7684\u4f4d\u7f6e\u662f\u5728newFiberList\u7684\u6700\u53f3\u4e00\u4e2a\u8282\u70b9\u5bf9\u5e94\u7684oldFiber\u8282\u70b9\u7684\u5de6\u8fb9\u3002\u4f46newChildren\u8282\u70b9b\u751f\u6210\u7684newFiber\u8282\u70b9\u4e00\u5b9a\u662f\u5728newFiberList\u7684\u6700\u53f3\u4e00\u4e2a\u8282\u70b9\u5bf9\u5e94\u7684newFiber\u8282\u70b9\u7684\u53f3\u8fb9\u7684\u3002\u56e0\u6b64\uff0c\u8282\u70b9b\u66f4\u65b0\u524d\u540e\u7684\u4f4d\u7f6e\u4f1a\u53d1\u751f\u53d8\u5316\u3002\n\u6b64\u65f6\uff0c\u56e0\u4e3a\u8282\u70b9b\u7684oldIndex < lastPlacedIndex\uff0c\u6240\u4ee5lastPlacedIndex\u4e0d\u53d8\uff0c\u5e76\u628a\u8282\u70b9b\u751f\u6210\u7684newFiber\u6807\u8bb0Placement\uff0c\u8868\u793a\u8be5\u8282\u70b9\u66f4\u65b0\u524d\u540e\u7684\u4f4d\u7f6e\u4f1a\u53d1\u751f\u53d8\u5316\uff0c\u6700\u540e\u628anewFiber\u52a0\u5165\u5230newFiberList\u4e2d\uff0c\u7ee7\u7eed\u904d\u5386\u3002")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"newChildren\u8282\u70b9d\nnewChildren\u8282\u70b9d\u901a\u8fc7existingChildren\u67e5\u8be2\u5230\u4e86oldFiber\u8282\u70b9d\uff0c\u53d1\u73b0oldFiber\u8282\u70b9d\u7684\u7d22\u5f15oldIndex\u4e3a 3 \uff0c\u5927\u4e8elastPlacedIndex=3\u3002 \u5904\u7406\u903b\u8f91\u4e0e\u8282\u70b9c\u4e00\u81f4\uff0c\u4e0d\u518d\u5c55\u5f00\u3002"))),(0,l.kt)("h3",{id:"diff\u5b8c\u6210\u6211\u4eec\u4e5f\u5f97\u5230\u4e86\u8be5\u5c42\u7ea7\u4e2d\u5b8c\u6574\u7684newfiberlist\u4f5c\u4e3aworkinprogress-fiber-tree\u5728\u8be5\u5c42\u7ea7\u7684fiber\u8282\u70b9"},"diff\u5b8c\u6210\uff0c\u6211\u4eec\u4e5f\u5f97\u5230\u4e86\u8be5\u5c42\u7ea7\u4e2d\u5b8c\u6574\u7684newFiberList\uff0c\u4f5c\u4e3aworkInProgress fiber tree\u5728\u8be5\u5c42\u7ea7\u7684fiber\u8282\u70b9\u3002"),(0,l.kt)("h2",{id:"reconcilechildrenarray\u7684\u5177\u4f53\u5b9e\u73b0"},"reconcileChildrenArray\u7684\u5177\u4f53\u5b9e\u73b0"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"  /* * returnFiber\uff1a\u5f53\u524d\u5c42\u7ea7\u7684\u8282\u70b9\u7684\u7236\u8282\u70b9\uff0c\u5373currentFirstChild\u7684\u7236\u7ea7fiber\u8282\u70b9\n     * currentFirstChild\uff1a\u5f53\u524d\u5c42\u7ea7\u7684\u7b2c\u4e00\u4e2acurrent fiber\u8282\u70b9\n     * newChildren\uff1a\u5f53\u524d\u5c42\u7ea7\u7684ReactElement\u8282\u70b9\n     * lanes\uff1a\u4f18\u5148\u7ea7\u76f8\u5173\n  * */\n  function reconcileChildrenArray(\n    returnFiber: Fiber,\n    currentFirstChild: Fiber | null,\n    newChildren: Array<*>,\n    lanes: Lanes,\n  ): Fiber | null {\n    //..\n\n    // workInProgress fiber tree\u5728\u6b64\u5c42\u7ea7\u7684\u7b2c\u4e00\u4e2afiber\u8282\u70b9\uff0c\u5373\u8be5\u5c42\u7ea7\u4e0a\u5728fiber.sibling\u65b9\u5411\u7684\u94fe\u8868\u7684\u5934\u8282\u70b9\uff0c\u5728\u4e0a\u9762\u7684\u5206\u6790\u4e2d\u6211\u4eec\u4f7f\u7528newFiberList\u6765\u8868\u793a\u6b64\u5e8f\u5217\n    let resultingFirstChild: Fiber | null = null;\n    // previousNewFiber\u7528\u6765\u5c06\u540e\u7eed\u7684\u65b0\u751f\u6210\u7684workInProgress fiber\u8fde\u63a5\u5230newFiberList\u4e2d\n    let previousNewFiber: Fiber | null = null;\n\n    // oldFiber\u8282\u70b9\uff0c\u7528\u4e8e\u8bbf\u95eeworkInProgress fiber tree\u5728\u6b64\u5c42\u7ea7\u4e0a\u5728fiber.sibling\u65b9\u5411\u7684\u94fe\u8868\n    let oldFiber = currentFirstChild;\n    // \u7528\u4e8e\u5b58\u50a8newFiberList\u4e2d\u6700\u53f3\u8fb9\u7684\u8282\u70b9\u5728oldFiber\u94fe\u8868\u4e2d\u7684index\n    let lastPlacedIndex = 0;\n    // \u5b58\u50a8\u904d\u5386\u5230newChildren\u7684\u7d22\u5f15\n    let newIdx = 0;\n    // \u5b58\u50a8\u5f53\u524doldFiber\u7684\u4e0b\u4e00\u4e2a\u8282\u70b9\n    let nextOldFiber = null;\n\n    // \u7b2c\u4e00\u8f6e\u904d\u5386\n    for (; oldFiber !== null && newIdx < newChildren.length; newIdx++) {\n      if (oldFiber.index > newIdx) {\n        nextOldFiber = oldFiber;\n        oldFiber = null;\n      } else {\n        nextOldFiber = oldFiber.sibling;\n      }\n\n       // \u5c1d\u8bd5\u751f\u6210\u65b0\u7684\u8282\u70b9\uff0c\u5982\u679ckey\u4e0d\u540c, \u8fd4\u56denull\uff0ckey\u76f8\u540c, \u518d\u6bd4\u8f83type\u662f\u5426\u4e00\u81f4\u3002type\u4e00\u81f4\u5219\u6267\u884cuseFiber(update\u903b\u8f91)\uff0ctype\u4e0d\u4e00\u81f4\u5219\u8fd0\u884ccreateXXX(insert\u903b\u8f91)\n      const newFiber = updateSlot(\n        returnFiber,\n        oldFiber,\n        newChildren[newIdx],\n        lanes,\n      );\n      if (newFiber === null) {\n      // newFiber\u4e3a null\u8bf4\u660e\u8282\u70b9\u4e0d\u53ef\u590d\u7528\uff0c\u4e2d\u65ad\u5f53\u524d\u904d\u5386\n        if (oldFiber === null) {\n          oldFiber = nextOldFiber;\n        }\n        break;\n      }\n      if (shouldTrackSideEffects) {\n      // shouldTrackSideEffects \u4e3atrue \u4ee3\u8868\u5f53\u524d\u4e3aupdate\u9636\u6bb5\n        if (oldFiber && newFiber.alternate === null) {\n          // \u6b64\u65f6\u4e3akey\u76f8\u540c\u4f46type\u4e0d\u540c\uff0cnewFiber.alternate\u4e3a\u7a7a\uff0c\u5220\u9664\u6389oldFiber\n          deleteChild(returnFiber, oldFiber);\n        }\n      }\n      \n      //\u66f4\u65b0\u8bb0\u5f55lastPlacedIndex\n      lastPlacedIndex = placeChild(newFiber, lastPlacedIndex, newIdx);\n\n      //\u5c06newFiber\u6dfb\u52a0\u5230newFiberList\u4e2d\n      if (previousNewFiber === null) {\n        resultingFirstChild = newFiber;\n      } else {\n        previousNewFiber.sibling = newFiber;\n      }\n      previousNewFiber = newFiber;\n      oldFiber = nextOldFiber;\n    }\n\n    if (newIdx === newChildren.length) {\n      // newChildren\u904d\u5386\u5b8c\u4e86\uff0c\u5220\u9664oldFiber\u94fe\u4e2d\u672a\u904d\u5386\u7684\u8282\u70b9\n      deleteRemainingChildren(returnFiber, oldFiber);\n     \n      //...\n      //\u7ed3\u675f\u6b64\u6b21diff\n      return resultingFirstChild;\n    }\n\n    if (oldFiber === null) {\n      // oldFiber\u904d\u5386\u5b8c\u4e86\uff0c\u65b0\u589enewChildren\u672a\u904d\u5386\u7684\u8282\u70b9\u5230newFiberList\u4e2d\n      for (; newIdx < newChildren.length; newIdx++) {\n        const newFiber = createChild(returnFiber, newChildren[newIdx], lanes);\n        if (newFiber === null) {\n          continue;\n        }\n        lastPlacedIndex = placeChild(newFiber, lastPlacedIndex, newIdx);\n        if (previousNewFiber === null) {\n          resultingFirstChild = newFiber;\n        } else {\n          previousNewFiber.sibling = newFiber;\n        }\n        previousNewFiber = newFiber;\n      }\n      //...\n      //\u7ed3\u675f\u672c\u6b21diff\n      return resultingFirstChild;\n    }\n\n    // newChildren\u548coldFiber\u90fd\u6ca1\u6709\u904d\u5386\u5b8c\uff0c\u5c06oldFiber\u5269\u4f59\u5e8f\u5217\u52a0\u5165\u5230\u4e00\u4e2amap\u4e2d\uff0c\u5728\u7b2c\u4e8c\u6b21\u904d\u5386\u7684\u8fc7\u7a0b\u4e2d\u80fd\u591f\u901a\u8fc7key\u503c\u627e\u5230\u5bf9\u5e94\u7684oldFiber\n    const existingChildren = mapRemainingChildren(returnFiber, oldFiber);\n\n    // \u7b2c\u4e8c\u8f6e\u904d\u5386\n    for (; newIdx < newChildren.length; newIdx++) {\n      const newFiber = updateFromMap(\n        existingChildren,\n        returnFiber,\n        newIdx,\n        newChildren[newIdx],\n        lanes,\n      );\n      if (newFiber !== null) {\n        if (shouldTrackSideEffects) {\n          if (newFiber.alternate !== null) {\n            // \u5982\u679cnewFiber\u662f\u901a\u8fc7\u590d\u7528\u521b\u5efa\u7684, \u5219\u6e05\u7406map\u4e2d\u5bf9\u5e94\u7684\u8001\u8282\u70b9\n            existingChildren.delete(\n              newFiber.key === null ? newIdx : newFiber.key,\n            );\n          }\n        }\n        // \u5224\u65ad\u5f53\u524d\u8282\u70b9\u662f\u5426\u9700\u8981\u6539\u53d8\u4f4d\u7f6e\uff0c\u5e76\u66f4\u65b0\u8bb0\u5f55lastPlacedIndex\n        lastPlacedIndex = placeChild(newFiber, lastPlacedIndex, newIdx);\n        // \u6dfb\u52a0newFiber\u5230newFiberList\u4e2d\n        if (previousNewFiber === null) {\n          resultingFirstChild = newFiber;\n        } else {\n          previousNewFiber.sibling = newFiber;\n        }\n        previousNewFiber = newFiber;\n      }\n    }\n\n    if (shouldTrackSideEffects) {\n      //\u5220\u9664\u672a\u904d\u5386\u7684oldFiber\n      existingChildren.forEach(child => deleteChild(returnFiber, child));\n    }\n\n    \n    //...\n\n    //\u7ed3\u675f\u672c\u6b21diff\n    return resultingFirstChild;\n  }\n\n  //\u6b64\u51fd\u6570\u7528\u4e8e\u8bb0\u5f55\u8282\u70b9\u5728\u6b64\u6b21\u66f4\u65b0\u4e2d\u662f\u5426\u9700\u8981\u79fb\u52a8\uff0c\u5e76\u8fd4\u56de\u65b0\u7684lastPlacedIndex \n  function placeChild(\n    newFiber: Fiber,\n    lastPlacedIndex: number,\n    newIndex: number,\n  ): number {\n    newFiber.index = newIndex;\n    \n    //...\n\n    const current = newFiber.alternate;\n    if (current !== null) {\n      const oldIndex = current.index;\n      if (oldIndex < lastPlacedIndex) {\n        // \u6b64\u8282\u70b9\u9700\u8981\u79fb\u52a8\n        newFiber.flags |= Placement;\n        return lastPlacedIndex;\n      } else {\n        // \u6b64\u8282\u70b9\u4e0d\u9700\u8981\u79fb\u52a8\uff0c\u8fd4\u56deoldIndex\u4f5c\u4e3alastPlacedIndex\u7684\u503c\n        return oldIndex;\n      }\n    } else {\n      // \u8fd9\u662f\u63d2\u5165\u7684\u903b\u8f91\n      newFiber.flags |= Placement;\n      return lastPlacedIndex;\n    }\n  }\n")))}b.isMDXComponent=!0},34887:(e,n,r)=>{r.d(n,{Z:()=>i});const i=r.p+"assets/images/diff\u6bd4\u8f83\u4f8b\u5b50-0fcddd9d946b6f6238563eb31f33782a.png"},97997:(e,n,r)=>{r.d(n,{Z:()=>i});const i=r.p+"assets/images/diff\u6df1\u5ea6\u904d\u5386-47c382bec14f06c3b43cd101ef9e7da0.png"}}]);