"use strict";(self.webpackChunkprogramming_technology=self.webpackChunkprogramming_technology||[]).push([[3352],{3905:(e,n,t)=>{t.d(n,{Zo:()=>i,kt:()=>h});var o=t(67294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);n&&(o=o.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,o)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,o,r=function(e,n){if(null==e)return{};var t,o,r={},a=Object.keys(e);for(o=0;o<a.length;o++)t=a[o],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(o=0;o<a.length;o++)t=a[o],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var p=o.createContext({}),c=function(e){var n=o.useContext(p),t=n;return e&&(t="function"==typeof e?e(n):s(s({},n),e)),t},i=function(e){var n=c(e.components);return o.createElement(p.Provider,{value:n},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var n=e.children;return o.createElement(o.Fragment,{},n)}},m=o.forwardRef((function(e,n){var t=e.components,r=e.mdxType,a=e.originalType,p=e.parentName,i=l(e,["components","mdxType","originalType","parentName"]),d=c(t),m=r,h=d["".concat(p,".").concat(m)]||d[m]||u[m]||a;return t?o.createElement(h,s(s({ref:n},i),{},{components:t})):o.createElement(h,s({ref:n},i))}));function h(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var a=t.length,s=new Array(a);s[0]=m;var l={};for(var p in n)hasOwnProperty.call(n,p)&&(l[p]=n[p]);l.originalType=e,l[d]="string"==typeof e?e:r,s[1]=l;for(var c=2;c<a;c++)s[c]=t[c];return o.createElement.apply(null,s)}return o.createElement.apply(null,t)}m.displayName="MDXCreateElement"},63277:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>p,contentTitle:()=>s,default:()=>u,frontMatter:()=>a,metadata:()=>l,toc:()=>c});var o=t(87462),r=(t(67294),t(3905));const a={},s=void 0,l={unversionedId:"Vue/render\u751f\u6210\u4e4b\u540e-vnode\u6784\u5efa",id:"Vue/render\u751f\u6210\u4e4b\u540e-vnode\u6784\u5efa",title:"render\u751f\u6210\u4e4b\u540e-vnode\u6784\u5efa",description:"\u901a\u8fc7 VNode\u63cf\u8ff0\u771f\u5b9e DOM,\u53ef\u4ee5\u6e32\u67d3\u51fa\u9875\u9762\u4e2d\u771f\u5b9e\u7684 DOM",source:"@site/programming-tech/Vue/21-render\u751f\u6210\u4e4b\u540e-vnode\u6784\u5efa.md",sourceDirName:"Vue",slug:"/Vue/render\u751f\u6210\u4e4b\u540e-vnode\u6784\u5efa",permalink:"/Vue/render\u751f\u6210\u4e4b\u540e-vnode\u6784\u5efa",draft:!1,editUrl:"https://github.com/huiruo/programming-tech-website/edit/main/programming-tech/Vue/21-render\u751f\u6210\u4e4b\u540e-vnode\u6784\u5efa.md",tags:[],version:"current",sidebarPosition:21,frontMatter:{},sidebar:"docs",previous:{title:"\u7f16\u8bd1AST-\u8f6c\u6362AST\u4e3arender",permalink:"/Vue/\u7f16\u8bd1AST-\u8f6c\u6362AST\u4e3arender"},next:{title:"VNode\u6784\u5efa\u4e4b\u540e-\u5f00\u59cb\u6e32\u67d3",permalink:"/Vue/VNode\u6784\u5efa\u4e4b\u540e-\u5f00\u59cb\u6e32\u67d3"}},p={},c=[{value:"\u901a\u8fc7 VNode\u63cf\u8ff0\u771f\u5b9e DOM,\u53ef\u4ee5\u6e32\u67d3\u51fa\u9875\u9762\u4e2d\u771f\u5b9e\u7684 DOM",id:"\u901a\u8fc7-vnode\u63cf\u8ff0\u771f\u5b9e-dom\u53ef\u4ee5\u6e32\u67d3\u51fa\u9875\u9762\u4e2d\u771f\u5b9e\u7684-dom",level:3},{value:"\u7ec4\u4ef6\u6302\u8f7d\u548c\u66f4\u65b0\u548cvnode\u7684\u5173\u7cfb",id:"\u7ec4\u4ef6\u6302\u8f7d\u548c\u66f4\u65b0\u548cvnode\u7684\u5173\u7cfb",level:2},{value:"\u7ec4\u4ef6\u7b2c\u4e00\u6b21\u6e32\u67d3\u65f6",id:"\u7ec4\u4ef6\u7b2c\u4e00\u6b21\u6e32\u67d3\u65f6",level:3},{value:"\u5f53\u7ec4\u4ef6\u4e2d\u7684\u72b6\u6001\u53d1\u751f\u4e86\u53d8\u5316\u65f6",id:"\u5f53\u7ec4\u4ef6\u4e2d\u7684\u72b6\u6001\u53d1\u751f\u4e86\u53d8\u5316\u65f6",level:3},{value:"\u7b2c\u4e00\u6b65createApp()--&gt;ensureRenderer()",id:"\u7b2c\u4e00\u6b65createapp--ensurerenderer",level:2},{value:"1.\u521b\u5efaapp\u5b9e\u4f8b\uff0c\u5e76\u8fd4\u56de\u8be5\u5b9e\u4f8b",id:"1\u521b\u5efaapp\u5b9e\u4f8b\u5e76\u8fd4\u56de\u8be5\u5b9e\u4f8b",level:3},{value:"2.\u91cd\u5199mount\u65b9\u6cd5",id:"2\u91cd\u5199mount\u65b9\u6cd5",level:3},{value:"\u7b2c\u4e8c\u6b65\uff1aensureRenderer()--&gt;baseCreateRenderer(),\u8fd9\u4e2a\u51fd\u6570\u975e\u5e38\u957f\uff0c\u5b9a\u4e49\u4e86\u5f88\u591a\u51fd\u6570",id:"\u7b2c\u4e8c\u6b65ensurerenderer--basecreaterenderer\u8fd9\u4e2a\u51fd\u6570\u975e\u5e38\u957f\u5b9a\u4e49\u4e86\u5f88\u591a\u51fd\u6570",level:2},{value:"2-1. \u4e0b\u9762\u5c55\u793a\u4e86baseCreateRenderer\u5b9a\u4e49\u7684\u51fd\u6570:patch render",id:"2-1-\u4e0b\u9762\u5c55\u793a\u4e86basecreaterenderer\u5b9a\u4e49\u7684\u51fd\u6570patch-render",level:3},{value:"2-2. \u4e0b\u9762\u5c55\u793a\u4e86baseCreateRenderer\u5b9a\u4e49\u7684\u51fd\u6570:processElement",id:"2-2-\u4e0b\u9762\u5c55\u793a\u4e86basecreaterenderer\u5b9a\u4e49\u7684\u51fd\u6570processelement",level:3},{value:"2-3. \u4e0b\u9762\u5c55\u793a\u4e86baseCreateRenderer\u5b9a\u4e49\u7684\u51fd\u6570:mountElement",id:"2-3-\u4e0b\u9762\u5c55\u793a\u4e86basecreaterenderer\u5b9a\u4e49\u7684\u51fd\u6570mountelement",level:3},{value:"2-4. \u4e0b\u9762\u5c55\u793a\u4e86baseCreateRenderer\u5b9a\u4e49\u7684\u51fd\u6570:processComponent",id:"2-4-\u4e0b\u9762\u5c55\u793a\u4e86basecreaterenderer\u5b9a\u4e49\u7684\u51fd\u6570processcomponent",level:3},{value:"2-5. \u4e0b\u9762\u5c55\u793a\u4e86baseCreateRenderer\u5b9a\u4e49\u7684\u51fd\u6570:mountComponent",id:"2-5-\u4e0b\u9762\u5c55\u793a\u4e86basecreaterenderer\u5b9a\u4e49\u7684\u51fd\u6570mountcomponent",level:3},{value:"2-6. \u4e0b\u9762\u5c55\u793a\u4e86baseCreateRenderer\u5b9a\u4e49\u7684\u51fd\u6570:setupRenderEffect",id:"2-6-\u4e0b\u9762\u5c55\u793a\u4e86basecreaterenderer\u5b9a\u4e49\u7684\u51fd\u6570setuprendereffect",level:3},{value:"\u7b2c\u4e09\u6b65. baseCreateRenderer return {render,createApp:createAppAPI(render, hydrate)}\u8c03\u7528createAppAPI(render, hydrate){return app}",id:"\u7b2c\u4e09\u6b65-basecreaterenderer-return-rendercreateappcreateappapirender-hydrate\u8c03\u7528createappapirender-hydratereturn-app",level:2},{value:"3-1. createAppAPI\u7684\u91cd\u70b9\u7684\u662fmount\u6302\u8f7d\u51fd\u6570,\u5728\u6302\u8f7d\u65f6\u671f\u4e3b\u8981\u505a\u4e86\u4e09\u4ef6\u4e8b\uff1a",id:"3-1-createappapi\u7684\u91cd\u70b9\u7684\u662fmount\u6302\u8f7d\u51fd\u6570\u5728\u6302\u8f7d\u65f6\u671f\u4e3b\u8981\u505a\u4e86\u4e09\u4ef6\u4e8b",level:3},{value:"3-2. mount() --&gt;createVNode()",id:"3-2-mount---createvnode",level:3},{value:"3-3. <code>_createVNode()</code>--&gt;createBaseVNode()",id:"3-3-_createvnode--createbasevnode",level:3},{value:"\u7b2c\u56db\u6b65. \u989d\u5916\u91cd\u70b9renderComponentRoot \u6267\u884c\u6784\u5efa\u51fa\u6765\u7684render() \u751f\u6210vnode",id:"\u7b2c\u56db\u6b65-\u989d\u5916\u91cd\u70b9rendercomponentroot-\u6267\u884c\u6784\u5efa\u51fa\u6765\u7684render-\u751f\u6210vnode",level:2},{value:"\u603b\u7ed3",id:"\u603b\u7ed3",level:3}],i={toc:c},d="wrapper";function u(e){let{components:n,...t}=e;return(0,r.kt)(d,(0,o.Z)({},i,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h3",{id:"\u901a\u8fc7-vnode\u63cf\u8ff0\u771f\u5b9e-dom\u53ef\u4ee5\u6e32\u67d3\u51fa\u9875\u9762\u4e2d\u771f\u5b9e\u7684-dom"},"\u901a\u8fc7 VNode\u63cf\u8ff0\u771f\u5b9e DOM,\u53ef\u4ee5\u6e32\u67d3\u51fa\u9875\u9762\u4e2d\u771f\u5b9e\u7684 DOM"),(0,r.kt)("p",null,"VNode \u662f\u901a\u8fc7\u7ec4\u4ef6\u7684 render \u51fd\u6570\u521b\u5efa\u51fa\u6765\u7684\uff0c\u6211\u4eec\u5e73\u65f6\u5728\u5f00\u53d1\u4e2d\uff0c\u4e00\u822c\u90fd\u662f\u4f7f\u7528 template \u5b57\u7b26\u4e32\u63cf\u8ff0\u9875\u9762\u5185\u5bb9\uff0c\u8fd9\u4e2a\u6a21\u677f\u5b57\u7b26\u4e32\u4f1a\u88ab Vue \u7684\u7f16\u8bd1\u5668\u7f16\u8bd1\u6210 render \u51fd\u6570(\u7528\u4e8e\u63cf\u8ff0\u7ec4\u4ef6\u6e32\u67d3\u5185\u5bb9\u7684\u662f render \u51fd\u6570)\uff0c",(0,r.kt)("inlineCode",{parentName:"p"},"\u5728Vue\u7684\u8fd0\u884c\u65f6\uff0crender\u51fd\u6570\u4f1a\u8f6c\u5316\u6210vnode\u3002")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("ol",{parentName:"li"},(0,r.kt)("li",{parentName:"ol"},"\u8de8\u5e73\u53f0"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("ol",{parentName:"li",start:2},(0,r.kt)("li",{parentName:"ol"},"\u6570\u636e\u9a71\u52a8\u89c6\u56fe\u63d0\u5347\u5f00\u53d1\u6548\u7387"))),(0,r.kt)("li",{parentName:"ul"},"\u5bf9\u4e8e\u9891\u7e41\u901a\u8fc7JavaScript\u64cd\u4f5cDOM\u7684\u573a\u666f\uff0cVNode\u6027\u80fd\u66f4\u4f18\uff0c\u56e0\u4e3a\u5b83\u4f1a\u7b49\u6536\u96c6\u5230\u8db3\u591f\u7684\u6539\u53d8\u65f6\uff0c\u518d\u5c06\u8fd9\u4e9b\u53d8\u5316\u4e00\u6b21\u6027\u5e94\u7528\u5230\u771f\u5b9e\u7684DOM\u4e0a\u3002")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"\u9891\u7e41\u7684\u53bb\u64cd\u4f5cdom\uff0c\u4f1a\u5bfc\u81f4\u9875\u9762\u5361\u987f\uff0c\u6027\u80fd\u5dee\uff0c\u5982\u4f55\u53bb\u51cf\u5c11dom\u64cd\u4f5c\u662f\u6027\u80fd\u4f18\u5316\u7684\u4e00\u4e2a\u5173\u952e\u70b9\u3002\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u7ec4\u4ef6\u6302\u8f7d\u548c\u66f4\u65b0\u548cvnode\u7684\u5173\u7cfb,diff\u7b97\u6cd5\u63d0\u5347\u6548\u7387")),(0,r.kt)("h2",{id:"\u7ec4\u4ef6\u6302\u8f7d\u548c\u66f4\u65b0\u548cvnode\u7684\u5173\u7cfb"},"\u7ec4\u4ef6\u6302\u8f7d\u548c\u66f4\u65b0\u548cvnode\u7684\u5173\u7cfb"),(0,r.kt)("h3",{id:"\u7ec4\u4ef6\u7b2c\u4e00\u6b21\u6e32\u67d3\u65f6"},"\u7ec4\u4ef6\u7b2c\u4e00\u6b21\u6e32\u67d3\u65f6"),(0,r.kt)("p",null,"\u9996\u5148\u9700\u8981\u901a\u8fc7\u7ec4\u4ef6\u7684 render \u51fd\u6570\u7ed3\u5408\u5f53\u524d\u7684\u72b6\u6001\u751f\u6210 vnode\uff0c\u7136\u540e\u901a\u8fc7 vnode \u521b\u5efa\u51fa\u5bf9\u5e94\u7684\u771f\u5b9eDOM \u8282\u70b9\uff0c\u6700\u540e\u628a\u521b\u5efa\u51fa\u6765\u7684DOM\u8282\u70b9\u8f93\u51fa\u5230\u9875\u9762\u4e2d\u3002"),(0,r.kt)("h3",{id:"\u5f53\u7ec4\u4ef6\u4e2d\u7684\u72b6\u6001\u53d1\u751f\u4e86\u53d8\u5316\u65f6"},"\u5f53\u7ec4\u4ef6\u4e2d\u7684\u72b6\u6001\u53d1\u751f\u4e86\u53d8\u5316\u65f6"),(0,r.kt)("p",null,"\u7ec4\u4ef6\u4fbf\u4f1a\u91cd\u65b0\u6e32\u67d3\uff0c\u4f7f\u7528\u7ec4\u4ef6\u7684 render \u51fd\u6570\u7ed3\u5408\u6700\u65b0\u7684\u72b6\u6001\u751f\u6210\u6700\u65b0\u7684 vnode\uff0c\u6ce8\u610f\uff0c\u8fd9\u4e00\u6b21 Vue \u4e0d\u4f1a\u76f4\u63a5\u4f7f\u7528\u65b0\u7684 vnode \u751f\u6210 DOM \u8282\u70b9\u8f93\u51fa\u5230\u9875\u9762\u4e0a\uff0c\u800c\u662f\u5c06\u672c\u6b21\u751f\u6210\u7684\u6700\u65b0\u7684 vnode \u548c\u4e0a\u4e00\u6b21\u6e32\u67d3\u4f7f\u7528\u7684 vnode \u8fdb\u884c\u6bd4\u8f83\uff08diff \u7b97\u6cd5\uff09;"),(0,r.kt)("p",null,"\u8ba1\u7b97\u51fa\u54ea\u4e9b\u8282\u70b9\u9700\u8981\u66f4\u65b0\uff0c\u7136\u540e\u5230\u9875\u9762\u4e2d\u53bb\u66f4\u65b0\u9700\u8981\u66f4\u65b0\u7684\u8282\u70b9\uff0c\u5176\u4ed6\u65e0\u9700\u66f4\u65b0\u7684\u8282\u70b9\u5219\u4e0d\u9700\u8981\u505a\u4efb\u4f55\u64cd\u4f5c\u3002\u901a\u8fc7\u8fd9\u79cd\u65b9\u5f0f\uff0c\u6bcf\u6b21\u7ec4\u4ef6\u91cd\u65b0\u6e32\u67d3\u7684\u65f6\u5019\uff0c\u90fd\u53ef\u4ee5\u4fdd\u8bc1\u5bf9\u771f\u5b9e DOM \u6700\u5c0f\u7684\u64cd\u4f5c\u91cf\uff0c\u4ee5\u6b64\u6765\u63d0\u9ad8\u6027\u80fd\u3002"),(0,r.kt)("h2",{id:"\u7b2c\u4e00\u6b65createapp--ensurerenderer"},"\u7b2c\u4e00\u6b65createApp()--\x3eensureRenderer()"),(0,r.kt)("p",null,"\u5f00\u53d1\u8c03\u7528\u7684\u662f\u8fd0\u884c\u65f6\u5305\u4e2d\u7684\u6784\u5efa\u51fd\u6570createApp\u5f00\u59cb:"),(0,r.kt)("h3",{id:"1\u521b\u5efaapp\u5b9e\u4f8b\u5e76\u8fd4\u56de\u8be5\u5b9e\u4f8b"},"1.\u521b\u5efaapp\u5b9e\u4f8b\uff0c\u5e76\u8fd4\u56de\u8be5\u5b9e\u4f8b"),(0,r.kt)("h3",{id:"2\u91cd\u5199mount\u65b9\u6cd5"},"2.\u91cd\u5199mount\u65b9\u6cd5"),(0,r.kt)("p",null,"\u8c03\u7528 ensureRenderer().createApp(...args) \u521b\u5efa\u4e00\u4e2a app \u5b9e\u4f8b\uff0c\u7136\u540e\u91cd\u5199 mount \u65b9\u6cd5\u6302\u8f7d\uff0c\u8fd4\u56de\u8fd9\u4e2a\u5b9e\u4f8b"),(0,r.kt)("p",null,"\u6d41\u7a0b\uff1a"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"\u6267\u884c createApp \u9996\u5148\u4f1a\u521b\u5efa\u6e32\u67d3\u5668\uff0c\u8fd9\u91cc\u8981\u6ce8\u610f\u7684\u662f\u5b58\u57282\u79cd\u6e32\u67d3\u5668\u7c7b\u578b\uff0c\u5e76\u4e14\u5b83\u4eec\u90fd\u662f\u901a\u8fc7\u5ef6\u8fdf\u521b\u5efa\u7684\uff0c\u4e3b\u8981\u76ee\u7684\u662f\u5f53\u7528\u6237\u53ea\u5f15\u7528reactive\u54cd\u5e94\u5f0f\u6846\u67b6\u7684\u65f6\u5019\uff0c\u65b9\u4fbf\u8fdb\u884ctree-shaking\u4f18\u5316\u3002\u4e14\u4e24\u79cd\u6e32\u67d3\u5668\u90fd\u662f\u57fa\u4e8e baseCreateRender \u65b9\u6cd5\u6765\u5b9e\u73b0\u3002")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"baseCreateRender \u51fd\u6570\u6267\u884c\u540e\u4f1a\u8fd4\u56de render \u6e32\u67d3\u51fd\u6570\u548c createApp \u65b9\u6cd5\uff0c\u5176\u4e2d render \u51fd\u6570\u662f\u7ec4\u4ef6\u521b\u5efa\u3001\u66f4\u65b0\u548c\u5378\u8f7d\u7684\u4e3b\u8981\u6838\u5fc3\u903b\u8f91\u5b9e\u73b0\u3002createApp\u5219\u7528\u4e8e\u521b\u5efa\u5e94\u7528\u5b9e\u4f8b\uff0c\u8fdb\u884c\u5e94\u7528\u5b9e\u4f8b\u7684\u521d\u59cb\u5316\u3002")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"createAppAPI\u7528\u4e8e\u751f\u6210\u9ed8\u8ba4\u7684\u5e94\u7528\u4e0a\u4e0b\u6587 context\uff0c\u8fd9\u91cc\u5b9a\u4e49\u4e86\u5e94\u7528\u5b9e\u4f8b\u5177\u5907\u7684\u5c5e\u6027\u548c\u65b9\u6cd5\uff0c\u5e76\u901a\u8fc7\u91cd\u5199\u6269\u5c55 context.app \u5c5e\u6027\uff0c\u8ba9\u7528\u6237\u80fd\u591f\u8fdb\u884c\u5bf9\u4e0a\u4e0b\u6587\u7684\u81ea\u5b9a\u4e49\u64cd\u4f5c\uff0c\u6bd4\u5982\u81ea\u5b9a\u4e49\u7ec4\u4ef6\u3001\u6307\u4ee4\u3001mixin\u3001\u63d2\u4ef6\u5b89\u88c5\u7b49\u4e00\u7cfb\u5217\u64cd\u4f5c\u3002\u5e76\u5b58\u5728mount\u65b9\u6cd5\u5b8c\u6210\u5c06\u6839\u7ec4\u4ef6\u8f6c\u4e3a\u865a\u62df\u8282\u70b9 vNode\uff0c\u5e76\u901a\u8fc7render \u51fd\u6570\u5b8c\u6210\u5bf9 vNode \u7684\u6e32\u67d3\u3002"))),(0,r.kt)("p",null,"ensureRenderer \u662f\u4e00\u4e2a\u5355\u4f8b\u6a21\u5f0f\u7684\u51fd\u6570\uff0c\u4f1a\u8fd4\u56de\u4e00\u4e2a renderer\uff0c\u5982\u679c\u65e0 renderer \u5219\u4f1a\u8c03\u7528createRenderer \u8fdb\u884c\u83b7\u53d6 renderer \uff0c\u83b7\u5f97\u4e86\u4e00\u4e2a app \u5b9e\u4f8b\u3002"),(0,r.kt)("h2",{id:"\u7b2c\u4e8c\u6b65ensurerenderer--basecreaterenderer\u8fd9\u4e2a\u51fd\u6570\u975e\u5e38\u957f\u5b9a\u4e49\u4e86\u5f88\u591a\u51fd\u6570"},"\u7b2c\u4e8c\u6b65\uff1aensureRenderer()--\x3ebaseCreateRenderer(),\u8fd9\u4e2a\u51fd\u6570\u975e\u5e38\u957f\uff0c\u5b9a\u4e49\u4e86\u5f88\u591a\u51fd\u6570"),(0,r.kt)("p",null,"baseCreateRenderer\u5305\u542b\u4e86\u7ec4\u4ef6\u6e32\u67d3\u7684\u6838\u5fc3\u903b\u8f91,\u4e3b\u8981\u5b9e\u73b0\u4e86\uff1a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u5b9e\u73b0\u4e86\u7ec4\u4ef6\u6e32\u67d3\u7684\u521b\u5efa\u3001\u66f4\u65b0\u3001\u5378\u8f7d\u7b49\u6838\u5fc3\u903b\u8f91"),(0,r.kt)("li",{parentName:"ul"},"\u8fd4\u56de\u6e32\u67d3\u51fd\u6570\uff0c\u4ee5\u53ca\u521b\u5efa\u5e94\u7528\u5b9e\u4f8b\u65b9\u6cd5\uff0c\u5f53\u7136\u8fd8\u6709 hydrate")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"ensureRenderer\u51fd\u6570\u8fd4\u56de\u5305\u542brender\u3001createApp\u548chydrate\u4e09\u4e2a\u51fd\u6570\u7684\u5355\u4f8b\u5bf9\u8c61\uff0c\u5176\u4e2dhydrate\u6c34\u5408\u51fd\u6570\u4e0essr\u6709\u5173\uff0ccreateApp\u9700\u8981\u4f7f\u7528\u5230render\u3001createApp\u3002\u6240\u4ee5\u5728\u89e3\u6790render\u4e4b\u524d\uff0c\u6211\u4eec\u5148\u7b80\u5355\u770b\u4e0bcreateAppAPI\u3002\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const createApp = ((...args) => {\n  console.log('%c\u8fd0\u884c\u65f6==>createApp\uff1a', 'color:yellow', ...args)\n  const app = ensureRenderer().createApp(...args);\n}\n\nconst render = ((...args) => {\n  console.log('\u8fd0\u884c\u65f6==>render\u8c03\u7528ensureRenderer().render(...args)')\n  ensureRenderer().render(...args);\n});\n\nfunction ensureRenderer() {\n  return (renderer ||\n    (renderer = createRenderer(rendererOptions)));\n}\n\nfunction createRenderer(options) {\n  return baseCreateRenderer(options);\n}\n")),(0,r.kt)("h3",{id:"2-1-\u4e0b\u9762\u5c55\u793a\u4e86basecreaterenderer\u5b9a\u4e49\u7684\u51fd\u6570patch-render"},"2-1. \u4e0b\u9762\u5c55\u793a\u4e86baseCreateRenderer\u5b9a\u4e49\u7684\u51fd\u6570:patch render"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u7ed3\u5c3ereturn createAppAPI(render, hydrate)")),(0,r.kt)("p",null,"\u7ec4\u4ef6\u6302\u8f7d\u548c\u66f4\u65b0\u7684\u903b\u8f91\u90fd\u5199\u5728\u6e32\u67d3\u5668\u4e2d patch"),(0,r.kt)("p",null,"\u4f1a\u6839\u636e VNode \u7c7b\u578b\u7684\u4e0d\u540c\u4f7f\u7528\u4e0d\u540c\u7684\u51fd\u6570\u8fdb\u884c\u5904\u7406\uff0c\u5982\u679c\u5f53\u524d\u7684 VNode \u8868\u793a\u7684\u662f\u7ec4\u4ef6\u7684\u8bdd\uff0c\u5219\u4f1a\u4f7f\u7528 processComponent \u51fd\u6570\u8fdb\u884c\u5904\u7406"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"\u89c1\uff1a\n## \u7b2c\u4e00\u6b65. patch \u9636\u6bb5: render()--\x3epatch()\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"function baseCreateRenderer(options, createHydrationFns) {\n  console.log('\u8fd0\u884c\u65f6==>baseCreateRenderer\uff1a', options, createHydrationFns)\n  const { insert: hostInsert, remove: hostRemove, patchProp: hostPatchProp, createElement: hostCreateElement, createText: hostCreateText, createComment: hostCreateComment, setText: hostSetText, setElementText: hostSetElementText, parentNode: hostParentNode, nextSibling: hostNextSibling, setScopeId: hostSetScopeId = NOOP, insertStaticContent: hostInsertStaticContent } = options;\n  // Note: functions inside this closure should use `const xxx = () => {}`\n  // style in order to prevent being inlined by minifiers.\n  const patch = (n1, n2, container, anchor = null, parentComponent = null, parentSuspense = null, isSVG = false, slotScopeIds = null, optimized = isHmrUpdating ? false : !!n2.dynamicChildren) => {\n    /*\n    n1,\u65e7\u8282\u70b9\n    n2,\u65b0\u8282\u70b9\n    container,DOM\u5bb9\u5668\uff0cvNode\u6e32\u67d3\u6210dom\u4f1a\u6302\u8f7d\u5230\u8be5\u8282\u70b9\u4e0b \n    */\n\n    // \u65b0\u65e7\u8282\u70b9\u662f\u540c\u4e00\u4e2a\u5bf9\u8c61\uff0c\u76f4\u63a5\u8fd4\u56de\n    if (n1 === n2) {\n      console.log(`%c\u8fd0\u884c\u65f6==>patch\uff1a\u65b0\u65e7\u8282\u70b9\u662f\u540c\u4e00\u4e2a\u5bf9\u8c61\uff0c\u76f4\u63a5\u8fd4\u56de:`, 'color:red')\n      return;\n    }\n    // patching & not same type, unmount old tree\n    // \u4e0d\u662f\u76f8\u540c\u7c7b\u578b\u7684\u8282\u70b9\uff0c\u76f4\u63a5\u5378\u8f7d\u65e7\u8282\u70b9\n    if (n1 && !isSameVNodeType(n1, n2)) {\n      anchor = getNextHostNode(n1);\n      unmount(n1, parentComponent, parentSuspense, true);\n      n1 = null;\n    }\n\n    // \u88ab\u6253\u8fc7BAIL\u7c7b\u578b\u6807\u8bb0\u7684\u8282\u70b9\u9000\u51fa\u4f18\u5316\u6a21\u5f0f\u3002\n    // \u6bd4\u5982\u975e\u7f16\u8bd1\u5668\u751f\u6210\uff0c\u800c\u662f\u624b\u52a8\u7f16\u5199\u7684\u6e32\u67d3\u51fd\u6570\uff0c\u8ba4\u4e3a\u603b\u662f\u65b0\u7684\uff0c\u65e0\u6cd5\u8fdb\u884c\u4f18\u5316\n    if (n2.patchFlag === -2 /* PatchFlags.BAIL */) {\n      optimized = false;\n      n2.dynamicChildren = null;\n    }\n\n    const { type, ref, shapeFlag } = n2;\n\n    console.log(`%c\u8fd0\u884c\u65f6==>patch\uff1a\u5f00\u542fpatch,n1\u4e3a\u65e7\u8282\u70b9\u3001n2\u4e3a\u65b0\u8282\u70b9:`, 'color:yellow')\n    // \u6839\u636evNode\u7c7b\u578b\uff0c\u6267\u884c\u4e0d\u540c\u7684\u7b97\u6cd5\n    switch (type) {\n      case Text:\n        console.log(`%c\u8fd0\u884c\u65f6==>patch\u5904\u7406\u6587\u672c\u8282\u70b9:`, 'color:red')\n        processText(n1, n2, container, anchor);\n        break;\n      case Comment:\n        console.log(`%c\u8fd0\u884c\u65f6==>patch\u5904\u7406\u6ce8\u91ca\u8282\u70b9:`, 'color:red')\n        processCommentNode(n1, n2, container, anchor);\n        break;\n      case Static:\n        console.log(`%c\u8fd0\u884c\u65f6==>patch\u5904\u7406\u9759\u6001\u8282\u70b9:`, 'color:red')\n        if (n1 == null) {\n          mountStaticNode(n2, container, anchor, isSVG);\n        }\n        else {\n          patchStaticNode(n1, n2, container, isSVG);\n        }\n        break;\n      case Fragment:\n        console.log(`%c\u8fd0\u884c\u65f6==>patch\u5904\u7406Fragment\u5143\u7d20:`, 'color:red')\n        processFragment(n1, n2, container, anchor, parentComponent, parentSuspense, isSVG, slotScopeIds, optimized);\n        break;\n      default:\n        if (shapeFlag & 1 /* ShapeFlags.ELEMENT */) {\n          console.log(`%c\u8fd0\u884c\u65f6==>patch--\x3e\u8f83\u4e3a\u91cd\u70b9\u76841:ELEMENT\u7c7b\u578b:\u8c03\u7528processElement\u5904\u7406DOM\u5143\u7d20:`, 'color:red')\n          processElement(n1, n2, container, anchor, parentComponent, parentSuspense, isSVG, slotScopeIds, optimized);\n        }\n        else if (shapeFlag & 6 /* ShapeFlags.COMPONENT */) {\n          console.log(`%c\u8fd0\u884c\u65f6==>patch--\x3e\u8f83\u4e3a\u91cd\u70b9\u76842:COMPONENT:\u8c03\u7528processComponent\u5904\u7406\u7ec4\u4ef6\u5143\u7d20:`, 'color:red')\n          processComponent(n1, n2, container, anchor, parentComponent, parentSuspense, isSVG, slotScopeIds, optimized);\n        }\n        else if (shapeFlag & 64 /* ShapeFlags.TELEPORT */) {\n          console.log(`%c\u8fd0\u884c\u65f6==>patch\u5904\u7406TELEPORT:`, 'color:red')\n          type.process(n1, n2, container, anchor, parentComponent, parentSuspense, isSVG, slotScopeIds, optimized, internals);\n        }\n        else if (shapeFlag & 128 /* ShapeFlags.SUSPENSE */) {\n          console.log(`%c\u8fd0\u884c\u65f6==>patch\u5904\u7406SUSPENSE:`, 'color:red')\n          type.process(n1, n2, container, anchor, parentComponent, parentSuspense, isSVG, slotScopeIds, optimized, internals);\n        }\n        else {\n          warn$1('Invalid VNode type:', type, `(${typeof type})`);\n        }\n    }\n    // set ref\n    if (ref != null && parentComponent) {\n      setRef(ref, n1 && n1.ref, parentSuspense, n2 || n1, !n2);\n    }\n  };\n  const render = (vnode, container, isSVG) => {\n    if (vnode == null) {\n      // \u6ca1\u6709\u4f20\u5165\u65b0\u7684\u865a\u62df\u8282\u70b9\uff0c\u5f53\u5b58\u5728\u65e7\u865a\u62df\u8282\u70b9\uff0c\u5219\u5378\u8f7d\u65e7\u865a\u62df\u8282\u70b9\n      if (container._vnode) {\n        console.log('%crender:--\x3e\u865a\u62df\u8282\u70b9\u4e0d\u5b58\u5728\uff0c\u5219\u9500\u6bc1', 'color:red', '')\n        unmount(container._vnode, null, null, true);\n      }\n    }\n    else {\n      // \u521b\u5efa\u3001\u6216\u8005\u66f4\u65b0\u8282\u70b9\uff0c\u521b\u5efa\u7684\u65f6\u5019\u8fd9\u91cccontainer._vnode\u662f\u4e0d\u5b58\u5728\u7684\n      // \u7b2c\u4e00\u4e2a\u53c2\u6570: \u65e7\u7684\u865a\u62df\u8282\u70b9\n      // \u7b2c\u4e8c\u4e2a\u53c2\u6570\uff1a\u65b0\u7684vnode\n      // \u7b2c\u4e09\u4e2a\u53c2\u6570\uff1avnode\u8f6c\u5316\u4e3adom\uff0c\u6700\u7ec8\u8981\u6302\u8f7d\u7684dom\u5bb9\u5668\n      console.log('%crender:--\x3e\u5b58\u5728\u65b0\u865a\u62df\u8282\u70b9\uff0c\u5219\u6267\u884cpatch\u7b97\u6cd5\uff0c\u6bd4\u8f83\u65b0\u65e7\u865a\u62df\u8282\u70b9,\u865a\u62df\u8282\u70b9\u5b58\u5728\uff0c\u521b\u5efa\u6216\u66f4\u65b0', 'color:red')\n      patch(container._vnode || null, vnode, container, null, null, null, isSVG);\n    }\n    flushPreFlushCbs();\n    flushPostFlushCbs();\n    // \u7f13\u5b58\u865a\u62df\u8282\u70b9\u6570\u636e\uff0c\u4f5c\u4e3a\u5df2\u5b8c\u6210\u6e32\u67d3\u7684\u6807\u8bc6,\u5bb9\u5668\u6307\u5411\u65b0\u7684\u865a\u62df\u7684\u8282\u70b9\n    container._vnode = vnode;\n  };\n  const internals = {\n    p: patch,\n    um: unmount,\n    m: move,\n    r: remove,\n    mt: mountComponent,\n    mc: mountChildren,\n    pc: patchChildren,\n    pbc: patchBlockChildren,\n    n: getNextHostNode,\n    o: options\n  };\n  let hydrate;\n  let hydrateNode;\n  if (createHydrationFns) {\n    [hydrate, hydrateNode] = createHydrationFns(internals);\n  }\n\n  console.log('\u8fd0\u884c\u65f6==>baseCreateRenderer\u8c03\u7528createAppAPI\uff1a')\n\n  return {\n    render,\n    hydrate,\n    createApp: createAppAPI(render, hydrate)\n  };\n}\n")),(0,r.kt)("h3",{id:"2-2-\u4e0b\u9762\u5c55\u793a\u4e86basecreaterenderer\u5b9a\u4e49\u7684\u51fd\u6570processelement"},"2-2. \u4e0b\u9762\u5c55\u793a\u4e86baseCreateRenderer\u5b9a\u4e49\u7684\u51fd\u6570:processElement"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"function baseCreateRenderer(options, createHydrationFns) {\n  const processElement = (n1, n2, container, anchor, parentComponent, parentSuspense, isSVG, slotScopeIds, optimized) => {\n    isSVG = isSVG || n2.type === 'svg';\n    if (n1 == null) {\n      console.log('%cpatch\u4e4bprocessElement1:\u6302\u8f7ddom\u5143\u7d20\u7684\u8fc7\u7a0b\uff0c\u8c03\u7528mountElement', 'color:magenta')\n      mountElement(n2, container, anchor, parentComponent, parentSuspense, isSVG, slotScopeIds, optimized);\n    }\n    else {\n      console.log('%cpatch\u4e4bprocessElement2:\u66f4\u65b0dom\u5143\u7d20\u7684\u8fc7\u7a0b\uff0c\u8c03\u7528patchElement', 'color:magenta')\n      patchElement(n1, n2, parentComponent, parentSuspense, isSVG, slotScopeIds, optimized);\n    }\n  };\n}\n")),(0,r.kt)("h3",{id:"2-3-\u4e0b\u9762\u5c55\u793a\u4e86basecreaterenderer\u5b9a\u4e49\u7684\u51fd\u6570mountelement"},"2-3. \u4e0b\u9762\u5c55\u793a\u4e86baseCreateRenderer\u5b9a\u4e49\u7684\u51fd\u6570:mountElement"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"function baseCreateRenderer(options, createHydrationFns) {\n  const mountElement = (vnode, container, anchor, parentComponent, parentSuspense, isSVG, slotScopeIds, optimized) => {\n    let el;\n    let vnodeHook;\n    const { type, props, shapeFlag, transition, dirs } = vnode;\n\n    el = vnode.el = hostCreateElement(vnode.type, isSVG, props && props.is, props);\n    console.log('%c\u6302\u8f7ddom\u5143\u7d20mountElement\u8c03\u7528hostCreateElement\u521b\u5efa\u65b0\u5143\u7d20', 'color:magenta', el)\n    // mount children first, since some props may rely on child content\n    // being already rendered, e.g. `<select value>`\n    if (shapeFlag & 8 /* ShapeFlags.TEXT_CHILDREN */) {\n      console.log('\u6302\u8f7ddom\u5143\u7d20mountElement:\u5904\u7406\u5b50\u8282\u70b9\u662f\u6587\u672c\u5185\u5bb9\u7684\u60c5\u51b5')\n      hostSetElementText(el, vnode.children);\n    }\n    else if (shapeFlag & 16 /* ShapeFlags.ARRAY_CHILDREN */) {\n      console.log('\u6302\u8f7ddom\u5143\u7d20mountElement:\u5904\u7406\u5b50\u8282\u70b9\u662f\u6570\u7ec4\u7684\u60c5\u51b5')\n      mountChildren(vnode.children, el, null, parentComponent, parentSuspense, isSVG && type !== 'foreignObject', slotScopeIds, optimized);\n    }\n    if (dirs) {\n      invokeDirectiveHook(vnode, null, parentComponent, 'created');\n    }\n    // props\n    if (props) {\n      console.log('\u6302\u8f7ddom\u5143\u7d20mountElement:\u5f53\u524d\u5143\u7d20el\u5904\u7406\u5c5e\u6027\u76f8\u5173\uff0c\u5982style/class/event\u7b49')\n      for (const key in props) {\n        if (key !== 'value' && !isReservedProp(key)) {\n          hostPatchProp(el, key, null, props[key], isSVG, vnode.children, parentComponent, parentSuspense, unmountChildren);\n        }\n      }\n      /**\n       * Special case for setting value on DOM elements:\n       * - it can be order-sensitive (e.g. should be set *after* min/max, #2325, #4024)\n       * - it needs to be forced (#1471)\n       * #2353 proposes adding another renderer option to configure this, but\n       * the properties affects are so finite it is worth special casing it\n       * here to reduce the complexity. (Special casing it also should not\n       * affect non-DOM renderers)\n       */\n      if ('value' in props) {\n        hostPatchProp(el, 'value', null, props.value);\n      }\n      if ((vnodeHook = props.onVnodeBeforeMount)) {\n        console.log('\u6302\u8f7ddom\u5143\u7d20mountElement:\u5904\u7406\u8282\u70b9\u6302\u8f7d\u524d\u7684\u94a9\u5b50\u51fd\u6570')\n        invokeVNodeHook(vnodeHook, parentComponent, vnode);\n      }\n    }\n    // scopeId\n    setScopeId(el, vnode, vnode.scopeId, slotScopeIds, parentComponent);\n    {\n      Object.defineProperty(el, '__vnode', {\n        value: vnode,\n        enumerable: false\n      });\n      Object.defineProperty(el, '__vueParentComponent', {\n        value: parentComponent,\n        enumerable: false\n      });\n    }\n    if (dirs) {\n      invokeDirectiveHook(vnode, null, parentComponent, 'beforeMount');\n    }\n    // #1583 For inside suspense + suspense not resolved case, enter hook should call when suspense resolved\n    // #1689 For inside suspense + suspense resolved case, just call it\n    const needCallTransitionHooks = (!parentSuspense || (parentSuspense && !parentSuspense.pendingBranch)) &&\n      transition &&\n      !transition.persisted;\n    if (needCallTransitionHooks) {\n      transition.beforeEnter(el);\n    }\n\n    console.log('%c\u6302\u8f7ddom\u5143\u7d20end==>mountElement\u8c03\u7528hostInsert\u628a\u5143\u7d20\u6302\u8f7d\u5230\u5bb9\u5668\u4e0a', 'color:magenta')\n    hostInsert(el, container, anchor);\n    if ((vnodeHook = props && props.onVnodeMounted) ||\n      needCallTransitionHooks ||\n      dirs) {\n      queuePostRenderEffect(() => {\n        vnodeHook && invokeVNodeHook(vnodeHook, parentComponent, vnode);\n        needCallTransitionHooks && transition.enter(el);\n        dirs && invokeDirectiveHook(vnode, null, parentComponent, 'mounted');\n      }, parentSuspense);\n    }\n  };\n}\n")),(0,r.kt)("h3",{id:"2-4-\u4e0b\u9762\u5c55\u793a\u4e86basecreaterenderer\u5b9a\u4e49\u7684\u51fd\u6570processcomponent"},"2-4. \u4e0b\u9762\u5c55\u793a\u4e86baseCreateRenderer\u5b9a\u4e49\u7684\u51fd\u6570:processComponent"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"function baseCreateRenderer(options, createHydrationFns) {\n  const processComponent = (n1, n2, container, anchor, parentComponent, parentSuspense, isSVG, slotScopeIds, optimized) => {\n    n2.slotScopeIds = slotScopeIds;\n    if (n1 == null) {\n      if (n2.shapeFlag & 512 /* ShapeFlags.COMPONENT_KEPT_ALIVE */) {\n        parentComponent.ctx.activate(n2, container, anchor, isSVG, optimized);\n      }\n      else {\n        console.log(`%cpath\u4e4bprocessComponent:1\u8c03\u7528mountComponent:`, 'color:magenta')\n        mountComponent(n2, container, anchor, parentComponent, parentSuspense, isSVG, optimized);\n      }\n    }\n    else {\n      console.log(`%cpath\u4e4bprocessComponent:2\u8c03\u7528updateComponent:`, 'color:magenta')\n      updateComponent(n1, n2, optimized);\n    }\n  };\n}\n")),(0,r.kt)("h3",{id:"2-5-\u4e0b\u9762\u5c55\u793a\u4e86basecreaterenderer\u5b9a\u4e49\u7684\u51fd\u6570mountcomponent"},"2-5. \u4e0b\u9762\u5c55\u793a\u4e86baseCreateRenderer\u5b9a\u4e49\u7684\u51fd\u6570:mountComponent"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"function baseCreateRenderer(options, createHydrationFns) {\n    const mountComponent = (initialVNode, container, anchor, parentComponent, parentSuspense, isSVG, optimized) => {\n      const instance = (initialVNode.component = createComponentInstance(initialVNode, parentComponent, parentSuspense));\n      console.log(`%c\u7ec4\u4ef6\u6302\u8f7d\uff1amountComponent:1\u8c03\u7528createComponentInstance\u521b\u5efa\u7ec4\u4ef6\u5b9e\u4f8b:`, 'color:magenta', instance)\n      if (instance.type.__hmrId) {\n        registerHMR(instance);\n      }\n      {\n        pushWarningContext(initialVNode);\n        startMeasure(instance, `mount`);\n      }\n      // inject renderer internals for keepAlive\n      // \u5c06keepAlive\u6ce8\u5165\u6e32\u67d3\u5668\u5185\u90e8\n      if (isKeepAlive(initialVNode)) {\n        instance.ctx.renderer = internals;\n      }\n      // resolve props and slots for setup context\n      {\n        {\n          startMeasure(instance, `init`);\n        }\n\n        console.log(`%c\u7ec4\u4ef6\u6302\u8f7d\uff1amountComponent:2\u8c03\u7528setupComponent\u8bbe\u7f6e\u7ec4\u4ef6\u5b9e\u4f8b:`, 'color:magenta')\n        console.log('test:\u5b9a\u4e49\u5728data\u7684\u54cd\u5e94\u5f0fstart==>mountComponent\u8c03\u7528setupComponent')\n        setupComponent(instance);\n        {\n          endMeasure(instance, `init`);\n        }\n      }\n      // setup() is async. This component relies on async logic to be resolved\n      // before proceeding\n      if (instance.asyncDep) {\n        parentSuspense && parentSuspense.registerDep(instance, setupRenderEffect);\n        // Give it a placeholder if this is not hydration\n        // TODO handle self-defined fallback\n        if (!initialVNode.el) {\n          const placeholder = (instance.subTree = createVNode(Comment));\n          processCommentNode(null, placeholder, container, anchor);\n        }\n        return;\n      }\n      console.log(`%c\u7ec4\u4ef6\u6302\u8f7d\uff1a==end mountComponent:3\u8c03\u7528setupRenderEffect \u6267\u884c\u5e26\u526f\u4f5c\u7528\u7684\u6e32\u67d3\u51fd\u6570setupRenderEffect:`, 'color:magenta')\n      setupRenderEffect(instance, initialVNode, container, anchor, parentSuspense, isSVG, optimized);\n      {\n        popWarningContext();\n        endMeasure(instance, `mount`);\n      }\n    };\n}\n")),(0,r.kt)("h3",{id:"2-6-\u4e0b\u9762\u5c55\u793a\u4e86basecreaterenderer\u5b9a\u4e49\u7684\u51fd\u6570setuprendereffect"},"2-6. \u4e0b\u9762\u5c55\u793a\u4e86baseCreateRenderer\u5b9a\u4e49\u7684\u51fd\u6570:setupRenderEffect"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"function baseCreateRenderer(options, createHydrationFns) {\n  const setupRenderEffect = (instance, initialVNode, container, anchor, parentSuspense, isSVG, optimized) => {\n    const componentUpdateFn = () => {\n      console.log('effect.run==>:\u8c03\u7528componentUpdateFn\u7ec4\u4ef6\u7684\u521d\u59cb\u6302\u8f7d\u548c\u66f4\u65b0')\n      if (!instance.isMounted) {\n        console.log('effect.run==>:componentUpdateFn\u4e4bMounte')\n        let vnodeHook;\n        const { el, props } = initialVNode;\n        const { bm, m, parent } = instance;\n        const isAsyncWrapperVNode = isAsyncWrapper(initialVNode);\n        toggleRecurse(instance, false);\n        // beforeMount hook\n        if (bm) {\n          console.log('effect.run==>:\u751f\u547d\u5468\u671fbeforeMount')\n          invokeArrayFns(bm);\n        }\n        // onVnodeBeforeMount\n        if (!isAsyncWrapperVNode &&\n          (vnodeHook = props && props.onVnodeBeforeMount)) {\n          console.log('effect.run==>:\u751f\u547d\u5468\u671fonVnodeBeforeMount')\n          invokeVNodeHook(vnodeHook, parent, initialVNode);\n        }\n        toggleRecurse(instance, true);\n        if (el && hydrateNode) {\n          // vnode has adopted host node - perform hydration instead of mount.\n          const hydrateSubTree = () => {\n            {\n              startMeasure(instance, `render`);\n            }\n            console.log(\"effect.run==>:setupRenderEffect:1\u7ec4\u4ef6\u5b9e\u4f8b\u751f\u6210\u5b50\u6811vnode\")\n            instance.subTree = renderComponentRoot(instance);\n            {\n              endMeasure(instance, `render`);\n            }\n            {\n              startMeasure(instance, `hydrate`);\n            }\n            hydrateNode(el, instance.subTree, instance, parentSuspense, null);\n            {\n              endMeasure(instance, `hydrate`);\n            }\n          };\n          if (isAsyncWrapperVNode) {\n            initialVNode.type.__asyncLoader().then(\n              // note: we are moving the render call into an async callback,\n              // which means it won't track dependencies - but it's ok because\n              // a server-rendered async wrapper is already in resolved state\n              // and it will never need to change.\n              () => !instance.isUnmounted && hydrateSubTree());\n          }\n          else {\n            hydrateSubTree();\n          }\n        }\n        else {\n          {\n            startMeasure(instance, `render`);\n          }\n          console.log('$ceffect.run==>\u6267\u884crenderComponentRoot\uff0c\u83b7\u53d6\u7ec4\u4ef6\u5f53\u524d\u7684 VNode,render\u4f1a\u8bfb\u53d6\u7ec4\u4ef6\u7684\u54cd\u5e94\u5f0f\u6570\u636e\uff0c\u8fd9\u4f1a\u89e6\u53d1\u4f9d\u8d56\u6536\u96c6', 'color:chartreuse')\n          const subTree = (instance.subTree = renderComponentRoot(instance));\n          {\n            endMeasure(instance, `render`);\n          }\n          {\n            startMeasure(instance, `patch`);\n          }\n          console.log(\"effect.run==>\u8c03\u7528patch\u8fdb\u884c\u7ec4\u4ef6\u5185\u5bb9\u7684\u6e32\u67d3,\u628a\u5b50\u6811\u6302\u8f7d\u5230container\u4e0a\")\n          patch(null, subTree, container, anchor, instance, parentSuspense, isSVG);\n          {\n            endMeasure(instance, `patch`);\n          }\n          initialVNode.el = subTree.el;\n        }\n        // mounted hook\n        if (m) {\n          console.log('effect.run==>:\u751f\u547d\u5468\u671fmounted')\n          queuePostRenderEffect(m, parentSuspense);\n        }\n        // onVnodeMounted\n        if (!isAsyncWrapperVNode &&\n          (vnodeHook = props && props.onVnodeMounted)) {\n          const scopedInitialVNode = initialVNode;\n          queuePostRenderEffect(() => invokeVNodeHook(vnodeHook, parent, scopedInitialVNode), parentSuspense);\n        }\n        // activated hook for keep-alive roots.\n        // #1742 activated hook must be accessed after first render\n        // since the hook may be injected by a child keep-alive\n        if (initialVNode.shapeFlag & 256 /* ShapeFlags.COMPONENT_SHOULD_KEEP_ALIVE */ ||\n          (parent &&\n            isAsyncWrapper(parent.vnode) &&\n            parent.vnode.shapeFlag & 256 /* ShapeFlags.COMPONENT_SHOULD_KEEP_ALIVE */)) {\n          instance.a && queuePostRenderEffect(instance.a, parentSuspense);\n        }\n        console.log(\"%ceffect.run==>\u5c06\u7ec4\u4ef6\u5b9e\u4f8b\u7684 isMounted \u5c5e\u6027\u8bbe\u4e3a true\uff0c\u8868\u660e\u5f53\u524d\u7684\u7ec4\u4ef6\u5df2\u7ecf\u5b8c\u6210\u4e86\u6302\u8f7d\u64cd\u4f5c\", 'color:red')\n        instance.isMounted = true;\n        {\n          devtoolsComponentAdded(instance);\n        }\n        // #2458: deference mount-only object parameters to prevent memleaks\n        initialVNode = container = anchor = null;\n      }\n      else {\n        console.log('effect.run==>:componentUpdateFn\u4e4bupdateComponent')\n        // updateComponent\n        // This is triggered by mutation of component's own state (next: null)\n        // OR parent calling processComponent (next: VNode)\n        let { next, bu, u, parent, vnode } = instance;\n        let originNext = next;\n        let vnodeHook;\n        {\n          pushWarningContext(next || instance.vnode);\n        }\n        // Disallow component effect recursion during pre-lifecycle hooks.\n        toggleRecurse(instance, false);\n        if (next) {\n          next.el = vnode.el;\n          updateComponentPreRender(instance, next, optimized);\n        }\n        else {\n          next = vnode;\n        }\n        // beforeUpdate hook\n        if (bu) {\n          console.log('effect.run==>:\u751f\u547d\u5468\u671fbeforeUpdate')\n          invokeArrayFns(bu);\n        }\n        // onVnodeBeforeUpdate\n        if ((vnodeHook = next.props && next.props.onVnodeBeforeUpdate)) {\n          invokeVNodeHook(vnodeHook, parent, next, vnode);\n        }\n        toggleRecurse(instance, true);\n        // render\n        {\n          startMeasure(instance, `render`);\n        }\n        console.log('$ceffect.run==>\u6267\u884crenderComponentRoot\uff0c\u83b7\u53d6\u7ec4\u4ef6\u6700\u65b0\u7684 VNode,render\u4f1a\u8bfb\u53d6\u7ec4\u4ef6\u7684\u54cd\u5e94\u5f0f\u6570\u636e\uff0c\u8fd9\u4f1a\u89e6\u53d1\u4f9d\u8d56\u6536\u96c6', 'color:chartreuse')\n        const nextTree = renderComponentRoot(instance);\n        {\n          endMeasure(instance, `render`);\n        }\n        // \u83b7\u53d6\u7ec4\u4ef6\u4e0a\u6b21\u6e32\u67d3\u7684 VNode\n        const prevTree = instance.subTree;\n        instance.subTree = nextTree;\n        {\n          startMeasure(instance, `patch`);\n        }\n        console.log('effect.run==>:componentUpdateFn\u4e4bupdateComponent\u8c03\u7528patch \u51fd\u6570\u8fdb\u884c\u7ec4\u4ef6\u7684\u66f4\u65b0')\n        patch(prevTree, nextTree,\n          // parent may have changed if it's in a teleport\n          hostParentNode(prevTree.el),\n          // anchor may have changed if it's in a fragment\n          getNextHostNode(prevTree), instance, parentSuspense, isSVG);\n        {\n          endMeasure(instance, `patch`);\n        }\n        next.el = nextTree.el;\n        if (originNext === null) {\n          // self-triggered update. In case of HOC, update parent component\n          // vnode el. HOC is indicated by parent instance's subTree pointing\n          // to child component's vnode\n          updateHOCHostEl(instance, nextTree.el);\n        }\n        // updated hook\n        if (u) {\n          console.log('effect.run==>:\u751f\u547d\u5468\u671fupdated')\n          queuePostRenderEffect(u, parentSuspense);\n        }\n        // onVnodeUpdated\n        if ((vnodeHook = next.props && next.props.onVnodeUpdated)) {\n          console.log('effect.run==>:\u751f\u547d\u5468\u671fonVnodeUpdated')\n          queuePostRenderEffect(() => invokeVNodeHook(vnodeHook, parent, next, vnode), parentSuspense);\n        }\n        {\n          devtoolsComponentUpdated(instance);\n        }\n        {\n          popWarningContext();\n        }\n      }\n    };\n    // create reactive effect for rendering\n    console.log('\u4f9d\u8d56\u6536\u96c6==>setupRenderEffect:3\u8c03\u7528ReactiveEffect \u521b\u5efa\u4e00\u4e2a\u526f\u4f5c\u7528:', { componentUpdateFn })\n    const effect = (instance.effect = new ReactiveEffect(componentUpdateFn, () => queueJob(update), instance.scope // track it in component's effect scope\n    ));\n    console.log('\u4f9d\u8d56\u6536\u96c6==>a,\u5173\u952e\uff1a\u8c03\u7528effect.run()\u4e3a\u4e86\u89e6\u53d1\u4e00\u4e0b\u4f9d\u8d56\u6536\u96c6')\n    const update = (instance.update = () => effect.run());\n    update.id = instance.uid;\n    // allowRecurse\n    // #1801, #2043 component render effects should allow recursive updates\n    toggleRecurse(instance, true);\n    {\n      effect.onTrack = instance.rtc\n        ? e => invokeArrayFns(instance.rtc, e)\n        : void 0;\n      effect.onTrigger = instance.rtg\n        ? e => invokeArrayFns(instance.rtg, e)\n        : void 0;\n      update.ownerInstance = instance;\n    }\n    update();\n  };\n}\n")),(0,r.kt)("h2",{id:"\u7b2c\u4e09\u6b65-basecreaterenderer-return-rendercreateappcreateappapirender-hydrate\u8c03\u7528createappapirender-hydratereturn-app"},"\u7b2c\u4e09\u6b65. baseCreateRenderer return {render,createApp:createAppAPI(render, hydrate)}\u8c03\u7528createAppAPI(render, hydrate){return app}"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"\u521b\u5efa\u5b9e\u4f8b:createAppAPI() \u8c03\u7528\u4e86mount() render()")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"\u521b\u5efa\u5b9a\u4e49\u4e00\u4e2a\u5b9e\u4f8b\u4e0a\u4e0b\u6587context\uff0c\u5305\u542b\u5c5e\u6027\u548c\u65b9\u6cd5")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"\u91cd\u5199\u6269\u5c55context.app\u65b9\u6cd5\uff0c\u5b9e\u73b0\u7528\u6237\u53ef\u4ee5\u5bf9\u4e0a\u4e0b\u6587\u76f8\u5173\u5c5e\u6027\u7684\u81ea\u5b9a\u4e49\u64cd\u4f5c\uff0c\u4e5f\u5c31\u662f\u5e94\u7528\u5b9e\u4f8b\u66b4\u9732\u7684api\u5b9e\u73b0\uff0c\u6bd4\u5982\u81ea\u5b9a\u4e49\u6307\u4ee4\u3001\u6df7\u5165mixin\u3001\u7ec4\u4ef6\u7b49\u63d0\u4f9b\u7528\u6237\u81ea\u5b9a\u4e49\u5b9e\u73b0\u3002")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"\u6839\u636e\u6839\u7ec4\u4ef6\u548c\u5c5e\u6027\u5728 mount \u65b9\u6cd5\u4e2d\u5b8c\u6210\u865a\u62df\u8282\u70b9 vNode \u7684\u8f6c\u6362\uff0c\u5e76\u901a\u8fc7 render \u5b8c\u6210\u6e32\u67d3\uff0c\u5173\u4e8e\u6e32\u67d3\u51fd\u6570\u5728 baseCreateRender \u5df2\u7ecf\u8bf4\u8fc7\u3002"))),(0,r.kt)("h3",{id:"3-1-createappapi\u7684\u91cd\u70b9\u7684\u662fmount\u6302\u8f7d\u51fd\u6570\u5728\u6302\u8f7d\u65f6\u671f\u4e3b\u8981\u505a\u4e86\u4e09\u4ef6\u4e8b"},"3-1. createAppAPI\u7684\u91cd\u70b9\u7684\u662fmount\u6302\u8f7d\u51fd\u6570,\u5728\u6302\u8f7d\u65f6\u671f\u4e3b\u8981\u505a\u4e86\u4e09\u4ef6\u4e8b\uff1a"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"\u57fa\u4e8ecreateApp\u7684\u53c2\u6570\u521b\u5efa\u865a\u62df\u8282\u70b9\u3002"),(0,r.kt)("li",{parentName:"ol"},"\u57fa\u4e8e\u865a\u62df\u8282\u70b9\u548c\u5bb9\u5668\u5143\u7d20\u8fdb\u884c\u8fdb\u884c\u6e32\u67d3\u3002"),(0,r.kt)("li",{parentName:"ol"},"\u6700\u540e\u8fd4\u56de\u865a\u62df\u8282\u70b9component\u5c5e\u6027\u7684\u4ee3\u7406\u5bf9\u8c61\uff0c\u4e3b\u8981\u4f7f\u6839\u5b9e\u4f8b\u53ef\u4ee5\u53d6\u5f97\u6240\u6709\u5c5e\u6027\u6210\u5458\uff0c\u6bd4\u5982refs\u7b49\uff0c\u987e\u4e0d\u5177\u4f53\u8bb2\u89e3\u3002")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"function createAppAPI(render, hydrate) {\n  return function createApp(rootComponent, rootProps = null) {\n    if (!isFunction(rootComponent)) {\n      rootComponent = Object.assign({}, rootComponent);\n    }\n    // ...\n    ...\n    // ...\n    directive(name, directive) {\n      {\n        validateDirectiveName(name);\n      }\n      if (!directive) {\n        return context.directives[name];\n      }\n      if (context.directives[name]) {\n        warn$1(`Directive \"${name}\" has already been registered in target app.`);\n      }\n      context.directives[name] = directive;\n      return app;\n    },\n    mount(rootContainer, isHydrate, isSVG) {\n      // \u672a\u6302\u8f7d\u6267\u884c\n      if (!isMounted) {\n        // #5571\n        if (rootContainer.__vue_app__) {\n          warn$1(`There is already an app instance mounted on the host container.\\n` +\n            ` If you want to mount another app on the same host container,` +\n            ` you need to unmount the previous app by calling \\`app.unmount()\\` first.`);\n        }\n        // \u6839\u636e\u6839\u7ec4\u4ef6\u521b\u5efa\u865a\u62df\u8282\u70b9\n        console.log('%c\u8fd0\u884c\u65f6==>createAppAPI--\u672a\u6302\u8f7d\u6267\u884c,\u521b\u5efa\u6839\u865a\u62df\u8282\u70b9,mount\u4e2d\u8c03\u7528createVNode:\u6839\u636e\u6839\u7ec4\u4ef6\u521b\u5efa\u865a\u62df\u8282\u70b9\uff1a', 'color:yellow')\n        const vnode = createVNode(rootComponent, rootProps);\n        console.log('%c\u8fd0\u884c\u65f6==>createAppAPI--\u672a\u6302\u8f7d\u6267\u884c,\u6839\u636e\u6839\u7ec4\u4ef6\u521b\u5efa\u865a\u62df\u8282\u70b9vnode\u7ed3\u679c\uff1a', 'color:yellow', vnode)\n        // store app context on the root VNode.\n        // this will be set on the root instance on initial mount.\n        // \u5c06app\u7684\u4e0a\u4e0b\u6587\u5b58\u50a8\u5728\u6839\u865a\u62df\u8282\u70b9\n        vnode.appContext = context;\n        // HMR root reload\n        {\n          context.reload = () => {\n            render(cloneVNode(vnode), rootContainer, isSVG);\n          };\n        }\n        // \u6c34\u5408\u6216\u8005\u6e32\u67d3\u865a\u62df\u8282\u70b9\n        if (isHydrate && hydrate) {\n          hydrate(vnode, rootContainer);\n        }\n        else {\n          console.log('%c\u8fd0\u884c\u65f6==>createAppAPI--mount\u4e2d\u8c03\u7528render:\u6e32\u67d3\u865a\u62df\u8282\u70b9\uff1a', 'color:red')\n          render(vnode, rootContainer, isSVG);\n        }\n        // \u8bbe\u7f6eisMounted,\u8bbe\u7f6eapp\u5bb9\u5668\n        isMounted = true;\n        app._container = rootContainer;\n        rootContainer.__vue_app__ = app;\n        {\n          app._instance = vnode.component;\n          devtoolsInitApp(app, version);\n        }\n        return getExposeProxy(vnode.component) || vnode.component.proxy;\n      }\n      else {\n        warn$1(`App has already been mounted.\\n` +\n          `If you want to remount the same app, move your app creation logic ` +\n          `into a factory function and create fresh app instances for each ` +\n          `mount - e.g. \\`const createMyApp = () => createApp(App)\\``);\n      }\n    },\n\n    // ... \n    ...\n    // ... \n    return app;\n  };\n}\n")),(0,r.kt)("h3",{id:"3-2-mount---createvnode"},"3-2. mount() --\x3ecreateVNode()"),(0,r.kt)("p",null,"type \u5c5e\u6027\u7528\u4e8e\u63cf\u8ff0 VNode \u7684\u7c7b\u578b\uff0cVNode \u7684\u7c7b\u578b\u6709\u5f88\u591a\u79cd\uff0c\u8fd9\u91cc\u6211\u4eec\u770b\u4e0b string \u548c Component \u7c7b\u578b\uff0c\u5f53 VNode \u7684 type \u5c5e\u6027\u662f\u5b57\u7b26\u4e32\u7684\u65f6\u5019\uff0c\u8bf4\u660e\u5f53\u524d\u7684 VNode \u63cf\u8ff0\u7684\u662f\u666e\u901a\u7684\u5143\u7d20\uff0c\u5f53 VNode \u7684 type \u662f Component \u7684\u65f6\u5019\uff0c\u8bf4\u660e\u5f53\u524d\u7684 VNode \u63cf\u8ff0\u7684\u662f\u4e00\u4e2a\u7ec4\u4ef6\u3002"),(0,r.kt)("p",null,"\u5728\u521b\u5efa\u865a\u62df\u8282\u70b9\u65f6\uff0c\u4f1a\u8fdb\u884c\u4e00\u4e9b\u7c7b\u578b\u68c0\u67e5\u3001\u6b63\u89c4\u5316\u3001\u514b\u9686\u3001\u5757\u6811\u8282\u70b9\u8ffd\u8e2a\u3001\u517c\u5bb9Vue2\u7b49\u64cd\u4f5c\u3002\u6700\u540e\u53ea\u662f\u5355\u7eaf\u5730\u8fd4\u56de\u4e86\u4e00\u4e2a\u865a\u62df\u8282\u70b9\u5bf9\u8c61\u3002\u603b\u7ed3\uff0ccreateVNode\u505a\u4e86\u5982\u4e0b\u51e0\u4ef6\u4e8b\uff1a"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"\u5bf9\u5c5e\u6027props\u6807\u51c6\u5316"),(0,r.kt)("li",{parentName:"ol"},"\u5c06VNode\u7c7b\u578b\u4fe1\u606f\u8fdb\u884c\u7f16\u7801\u4e3a\u4f4d\u56fe"),(0,r.kt)("li",{parentName:"ol"},"\u521b\u5efaVNode\u5bf9\u8c61"),(0,r.kt)("li",{parentName:"ol"},"\u5bf9\u5b50\u8282\u70b9\u8fdb\u884c\u6807\u51c6\u5316")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const createVNode = (createVNodeWithArgsTransform);\n\nconst createVNodeWithArgsTransform = (...args) => {\n  return _createVNode(...(vnodeArgsTransformer\n    ? vnodeArgsTransformer(args, currentRenderingInstance)\n    : args));\n};\n\nfunction _createVNode(type, props = null, children = null, patchFlag = 0, dynamicProps = null, isBlockNode = false) {\n  if (!type || type === NULL_DYNAMIC_COMPONENT) {\n    if (!type) {\n      warn$1(`Invalid vnode type when creating vnode: ${type}.`);\n    }\n    type = Comment;\n    console.log('%cvnode-\u6784\u5efa:a--\x3e\u4e0d\u4f20type\uff0c\u9ed8\u8ba4Comment\u7c7b\u578b\u7684\u865a\u62df\u8282\u70b9', 'color:green', type)\n  }\n  console.log('%cvnode-\u6784\u5efa:a--\x3e', 'color:green', type)\n  if (isVNode(type)) {\n    // createVNode receiving an existing vnode. This happens in cases like\n    // <component :is=\"vnode\"/>\n    // #2078 make sure to merge refs during the clone instead of overwriting it\n    const cloned = cloneVNode(type, props, true /* mergeRef: true */);\n    if (children) {\n      normalizeChildren(cloned, children);\n    }\n    if (isBlockTreeEnabled > 0 && !isBlockNode && currentBlock) {\n      if (cloned.shapeFlag & 6 /* ShapeFlags.COMPONENT */) {\n        currentBlock[currentBlock.indexOf(type)] = cloned;\n      }\n      else {\n        currentBlock.push(cloned);\n      }\n    }\n    cloned.patchFlag |= -2 /* PatchFlags.BAIL */;\n    console.log('%ccvnode-\u6784\u5efa:a--\x3e\u5df2\u7ecf\u662f\u865a\u62df\u8282\u70b9\uff0c\u5219\u514b\u9686\u4e00\u4e2a\uff0c\u8fd4\u56de:', 'color:green', type)\n    return cloned;\n  }\n  // class component normalization.\n  if (isClassComponent(type)) {\n    type = type.__vccOpts;\n  }\n  // class & style normalization.\n  if (props) {\n    console.log('%ccvnode-\u6784\u5efa:a--\x3estyle\u548cclass\u6807\u51c6\u5316\uff1a', 'color:green', type)\n    // for reactive or proxy objects, we need to clone it to enable mutation.\n    props = guardReactiveProps(props);\n    let { class: klass, style } = props;\n    if (klass && !isString(klass)) {\n      props.class = normalizeClass(klass);\n    }\n    if (isObject(style)) {\n      // reactive state objects need to be cloned since they are likely to be\n      // mutated\n      if (isProxy(style) && !isArray(style)) {\n        style = extend({}, style);\n      }\n      props.style = normalizeStyle(style);\n    }\n  }\n  // encode the vnode type information into a bitmap\n  // \u5c06vnode\u7c7b\u578b\u4fe1\u606f\u7f16\u7801\u4e3a\u4f4d\u56fe\n  const shapeFlag = isString(type)\n    ? 1 /* ShapeFlags.ELEMENT */\n    : isSuspense(type)\n      ? 128 /* ShapeFlags.SUSPENSE */\n      : isTeleport(type)\n        ? 64 /* ShapeFlags.TELEPORT */\n        : isObject(type)\n          ? 4 /* ShapeFlags.STATEFUL_COMPONENT */\n          : isFunction(type)\n            ? 2 /* ShapeFlags.FUNCTIONAL_COMPONENT */\n            : 0;\n  if (shapeFlag & 4 /* ShapeFlags.STATEFUL_COMPONENT */ && isProxy(type)) {\n    type = toRaw(type);\n    warn$1(`Vue received a Component which was made a reactive object. This can ` +\n      `lead to unnecessary performance overhead, and should be avoided by ` +\n      `marking the component with \\`markRaw\\` or using \\`shallowRef\\` ` +\n      `instead of \\`ref\\`.`, `\\nComponent that was made reactive: `, type);\n  }\n  // \u521b\u5efa\u865a\u62df\u8282\u70b9\n  return createBaseVNode(type, props, children, patchFlag, dynamicProps, shapeFlag, isBlockNode, true);\n}\n")),(0,r.kt)("h3",{id:"3-3-_createvnode--createbasevnode"},"3-3. ",(0,r.kt)("inlineCode",{parentName:"h3"},"_createVNode()"),"--\x3ecreateBaseVNode()"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"function createBaseVNode(type, props = null, children = null, patchFlag = 0, dynamicProps = null, shapeFlag = type === Fragment ? 0 : 1 /* ShapeFlags.ELEMENT */, isBlockNode = false, needFullChildrenNormalization = false) {\n  const vnode = {\n    __v_isVNode: true,\n    __v_skip: true,\n    type, // \u4f20\u5165\u7684\u7ec4\u4ef6\u5bf9\u8c61\n    props, // \u4f20\u9012\u7ed9\u7ec4\u4ef6\u5bf9\u8c61\u7684\u53c2\u6570\n    key: props && normalizeKey(props), // \u53d6\u51fa\u6240\u6709\u4f20\u5165\u7684key\n    ref: props && normalizeRef(props), // \u5bf9props\u8fdb\u884cref\u6b63\u89c4\u5316\n    scopeId: currentScopeId, // \u73b0\u5728\u7684\u4f5c\u7528\u57dfid \n    slotScopeIds: null,\n    children, // \u5b50\u8282\u70b9\n    component: null,\n    suspense: null,\n    ssContent: null,\n    ssFallback: null,\n    dirs: null,\n    transition: null,\n    el: null,\n    anchor: null,\n    target: null,\n    targetAnchor: null,\n    staticCount: 0,\n    shapeFlag, // \u865a\u62df\u8282\u70b9\u7c7b\u578b\u6807\u8bb0\n    patchFlag, // patch\u7b97\u6cd5\u6807\u8bb0\n    dynamicProps, // \u52a8\u6001Props\n    dynamicChildren: null,\n    appContext: null,\n    ctx: currentRenderingInstance\n  };\n  if (needFullChildrenNormalization) {\n    // \u6807\u51c6\u5316\u5b50\u8282\u70b9\uff0c\u628a\u4e0d\u540c\u6570\u636e\u7c7b\u578b\u7684 children \u8f6c\u6210\u6570\u7ec4\u6216\u8005\u6587\u672c\u7c7b\u578b\n    normalizeChildren(vnode, children);\n    // normalize suspense children\n    if (shapeFlag & 128 /* ShapeFlags.SUSPENSE */) {\n      type.normalize(vnode);\n    }\n  }\n  else if (children) {\n    // compiled element vnode - if children is passed, only possible types are\n    // string or Array.\n    vnode.shapeFlag |= isString(children)\n      ? 8 /* ShapeFlags.TEXT_CHILDREN */\n      : 16 /* ShapeFlags.ARRAY_CHILDREN */;\n  }\n  // validate key\n  if (vnode.key !== vnode.key) {\n    warn$1(`VNode created with invalid key (NaN). VNode type:`, vnode.type);\n  }\n  // track vnode for block tree\n  if (isBlockTreeEnabled > 0 &&\n    // avoid a block node from tracking itself\n    !isBlockNode &&\n    // has current parent block\n    currentBlock &&\n    // presence of a patch flag indicates this node needs patching on updates.\n    // component nodes also should always be patched, because even if the\n    // component doesn't need to update, it needs to persist the instance on to\n    // the next vnode so that it can be properly unmounted later.\n    (vnode.patchFlag > 0 || shapeFlag & 6 /* ShapeFlags.COMPONENT */) &&\n    // the EVENTS flag is only for hydration and if it is the only flag, the\n    // vnode should not be considered dynamic due to handler caching.\n    vnode.patchFlag !== 32 /* PatchFlags.HYDRATE_EVENTS */) {\n    currentBlock.push(vnode);\n  }\n\n  console.log('%cvnode-\u6784\u5efa:b--\x3ecreateBaseVNode\u8fd4\u56de\u503c', 'color:green', { type, vnode })\n  return vnode;\n}\n")),(0,r.kt)("h2",{id:"\u7b2c\u56db\u6b65-\u989d\u5916\u91cd\u70b9rendercomponentroot-\u6267\u884c\u6784\u5efa\u51fa\u6765\u7684render-\u751f\u6210vnode"},"\u7b2c\u56db\u6b65. \u989d\u5916\u91cd\u70b9renderComponentRoot \u6267\u884c\u6784\u5efa\u51fa\u6765\u7684render() \u751f\u6210vnode"),(0,r.kt)("mermaid",{value:'flowchart LR\n\ntemplate--\x3east--\x3ea1("render()")--\u6267\u884crender--\x3eVNode'}),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"1. effect.run()\u5185\u90e8\u8c03\u7528componentUpdateFn\u7ec4\u4ef6\u7684\u521d\u59cb\u6302\u8f7d\u548c\u66f4\u65b0\n\n2. \u8c03\u7528renderComponentRoot\n")),(0,r.kt)("p",null,"renderComponentRoot\u51fd\u6570\uff0c\u4f20\u53c2\u4e3ainstance\u5bf9\u8c61"),(0,r.kt)("p",null,"renderComponentRoot\u51fd\u6570\u5185\u90e8\u9996\u5148\u901a\u8fc7render!.call(proxyToUse, ...)\u65b9\u6cd5\u6267\u884cinstance.render\u51fd\u6570(\u672c\u6587\u5f00\u5934\u5df2\u7ecf\u5c55\u793a\u4e86\u4f9d\u672c\u4f8b\u6a21\u7248\u89e3\u6790\u540e\u7684render\u51fd\u6570)\uff0c\u4f20\u53c2\u662fproxyToUse(\u5c31\u662fwithProxy\u5bf9\u8c61)\u548crenderCache(\u7a7a\u6570\u7ec4[])\u4e0b\u9762\u8be6\u7ec6\u89e3\u6790render\u51fd\u6570\u7684\u6267\u884c\u8fc7\u7a0b:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"\u5177\u4f53\u51fd\u6570\u89c1\n### \u4f8b\u5b502:\u751f\u6210\u7531AST\u751f\u6210\u7684code\u8f6c\u5316\u7684render\u51fd\u6570\n")),(0,r.kt)("p",null,"\u53c2\u8003\uff1a",(0,r.kt)("a",{parentName:"p",href:"https://juejin.cn/post/7006988485949128741"},"https://juejin.cn/post/7006988485949128741")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"\u6574\u4e2a\u51fd\u6570\u4f53\u90fd\u5728with(_ctx){}\u4e2d\uff0c\u5982\u679c\u5bf9with\u7684\u7528\u6cd5\u4e0d\u719f\u6089\uff0c\u53ef\u4ee5\u4e86\u89e3\u4e0b\u3002\u7b80\u5355\u6765\u8bf4\u5c31\u662f\u5728with\u82b1\u62ec\u53f7\u91cc\u9762\u7684\u5c5e\u6027\u4e0d\u9700\u8981\u6307\u5b9a\u547d\u540d\u7a7a\u95f4\uff0c\u4f1a\u81ea\u52a8\u6307\u5411_ctx\u5bf9\u8c61\uff1bwith(Proxy){key}\u4f1a\u89e6\u53d1Proxy\u4ee3\u7406\u7684has\u94a9\u5b50\u51fd\u6570(_ctx\u5bf9\u8c61\u5c31\u662fwithProxy\u5bf9\u8c61\uff0c\u672c\u6587\u4e0a\u9762\u63d0\u5230\u4e86withProxy\u5c31\u662finstance.ctx\u5bf9\u8c61\u901a\u8fc7Proxy\u4ee3\u7406\u540e\u7684\u5bf9\u8c61)"),(0,r.kt)("li",{parentName:"ol"},"const { ... } = _Vue\u5bf9_Vue\u5bf9\u8c61\u8fdb\u884c\u7ed3\u6784\uff0c\u9996\u5148\u4f1a\u89e6\u53d1_ctx\u7684has\u94a9\u5b50\u51fd\u6570(\u56e0\u4e3actx\u4e0a\u5e76\u6ca1\u6709_Vue\u5c5e\u6027\uff0c\u8fd9\u91cc\u5c31\u5ffd\u7565\uff0c\u540e\u7eed\u518d\u8be6\u7ec6\u89e3\u6790has\u94a9\u5b50\u51fd\u6570)\u3002\u56de\u987e\u5230\u4e4b\u524d\u89e3\u6790\u5b8c\u6210\u7684render String\u5f00\u5934\u90e8\u5206\uff0c\u5b9a\u4e49const _Vue = Vue\uff0c\u4e5f\u5c31\u662f_Vue\u5c31\u662f\u5168\u5c40\u7684Vue\u5bf9\u8c61\u3002\u90a3\u89e3\u6784\u51fa\u6765\u7684\u4e00\u7cfb\u5217\u65b9\u6cd5\u5c31\u662f\u5168\u5c40\u7684Vue\u66b4\u9732\u7684\u65b9\u6cd5(toDisplayString, createVNode, createTextVNode, Fragment, openBlock, createBlock)")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"function renderComponentRoot(instance) {\n  const { type: Component, vnode, proxy, withProxy, props, propsOptions: [propsOptions], slots, attrs, emit, render, renderCache, data, setupState, ctx, inheritAttrs } = instance;\n  let result;\n  let fallthroughAttrs;\n  const prev = setCurrentRenderingInstance(instance);\n  {\n    accessedAttrs = false;\n  }\n  try {\n    if (vnode.shapeFlag & 4 /* ShapeFlags.STATEFUL_COMPONENT */) {\n      // withProxy is a proxy with a different `has` trap only for\n      // runtime-compiled render functions using `with` block.\n      const proxyToUse = withProxy || proxy;\n      console.log('vnode-\u6784\u5efa:\u8c03\u7528render\u51fd\u6570', { test: render })\n      result = normalizeVNode(render.call(proxyToUse, proxyToUse, renderCache, props, setupState, data, ctx));\n      console.log('vnode-\u6784\u5efa:\u8c03\u7528render\u8fd4\u56de\u7ed3\u679c:', { test: result })\n      fallthroughAttrs = attrs;\n    }\n\n    // ...\n    ...\n    // ...\n  }\n\n  // ...\n  ...\n  // ...\n}\n")),(0,r.kt)("ol",{start:3},(0,r.kt)("li",{parentName:"ol"},"\u540e\u7eed\u6267\u884crender\u51fd\u6570\u4e2dreturn\u7684\u5185\u5bb9\u3002\u9996\u5148\u662f\u6267\u884copenBlock\u51fd\u6570(\u65e0\u53c2\u6570)")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"// openBlock\u51fd\u6570\u5185\u90e8\u7ed9\u5168\u5c40\u7684currentBlock\u53d8\u91cf\u8d4b\u503c\u7a7a\u6570\u7ec4[]\uff0c\u7136\u540e\u5c06\u8fd9\u4e2a\u53d8\u91cfpush\u5230\u53e6\u4e00\u4e2a\u5168\u5c40\u7684\u7a7a\u6570\u7ec4blockStack\u4e2d\uff0c\u5373blockStack=[[]]\uff0c\u540e\u7eed\u521b\u5efaVNode\u4f1a\u4f7f\u7528\u8fd9\u4e2a\u5168\u5c40\u6570\u7ec4\nfunction openBlock(disableTracking = false) {\n  blockStack.push((currentBlock = disableTracking ? null : []));\n}\n")),(0,r.kt)("ol",{start:3},(0,r.kt)("li",{parentName:"ol"},"\u89e3\u6790\u52a8\u6001\u6570\u636e(\u4f9d\u8d56\u6536\u96c6\u81f3\u5168\u5c40targetMap\u5bf9\u8c61)\n\u7136\u540e\u6267\u884ccreateBlock\u65b9\u6cd5\uff0c\u5176\u4e2d\u7b2c\u4e09\u4e2a\u53c2\u6570\u662f\u6570\u7ec4\uff0c\u6570\u7ec4\u7684\u7b2c\u4e00\u9879\u662fcreateTextVNode\u51fd\u6570\u7684\u8fd4\u56de\u503c\uff0c\u6267\u884ccreateTextVNode\u51fd\u6570\u65f6\u53c2\u6570\u6709\u4e24\u4e2a\uff0c\u7b2c\u4e00\u4e2a\u53c2\u6570\u662ftoDisplayString\u65b9\u6cd5\u7684\u6267\u884c\u7ed3\u679c\uff0c\u53c2\u6570\u662fmessage\u3002\u8fd9\u91cc\u56e0\u4e3awith(_ctx){message}\u4f1a\u89e6\u53d1has\u94a9\u5b50\u51fd\u6570\uff0c\u770b\u4e0bhas\u94a9\u5b50\u51fd\u6570\u7684\u5177\u4f53\u5185\u90e8\u5b9e\u73b0")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"\u5224\u65ad\u5c5e\u6027\u540d\u79f0key\u503c\u4e0d\u662f\u4ee5'_'\u5f00\u5934\u7684\uff0c\u5e76\u4e14\u4e0d\u662f\u7279\u5b9a\u7684\u4e00\u4e9b\u5b57\u7b26\u4e32\uff0c\u7c7b\u4f3cObject\u3001Boolean\u7b49(\u5177\u4f53\u53ef\u4ee5\u53bb\u770b\u4e0bisGloballyWhitelisted\u65b9\u6cd5\u7684\u5185\u90e8\u5b9e\u73b0)\uff0c\u6b64\u65f6key\u503c\u4e3amessage\uff0c\u6240\u4ee5has\u4e3atrue\n\n\u4e4b\u540e\u83b7\u53d6messgae\u7684\u503c\uff0c_ctx.message\u4f1a\u89e6\u53d1get\u94a9\u5b50\u51fd\u6570\uff0c\u5148\u5224\u65ad\u5c5e\u6027\u540d\u662f\u5426\u7b49\u4e8eSymbol.unscopables\uff0c\u6b64\u65f6key\u503c\u4e3amessage\uff0c\u6240\u4ee5\u6267\u884cPublicInstanceProxyHandlers\u7684get\u65b9\u6cd5\u3002\u4e00\u8d77\u770b\u4e0bPublicInstanceProxyHandlers\u5185\u90e8get\u65b9\u6cd5\u7684\u5177\u4f53\u5b9e\u73b0\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const PublicInstanceProxyHandlers = {\n  get({ _: instance }, key) {\n    const { ctx, setupState, data, props, accessCache, type, appContext } = instance;\n    // for internal formatters to know that this is a Vue instance\n    if (key === '__isVue') {\n      return true;\n    }\n    // data / props / ctx\n    // This getter gets called for every property access on the render context\n    // during render and is a major hotspot. The most expensive part of this\n    // is the multiple hasOwn() calls. It's much faster to do a simple property\n    // access on a plain object, so we use an accessCache object (with null\n    // prototype) to memoize what access type a key corresponds to.\n    let normalizedProps;\n    if (key[0] !== '$') {\n      const n = accessCache[key];\n      if (n !== undefined) {\n        switch (n) {\n          case 1 /* AccessTypes.SETUP */:\n            return setupState[key];\n          case 2 /* AccessTypes.DATA */:\n            return data[key];\n          case 4 /* AccessTypes.CONTEXT */:\n            return ctx[key];\n          case 3 /* AccessTypes.PROPS */:\n            return props[key];\n          // default: just fallthrough\n        }\n      }\n      else if (hasSetupBinding(setupState, key)) {\n        accessCache[key] = 1 /* AccessTypes.SETUP */;\n        return setupState[key];\n      }\n      else if (data !== EMPTY_OBJ && hasOwn(data, key)) {\n        accessCache[key] = 2 /* AccessTypes.DATA */;\n        return data[key];\n      }\n      else if (\n        // only cache other properties when instance has declared (thus stable)\n        // props\n        (normalizedProps = instance.propsOptions[0]) &&\n        hasOwn(normalizedProps, key)) {\n        accessCache[key] = 3 /* AccessTypes.PROPS */;\n        return props[key];\n      }\n      else if (ctx !== EMPTY_OBJ && hasOwn(ctx, key)) {\n        accessCache[key] = 4 /* AccessTypes.CONTEXT */;\n        return ctx[key];\n      }\n      else if (shouldCacheAccess) {\n        accessCache[key] = 0 /* AccessTypes.OTHER */;\n      }\n    }\n    const publicGetter = publicPropertiesMap[key];\n    let cssModule, globalProperties;\n    // public $xxx properties\n    if (publicGetter) {\n      if (key === '$attrs') {\n        track(instance, \"get\" /* TrackOpTypes.GET */, key);\n        markAttrsAccessed();\n      }\n      return publicGetter(instance);\n    }\n    else if (\n      // css module (injected by vue-loader)\n      (cssModule = type.__cssModules) &&\n      (cssModule = cssModule[key])) {\n      return cssModule;\n    }\n    else if (ctx !== EMPTY_OBJ && hasOwn(ctx, key)) {\n      // user may set custom properties to `this` that start with `$`\n      accessCache[key] = 4 /* AccessTypes.CONTEXT */;\n      return ctx[key];\n    }\n    else if (\n      // global properties\n      ((globalProperties = appContext.config.globalProperties),\n        hasOwn(globalProperties, key))) {\n      {\n        return globalProperties[key];\n      }\n    }\n    else if (currentRenderingInstance &&\n      (!isString(key) ||\n        // #1091 avoid internal isRef/isVNode checks on component instance leading\n        // to infinite warning loop\n        key.indexOf('__v') !== 0)) {\n      if (data !== EMPTY_OBJ && isReservedPrefix(key[0]) && hasOwn(data, key)) {\n        warn$1(`Property ${JSON.stringify(key)} must be accessed via $data because it starts with a reserved ` +\n          `character (\"$\" or \"_\") and is not proxied on the render context.`);\n      }\n      else if (instance === currentRenderingInstance) {\n        warn$1(`Property ${JSON.stringify(key)} was accessed during render ` +\n          `but is not defined on instance.`);\n      }\n    }\n  },\n  set({ _: instance }, key, value) {\n    const { data, setupState, ctx } = instance;\n    if (hasSetupBinding(setupState, key)) {\n      setupState[key] = value;\n      return true;\n    }\n    else if (setupState.__isScriptSetup &&\n      hasOwn(setupState, key)) {\n      warn$1(`Cannot mutate <script setup> binding \"${key}\" from Options API.`);\n      return false;\n    }\n    else if (data !== EMPTY_OBJ && hasOwn(data, key)) {\n      data[key] = value;\n      return true;\n    }\n    else if (hasOwn(instance.props, key)) {\n      warn$1(`Attempting to mutate prop \"${key}\". Props are readonly.`);\n      return false;\n    }\n    if (key[0] === '$' && key.slice(1) in instance) {\n      warn$1(`Attempting to mutate public property \"${key}\". ` +\n        `Properties starting with $ are reserved and readonly.`);\n      return false;\n    }\n    else {\n      if (key in instance.appContext.config.globalProperties) {\n        Object.defineProperty(ctx, key, {\n          enumerable: true,\n          configurable: true,\n          value\n        });\n      }\n      else {\n        ctx[key] = value;\n      }\n    }\n    return true;\n  },\n  has({ _: { data, setupState, accessCache, ctx, appContext, propsOptions } }, key) {\n    let normalizedProps;\n    return (!!accessCache[key] ||\n      (data !== EMPTY_OBJ && hasOwn(data, key)) ||\n      hasSetupBinding(setupState, key) ||\n      ((normalizedProps = propsOptions[0]) && hasOwn(normalizedProps, key)) ||\n      hasOwn(ctx, key) ||\n      hasOwn(publicPropertiesMap, key) ||\n      hasOwn(appContext.config.globalProperties, key));\n  },\n  defineProperty(target, key, descriptor) {\n    if (descriptor.get != null) {\n      // invalidate key cache of a getter based property #5417\n      target._.accessCache[key] = 0;\n    }\n    else if (hasOwn(descriptor, 'value')) {\n      this.set(target, key, descriptor.value, null);\n    }\n    return Reflect.defineProperty(target, key, descriptor);\n  }\n};\n{\n  PublicInstanceProxyHandlers.ownKeys = (target) => {\n    warn$1(`Avoid app logic that relies on enumerating keys on a component instance. ` +\n      `The keys will be empty in production mode to avoid performance overhead.`);\n    return Reflect.ownKeys(target);\n  };\n}\nconst RuntimeCompiledPublicInstanceProxyHandlers = /*#__PURE__*/ extend({}, PublicInstanceProxyHandlers, {\n  get(target, key) {\n    // fast path for unscopables when using `with` block\n    if (key === Symbol.unscopables) {\n      return;\n    }\n    return PublicInstanceProxyHandlers.get(target, key, target);\n  },\n  has(_, key) {\n    const has = key[0] !== '_' && !isGloballyWhitelisted(key);\n    if (!has && PublicInstanceProxyHandlers.has(_, key)) {\n      warn$1(`Property ${JSON.stringify(key)} should not start with _ which is a reserved prefix for Vue internals.`);\n    }\n    return has;\n  }\n});\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"\u9996\u5148\u4f1a\u5bf9target\u5bf9\u8c61\u8fdb\u884c\u7ed3\u6784\uff0c\u83b7\u53d6'_'\u5c5e\u6027\u7684\u503c\uff0ctarget\u5c31\u662f_ctx\u5bf9\u8c61\uff0c\u672c\u6587\u524d\u9762\u63d0\u5230\u4e86_ctx\u662finstance.ctx\u7684Proxy\u4ee3\u7406\u5bf9\u8c61(\u5173\u4e8einstance.ctx\u5bf9\u8c61\u4e0a\u7684_\u5c5e\u6027\u7684\u503c\uff0c\u5728\u6587\u7ae0\u4e8c\"\u53cc\u5411\u6570\u636e\u7ed1\u5b9a\"\u4e2d\u63d0\u5230\u4e86instance\u5bf9\u8c61\u7684\u521b\u5efa\uff0c\u5e76\u65b0\u589e_\u5c5e\u6027\u503c\u4e3ainstance)\u3002\u56de\u5f52\u5230get\u94a9\u5b50\u51fd\u6570\u4e2d\uff0c\u5224\u65ad\u5c5e\u6027\u540dkey(message)\u4e0d\u662f\u4ee5'$'\u5f00\u5934\u7684\uff0c\u5e76\u4e14\u4e0d\u5b58\u5728\u4e8einstance\u7684accessCache\u7f13\u5b58\u5bf9\u8c61\u4e2d\uff0c\u518d\u5224\u65adinstance.setupState\u5c5e\u6027\u4e0d\u662f\u7a7a\u5bf9\u8c61\uff0c\u5e76\u4e14message\u5b58\u5728\u4e8esetupState\u5bf9\u8c61\u4e2d(\u5728\u6587\u7ae0\u4e09\"\u53cc\u5411\u6570\u636e\u7ed1\u5b9a\"\u4e2d\u63d0\u5230instance.setupState\u5c31\u662fsetup\u51fd\u6570\u6267\u884c\u5b8c\u6210\u4e4b\u540e\u8fd4\u56de\u7684\u7ed3\u679c\u518d\u901a\u8fc7Proxy\u4ee3\u7406\u7684\u5bf9\u8c61)\u3002\u672c\u4f8b\u4e2dsetupState\u4e0d\u662f\u7a7a\u5bf9\u8c61\u5e76\u4e14message\u4e5f\u662f\u6b64\u5bf9\u8c61\u7684\u5c5e\u6027\uff0c\u6240\u4ee5\u8bbe\u7f6eaccessCache[message] = 0\uff0c\u6700\u7ec8\u8fd4\u56desetupState[message]\u7684\u503c\u3002\n\n\u56e0\u4e3asetupState\u5bf9\u8c61\u662fsetup\u51fd\u6570\u8fd4\u56de\u503c\u7684Proxy\u5bf9\u8c61\uff0c\u6240\u4ee5\u6267\u884csetupState[message]\u65f6\u4f1a\u89e6\u53d1get\u94a9\u5b50\u51fd\u6570\n")),(0,r.kt)("p",null,'\u9996\u5148\u901a\u8fc7Reflect\u65b9\u6cd5\u83b7\u53d6setupState.message\u7684\u503c(\u6587\u7ae0\u4e09"\u53cc\u5411\u6570\u636e\u7ed1\u5b9a"\u4e2d\u89e3\u6790\u4e86message\u5c5e\u6027\u503c\u662f\u8c03\u7528ref\u65b9\u6cd5\u8fd4\u56de\u7684RefImpl\u5b9e\u4f8b\u5bf9\u8c61)\u3002\u7136\u540e\u8c03\u7528unref\u65b9\u6cd5\uff0c\u5224\u65ad\u5165\u53c2\u7684__v_isRef\u5c5e\u6027\u662f\u5426\u4e3atrue\uff0c\u672c\u4f8b\u4e2dmessage\u7b26\u5408\uff0c\u6240\u4ee5\u8fd4\u56deref.value(message.value)\u3002\u56e0\u4e3amessage\u662fRefImpl\u7684\u5b9e\u4f8b\u5bf9\u8c61\uff0c\u6240\u4ee5\u83b7\u53d6\u5c5e\u6027\u65f6\u4f1a\u89e6\u53d1get\u94a9\u5b50\u51fd\u6570'),(0,r.kt)("p",null,"\u94a9\u5b50\u51fd\u6570\u5185\u90e8\u5148\u8c03\u7528track\u51fd\u6570\u6536\u96c6\u4f9d\u8d56\uff0c\u51fd\u6570\u5185\u90e8\u5148\u5224\u65ad\uff0ctargetMap(WeakMap\u5bf9\u8c61)\u5168\u5c40\u5bf9\u8c61\u4e2d\u662f\u5426\u5b58\u5728target\u5c5e\u6027(\u521d\u59cb\u5316\u6302\u8f7d\u662f\u4e0d\u5b58\u5728\u7684)\uff0c\u82e5\u4e0d\u5b58\u5728\u5219\u6267\u884ctargetMap.set(target, (depsMap = new Map()))\uff0c\u8bbe\u7f6ekey=target\uff0cvalue=new Map()(\u7a7a\u7684Map\u5bf9\u8c61)\uff0c\u7136\u540e\u83b7\u53d6depsMap(Map\u5bf9\u8c61)\u4e2dkey=message\u7684\u5c5e\u6027\u503c\uff0c\u56e0\u4e3adepsMap\u662f\u65b0\u5efa\u7684\u7a7aMap\u5bf9\u8c61\uff0c\u6240\u4ee5\u4e5f\u4e0d\u5b58\u5728message\u5c5e\u6027\uff0c\u56fa\u6267\u884cdepsMap.set(key, (dep = new Set()))\uff0c\u8bbe\u7f6ekey=message\uff0cvalue=new Set()(\u7a7a\u7684Set\u5bf9\u8c61)\u3002\u56e0\u4e3adep\u662f\u7a7a\u7684Set\u5bf9\u8c61\uff0c\u6240\u4ee5\u5f80dep\u5bf9\u8c61\u4e2d\u65b0\u589eactiveEffect\u5168\u5c40\u53d8\u91cf(\u672c\u6587\u4e0a\u8ff0\u89e3\u6790\u8fc7activeEffect\u5c31\u662freactiveEffect\u51fd\u6570)\uff0c\u7136\u540e\u5728reactiveEffect\u65b9\u6cd5\u7684deps\u6570\u7ec4\u4e2d\u6dfb\u52a0dep\u5bf9\u8c61(Set\u5bf9\u8c61)\u3002\u540e\u7eed\u5728\u4fee\u6539message\u7684\u503c\u4e4b\u540e\u89e6\u53d1set\u94a9\u5b50\u51fd\u6570\u65f6\u4f1a\u6267\u884c\u4f9d\u8d56\uff0c\u66f4\u65b0DOM"),(0,r.kt)("ol",{start:5},(0,r.kt)("li",{parentName:"ol"},"createTextVNode\u521b\u5efa\u6587\u672cvnode\u5bf9\u8c61\n\u56de\u5f52\u5230render\u51fd\u6570\u4e2d\uff0c\u6839\u636e\u4e00\u7cfb\u5217\u7684Proxy\u4ee3\u7406\u5f97\u5230message=\"\u6d4b\u8bd5\u6570\u636e\"(\u4ee5\u672c\u4f8b\u4e3a\u6a21\u7248\u89e3\u6790)\uff0c\u5f00\u59cb\u6267\u884ctoDisplayString('\u6d4b\u8bd5\u6570\u636e')")),(0,r.kt)("p",null,"toDisplayString\u51fd\u6570\u6700\u7ec8\u8fd4\u56deString(val)\u5c31\u662f'\u6d4b\u8bd5\u6570\u636e'"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const toDisplayString = (val) => {\n  return isString(val)\n    ? val\n    : val == null\n      ? ''\n      : isArray(val) ||\n        (isObject(val) &&\n          (val.toString === objectToString || !isFunction(val.toString)))\n        ? JSON.stringify(val, replacer, 2)\n        : String(val);\n};\n")),(0,r.kt)("ol",{start:6},(0,r.kt)("li",{parentName:"ol"},'\u63a5\u7740\u5f00\u59cb\u6267\u884ccreateTextVNode\u51fd\u6570\uff0c\u53c2\u6570\u4e3a"\u6d4b\u8bd5\u6570\u636e" \u548c 1')),(0,r.kt)("p",null,"createTextVNode\u51fd\u6570\u5185\u90e8\u8c03\u7528createVNode\u65b9\u6cd5\uff0c\u53c2\u6570\u4e3aSymbol('Text')\u3001null\u3001'\u6d4b\u8bd5\u6570\u636e '\u30011\uff0c\u5728\u6587\u7ae0\u4e8c\"\u6570\u636e\u53cc\u5411\u7ed1\u5b9a\"\u4e2d\u5df2\u7ecf\u7b80\u5355\u89e3\u6790\u4e86createVNode\u65b9\u6cd5\u7684\u4f5c\u7528\uff0c\u4e3b\u8981\u662f\u751f\u6210\u4e00\u4e2aVNode\u5bf9\u8c61\uff0c\u5728\u521d\u59cb\u5316\u6267\u884capp.mount\u65f6\u4f1a\u4f7f\u7528\uff0c\u521d\u59cb\u5316\u6267\u884c\u65f6type\u662f\u8c03\u7528createApp\u4f20\u5165\u7684\u53c2\u6570\u3002\u73b0\u5728\u662f\u7528\u6765\u751f\u6210\u4e00\u4e2a\u6587\u672c\u8282\u70b9\uff0c\u770b\u4e0bcreateVNode\u5185\u90e8\u7684\u5177\u4f53\u5b9e\u73b0"),(0,r.kt)("p",null,"\u9996\u5148\u6839\u636etype\u7c7b\u578b\u7ed9shapeFlag\u8d4b\u503c\uff0c\u56e0\u4e3atype\u662fSymbol('Text')\uff0c\u6240\u4ee5shapeFlag=0"),(0,r.kt)("p",null,"\u521b\u5efavnode\u5bf9\u8c61\uff0c\u5176\u4e2dpatchFlag\u5c5e\u6027\u503c\u4e3a1"),(0,r.kt)("p",null,"\u63a5\u7740\u8c03\u7528normalizeChildren\u51fd\u6570\uff0c\u6b64\u51fd\u6570\u4e3b\u8981\u662f\u7528\u6765\u5904\u7406\u8282\u70b9\u7684children\u5c5e\u6027"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"export function createTextVNode(text: string = ' ', flag: number = 0): VNode {\n  return createVNode(Text, null, text, flag)\n}\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"export function normalizeChildren(vnode: VNode, children: unknown) {\n  let type = 0\n  const { shapeFlag } = vnode\n  if (children == null) {}\n  else if (isArray(children)) {}\n  else if (typeof children === 'object') {}\n  else if (isFunction(children)) {}\n  else {\n    children = String(children)\n    // force teleport children to array so it can be moved around\n    if (shapeFlag & ShapeFlags.TELEPORT) {\n      type = ShapeFlags.ARRAY_CHILDREN\n      children = [createTextVNode(children as string)]\n    } else {\n      type = ShapeFlags.TEXT_CHILDREN // 8\n    } \n  }\n  vnode.children = children as VNodeNormalizedChildren\n  vnode.shapeFlag |= type\n}\n")),(0,r.kt)("p",null,"createVNode\u521b\u5efa\u5143\u7d20vnode\u5bf9\u8c61"),(0,r.kt)("p",null,"\u56de\u5f52\u5230render\u65b9\u6cd5\u4e2d\uff0c\u6267\u884c\u5b8c\u6587\u672c\u8282\u70b9\u4e4b\u540e\u5f00\u59cb\u6267\u884c\u5143\u7d20\u8282\u70b9(button\u8282\u70b9\uff0c\u76f4\u63a5\u8c03\u7528createVNode\u65b9\u6cd5)\uff0c\u53c2\u6570\u4e3a\"button\", { onClick: modifyMessage }, '\u4fee\u6539\u6570\u636e', 8\u3002"),(0,r.kt)("ol",{start:7},(0,r.kt)("li",{parentName:"ol"},"\u56de\u5f52\u5230render\u65b9\u6cd5\u4e2d\uff0c\u6267\u884c\u5b8c\u6587\u672c\u8282\u70b9\u4e4b\u540e\u5f00\u59cb\u6267\u884c\u5143\u7d20\u8282\u70b9(button\u8282\u70b9\uff0c\u76f4\u63a5\u8c03\u7528createVNode\u65b9\u6cd5)\uff0c\u53c2\u6570\u4e3a\"button\", { onClick: modifyMessage }, '\u4fee\u6539\u6570\u636e', 8\u3002")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"\u6839\u636etype\u662f\u5b57\u7b26\u4e32\u7c7b\u578b\uff0c\u6240\u4ee5shapeFlag\u8d4b\u503c\u4e3a1\n\n\n\u521b\u5efavnode\u5bf9\u8c61\uff0c\u8d4b\u503cprops\u5c5e\u6027\u4e3a{ onClick: modifyMessage }\uff0cpatchFlag\u4e3a8\n\n\n\u8c03\u7528normalizeChildren\u5904\u7406children\u5c5e\u6027\uff0c\u6b64\u5143\u7d20\u8282\u70b9\u7684children\u4e5f\u662f\u5b57\u7b26\u4e32\uff0c\u6240\u4ee5vnode.children='\u4fee\u6539\u6570\u636e'\uff0cvnode.shapeFlag = 1 | 8 = 9\uff0c\u6700\u540e\u5c06vnode\u5bf9\u8c61\u5b58\u5165currentBlock\u6570\u7ec4\u4e2d\u5e76\u8fd4\u56devnode\u5bf9\u8c61\n")),(0,r.kt)("p",null,"createBlock\u521b\u5efa\u6839vnode\u5bf9\u8c61"),(0,r.kt)("ol",{start:8},(0,r.kt)("li",{parentName:"ol"},"\u56de\u5f52\u5230render\u51fd\u6570\u4e2d\uff0c\u5f53\u4e2d\u62ec\u53f7\u7684\u4e24\u4e2a\u65b9\u6cd5(createTextVNode\u3001createVNode)\u6267\u884c\u5b8c\u6210\u540e\uff0c\u6700\u540e\u6267\u884ccreateBlock\u65b9\u6cd5\u751f\u6210\u6839vnode\u5bf9\u8c61")),(0,r.kt)("p",null,"\u5728createBlock\u5185\u90e8\u9996\u5148\u662f\u8c03\u7528createVNode\u65b9\u6cd5\u521b\u5efavnode\u8282\u70b9\uff0c\u53c2\u6570\u662fSymbol('Fragment')\u3001null\u3001","[\u6587\u672cvnode\u5bf9\u8c61, \u5143\u7d20vnode\u5bf9\u8c61]","\u300164\u3001true"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"createVNode\u65b9\u6cd5\u4e2d\u9996\u5148\u6839\u636etype\u662fSymbol\u7c7b\u578b\uff0cshapeFlag\u8d4b\u503c\u4e3a0\u3002\u521b\u5efavnode\u5bf9\u8c61\uff0cpatchFlag\u503c\u4e3a64\n\n\n\u6267\u884cnormalizeChildren\u51fd\u6570\uff0c\u5904\u7406children\u5c5e\u6027\u65f6\uff0c\u56e0\u4e3achildren\u662f\u6570\u7ec4\uff0c\u6240\u4ee5vnode.shapeFlag = 0 | 16 = 16\n\n\n\u56e0\u4e3a\u4f20\u5165\u7684isBlockNode=true\uff0c\u6240\u4ee5\u4e0d\u4f1a\u6267\u884ccurrentBlock.push(vnode)\uff0c\u6700\u540e\u8fd4\u56devnode\u5bf9\u8c61\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"function createBlock(type, props, children, patchFlag, dynamicProps) {\n  return setupBlock(createVNode(type, props, children, patchFlag, dynamicProps, true /* isBlock: prevent a block from tracking itself */));\n}\n\nexport function closeBlock() {\n  blockStack.pop()\n  currentBlock = blockStack[blockStack.length - 1] || null\n}\n")),(0,r.kt)("p",null,"\u56de\u5f52\u5230createBlock\u51fd\u6570\u4e2d\uff0c\u5c06vnode.dynamicChildren\u5c5e\u6027\u8d4b\u503c\u4e3acurrentBlock\u6570\u7ec4(\u6570\u7ec4\u4e2d\u5305\u542b\u6587\u672cvnode\u5bf9\u8c61 \u548c \u5143\u7d20vnode\u5bf9\u8c61\u4e24\u4e2a\u5143\u7d20\uff0c\u4e5f\u5c31\u662fvnode.children)\u3002\u7136\u540e\u6267\u884ccloseBlock"),(0,r.kt)("p",null,"\u8be5\u65b9\u6cd5\u5185\u5c06blockStack\u6570\u7ec4\u4e2d\u7684\u6700\u540e\u4e00\u9879\u79fb\u9664\u3002\u7531\u672c\u6587\u4e0a\u8ff0\u89e3\u6790\u53ef\u77e5\uff0cblockStack\u6570\u7ec4\u4e2d\u53ea\u6709\u4e00\u4e2a\u5143\u7d20\uff0c\u5c31\u662fcurrentBlock\u6570\u7ec4\uff0c\u7136\u540e\u5c06currentBlock\u8d4b\u503c\u4e3anull\u3002\u6700\u540ecreateBlock\u65b9\u6cd5\u8fd4\u56devnode\u5bf9\u8c61\uff0ctype\u4e3aSymbol('Fragment')\uff0cchildren\u6570\u7ec4\u5305\u542b\u4e24\u4e2avnode\u5bf9\u8c61\uff0c\u662ftype\u4e3aSymbol('Text')\u7684\u6587\u672c \u548c type\u4e3a'button'\u7684\u5143\u7d20\u3002\u81f3\u6b64render\u51fd\u6570\u7684\u89e3\u6790\u5df2\u7ecf\u5b8c\u5168\u7ed3\u675f\u4e86\u3002"),(0,r.kt)("h3",{id:"\u603b\u7ed3"},"\u603b\u7ed3"),(0,r.kt)("p",null,"\u89e3\u6790render\u51fd\u6570\u7684\u6267\u884c\u8fc7\u7a0b\uff0c\u9996\u5148\u89e3\u6790\u52a8\u6001\u6570\u636emessage\u65f6\u89e6\u53d1get\u94a9\u5b50\u51fd\u6570\uff0c\u8c03\u7528track\u65b9\u6cd5\u8fdb\u884c\u4f9d\u8d56\u7684\u6536\u96c6(activeEffect\u53d8\u91cf\u6536\u96c6\u5230\u5168\u5c40\u7684targetMap\u5bf9\u8c61\u4e2d)\uff1b\u7136\u540e\u8c03\u7528createTextVNode\u65b9\u6cd5\u6784\u5efa\u6587\u672cvnode\u5bf9\u8c61\uff1b\u8c03\u7528createVNode\u65b9\u6cd5\u6784\u5efabutton\u5143\u7d20\u7684vnode\u5bf9\u8c61\uff1b\u6700\u540e\u8c03\u7528createBlock\u65b9\u6cd5\u6784\u5efa\u6839vnode\u5bf9\u8c61\u3002\u540e\u7eed\u5c06\u8be6\u7ec6\u89e3\u6790patch\u65b9\u6cd5\u5229\u7528\u751f\u6210\u7684vnode\u5bf9\u8c61\u6784\u5efa\u51fa\u771f\u6b63\u7684DOM\u5143\u7d20"))}u.isMDXComponent=!0}}]);