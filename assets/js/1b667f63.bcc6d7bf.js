"use strict";(self.webpackChunkprogramming_technology=self.webpackChunkprogramming_technology||[]).push([[3157],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>h});var a=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function u(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=a.createContext({}),i=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):u(u({},t),e)),n},d=function(e){var t=i(e.components);return a.createElement(l.Provider,{value:t},e.children)},p="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},k=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),p=i(n),k=o,h=p["".concat(l,".").concat(k)]||p[k]||c[k]||r;return n?a.createElement(h,u(u({ref:t},d),{},{components:n})):a.createElement(h,u({ref:t},d))}));function h(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,u=new Array(r);u[0]=k;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[p]="string"==typeof e?e:o,u[1]=s;for(var i=2;i<r;i++)u[i]=n[i];return a.createElement.apply(null,u)}return a.createElement.apply(null,n)}k.displayName="MDXCreateElement"},19162:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>u,default:()=>c,frontMatter:()=>r,metadata:()=>s,toc:()=>i});var a=n(87462),o=(n(67294),n(3905));const r={title:"setState",sidebar_position:5},u=void 0,s={unversionedId:"React/setState",id:"React/setState",title:"setState",description:"\u590d\u4e60\u6e32\u67d3\u6d41\u7a0b",source:"@site/programming-tech/React/05-setState.md",sourceDirName:"React",slug:"/React/setState",permalink:"/React/setState",draft:!1,editUrl:"https://github.com/huiruo/programming-tech-website/programming-tech/React/05-setState.md",tags:[],version:"current",sidebarPosition:5,frontMatter:{title:"setState",sidebar_position:5},sidebar:"docs",previous:{title:"router",permalink:"/React/router"},next:{title:"setState\u5f02\u6b65-\u540c\u6b65",permalink:"/React/setState\u5f02\u6b65-\u540c\u6b65"}},l={},i=[{value:"\u590d\u4e60\u6e32\u67d3\u6d41\u7a0b",id:"\u590d\u4e60\u6e32\u67d3\u6d41\u7a0b",level:2},{value:"\u63a5\u4e0a\u9762beginWork,useState\u6302\u8f7dhooks\u51fd\u6570;\u751f\u6210dispatch;\u6302\u8f7d\u94fe\u8868",id:"\u63a5\u4e0a\u9762beginworkusestate\u6302\u8f7dhooks\u51fd\u6570\u751f\u6210dispatch\u6302\u8f7d\u94fe\u8868",level:2},{value:"setState \u66f4\u65b0,\u91cd\u70b9\u5728dispatchSetState",id:"setstate-\u66f4\u65b0\u91cd\u70b9\u5728dispatchsetstate",level:2},{value:"\u4e0d\u540c\u7c7b\u578bhook\u7684memoizedState\u4fdd\u5b58\u4e0d\u540c\u7c7b\u578b\u6570\u636e\uff0c\u5177\u4f53\u5982\u4e0b\uff1a",id:"\u4e0d\u540c\u7c7b\u578bhook\u7684memoizedstate\u4fdd\u5b58\u4e0d\u540c\u7c7b\u578b\u6570\u636e\u5177\u4f53\u5982\u4e0b",level:2},{value:"updateReducer \u4e3b\u8981\u5de5\u4f5c\uff1a",id:"updatereducer-\u4e3b\u8981\u5de5\u4f5c",level:3},{value:"1.React Hooks \u4e3a\u4ec0\u4e48\u4e0d\u80fd\u5199\u5728\u6761\u4ef6\u8bed\u53e5\u4e2d\uff1f",id:"1react-hooks-\u4e3a\u4ec0\u4e48\u4e0d\u80fd\u5199\u5728\u6761\u4ef6\u8bed\u53e5\u4e2d",level:2},{value:"\u95ee\u98981\uff1a setState()\u51fd\u6570\u5728\u4efb\u4f55\u60c5\u51b5\u4e0b\u90fd\u4f1a\u5bfc\u81f4\u7ec4\u4ef6\u91cd\u6e32\u67d3\u5417\uff1f\u5982\u679csetState\u4e2d\u7684state\u6ca1\u6709\u53d1\u751f\u6539\u53d8\u5462\uff1f",id:"\u95ee\u98981-setstate\u51fd\u6570\u5728\u4efb\u4f55\u60c5\u51b5\u4e0b\u90fd\u4f1a\u5bfc\u81f4\u7ec4\u4ef6\u91cd\u6e32\u67d3\u5417\u5982\u679csetstate\u4e2d\u7684state\u6ca1\u6709\u53d1\u751f\u6539\u53d8\u5462",level:2},{value:"\u95ee\u98982\uff1a \u5982\u679cstate\u548c\u4ece\u7236\u7ec4\u4ef6\u4f20\u8fc7\u6765\u7684props\u90fd\u6ca1\u53d8\u5316\uff0c\u90a3\u4ed6\u5c31\u4e00\u5b9a\u4e0d\u4f1a\u53d1\u751f\u91cd\u6e32\u67d3\u5417\uff1f",id:"\u95ee\u98982-\u5982\u679cstate\u548c\u4ece\u7236\u7ec4\u4ef6\u4f20\u8fc7\u6765\u7684props\u90fd\u6ca1\u53d8\u5316\u90a3\u4ed6\u5c31\u4e00\u5b9a\u4e0d\u4f1a\u53d1\u751f\u91cd\u6e32\u67d3\u5417",level:2},{value:"\u4e00\u4e9b\u5168\u5c40\u53d8\u91cf,\u5728\u8bb2\u89e3\u6e90\u7801\u4e4b\u524d\uff0c\u5148\u8ba4\u8bc6\u4e00\u4e9b \u91cd\u8981\u7684\u5168\u5c40\u53d8\u91cf\uff1a",id:"\u4e00\u4e9b\u5168\u5c40\u53d8\u91cf\u5728\u8bb2\u89e3\u6e90\u7801\u4e4b\u524d\u5148\u8ba4\u8bc6\u4e00\u4e9b-\u91cd\u8981\u7684\u5168\u5c40\u53d8\u91cf",level:2},{value:"hooks:\u95ed\u5305 + \u4e24\u7ea7\u94fe\u8868",id:"hooks\u95ed\u5305--\u4e24\u7ea7\u94fe\u8868",level:2},{value:"\u9996\u5148\uff0cHooks\u662f\u4ee5\u5355\u5411\u94fe\u8868\u7684\u5f62\u5f0f\u5b58\u50a8\u5728 Fiber \u7684 memoizedState \u5c5e\u6027\u8eab\u4e0a",id:"\u9996\u5148hooks\u662f\u4ee5\u5355\u5411\u94fe\u8868\u7684\u5f62\u5f0f\u5b58\u50a8\u5728-fiber-\u7684-memoizedstate-\u5c5e\u6027\u8eab\u4e0a",level:3},{value:"\u540c\u65f6\uff0c\u6bcf\u4e2ahooks\u53c8\u62e5\u6709\u81ea\u5df1\u7684\u66f4\u65b0\u961f\u5217queue\uff0cqueue.pending \u4f1a\u6307\u5411\u4e00\u4e2a\u73af\u72b6\u94fe\u8868",id:"\u540c\u65f6\u6bcf\u4e2ahooks\u53c8\u62e5\u6709\u81ea\u5df1\u7684\u66f4\u65b0\u961f\u5217queuequeuepending-\u4f1a\u6307\u5411\u4e00\u4e2a\u73af\u72b6\u94fe\u8868",level:3},{value:"\u4e3a\u4ec0\u4e48\u8981\u662f\u73af\u72b6\u94fe\u8868\uff1f",id:"\u4e3a\u4ec0\u4e48\u8981\u662f\u73af\u72b6\u94fe\u8868",level:2},{value:"\u8f85:\u5355\u5411\u94fe\u8868js\u5b9e\u73b0",id:"\u8f85\u5355\u5411\u94fe\u8868js\u5b9e\u73b0",level:3},{value:"\u8f85:\u73af\u72b6\u94fe\u8868js\u5b9e\u73b0",id:"\u8f85\u73af\u72b6\u94fe\u8868js\u5b9e\u73b0",level:3},{value:"1.\u95ed\u5305",id:"1\u95ed\u5305",level:3},{value:"2.\u7b2c\u4e00\u4e2a\u94fe\u8868\uff1ahooks,\u5355\u5411\u94fe\u8868\u5b9e\u73b0",id:"2\u7b2c\u4e00\u4e2a\u94fe\u8868hooks\u5355\u5411\u94fe\u8868\u5b9e\u73b0",level:3},{value:"2.\u7b2c\u4e8c\u4e2a\u94fe\u8868\uff1a\u73af\u72b6\u94fe\u8868\u5b9e\u73b0",id:"2\u7b2c\u4e8c\u4e2a\u94fe\u8868\u73af\u72b6\u94fe\u8868\u5b9e\u73b0",level:3},{value:"\u73af\u72b6\u94fe\u8868\u5b9e\u73b0",id:"\u73af\u72b6\u94fe\u8868\u5b9e\u73b0",level:3},{value:"Fiber \u6570\u636e\u7ed3\u6784:",id:"fiber-\u6570\u636e\u7ed3\u6784",level:2},{value:"\u4f8b\u5b501",id:"\u4f8b\u5b501",level:3},{value:"\u793a\u4f8b2",id:"\u793a\u4f8b2",level:3},{value:"Hooks \u94fe\u8868\u521b\u5efa\u8fc7\u7a0b",id:"hooks-\u94fe\u8868\u521b\u5efa\u8fc7\u7a0b",level:3},{value:"\u4e3a\u4ec0\u4e48hooks",id:"\u4e3a\u4ec0\u4e48hooks",level:2},{value:"mountWorkInProgressHook\u4f5c\u7528:",id:"mountworkinprogresshook\u4f5c\u7528",level:2},{value:"\u6302\u8f7duseState",id:"\u6302\u8f7dusestate",level:2},{value:"renderWithHooks",id:"renderwithhooks",level:3},{value:"\u5206\u67901:dev\u91cc\u9762\u7684 useState",id:"\u5206\u67901dev\u91cc\u9762\u7684-usestate",level:2},{value:"dispatcher.useState\u5c31\u662fdom\u91cc\u9762\u7684 useState()",id:"dispatcherusestate\u5c31\u662fdom\u91cc\u9762\u7684-usestate",level:2},{value:"\u8c03\u7528 mountState \u51fd\u6570",id:"\u8c03\u7528-mountstate-\u51fd\u6570",level:2},{value:"mountState \u548c dispatchSetState.bind",id:"mountstate-\u548c-dispatchsetstatebind",level:3},{value:"enqueueUpdate$1",id:"enqueueupdate1",level:3},{value:"update\u4f1a\u6267\u884cuseState \u83b7\u53d6\u6700\u65b0\u72b6\u6001",id:"update\u4f1a\u6267\u884cusestate-\u83b7\u53d6\u6700\u65b0\u72b6\u6001",level:2},{value:"updateState--&gt;updateReducer\u4f5c\u7528:\u6700\u540e\u66f4\u65b0 hook \u4e0a\u7684\u53c2\u6570\uff0c\u8fd4\u56de state \u548c dispatch\u3002",id:"updatestate--updatereducer\u4f5c\u7528\u6700\u540e\u66f4\u65b0-hook-\u4e0a\u7684\u53c2\u6570\u8fd4\u56de-state-\u548c-dispatch",level:3},{value:"\u7ee7\u7eed\u770b updateWorkInProgressHook()",id:"\u7ee7\u7eed\u770b-updateworkinprogresshook",level:3}],d={toc:i},p="wrapper";function c(e){let{components:t,...r}=e;return(0,o.kt)(p,(0,a.Z)({},d,r,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"\u590d\u4e60\u6e32\u67d3\u6d41\u7a0b"},"\u590d\u4e60\u6e32\u67d3\u6d41\u7a0b"),(0,o.kt)("mermaid",{value:'flowchart TD\nd1("ReactDOMRoot.prototype.render")--\x3ed2(updateContainer)--\x3ed3(scheduleUpdateOnFiber)--\x3ed4("ensureRootIsScheduled")--\x3ed5\n\nd5("scheduleCallback$1(schedulerPriorityLevel,performConcurrentWorkOnRoot.bind(null, root))")--\u8fd9\u4e2a\u51fd\u6570\u5728render\u7ed3\u675f\u4f1a\u5f00\u542fcommit\u9636\u6bb5--\x3ec2\n\nc2("performConcurrentWorkOnRoot")--1--\x3ee1\n\nc2--2--\x3ec3("flushPassiveEffects()")\n\n%% begin work\ne1(renderRootSync)--\x3ee2("workLoopSync()")--\u5faa\u73af--\x3ee3("performUnitOfWork()")--1--\x3ee4("beginWork$1()")\ne3--2--\x3ee5("completeUnitOfWork")--\x3ee6("completeWork")\n\n%% commit work\nc2--3commit--\x3ec4("finishConcurrentRender")--\x3ec5("commitRoot")'}),(0,o.kt)("h2",{id:"\u63a5\u4e0a\u9762beginworkusestate\u6302\u8f7dhooks\u51fd\u6570\u751f\u6210dispatch\u6302\u8f7d\u94fe\u8868"},"\u63a5\u4e0a\u9762beginWork,useState\u6302\u8f7dhooks\u51fd\u6570;\u751f\u6210dispatch;\u6302\u8f7d\u94fe\u8868"),(0,o.kt)("mermaid",{value:'flowchart TD\na1(beginWork)--case_IndeterminateComponent--\x3ea2("return mountIndeterminateComponent()")--\x3ea3(renderWithHooks)\n\na3--\x3ea4("children=Component(props,secondArg)")--\u6267\u884c\u51fd\u6570\u7ec4\u4ef6--\x3eA1\n\nA1("dev.useState(initialState)")--\x3eA2("return dev.dispatcher.useState(initialState)")\n\nA2--\x3eb1("dom.useState(initialState)<br>return mountState(initialState)")--\x3eb2("mountState(initialState)")\n\n\nb2--1\u5904\u7406\u94fe\u8868--\x3eb5("hook=mountWorkInProgressHook()")\nb2--2\u7ed1\u5b9adispatch--\x3eb4("dispatchSetState.bind(null,currentlyRenderingFiber$1,queue)")\nb2--3--\x3eb3("\u8fd4\u56de[hook.memoizedState,dispatch]")'}),(0,o.kt)("h2",{id:"setstate-\u66f4\u65b0\u91cd\u70b9\u5728dispatchsetstate"},"setState \u66f4\u65b0,\u91cd\u70b9\u5728dispatchSetState"),(0,o.kt)("mermaid",{value:'flowchart TD\nA1("setData(\'\u52aa\u529b\u54e6\')")--\x3ea1(dispatchSetState)\n\n\na1--1update\u6dfb\u52a0\u5230\u73af\u5f62\u94fe\u8868--\x3ea1a("enqueueUpdate$1")\na1--2\u5bf9\u6bd4\u65b0\u65e7\u82e5\u65e0\u66f4\u65b0return--\x3ea2a("objectIs(eagerState, currentState)")\na1--3\u8c03\u5ea6\u66f4\u65b0--\x3ea2("scheduleUpdateOnFiber()")--\x3ea3("performSyncWorkOnRoot()")--\u6682\u65f6\u7701\u7565\u6b65\u9aa4--\x3eb1\n\nb1("beginWork(current,workInProgress,renderLanes)")--case_FunctionComponent--\x3eb2("return updateFunctionComponent(current,workInProgress,..")\nb2--1--\x3eb3("renderWithHooks(current,workInProgress,Component,..")\n\nb2--2--\x3eb4("reconcileChildren")\n\nb3--\u91cd\u70b9\u6267\u884c\u51fd\u6570\u7ec4\u4ef6\u83b7\u53d6\u65b0\u503c--\x3eb5("children=Component(props,secondArg)")\n\nb5--\u91cd\u65b0\u8fd0\u884c\u51fd\u6570\u7ec4\u4ef6--\x3eb6(useState)--\x3eb7("updateState(initialState)")--\x3eb8("return updateReducer")--\x3eb9("return updateReducer(basicStateReducer)")\n\nb9--\x3eb10("updateReducer(reducer)\u8fd4\u56de\u6700\u65b0[hook.memoizedState, dispatch]")\nb10--1--\x3eb11("hook=updateWorkInProgressHook(),hook:\u6700\u65b0\u72b6\u6001\u503c\u548csetState()")--\x3eb13("\u62ff\u5230\u62f7\u8d1d\u540e\u7684hook\uff0c\u53ef\u4ee5\u8ba1\u7b97\u65b0\u72b6\u6001\u503c\u4e86")\nb10--2--\x3eb12("\u8bfb\u53d6\u961f\u5217,\u8ba1\u7b97\u51fa\u6700\u65b0\u72b6\u6001\uff0c\u66f4\u65b0hook\u7684\u72b6\u6001")'}),(0,o.kt)("p",null,"\u5bf9\u4e8e"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"const [state, updateState] = useState(initialState)\n")),(0,o.kt)("p",null,"memoizedState\u4fdd\u5b58state\u7684\u503c"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"mount \u65f6\uff1a\u628a\u4f20\u8fdb\u6765\u7684 value \u5305\u88c5\u6210\u4e00\u4e2a\u542b\u6709 current \u5c5e\u6027\u7684\u5bf9\u8c61\uff0c\u7136\u540e\u653e\u5728 memorizedState \u5c5e\u6027\u4e0a\u3002")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"mount \u65f6\uff1a\u5c06\u521d\u59cb\u503c\u5b58\u653e\u5728memoizedState \u4e2d\uff0cqueue.pending\u7528\u6765\u5b58\u8c03\u7528 setValue\uff08\u5373 dispatch\uff09\u65f6\u521b\u5efa\u7684\u6700\u540e\u4e00\u4e2a update \uff0c\u662f\u4e2a\u73af\u72b6\u94fe\u8868\uff0c\u6700\u7ec8\u8fd4\u56de\u4e00\u4e2a\u6570\u7ec4\uff0c\u5305\u542b\u521d\u59cb\u503c\u548c\u4e00\u4e2a\u7531dispatchState\u521b\u5efa\u7684\u51fd\u6570\u3002\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"update \u65f6\uff1a\u53ef\u4ee5\u770b\u5230\uff0c\u5176\u5b9e\u8c03\u7528\u7684\u662f updateReducer\uff0c\u53ea\u662f reducer \u662f\u56fa\u5b9a\u597d\u7684\uff0c\u4f5c\u7528\u5c31\u662f\u7528\u6765\u76f4\u63a5\u6267\u884c setValue\uff08\u5373 dispatch\uff09 \u51fd\u6570\u4f20\u8fdb\u6765\u7684 action\uff0c\u5373 useState \u5176\u5b9e\u662f\u5bf9 useReducer \u7684\u4e00\u4e2a\u5c01\u88c5\uff0c\u53ea\u662f reducer \u51fd\u6570\u662f\u9884\u7f6e\u597d\u7684\u3002")),(0,o.kt)("h2",{id:"\u4e0d\u540c\u7c7b\u578bhook\u7684memoizedstate\u4fdd\u5b58\u4e0d\u540c\u7c7b\u578b\u6570\u636e\u5177\u4f53\u5982\u4e0b"},"\u4e0d\u540c\u7c7b\u578bhook\u7684memoizedState\u4fdd\u5b58\u4e0d\u540c\u7c7b\u578b\u6570\u636e\uff0c\u5177\u4f53\u5982\u4e0b\uff1a"),(0,o.kt)("p",null,"\u6bd4\u5bf9\u662f\u4f9d\u8d56\u9879\u662f\u5426\u4e00\u81f4\u7684\u65f6\u5019\uff0c\u7528\u7684\u662fObject.is\uff1a"),(0,o.kt)("p",null,"Object.is() \u4e0e === \u4e0d\u76f8\u540c\u3002\u5dee\u522b\u662f\u5b83\u4eec\u5bf9\u5f85\u6709\u7b26\u53f7\u7684\u96f6\u548c NaN \u4e0d\u540c\uff0c\u4f8b\u5982\uff0c=== \u8fd0\u7b97\u7b26\uff08\u4e5f\u5305\u62ec == \u8fd0\u7b97\u7b26\uff09\u5c06\u6570\u5b57 -0 \u548c +0 \u89c6\u4e3a\u76f8\u7b49\uff0c\u800c\u5c06 Number.NaN \u4e0e NaN \u89c6\u4e3a\u4e0d\u76f8\u7b49\u3002"),(0,o.kt)("h3",{id:"updatereducer-\u4e3b\u8981\u5de5\u4f5c"},"updateReducer \u4e3b\u8981\u5de5\u4f5c\uff1a"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"\u5c06 baseQueue \u548c  pendingQueue \u9996\u5c3e\u5408\u5e76\u5f62\u6210\u65b0\u7684\u94fe\u8868")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"baseQueue \u4e3a\u4e4b\u524d\u56e0\u4e3a\u67d0\u4e9b\u539f\u56e0\u5bfc\u81f4\u66f4\u65b0\u4e2d\u65ad\u4ece\u800c\u5269\u4e0b\u7684 update \u94fe\u8868\uff0cpendingQueue \u5219\u662f\u672c\u6b21\u4ea7\u751f\u7684 update\u94fe\u8868\u3002\u4f1a\u628a baseQueue \u63a5\u5728 pendingQueue \u524d\u9762\u3002")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"\u4ece baseQueue.next \u5f00\u59cb\u904d\u5386\u6574\u4e2a\u94fe\u8868\u6267\u884c update\uff0c\u6bcf\u6b21\u5faa\u73af\u4ea7\u751f\u7684 newState\uff0c\u4f5c\u4e3a\u4e0b\u4e00\u6b21\u7684\u53c2\u6570\uff0c\u76f4\u5230\u904d\u5386\u5b8c\u6574\u4e2a\u94fe\u8868\u3002\u5373\u6574\u4e2a\u5408\u5e76\u7684\u94fe\u8868\u662f\u5148\u6267\u884c\u4e0a\u4e00\u6b21\u66f4\u65b0\u540e\u518d\u6267\u884c\u65b0\u7684\u66f4\u65b0\uff0c\u4ee5\u6b64\u4fdd\u8bc1\u66f4\u65b0\u7684\u5148\u540e\u987a\u5e8f\u3002")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"\u6700\u540e\u66f4\u65b0 hook \u4e0a\u7684\u53c2\u6570\uff0c\u8fd4\u56de state \u548c dispatch\u3002"))),(0,o.kt)("h1",{id:"\u5173\u4e8ehook-\u95ee\u9898"},"\u5173\u4e8ehook \u95ee\u9898"),(0,o.kt)("h2",{id:"1react-hooks-\u4e3a\u4ec0\u4e48\u4e0d\u80fd\u5199\u5728\u6761\u4ef6\u8bed\u53e5\u4e2d"},"1.React Hooks \u4e3a\u4ec0\u4e48\u4e0d\u80fd\u5199\u5728\u6761\u4ef6\u8bed\u53e5\u4e2d\uff1f"),(0,o.kt)("p",null,"\u8981\u4fdd\u8bc1 React Hooks \u7684\u987a\u5e8f\u4e00\u81f4\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"const [data, setData] = React.useState('\u6539\u53d8\u6211')\nconst [showDiv, setShowDiv] = React.useState(false)\n")),(0,o.kt)("p",null,"\u6bcf\u4e00\u4e2a\u7ec4\u4ef6\u90fd\u4f1a\u6709\u4e00\u4e2afiber\u5bf9\u8c61\uff0c\u5728fiber\u4e2d\u6211\u4eec\u4e3b\u8981\u5173\u6ce8memoizedState\u8fd9\u4e2a\u5bf9\u8c61\uff0c\u5b83\u5c31\u662f\u8c03\u7528\u5b8cuseState\u540e\u5bf9\u5e94\u7684\u5b58\u50a8state\u7684\u5bf9\u8c61\u3002"),(0,o.kt)("p",null,"\u6bcf\u4e00\u4e2auseState\u90fd\u4f1a\u5728\u5f53\u524d\u7ec4\u4ef6\u4e2d\u521b\u5efa\u4e00\u4e2ahook\u5bf9\u8c61 \uff0c\u5e76\u4e14\u8fd9\u4e2a\u5bf9\u8c61\u4e2d\u7684next\u5c5e\u6027\u59cb\u7ec8\u6267\u884c\u4e0b\u4e00\u4e2auseState\u7684hook\u5bf9\u8c61,\u8fd9\u4e9b\u5bf9\u8c61\u4ee5\u4e00\u79cd\u7c7b\u4f3c\u94fe\u8868\u7684\u5f62\u5f0f\u5b58\u5728 Fiber.memoizedState \u4e2d"),(0,o.kt)("p",null,"\u8c03\u7528useState\u540e\u8bbe\u7f6e\u5728memoizedState\u4e0a\u7684\u5bf9\u8c61\u957f\u8fd9\u6837\uff1a\uff08\u53c8\u53ebHook\u5bf9\u8c61\uff09"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"{\n  baseState,\n  next,  \n  baseUpdate,\n  queue,\n  memoizedState\n}\n")),(0,o.kt)("p",null,"\u800c\u51fd\u6570\u7ec4\u4ef6\u5c31\u662f\u901a\u8fc7fiber\u8fd9\u4e2a\u6570\u636e\u7ed3\u6784\u6765\u5b9e\u73b0\u6bcf\u6b21render\u540ename address\u4e0d\u4f1a\u88abuseState\u91cd\u65b0\u521d\u59cb\u5316\u3002\n\u8fd9\u91cc\u9762\u6211\u4eec\u6700\u9700\u8981\u5173\u5fc3\u7684\u662fmemoizedState\u548cnext\uff0cmemoizedState\u662f\u7528\u6765\u8bb0\u5f55\u8fd9\u4e2auseState\u5e94\u8be5\u8fd4\u56de\u7684\u7ed3\u679c\u7684\uff0c\u800cnext\u6307\u5411\u7684\u662f\u4e0b\u4e00\u6b21useState\u5bf9\u5e94\u7684Hook\u5bf9\u8c61\uff0c\u5373"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"hook1  ==>  Fiber.memoizedState\nstate1 === hook1.memoizedState\nhook1.next  ==> hook2\nstate2  ==> hook2.memoizedState\n....\n")),(0,o.kt)("p",null,"\u901a\u8fc7\u4e0a\u9762\u4ecb\u7ecd\u5df2\u7ecf\u77e5\u9053\u5404\u4e2a hook \u5728 mount \u65f6\u4f1a\u4ee5\u94fe\u8868\u7684\u5f62\u5f0f\u6302\u5230 fiber.memoizedState\u4e0a\u3002\nupdate \u65f6\u4f1a\u8fdb\u5165\u5230 HooksDispatcherOnUpdateInDEV\uff0c\u6267\u884c\u4e0d\u540c hook \u7684 updateXxx \u65b9\u6cd5\u3002"),(0,o.kt)("p",null,"\u6700\u7ec8\u4f1a\u901a\u8fc7 updateWorkInProgressHook\u65b9\u6cd5\u83b7\u53d6\u5f53\u524d hook \u7684\u5bf9\u8c61\uff0c\u83b7\u53d6\u65b9\u5f0f\u5c31\u662f\u4ece\u5f53\u524d fiber.memoizedState\u4e0a\u4f9d\u6b21\u83b7\u53d6\uff0c\u904d\u5386\u7684\u662f mount \u9636\u6bb5\u521b\u5efa\u7684\u94fe\u8868\uff0c\u6545\u4e0d\u80fd\u6539\u53d8 hook \u7684\u6267\u884c\u987a\u5e8f\uff0c\u5426\u5219\u4f1a\u62ff\u9519\u3002\uff08updateWorkInProgressHook \u4e5f\u662f\u4e2a\u901a\u7528\u65b9\u6cd5\uff0cupdateXXX \u90fd\u662f\u8d70\u5230\u8fd9\u4e2a\u5730\u65b9\uff09"),(0,o.kt)("p",null,"\u51fd\u6570\u7ec4\u4ef6\u7684\u72b6\u6001\u662f\u4fdd\u5b58\u5728 fiber.memorizedState \u4e2d\u7684\u3002\u5b83\u662f\u4e00\u4e2a\u94fe\u8868\uff0c\u4fdd\u5b58\u8c03\u7528 Hook \u751f\u6210\u7684 hook \u5bf9\u8c61\uff0c\u8fd9\u4e9b\u5bf9\u8c61\u4fdd\u5b58\u7740\u72b6\u6001\u503c\u3002\u5f53\u66f4\u65b0\u65f6\uff0c\u6211\u4eec\u6bcf\u8c03\u7528\u4e00\u4e2a Hook\uff0c\u5176\u5b9e\u5c31\u662f\u4ece fiber.memorizedState \u94fe\u8868\u4e2d\u8bfb\u53d6\u4e0b\u4e00\u4e2a hook\uff0c\u53d6\u51fa\u5b83\u7684\u72b6\u6001\u3002"),(0,o.kt)("p",null,"\u5982\u679c\u987a\u5e8f\u4e0d\u4e00\u81f4\u4e86\u6216\u8005\u6570\u91cf\u4e0d\u4e00\u81f4\u4e86\uff0c\u5c31\u4f1a\u5bfc\u81f4\u9519\u8bef\uff0c\u53d6\u51fa\u4e86\u4e00\u4e2a\u5176\u4ed6 Hook \u5bf9\u5e94\u7684\u72b6\u6001\u503c\u3002"),(0,o.kt)("p",null,"\u6b63\u662f\u56e0\u4e3ahooks\u4e2d\u662f\u8fd9\u6837\u5b58\u50a8state\u7684 \u6240\u4ee5\u6211\u4eec\u53ea\u80fd\u5728hooks\u7684\u6839\u4f5c\u7528\u57df\u4e2d\u4f7f\u7528useState\uff0c\u800c\u4e0d\u80fd\u5728\u6761\u4ef6\u8bed\u53e5\u548c\u5faa\u73af\u4e2d\u4f7f\u7528,\u56e0\u4e3a\u6211\u4eec\u4e0d\u80fd\u6bcf\u6b21\u90fd\u4fdd\u8bc1\u6761\u4ef6\u6216\u5faa\u73af\u8bed\u53e5\u90fd\u4f1a\u6267\u884c:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"if (something) {\n  const [state1] = useState(1)\n}\n\n// or\n\nfor (something) {\n  const [state2] = useState(2)\n}\n")),(0,o.kt)("h2",{id:"\u95ee\u98981-setstate\u51fd\u6570\u5728\u4efb\u4f55\u60c5\u51b5\u4e0b\u90fd\u4f1a\u5bfc\u81f4\u7ec4\u4ef6\u91cd\u6e32\u67d3\u5417\u5982\u679csetstate\u4e2d\u7684state\u6ca1\u6709\u53d1\u751f\u6539\u53d8\u5462"},"\u95ee\u98981\uff1a setState()\u51fd\u6570\u5728\u4efb\u4f55\u60c5\u51b5\u4e0b\u90fd\u4f1a\u5bfc\u81f4\u7ec4\u4ef6\u91cd\u6e32\u67d3\u5417\uff1f\u5982\u679csetState\u4e2d\u7684state\u6ca1\u6709\u53d1\u751f\u6539\u53d8\u5462\uff1f"),(0,o.kt)("p",null,"\u6bd4\u5bf9\u662f\u4f9d\u8d56\u9879\u662f\u5426\u4e00\u81f4\u7684\u65f6\u5019\uff0c\u7528\u7684\u662fObject.is\uff1a"),(0,o.kt)("p",null,"Object.is() \u4e0e === \u4e0d\u76f8\u540c\u3002\u5dee\u522b\u662f\u5b83\u4eec\u5bf9\u5f85\u6709\u7b26\u53f7\u7684\u96f6\u548c NaN \u4e0d\u540c\uff0c\u4f8b\u5982\uff0c=== \u8fd0\u7b97\u7b26\uff08\u4e5f\u5305\u62ec == \u8fd0\u7b97\u7b26\uff09\u5c06\u6570\u5b57 -0 \u548c +0 \u89c6\u4e3a\u76f8\u7b49\uff0c\u800c\u5c06 Number.NaN \u4e0e NaN \u89c6\u4e3a\u4e0d\u76f8\u7b49\u3002"),(0,o.kt)("p",null,"\u4f8b5-\u4e3b\u8981\u6d4b\u8bd5\u5b9e5-\u6ca1\u6709\u5bfc\u81f4state\u7684\u503c\u53d1\u751f\u53d8\u5316\u7684setState\u662f\u5426\u4f1a\u5bfc\u81f4\u91cd\u6e32\u67d3.html"),(0,o.kt)("p",null,"\u6ca1\u6709\u5bfc\u81f4state\u7684\u503c\u53d1\u751f\u53d8\u5316\u7684this.setState()\u662f\u5426\u4f1a\u5bfc\u81f4\u91cd\u6e32\u67d3--\x3e\u4e0d\u4f1a"),(0,o.kt)("h2",{id:"\u95ee\u98982-\u5982\u679cstate\u548c\u4ece\u7236\u7ec4\u4ef6\u4f20\u8fc7\u6765\u7684props\u90fd\u6ca1\u53d8\u5316\u90a3\u4ed6\u5c31\u4e00\u5b9a\u4e0d\u4f1a\u53d1\u751f\u91cd\u6e32\u67d3\u5417"},"\u95ee\u98982\uff1a \u5982\u679cstate\u548c\u4ece\u7236\u7ec4\u4ef6\u4f20\u8fc7\u6765\u7684props\u90fd\u6ca1\u53d8\u5316\uff0c\u90a3\u4ed6\u5c31\u4e00\u5b9a\u4e0d\u4f1a\u53d1\u751f\u91cd\u6e32\u67d3\u5417\uff1f"),(0,o.kt)("p",null,"\u5b58\u7591\uff1f\u8fd9\u4e2a\u95ee\u9898\u8fd8\u6ca1\u63a2\u7a76"),(0,o.kt)("p",null,"\u5f53React\u91cd\u65b0\u6e32\u67d3\u65f6ParentComponent\uff0c\u5b83\u5c06\u81ea\u52a8\u91cd\u65b0\u6e32\u67d3ChildComponent\u3002\u8981\u89e3\u51b3\u7684\u552f\u4e00\u9014\u5f84\u662f\u5b9e\u73b0shouldComponentUpdate"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"shouldComponentUpdate(nextProps,nextState){\n    if(nextState.Number == this.state.Number){\n      return false\n    }\n}\n")),(0,o.kt)("h1",{id:"\u524d\u8a00"},"\u524d\u8a00"),(0,o.kt)("h2",{id:"\u4e00\u4e9b\u5168\u5c40\u53d8\u91cf\u5728\u8bb2\u89e3\u6e90\u7801\u4e4b\u524d\u5148\u8ba4\u8bc6\u4e00\u4e9b-\u91cd\u8981\u7684\u5168\u5c40\u53d8\u91cf"},"\u4e00\u4e9b\u5168\u5c40\u53d8\u91cf,\u5728\u8bb2\u89e3\u6e90\u7801\u4e4b\u524d\uff0c\u5148\u8ba4\u8bc6\u4e00\u4e9b \u91cd\u8981\u7684\u5168\u5c40\u53d8\u91cf\uff1a"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"currentlyRenderingFiber\uff1a\u6b63\u5728\u5904\u7406\u7684\u51fd\u6570\u7ec4\u4ef6\u5bf9\u5e94 fiber\u3002\u5728\u6267\u884c useState \u7b49 hook \u65f6\uff0c\u9700\u8981\u901a\u8fc7\u5b83\u77e5\u9053\u5f53\u524d hook \u5bf9\u5e94\u54ea\u4e2a fiber\u3002")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"workInProgressHook\uff1a\u6302\u8f7d\u65f6\u6b63\u5728\u5904\u7406\u7684 hook \u5bf9\u8c61\u3002\u6211\u4eec\u4f1a\u6cbf\u7740 workInProcess.memoizedState \u94fe\u8868\u4e00\u4e2a\u4e2a\u5f80\u4e0b\u8d70\uff0c\u8fd9\u4e2a workInProgressHook \u5c31\u662f\u8be5\u94fe\u8868\u7684\u6307\u9488\u3002")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"currentHook\uff1a\u65e7\u7684 fiber \u7684 hooks \u94fe\u8868\uff08current.memorizedState\uff09\u6307\u9488\u3002")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"ReactCurrentDispatcher\uff1a\u5168\u5c40\u5bf9\u8c61\uff0c\u662f\u4e00\u4e2a hook \u8c03\u5ea6\u5668\u5bf9\u8c61\uff0c\u5176\u4e0b\u6709 useState\u3001useEffect \u7b49\u65b9\u6cd5\uff0c\u662f\u6211\u4eec\u4e1a\u52a1\u4ee3\u7801\u4e2d hook \u5e95\u5c42\u8c03\u7528\u7684\u65b9\u6cd5\u3002ReactCurrentDispatcher \u6709\u4e09\u79cd\uff1a"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"ContextOnlyDispatcher\uff1a\u6240\u6709\u65b9\u6cd5\u90fd\u4f1a\u629b\u51fa\u9519\u8bef\uff0c\u7528\u4e8e\u9632\u6b62\u5f00\u53d1\u8005\u5728\u8c03\u7528\u51fd\u6570\u7ec4\u4ef6\u7684\u5176\u4ed6\u65f6\u673a\u8c03\u7528 React Hook\uff1b"),(0,o.kt)("li",{parentName:"ul"},"HooksDispatcherOnMount\uff1a\u6302\u8f7d\u9636\u6bb5\u7528\u3002\u6bd4\u5982\u5b83\u7684 useState \u8981\u5c06\u521d\u59cb\u503c\u4fdd\u5b58\u8d77\u6765\uff1b"),(0,o.kt)("li",{parentName:"ul"},"HooksDispatcherOnUpdate\uff1a\u66f4\u65b0\u9636\u6bb5\u7528\u3002\u6bd4\u5982\u5b83\u7684 useState \u4f1a\u65e0\u89c6\u4f20\u5165\u7684\u521d\u59cb\u503c\uff0c\u800c\u662f\u4ece\u94fe\u8868\u4e2d\u53d6\u51fa\u503c\u3002")))),(0,o.kt)("h2",{id:"hooks\u95ed\u5305--\u4e24\u7ea7\u94fe\u8868"},"hooks:\u95ed\u5305 + \u4e24\u7ea7\u94fe\u8868"),(0,o.kt)("h3",{id:"\u9996\u5148hooks\u662f\u4ee5\u5355\u5411\u94fe\u8868\u7684\u5f62\u5f0f\u5b58\u50a8\u5728-fiber-\u7684-memoizedstate-\u5c5e\u6027\u8eab\u4e0a"},"\u9996\u5148\uff0cHooks\u662f\u4ee5\u5355\u5411\u94fe\u8868\u7684\u5f62\u5f0f\u5b58\u50a8\u5728 Fiber \u7684 memoizedState \u5c5e\u6027\u8eab\u4e0a"),(0,o.kt)("mermaid",{value:"graph LR\n1[Fiber] --memoized--\x3e 2[useReducer] --next--\x3e3[userState]--next--\x3e4[useEffect]"}),(0,o.kt)("h3",{id:"\u540c\u65f6\u6bcf\u4e2ahooks\u53c8\u62e5\u6709\u81ea\u5df1\u7684\u66f4\u65b0\u961f\u5217queuequeuepending-\u4f1a\u6307\u5411\u4e00\u4e2a\u73af\u72b6\u94fe\u8868"},"\u540c\u65f6\uff0c\u6bcf\u4e2ahooks\u53c8\u62e5\u6709\u81ea\u5df1\u7684\u66f4\u65b0\u961f\u5217queue\uff0cqueue.pending \u4f1a\u6307\u5411\u4e00\u4e2a\u73af\u72b6\u94fe\u8868"),(0,o.kt)("mermaid",{value:"graph LR\n1[Fiber] ==> |memoized|2[useReducer] ==>|next| 3[userState]==>|next| 4[useEffect]\n\n2 -.->|quene.pending| B1((update3))--next--\x3eB2\n\nB2((update1))--next--\x3eB3((update2))--next--\x3eB1"}),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"\u7531\u56fe\u53ef\u77e5\uff0cqueue.pending \u6c38\u8fdc\u6307\u5411\u6700\u540e\u4e00\u4e2a\u66f4\u65b0"),(0,o.kt)("li",{parentName:"ul"},"\u7531\u56fe\u53ef\u77e5\uff0cpending.next \u6c38\u8fdc\u6307\u5411\u7b2c\u4e00\u4e2a\u66f4\u65b0")),(0,o.kt)("h2",{id:"\u4e3a\u4ec0\u4e48\u8981\u662f\u73af\u72b6\u94fe\u8868"},"\u4e3a\u4ec0\u4e48\u8981\u662f\u73af\u72b6\u94fe\u8868\uff1f"),(0,o.kt)("p",null,"\u4e3a\u4ec0\u4e48\u8981\u7528\u73af\u72b6\u94fe\u8868\u5462?\n\u56e0\u4e3aReact\u7684\u66f4\u65b0\u4efb\u52a1\u662f\u6709\u4f18\u5148\u7ea7\u7684\u3002"),(0,o.kt)("p",null,"\u5047\u5982\u6709\u4e09\u4e2a update\uff0c\u7b2c\u4e8c\u4e2aupdate\u7684\u4f18\u5148\u7ea7\u6bd4\u8f83\u9ad8\uff0c\u90a3\u4e48\u4f1a\u5148\u6267\u884c\u7b2c\u4e8c\u4e2a update\uff0c\u5355\u5411\u94fe\u8868\u53ef\u80fd\u4f1a\u5bfc\u81f4\u7b2c\u4e00\u4e2aupdate\u4e22\u5931\uff0c\u800c\u73af\u72b6\u94fe\u8868\u7684\u4f18\u52bf\u5728\u4e8e\u53ef\u4ee5\u4ece\u4efb\u4f55\u8282\u70b9\u5f00\u59cb\u5faa\u73af\u94fe\u8868\u3002\u603b\u7ed3\u6765\u8bf4\uff1a\u73af\u72b6\u94fe\u8868\u53ef\u4ee5\u4fdd\u8bc1update\u4e0d\u4e22\u5931\uff0c\u5e76\u4e14\u4fdd\u8bc1\u72b6\u6001\u4f9d\u8d56\u7684\u8fde\u7eed\u6027\u3002"),(0,o.kt)("p",null,"\u5728\u83b7\u53d6\u5934\u90e8\u6216\u8005\u63d2\u5165\u5c3e\u90e8\u7684\u65f6\u5019\u907f\u514d\u4e0d\u5fc5\u8981\u7684\u904d\u5386\u64cd\u4f5c"),(0,o.kt)("p",null,"\uff08\u4e0a\u9762\u63d0\u5230\u7684 fiber.updateQueue \u3001 useEffect \u521b\u5efa\u7684 hook \u5bf9\u8c61\u4e2d\u7684 memoizedState \u5b58\u7684 effect \u73af\u72b6\u94fe\u8868\uff0c\u4ee5\u53ca useState \u7684 queue.pending \u4e0a\u7684 update \u5bf9\u8c61\u7684\u73af\u72b6\u94fe\u8868\uff0c\u90fd\u662f\u8fd9\u4e2a\u539f\u56e0\uff09"),(0,o.kt)("p",null,"\u65b9\u4fbf\u5b9a\u4f4d\u5230\u94fe\u8868\u7684\u7b2c\u4e00\u4e2a\u5143\u7d20\u3002updateQueue \u6307\u5411\u5b83\u7684\u6700\u540e\u4e00\u4e2a update\uff0cupdateQueue.next \u6307\u5411\u5b83\u7684\u7b2c\u4e00\u4e2aupdate\u3002"),(0,o.kt)("p",null,"\u82e5\u4e0d\u4f7f\u7528\u73af\u72b6\u94fe\u8868\uff0cupdateQueue \u6307\u5411\u6700\u540e\u4e00\u4e2a\u5143\u7d20\uff0c\u9700\u8981\u904d\u5386\u624d\u80fd\u83b7\u53d6\u94fe\u8868\u9996\u90e8\u3002\u5373\u4f7f\u5c06updateQueue\u6307\u5411\u7b2c\u4e00\u4e2a\u5143\u7d20\uff0c\u90a3\u4e48\u65b0\u589eupdate\u65f6\u4ecd\u7136\u8981\u904d\u5386\u5230\u5c3e\u90e8\u624d\u80fd\u5c06\u65b0\u589e\u7684\u63a5\u5165\u94fe\u8868\u3002"),(0,o.kt)("h3",{id:"\u8f85\u5355\u5411\u94fe\u8868js\u5b9e\u73b0"},"\u8f85:\u5355\u5411\u94fe\u8868js\u5b9e\u73b0"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function buildQueue(queue,action){\n    const update = {action,next:null}\n    const pending = queue.pending\n \n    if(!pending){\n        queue.pending = update\n    }else{\n        let current = queue.pending\n        // \u627e\u5230\u672b\u5c3e\u7684\u5143\u7d20\n        while(current.next){\n            current = current.next\n        }\n        // \u5c06update\u6302\u8f7d\u5230\u94fe\u8868\u7684\u672b\u5c3e\n        current.next = update\n    }\n}\n \n// excute\nlet queue = {pending:null}\nbuildQueue(queue,'hooks1')\nbuildQueue(queue,'hooks2')\n \n// output: queue.pending = {action:'hooks1',next:{action:'hooks2',next:null}}\n")),(0,o.kt)("h3",{id:"\u8f85\u73af\u72b6\u94fe\u8868js\u5b9e\u73b0"},"\u8f85:\u73af\u72b6\u94fe\u8868js\u5b9e\u73b0"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function dispatchAction(queue,action){\n     const update = {action,next:null}\n     const pending = queue.pending\n     if(pending === null){\n        update.next = update // \u81ea\u5df1\u4e0e\u81ea\u5df1\u521b\u5efa\u4e00\u4e2a\u73af\u72b6\u94fe\u8868\n     }else{\n        update.next = pending.next\n        pending.next = update\n     }\n     queue.pending = update\n}\n \nlet queue = {pending:null}\n \n/**\n * update.next === update\n * queue.pending === update(action) \n */\ndispatchAction(queue,'action')\n \n \n/**\n * update(action1).next -> update(action).next [update(action)]    \n * update1 \u7684next \u6307\u5411 update\n * queue.pending.next [update(update)] -> update(action1)          \n * update \u6307\u5411 update1\n * queue.pending -> update(action1)                                \n * queue.pending \u6307\u5411 update1\n */\ndispatchAction(queue,'action1')\n")),(0,o.kt)("h3",{id:"1\u95ed\u5305"},"1.\u95ed\u5305"),(0,o.kt)("p",null,"\u95ed\u5305\u662f\u6307\u6709\u6743\u8bbf\u95ee\u53e6\u4e00\u4e2a\u51fd\u6570\u4f5c\u7528\u57df\u4e2d\u53d8\u91cf\u6216\u65b9\u6cd5\u7684\u51fd\u6570\uff0c\u521b\u5efa\u95ed\u5305\u7684\u65b9\u5f0f\u5c31\u662f\u5728\u4e00\u4e2a\u51fd\u6570\u5185\u521b\u5efa\u95ed\u5305\u51fd\u6570\uff0c\u901a\u8fc7\u95ed\u5305\u51fd\u6570\u8bbf\u95ee\u8fd9\u4e2a\u51fd\u6570\u7684\u5c40\u90e8\u53d8\u91cf, \u5229\u7528\u95ed\u5305\u53ef\u4ee5\u7a81\u7834\u4f5c\u7528\u94fe\u57df\u7684\u7279\u6027\uff0c\u5c06\u51fd\u6570\u5185\u90e8\u7684\u53d8\u91cf\u548c\u65b9\u6cd5\u4f20\u9012\u5230\u5916\u90e8\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"export default function Hooks() {\n  const [count, setCount] = useState(0);\n  const [age, setAge] = useState(18);\n\n  const self = useRef(0);\n\n  const onClick = useCallback(() => {\n    setAge(19);\n    setAge(20);\n    setAge(21);\n  }, []);\n\n  console.log('self', self.current);\n  return (\n    <div>\n      <h2>\u5e74\u9f84\uff1a {age} <a onClick={onClick}>\u589e\u52a0</a></h2>\n      <h3>\u8f6e\u6b21\uff1a {count} <a onClick={() => setCount(count => count + 1)}>\u589e\u52a0</a></h3>\n    </div>\n  );\n}\n")),(0,o.kt)("p",null,"\u4ee5\u4e0a\u9762\u7684\u793a\u4f8b\u6765\u8bb2\uff0c\u95ed\u5305\u5c31\u662fsetAge\u8fd9\u4e2a\u51fd\u6570\uff0c\u4f55\u4ee5\u89c1\u5f97\u5462\uff0c\u770b\u7ec4\u4ef6\u6302\u8f7d\u9636\u6bb5hook\u6267\u884c\u7684\u6e90\u7801\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function useState(initialState) {\n  console.log('=useState=dev=\u8c03\u7528mountState', { initialState })\n  var dispatcher = resolveDispatcher();\n  return dispatcher.useState(initialState);\n}\n\nuseState: function (initialState) {\n  currentHookNameInDev = 'useState';\n  mountHookTypesDev();\n  var prevDispatcher = ReactCurrentDispatcher$1.current;\n  ReactCurrentDispatcher$1.current = InvalidNestedHooksDispatcherOnMountInDEV;\n\n  try {\n    console.log('=useState=\u8c03\u7528mountState', { initialState })\n    return mountState(initialState);\n  } finally {\n    ReactCurrentDispatcher$1.current = prevDispatcher;\n  }\n}\n\nfunction mountState(initialState) {\n  var hook = mountWorkInProgressHook();\n\n  if (typeof initialState === 'function') {\n    // $FlowFixMe: Flow doesn't like mixed types\n    initialState = initialState();\n  }\n\n  hook.memoizedState = hook.baseState = initialState;\n  var queue = {\n    pending: null,\n    interleaved: null,\n    lanes: NoLanes,\n    dispatch: null,\n    lastRenderedReducer: basicStateReducer,\n    lastRenderedState: initialState\n  };\n  hook.queue = queue;\n\n  // \u91cd\u70b9\n  var dispatch = queue.dispatch = dispatchSetState.bind(null, currentlyRenderingFiber$1, queue)\n  console.log('=useState=dom=\u5229\u7528bind\u8fd4\u56dedispatch:', { dispatch })\n  return [hook.memoizedState, dispatch];\n}\n")),(0,o.kt)("p",null,"\u800c\u4ea7\u751f\u7684\u95ed\u5305\u5c31\u662fdispatch\u51fd\u6570\uff08\u5bf9\u5e94\u4e0a\u9762\u7684setAge\uff09\uff0c\u88ab\u95ed\u5305\u5f15\u7528\u7684\u53d8\u91cf\u5c31\u662f\ncurrentlyRenderingFiber \u4e0e queue\u3002"),(0,o.kt)("p",null,"currentlyRenderingFiber: \u5176\u5b9e\u5c31\u662fworkInProgressTree, \u5373\u66f4\u65b0\u65f6\u94fe\u8868\u5f53\u524d\u6b63\u5728\u904d\u5386\u7684fiber\u8282\u70b9"),(0,o.kt)("p",null,"queue: \u6307\u5411hook.queue\uff0c\u4fdd\u5b58\u5f53\u524dhook\u64cd\u4f5c\u76f8\u5173\u7684reducer \u548c \u72b6\u6001\u7684\u5bf9\u8c61\uff0c\u5176\u6765\u6e90\u4e8emountWorkInProgressHook\u8fd9\u4e2a\u51fd\u6570\uff0c\u4e0b\u9762\u91cd\u70b9\u8bb2\uff1b"),(0,o.kt)("p",null,"\u8fd9\u4e2a\u95ed\u5305\u5c06 fiber\u8282\u70b9\u4e0eaction, action \u4e0e state\u5f88\u597d\u7684\u4e32\u8054\u8d77\u6765\u4e86\uff0c\u4e3e\u4e0a\u9762\u7684\u4f8b\u5b50\u5c31\u662f\uff1a"),(0,o.kt)("p",null,"\u5f53\u70b9\u51fb\u589e\u52a0\u6267\u884csetAge, \u6267\u884c\u540e\uff0c\u65b0\u7684state\u66f4\u65b0\u4efb\u52a1\u5c31\u50a8\u5b58\u5728fiber\u8282\u70b9\u7684hook.queue\u4e0a\uff0c\u5e76\u89e6\u53d1\u66f4\u65b0\uff1b"),(0,o.kt)("p",null,"\u5f53\u8282\u70b9\u66f4\u65b0\u65f6\uff0c\u4f1a\u904d\u5386queue\u4e0a\u7684state\u4efb\u52a1\u94fe\u8868\uff0c\u8ba1\u7b97\u6700\u7ec8\u7684state\uff0c\u5e76\u8fdb\u884c\u6e32\u67d3\uff1b"),(0,o.kt)("p",null,"ok\uff0c\u5230\u8fd9\uff0c\u95ed\u5305\u5c31\u8bb2\u5b8c\u4e86\u3002"),(0,o.kt)("h3",{id:"2\u7b2c\u4e00\u4e2a\u94fe\u8868hooks\u5355\u5411\u94fe\u8868\u5b9e\u73b0"},"2.\u7b2c\u4e00\u4e2a\u94fe\u8868\uff1ahooks,\u5355\u5411\u94fe\u8868\u5b9e\u73b0"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"/*\nHooks are stored as a linked list on the fiber's memoizedState field.  \nhooks \u4ee5\u94fe\u8868\u7684\u5f62\u5f0f\u5b58\u50a8\u5728fiber\u8282\u70b9\u7684memoizedState\u5c5e\u6027\u4e0a\nThe current hook list is the list that belongs to the current fiber.\n\u5f53\u524d\u7684hook\u94fe\u8868\u5c31\u662f\u5f53\u524d\u6b63\u5728\u904d\u5386\u7684fiber\u8282\u70b9\u4e0a\u7684\nThe work-in-progress hook list is a new list that will be added to the work-in-progress fiber.\nwork-in-progress hook \u5c31\u662f\u5373\u5c06\u88ab\u6dfb\u52a0\u5230\u6b63\u5728\u904d\u5386fiber\u8282\u70b9\u7684hooks\u65b0\u94fe\u8868\n*/\nlet currentHook: Hook | null = null;\nlet nextCurrentHook: Hook | null = null;\n")),(0,o.kt)("p",null,"\u4ece\u4e0a\u9762\u7684\u6e90\u7801\u6ce8\u91ca\u53ef\u4ee5\u770b\u51fahooks\u94fe\u8868\u4e0efiber\u94fe\u8868\u662f\u6781\u5176\u76f8\u4f3c\u7684\uff1b\u4e5f\u5f97\u77e5hooks \u94fe\u8868\u662f\u4fdd\u5b58\u5728fiber\u8282\u70b9\u7684memoizedState\u5c5e\u6027\u7684, "),(0,o.kt)("p",null,"\u8fd9\u4e2ahooks \u94fe\u8868\u5177\u4f53\u6307\u4ec0\u4e48\uff1f\n\u5176\u5b9e\u5c31\u662f\u6307\u4e00\u4e2a\u7ec4\u4ef6\u5305\u542b\u7684hooks, \u6bd4\u5982\u4e0a\u9762\u793a\u4f8b\u4e2d\u7684\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"const [count, setCount] = useState(0);\nconst [age, setAge] = useState(18);\nconst self = useRef(0);\nconst onClick = useCallback(() => {\n  setAge(19);\n  setAge(20);\n  setAge(21);\n}, []);\n")),(0,o.kt)("p",null,"\u5f62\u6210\u7684\u94fe\u8868\u5c31\u662f\u4e0b\u9762\u8fd9\u6837\u7684\uff1a"),(0,o.kt)("p",null,(0,o.kt)("img",{src:n(18861).Z,width:"1223",height:"397"})),(0,o.kt)("p",null,"\u6240\u4ee5\u5728\u4e0b\u4e00\u6b21\u66f4\u65b0\u65f6\uff0c\u518d\u6b21\u6267\u884chook\uff0c\u5c31\u4f1a\u53bb\u83b7\u53d6\u5f53\u524d\u8fd0\u884c\u8282\u70b9\u7684hooks\u94fe\u8868\uff1b"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"const hook = updateWorkInProgressHook();\n// updateWorkInProgressHook \u5c31\u662f\u4e00\u4e2a\u7eaf\u94fe\u8868\u7684\u64cd\u4f5c\uff1a\u6307\u5411\u4e0b\u4e00\u4e2a hook\u8282\u70b9\n")),(0,o.kt)("p",null,"\u5230\u8fd9 hooks \u94fe\u8868\u662f\u4ec0\u4e48\uff0c\u5e94\u8be5\u5c31\u660e\u767d\u4e86\uff1b\u8fd9\u65f6\u4f60\u53ef\u80fd\u4f1a\u66f4\u660e\u767d\uff0c\u4e3a\u4ec0\u4e48hooks\u4e0d\u80fd\u5728\u5faa\u73af\uff0c\u5224\u65ad\u8bed\u53e5\u4e2d\u8c03\u7528\uff0c\u800c\u53ea\u80fd\u5728\u51fd\u6570\u6700\u5916\u5c42\u4f7f\u7528\uff0c\u56e0\u4e3a\u6302\u8f7d\u6216\u5219\u66f4\u65b0\u65f6\uff0c\u8fd9\u4e2a\u961f\u5217\u9700\u8981\u662f\u4e00\u81f4\u7684\uff0c\u624d\u80fd\u4fdd\u8bc1hooks\u7684\u7ed3\u679c\u6b63\u786e\u3002"),(0,o.kt)("h3",{id:"2\u7b2c\u4e8c\u4e2a\u94fe\u8868\u73af\u72b6\u94fe\u8868\u5b9e\u73b0"},"2.\u7b2c\u4e8c\u4e2a\u94fe\u8868\uff1a\u73af\u72b6\u94fe\u8868\u5b9e\u73b0"),(0,o.kt)("p",null,"state \u94fe\u8868\u4e0d\u662fhooks\u72ec\u6709\u7684\uff0c\u7c7b\u64cd\u4f5c\u7684setState\u4e5f\u5b58\u5728\uff0c\u6b63\u662f\u7531\u4e8e\u8fd9\u4e2a\u94fe\u8868\u5b58\u5728\uff0c\u6240\u4ee5\u6709\u4e00\u4e2a\u7ecf\u5178React \u9762\u8bd5\u9898\uff1a"),(0,o.kt)("p",null,"setState\u4e3a\u4ec0\u4e48\u9ed8\u8ba4\u662f\u5f02\u6b65\uff0c\u4ec0\u4e48\u65f6\u5019\u662f\u540c\u6b65\uff1f"),(0,o.kt)("p",null,"\u53c2\u8003\uff1a",(0,o.kt)("a",{parentName:"p",href:"./setState%E5%BC%82%E6%AD%A5-%E5%90%8C%E6%AD%A5"},"React/setState\u7684\u5f02\u6b65\u548c\u540c\u6b65\u95ee\u9898")),(0,o.kt)("h3",{id:"\u73af\u72b6\u94fe\u8868\u5b9e\u73b0"},"\u73af\u72b6\u94fe\u8868\u5b9e\u73b0"),(0,o.kt)("p",null,"\u5efa\u7acb\u8fd9\u4e2a\u94fe\u8868\u7684\u903b\u8f91\u5c31\u5728 dispatchSetState--\x3eenqueueUpdate$1\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"update(action1).next -> update(action).next [update(action)]    \nupdate1 \u7684next \u6307\u5411 update\nqueue.pending.next [update(update)] -> update(action1)          \nupdate \u6307\u5411 update1\nqueue.pending -> update(action1)                                \nqueue.pending \u6307\u5411 update1\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function dispatchSetState(fiber, queue, action) {\n  // \u7701\u7565..\n  // \u521b\u5efa\u4e00\u4e2a update \u66f4\u65b0\u5bf9\u8c61\n  var update = {\n    lane: lane,\n    action: action,\n    hasEagerState: false,\n    eagerState: null,\n    next: null\n  };\n  if (isRenderPhaseUpdate(fiber)) {\n    console.log('=useState=app=dispatchSetState\u8c03\u7528enqueueRenderPhaseUpdate\u6e32\u67d3\u9636\u6bb5\u66f4\u65b0:')\n    enqueueRenderPhaseUpdate(queue, update);\n  } else {\n    enqueueUpdate$1(fiber, queue, update);\n  }\n\n  // \u7701\u7565..\n}\n\nfunction enqueueUpdate$1(fiber, queue, update, lane) {\n  if (isInterleavedUpdate(fiber)) {\n    var interleaved = queue.interleaved;\n\n    if (interleaved === null) {\n      // This is the first update. Create a circular list.\n      update.next = update; // At the end of the current render, this queue's interleaved updates will\n      // be transferred to the pending queue.\n\n      pushInterleavedQueue(queue);\n    } else {\n      update.next = interleaved.next;\n      interleaved.next = update;\n    }\n\n    queue.interleaved = update;\n  } else {\n\n    console.log('=useState=app=enqueueUpdate$1\u5c06update\u5bf9\u8c61\u6dfb\u52a0\u5230hook.queue.pending\u961f\u5217')\n    var pending = queue.pending;\n\n    if (pending === null) {\n      // This is the first update. Create a circular list.\n      console.log('=useState=app=\u9996\u4e2aupdate 2, \u81ea\u5df1\u6307\u5411\u81ea\u5df1\u521b\u5efa\u4e00\u4e2a\u73af\u72b6\u94fe\u8868,\u521b\u5efa\u4e00\u4e2a\u73af\u5f62\u94fe\u8868')\n      update.next = update;\n    } else {\n      update.next = pending.next;\n      pending.next = update;\n    }\n\n    queue.pending = update;\n  }\n}\n")),(0,o.kt)("p",null,"\u6267\u884csetAge \u53ea\u662f\u5f62\u6210\u4e86\u72b6\u6001\u5f85\u6267\u884c\u4efb\u52a1\u94fe\u8868\uff0c\u771f\u6b63\u5f97\u5230\u6700\u7ec8\u72b6\u6001\uff0c\u5176\u5b9e\u662f\u5728\u4e0b\u4e00\u6b21\u66f4\u65b0(\u83b7\u53d6\u72b6\u6001)\u65f6\uff0c\u5373\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"// \u8bfb\u53d6\u6700\u65b0age\nconst [age, setAge] = useState(18);\n")),(0,o.kt)("p",null,"\u800c\u83b7\u53d6\u6700\u65b0\u72b6\u6001\u7684\u76f8\u5173\u4ee3\u7801\u903b\u8f91\u5b58\u5728\u4e8eupdateReducer\u4e2d\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function updateReducer(reducer, initialArg, init) {\n  var hook = updateWorkInProgressHook();\n  // \u7701\u7565..\n  if (baseQueue !== null) {\n  // We have a queue to process.\n  var first = baseQueue.next;\n  var newState = current.baseState;\n  var newBaseState = null;\n  var newBaseQueueFirst = null;\n  var newBaseQueueLast = null;\n  var update = first;\n\n  do {\n    var updateLane = update.lane;\n\n    if (!isSubsetOfLanes(renderLanes, updateLane)) {\n      // Priority is insufficient. Skip this update. If this is the first\n      // skipped update, the previous update/state is the new base\n      // update/state.\n      var clone = {\n        lane: updateLane,\n        action: update.action,\n        hasEagerState: update.hasEagerState,\n        eagerState: update.eagerState,\n        next: null\n      };\n\n      if (newBaseQueueLast === null) {\n        newBaseQueueFirst = newBaseQueueLast = clone;\n        newBaseState = newState;\n      } else {\n        newBaseQueueLast = newBaseQueueLast.next = clone;\n      } // Update the remaining priority in the queue.\n      // TODO: Don't need to accumulate this. Instead, we can remove\n      // renderLanes from the original lanes.\n\n\n      currentlyRenderingFiber$1.lanes = mergeLanes(currentlyRenderingFiber$1.lanes, updateLane);\n      markSkippedUpdateLanes(updateLane);\n    } else {\n      // This update does have sufficient priority.\n      if (newBaseQueueLast !== null) {\n        var _clone = {\n          // This update is going to be committed so we never want uncommit\n          // it. Using NoLane works because 0 is a subset of all bitmasks, so\n          // this will never be skipped by the check above.\n          lane: NoLane,\n          action: update.action,\n          hasEagerState: update.hasEagerState,\n          eagerState: update.eagerState,\n          next: null\n        };\n        newBaseQueueLast = newBaseQueueLast.next = _clone;\n      } // Process this update.\n\n\n      if (update.hasEagerState) {\n        // If this update is a state update (not a reducer) and was processed eagerly,\n        // we can use the eagerly computed state\n        // \u72b6\u6001\u5df2\u7ecf\u8ba1\u7b97\u8fc7\uff0c\u90a3\u5c31\u76f4\u63a5\u7528\n        newState = update.eagerState;\n      } else {\n        var action = update.action;\n        newState = reducer(newState, action);\n      }\n    }\n\n    update = update.next;\n    // \u7ec8\u6b62\u6761\u4ef6\u662f\u6307\u9488\u4e3a\u7a7a \u6216 \u73af\u5df2\u904d\u5386\u5b8c\n  } while (update !== null && update !== first);\n\n  if (newBaseQueueLast === null) {\n    newBaseState = newState;\n  } else {\n    newBaseQueueLast.next = newBaseQueueFirst;\n  } // Mark that the fiber performed work, but only if the new state is\n  // different from the current state.\n\n\n  if (!objectIs(newState, hook.memoizedState)) {\n    markWorkInProgressReceivedUpdate();\n  }\n\n  hook.memoizedState = newState;\n  hook.baseState = newBaseState;\n  hook.baseQueue = newBaseQueueLast;\n  queue.lastRenderedState = newState;\n}\n  // \u7701\u7565..\n}\n")),(0,o.kt)("h2",{id:"fiber-\u6570\u636e\u7ed3\u6784"},"Fiber \u6570\u636e\u7ed3\u6784:"),(0,o.kt)("p",null,"\u4e3b\u8981\u5206\u4e0b\u9762\u51e0\u5757\uff1a"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"\u8282\u70b9\u57fa\u7840\u4fe1\u606f\u7684\u63cf\u8ff0"),(0,o.kt)("li",{parentName:"ul"},"\u63cf\u8ff0\u4e0e\u5176\u5b83 fiber \u8282\u70b9\u8fde\u63a5\u7684\u5c5e\u6027"),(0,o.kt)("li",{parentName:"ul"},"\u72b6\u6001\u66f4\u65b0\u76f8\u5173\u7684\u4fe1\u606f:hook")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"hook \u5173\u8054\u6bd4\u8f83\u5927\u7684\u4e3b\u8981\u662f memoizedState \u548c updateQueue \u5c5e\u6027\u3002\u51fd\u6570\u7ec4\u4ef6\u4f1a\u5c06\u5185\u90e8\u7528\u5230\u7684\u6240\u6709\u7684 hook \u901a\u8fc7\u5355\u5411\u94fe\u8868\u7684\u5f62\u5f0f\uff0c\u4fdd\u5b58\u5728\u7ec4\u4ef6\u5bf9\u5e94 fiber \u8282\u70b9\u7684 memoizedState \u5c5e\u6027\u4e0a\u3002\n\nuseEffect\uff1amemoizedState\u4fdd\u5b58\u5305\u542buseEffect\u56de\u8c03\u51fd\u6570\u3001\u4f9d\u8d56\u9879\u7b49\u7684\u94fe\u8868\u6570\u636e\u7ed3\u6784effect\u3002effect\u94fe\u8868\u540c\u65f6\u4f1a\u4fdd\u5b58\u5728fiber.updateQueue\u4e2d\u3002\n\nupdateQueue \u662f useEffect \u4ea7\u751f\u7684 effect \u8fde\u63a5\u6210\u7684\u73af\u72b6\u5355\u5411\u94fe\u8868\u3002\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"\u4f18\u5148\u7ea7\u8c03\u5ea6\u76f8\u5173")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function FiberNode(\n  tag: WorkTag,\n  pendingProps: mixed,\n  key: null | string,\n  mode: TypeOfMode,\n) {\n  // \u4f5c\u4e3a\u9759\u6001\u6570\u636e\u7ed3\u6784\u7684\u5c5e\u6027\n  this.tag = tag;      // Fiber\u5bf9\u5e94\u7ec4\u4ef6\u7684\u7c7b\u578b Function/Class/Host...\n  this.key = key;      // key\u5c5e\u6027\n  this.elementType = null; // \u5927\u90e8\u5206\u60c5\u51b5\u540ctype\uff0c\u67d0\u4e9b\u60c5\u51b5\u4e0d\u540c\uff0c\u6bd4\u5982FunctionComponent\u4f7f\u7528React.memo\u5305\u88f9\n  this.type = null;     // \u5bf9\u4e8e FunctionComponent\uff0c\u6307\u51fd\u6570\u672c\u8eab\uff0c\u5bf9\u4e8eClassComponent\uff0c\u6307class\uff0c\u5bf9\u4e8eHostComponent\uff0c\u6307DOM\u8282\u70b9tagName\n  this.stateNode = null;  // Fiber\u5bf9\u5e94\u7684\u771f\u5b9eDOM\u8282\u70b9\n\n  // \u7528\u4e8e\u8fde\u63a5\u5176\u4ed6Fiber\u8282\u70b9\u5f62\u6210Fiber\u6811\n  this.return = null;  // \u6307\u5411\u7236\u7ea7Fiber\u8282\u70b9\n  this.child = null;  // \u6307\u5411\u5b50Fiber\u8282\u70b9\n  this.sibling = null; // \u6307\u5411\u53f3\u8fb9\u7b2c\u4e00\u4e2a\u5144\u5f1fFiber\u8282\u70b9\n  this.index = 0;\n\n  this.ref = null;\n\n  // \u4f5c\u4e3a\u52a8\u6001\u7684\u5de5\u4f5c\u5355\u5143\u7684\u5c5e\u6027 \u2014\u2014 \u4fdd\u5b58\u672c\u6b21\u66f4\u65b0\u9020\u6210\u7684\u72b6\u6001\u6539\u53d8\u76f8\u5173\u4fe1\u606f\n  this.pendingProps = pendingProps;\n  this.memoizedProps = null;\n  this.updateQueue = null;  // class \u7ec4\u4ef6 Fiber \u8282\u70b9\u4e0a\u7684\u591a\u4e2a Update \u4f1a\u7ec4\u6210\u94fe\u8868\u5e76\u88ab\u5305\u542b\u5728 fiber.updateQueue \u4e2d\u3002 \u51fd\u6570\u7ec4\u4ef6\u5219\u662f\u5b58\u50a8 useEffect \u7684 effect \u7684\u73af\u72b6\u94fe\u8868\u3002\n  this.memoizedState = null; // hook \u7ec4\u6210\u5355\u5411\u94fe\u8868\u6302\u8f7d\u7684\u4f4d\u7f6e\n  this.dependencies = null;\n\n  this.mode = mode;\n\n  // Effects\n  this.flags = NoFlags;\n  this.subtreeFlags = NoFlags;\n  this.deletions = null;\n\n  // \u8c03\u5ea6\u4f18\u5148\u7ea7\u76f8\u5173\n  this.lanes = NoLanes;\n  this.childLanes = NoLanes;\n\n  // \u6307\u5411\u8be5fiber\u5728\u53e6\u4e00\u6b21\u66f4\u65b0\u65f6\u5bf9\u5e94\u7684fiber\n  this.alternate = null;\n}\n")),(0,o.kt)("p",null,"hook \u7684 memoizedState \u5b58\u7684\u662f\u5f53\u524d hook \u81ea\u5df1\u7684\u503c\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"const hook: Hook = {\n  memoizedState: null, // \u5f53\u524d\u9700\u8981\u4fdd\u5b58\u7684\u503c\n\n  baseState: null,\n  baseQueue: null, // \u7531\u4e8e\u4e4b\u524d\u67d0\u4e9b\u9ad8\u4f18\u5148\u7ea7\u4efb\u52a1\u5bfc\u81f4\u66f4\u65b0\u4e2d\u65ad\uff0cbaseQueue \u8bb0\u5f55\u7684\u5c31\u662f\u5c1a\u672a\u5904\u7406\u7684\u6700\u540e\u4e00\u4e2a update\n  queue: null, // \u5185\u90e8\u5b58\u50a8\u8c03\u7528 setValue \u4ea7\u751f\u7684 update \u66f4\u65b0\u4fe1\u606f\uff0c\u662f\u4e2a\u73af\u72b6\u5355\u5411\u94fe\u8868\n\n  next: null,  // \u4e0b\u4e00\u4e2ahook\n};\n")),(0,o.kt)("h3",{id:"\u4f8b\u5b501"},"\u4f8b\u5b501"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function Test() {\n  console.log('test-render')\n  const [data, setData] = React.useState('\u6539\u53d8\u6211')\n  const [showDiv, setShowDiv] = React.useState(false)\n\n  const onClickText = () => {\n    console.log('=useState=onClick');\n    setData('\u52aa\u529b\u54e6')\n    setShowDiv(!showDiv)\n  }\n\n  const onClickText2 = () => {\n    console.log('=useState=onClick:', data);\n  }\n\n  React.useEffect(() => {\n    console.log('=\u526f\u4f5c\u7528-useEffect--\x3e\u8fd0\u884c');\n  }, [])\n\n  React.useLayoutEffect(() => {\n    console.log('=\u526f\u4f5c\u7528-useLayoutEffect--\x3e\u8fd0\u884c');\n  }, [])\n\n  return (\n    <div id='div1' className='c1'>\n      <button onClick={onClickText} className=\"btn\">Hello world,Click me</button>\n      <span>{data}</span>\n      {showDiv && <div>\u88ab\u4f60\u53d1\u73b0\u4e86</div>}\n      <div id='div2' className='c2'>\n        <p>\u6d4b\u8bd5\u5b50\u8282\u70b9</p>\n      </div>\n    </div>\n  )\n}\n")),(0,o.kt)("p",null,(0,o.kt)("img",{src:n(58877).Z,width:"939",height:"901"}),"\n\u5708\u8d77\u67651\u548c2\u8868\u793a\u4ee5\u4e0b\u51fd\u6570"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"React.useLayoutEffect(() => {\n  console.log('=\u526f\u4f5c\u7528-useLayoutEffect--\x3e\u8fd0\u884c');\n}, [])\n\nReact.useEffect(() => {\n  console.log('=\u526f\u4f5c\u7528-useEffect--\x3e\u8fd0\u884c');\n}, [])\n")),(0,o.kt)("h3",{id:"\u793a\u4f8b2"},"\u793a\u4f8b2"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'function App() {\n  const [value, setValue] = useState(0);\n  const ref = useRef();\n  ref.current = "some value";\n\n  return (\n    <div className="App">\n      <h1>\u76ee\u524d\u503c\uff1a{value}</h1>\n      <div>\n        <button onClick={() => { \n          setValue(v => v + 1)\n        }}>\u589e\u52a0</button>\n      </div>\n    </div>\n  );\n}\n')),(0,o.kt)("p",null,"\u53ef\u4ee5\u4ece\u622a\u56fe\u4e2d\u770b\u5230\uff0c\u4ee3\u7801\u4e2d\u4f7f\u7528\u7684 useState \u548c useRef \u4e24\u4e2a hook \u901a\u8fc7 next \u8fde\u63a5\u6210\u94fe\u8868\u3002\u53e6\u5916 useState \u7684 hook \u5bf9\u8c61\u7684 queue \u4e2d\u5b58\u50a8\u4e86\u8c03\u7528 setValue \u65f6\u7528\u5230\u7684\u51fd\u6570\u3002"),(0,o.kt)("p",null,(0,o.kt)("img",{src:n(44754).Z,width:"1080",height:"1181"})),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'function App() {\n  const [value, setValue] = useState(0);\n  const ref = useRef();\n  ref.current = "some value";\n\n  return (\n    <div className="App">\n      <h1>\u76ee\u524d\u503c\uff1a{value}</h1>\n      <div>\n        <button onClick={() => { \n          setValue(v => v + 1)\n        }}>\u589e\u52a0</button>\n      </div>\n    </div>\n  );\n}\n')),(0,o.kt)("h3",{id:"hooks-\u94fe\u8868\u521b\u5efa\u8fc7\u7a0b"},"Hooks \u94fe\u8868\u521b\u5efa\u8fc7\u7a0b"),(0,o.kt)("p",null,"\u6bcf\u4e2a useXxx \u7684 hooks \u90fd\u6709 mountXxx \u548c updateXxx \u4e24\u4e2a\u9636\u6bb5\u3002\u94fe\u8868\u53ea\u521b\u5efa\u4e00\u6b21\uff0c\u5728 mountXxx \u5f53\u4e2d\uff0c\u540e\u9762\u90fd\u662f update\u3002"),(0,o.kt)("p",null,"\u4ee5 useState \u4e3a\u4f8b\uff0cmount \u65f6\u4f1a\u8fdb\u5165 HooksDispatcherOnMountInDEV \u7684 useState\u65b9\u6cd5\uff0c\u6700\u7ec8\u6267\u884c mountState"),(0,o.kt)("p",null,"\u4e0b\u9762\u6709\u8be6\u7ec6\u89e3\u6790"),(0,o.kt)("h1",{id:"hooks\u57fa\u7840"},"hooks\u57fa\u7840"),(0,o.kt)("h2",{id:"\u4e3a\u4ec0\u4e48hooks"},"\u4e3a\u4ec0\u4e48hooks"),(0,o.kt)("p",null,"\u4e3b\u8981\u662fclass\u7ec4\u4ef6\u6bd4\u8f83\u5197\u4f59\u3001\u751f\u547d\u5468\u671f\u51fd\u6570\u5199\u6cd5\u4e0d\u53cb\u597d\uff0cfunctional\u7ec4\u4ef6\u66f4\u7b26\u5408React\u7f16\u7a0b\u601d\u60f3"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'// hook\u7684\u7ed3\u6784\nexport type Hook = {\n  memoizedState: any, //\u4e0a\u4e00\u6b21\u7684state\n  baseState: any,  // \u5f53\u524dstate\n  baseUpdate: Update<any, any> | null,  // update func\n  next: Hook | null, // \u94fe\u8868\n  queue: UpdateQueue<any, any> | null,  // \u7528\u4e8e\u7f13\u5b58\u591a\u6b21action\n};\n\nconst example ={\n  baseQueue:null,\n  baseState:"\u6539\u53d8\u6211",\n  memoizedState:"\u6539\u53d8\u6211",\n  next:{},\n  queue:{},\n}\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'import { useState, useEffect } from "react";\nexport default function App() {\n  // 1. useState\n  const [a, setA] = useState(1);\n  // 2. useEffect\n  useEffect(() => {\n    console.log(`effect 1 created`);\n  });\n  // 3. useState\n  const [b] = useState(2);\n  // 4. useEffect\n  useEffect(() => {\n    console.log(`effect 2 created`);\n  });\n  return (\n    <>\n      <button onClick={() => setA(a + 1)}>{a}</button>\n      <button>{b}</button>\n    </>\n  );\n}\n')),(0,o.kt)("p",null,"\u672c\u793a\u4f8b\u4e2d, function\u8c03\u7528\u4e4b\u540e\u5219\u4f1a\u521b\u5efa 4 \u4e2ahook, \u8fd9\u65f6\u7684\u5185\u5b58\u7ed3\u6784\u5982\u4e0b:\n",(0,o.kt)("img",{src:n(30145).Z,width:"894",height:"707"})),(0,o.kt)("p",null,"\u72b6\u6001Hook\u6216\u526f\u4f5c\u7528Hook\u90fd\u6309\u7167\u8c03\u7528\u987a\u5e8f\u5b58\u50a8\u5728fiber.memoizedState\u94fe\u8868\u4e2d"),(0,o.kt)("h2",{id:"mountworkinprogresshook\u4f5c\u7528"},"mountWorkInProgressHook\u4f5c\u7528:"),(0,o.kt)("p",null,"\u7ed9 memoizedState \u94fe\u8868\u52a0\u8282\u70b9\u7684\u903b\u8f91,\u5199\u8fc7\u5355\u94fe\u8868\u7684\u4f1a\u6bd4\u8f83\u7406\u89e3\uff0c\u5934\u8282\u70b9\u8981\u7279\u6b8a\u5904\u7406"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"\u521b\u5efa\u4e00\u4e2a hook"),(0,o.kt)("li",{parentName:"ul"},"\u82e5\u65e0 hook \u94fe\uff0c\u5219\u521b\u5efa\u4e00\u4e2a hook \u94fe\uff1b\u82e5\u6709\uff0c\u5219\u5c06\u65b0\u5efa\u7684 hook \u52a0\u81f3\u672b\u5c3e"),(0,o.kt)("li",{parentName:"ul"},"\u5c06\u65b0\u5efa\u7684\u8fd9\u4e2a hook \u6302\u8f7d\u5230 workInProgressHook \u4ee5\u53ca\u5f53\u524d fiber node \u7684 memoizedState \u4e0a")),(0,o.kt)("p",null,"\u8fd4\u56de workInProgressHook\uff0c\u4e5f\u5c31\u662f\u8fd9\u4e2a\u65b0\u5efa\u7684 hook"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function mountWorkInProgressHook() {\n  var hook = {\n    memoizedState: null,\n    baseState: null,\n    baseQueue: null,\n    queue: null,\n    next: null\n  };\n\n  if (workInProgressHook === null) {\n    // This is the first hook in the list\n    console.log('=useState=dom=\u8c03\u7528workInProgressHook 1:', { hook, workInProgressHook })\n    // \u94fe\u8868\u4e2d\u9996\u4e2ahook\n    currentlyRenderingFiber$1.memoizedState = workInProgressHook = hook;\n  } else {\n    // Append to the end of the list\n    // \u5c06hook\u6dfb\u52a0\u5230\u94fe\u8868\u672b\u5c3e\n    workInProgressHook = workInProgressHook.next = hook;\n    console.log('=useState=dom=\u8c03\u7528workInProgressHook 2:', { hook, workInProgressHook })\n  }\n\n  return workInProgressHook;\n}\n")),(0,o.kt)("h1",{id:"setstate-\u6e32\u67d3"},"setState \u6e32\u67d3"),(0,o.kt)("h2",{id:"\u6302\u8f7dusestate"},"\u6302\u8f7duseState"),(0,o.kt)("p",null,"\u9996\u5148\u8981\u6ce8\u610f\u7684\u662f\uff0c\u867d\u7136 App \u662f\u4e00\u4e2a FunctionComponent\uff0c\u4f46\u662f\u5728 first paint \u7684\u65f6\u5019\uff0cReact \u5224\u65ad\u5176\u4e3a IndeterminateComponent\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function beginWork(current, workInProgress, renderLanes) {\n  // \u7701\u7565\u4ee3\u7801\n  console.log('%c=beginWork()===start1-\u521d\u59cb\u5316', 'color:magenta', { getFiberName: getFiberName(workInProgress), current, renderLanes, workInProgress })\n\n  switch (workInProgress.tag) {\n    case IndeterminateComponent:\n      {\n        console.log('%c=beginWork()==end 2 mountIndeterminateComponent', 'color:magenta')\n\n        console.log(`%c=\u63a2\u7a76\u521d\u59cb\u548chook=\u8c03\u7528mountIndeterminateComponent`, 'color:blueviolet')\n        return mountIndeterminateComponent(current, workInProgress, workInProgress.type, renderLanes);\n  }\n}\n\nfunction mountIndeterminateComponent(_current, workInProgress, Component, renderLanes) {\n  // \u7701\u7565\u4ee3\u7801\n\n  ReactCurrentOwner$1.current = workInProgress;\n\n  console.log(`%c=\u63a2\u7a76\u521d\u59cb\u548chook=mountIndeterminateComponent\u8c03\u7528renderWithHooks 1`, 'color:blueviolet', { workInProgress, Component, props, context, renderLanes })\n\n  value = renderWithHooks(null, workInProgress, Component, props, context, renderLanes);\n\n  console.log(`%c=\u63a2\u7a76\u521d\u59cb\u548chook=mountIndeterminateComponent\u8c03\u7528renderWithHooks \u8fd4\u56de\u503c`, 'color:blueviolet', { value })\n\n  // \u7701\u7565\u4ee3\u7801\n}\n")),(0,o.kt)("h3",{id:"renderwithhooks"},"renderWithHooks"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"workInProgress \u8d4b\u503c\u7ed9\u5168\u5c40\u53d8\u91cf currentlyRenderingFiber\uff0c\u4e4b\u540e\u6267\u884c hook \u5c31\u80fd\u77e5\u9053\u662f\u7ed9\u54ea\u4e2a\u7ec4\u4ef6\u66f4\u65b0\u72b6\u6001\u4e86\u3002"),(0,o.kt)("li",{parentName:"ol"},"\u9009\u62e9 hook \u8c03\u5ea6\u5668\uff1a\u6839\u636e\u662f\u6302\u8f7d\u8fd8\u662f\u66f4\u65b0\u9636\u6bb5\uff0cReactCurrentDispatcher \u8bbe\u7f6e\u4e3a\u5bf9\u5e94 hook \u8c03\u5ea6\u5668\u3002"),(0,o.kt)("li",{parentName:"ol"},"\u8c03\u7528\u51fd\u6570\u7ec4\u4ef6\uff0c\u8fdb\u884c render\u3002\u51fd\u6570\u7ec4\u4ef6\u5185\u90e8\u4f1a\u8c03\u7528 Hook\uff0c\u5e76\u8fd4\u56de ReactElement\u3002"),(0,o.kt)("li",{parentName:"ol"},"\u91cd\u7f6e\u5168\u5c40\u53d8\u91cf\uff0c\u6bd4\u5982 currentlyRenderingFiber \u8bbe\u7f6e\u56de null\uff1bReactCurrentDispatcher \u8fd8\u539f\u4e3a ContextOnlyDispatcher\uff0c\u9632\u6b62\u5728\u9519\u8bef\u65f6\u673a\u4f7f\u7528 Hook\u3002")),(0,o.kt)("p",null,"renderWithHooks \u4e2d\uff0c\u6211\u4eec\u4f1a\u6839\u636e\u7ec4\u4ef6\u5904\u4e8e\u4e0d\u540c\u7684\u72b6\u6001\uff0c\u7ed9 ReactCurrentDispatcher.current \u6302\u8f7d\u4e0d\u540c\u7684 dispatcher \u3002\u800c\u5728first paint \u65f6\uff0c\u6302\u8f7d\u7684\u662fContextOnlyDispatcher\n\u6216\u5219 HooksDispatcherOnMountInDEV"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function renderWithHooks(current, workInProgress, Component, props, secondArg, nextRenderLanes) {\n    renderLanes = nextRenderLanes;\n    console.log(`%c=\u63a2\u7a76\u521d\u59cb\u548chook=renderWithHooks\u6302\u8f7d\u5c06workInProgress \u8d4b\u503c\u7ed9\u5168\u5c40\u53d8\u91cf currentlyRenderingFiber,\u8fd9\u6837\u5728\u8c03\u7528 Hook \u65f6\u5c31\u80fd\u77e5\u9053\u5bf9\u5e94\u7684 fiber \u662f\u8c01`, 'color:blueviolet')\n    currentlyRenderingFiber$1 = workInProgress;\n\n    {\n      if (current !== null && current.memoizedState !== null) {\n        ReactCurrentDispatcher$1.current = HooksDispatcherOnUpdateInDEV;\n      } else if (hookTypesDev !== null) {\n        // This dispatcher handles an edge case where a component is updating,\n        // but no stateful hooks have been used.\n        // We want to match the production code behavior (which will use HooksDispatcherOnMount),\n        // but with the extra DEV validation to ensure hooks ordering hasn't changed.\n        // This dispatcher does that.\n        ReactCurrentDispatcher$1.current = HooksDispatcherOnMountWithHookTypesInDEV;\n      } else {\n        console.log(`%c=\u63a2\u7a76\u521d\u59cb\u548chook=renderWithHooks dev\u6302\u8f7d\u7684\u662fHooksDispatcherOnMountInDEV hook`, 'color:blueviolet', { current: HooksDispatcherOnMountInDEV })\n        ReactCurrentDispatcher$1.current = HooksDispatcherOnMountInDEV;\n      }\n    }\n\n\n    // \u7701\u7565\u4ee3\u7801\n    console.log(`%c=\u63a2\u7a76\u521d\u59cb\u548chook=renderWithHooks\u6302\u8f7d,\u5c06\u4e00\u4e9b\u5168\u5c40\u53d8\u91cf\u8fdb\u884c\u91cd\u7f6e`, 'color:blueviolet')\n    ReactCurrentDispatcher$1.current = ContextOnlyDispatcher;\n    // \u7701\u7565\u4ee3\u7801\n}\n\nHooksDispatcherOnMountInDEV = {\n  readContext: function (context) {\n    return readContext(context);\n  },\n  // \u7701\u7565\n  useState: function (initialState) {\n    currentHookNameInDev = 'useState';\n    mountHookTypesDev();\n    var prevDispatcher = ReactCurrentDispatcher$1.current;\n    ReactCurrentDispatcher$1.current = InvalidNestedHooksDispatcherOnMountInDEV;\n\n    try {\n      console.log('=useState=dom=\u8c03\u7528mountState', { initialState })\n      return mountState(initialState);\n    } finally {\n      ReactCurrentDispatcher$1.current = prevDispatcher;\n    }\n  },\n}\n")),(0,o.kt)("p",null,"\u63a5\u4e0b\u91cc\u8d70\u8fdb\u6211\u4eec\u7684 App()\uff0c\u6211\u4eec\u4f1a\u8c03\u7528 React.useState,\u8fd9\u91cc\u7684 dispatcher \u5c31\u662f\u4e0a\u6587\u6302\u8f7d\u5230 ReactCurrentDispatcher.current \u7684ContextOnlyDispatcher"),(0,o.kt)("h2",{id:"\u5206\u67901dev\u91cc\u9762\u7684-usestate"},"\u5206\u67901:dev\u91cc\u9762\u7684 useState"),(0,o.kt)("p",null,"\u53ef\u89c1\u5b9e\u9645\u4e0a\u6267\u884c\u7684\u662f dispatcher.useState()\uff0c\u8fd9\u91cc\u9762\u4f1a\u901a\u8fc7\u6267\u884c resolveDispatcher() \u5f97\u5230\u4e00\u4e2a dispatcher\uff0c\u7136\u540e\u8c03\u7528\u8be5\u5bf9\u8c61\u4e0a\u7684 useState() \u65b9\u6cd5"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function useState(initialState) {\n  console.log('=useState=dev=\u8c03\u7528mountState', { initialState })\n  var dispatcher = resolveDispatcher();\n  return dispatcher.useState(initialState);\n}\n\nfunction resolveDispatcher() {\n  var dispatcher = ReactCurrentDispatcher.current;\n  {\n    if (dispatcher === null) {\n      error('Invalid hook call. Hooks can only be called inside of the body of a function component. This could happen for' + ' one of the following reasons:\\n' + '1. You might have mismatching versions of React and the renderer (such as React DOM)\\n' + '2. You might be breaking the Rules of Hooks\\n' + '3. You might have more than one copy of React in the same app\\n' + 'See https://reactjs.org/link/invalid-hook-call for tips about how to debug and fix this problem.');\n    }\n  } // Will result in a null access error if accessed outside render phase. We\n  // intentionally don't throw our own error because this is in a hot path.\n  // Also helps ensure this is inlined.\n  return dispatcher;\n}\n")),(0,o.kt)("h2",{id:"dispatcherusestate\u5c31\u662fdom\u91cc\u9762\u7684-usestate"},"dispatcher.useState\u5c31\u662fdom\u91cc\u9762\u7684 useState()"),(0,o.kt)("p",null,"\u53ef\u4ee5\u89c1\u5230\u7ed3\u6784\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"hook.memoizedState = hook.baseState = initialState;\nvar queue = {\n  pending: null,\n  interleaved: null,\n  lanes: NoLanes,\n  dispatch: null,\n  lastRenderedReducer: basicStateReducer,\n  lastRenderedState: initialState\n};\nhook.queue = queue;\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"useState: function (initialState) {\n  currentHookNameInDev = 'useState';\n  mountHookTypesDev();\n  var prevDispatcher = ReactCurrentDispatcher$1.current;\n  ReactCurrentDispatcher$1.current = InvalidNestedHooksDispatcherOnMountInDEV;\n\n  try {\n    console.log('=useState=\u8c03\u7528mountState', { initialState })\n    return mountState(initialState);\n  } finally {\n    ReactCurrentDispatcher$1.current = prevDispatcher;\n  }\n},\n")),(0,o.kt)("h2",{id:"\u8c03\u7528-mountstate-\u51fd\u6570"},"\u8c03\u7528 mountState \u51fd\u6570"),(0,o.kt)("p",null,"mountState \u51fd\u6570\u5bf9 var hook = mountWorkInProgressHook()\u8fdb\u884c\u8d4b\u503c:"),(0,o.kt)("h3",{id:"mountstate-\u548c-dispatchsetstatebind"},"mountState \u548c dispatchSetState.bind"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"\u521b\u5efa\u65b0\u7684 hook \u7a7a\u5bf9\u8c61\uff0c\u6302\u5230 workInProcess.memorizedState \u961f\u5217\u4e0a\uff08mountWorkInProgressHook \u65b9\u6cd5\uff09\u3002"),(0,o.kt)("li",{parentName:"ol"},"dispatchSetState \u7ed1\u5b9a\u5bf9\u5e94 fiber \u548c queue\uff0c\u65b9\u4fbf\u4ee5\u540e setState \u5feb\u901f\u627e\u5230\u76f8\u5173\u5bf9\u8c61\uff0c\u6700\u540e\u8fd4\u56de\u72b6\u6001\u503c\u548c\u66f4\u65b0\u72b6\u6001\u65b9\u6cd5\u3002")),(0,o.kt)("p",null,"dispatchSetState.bind(null, currentlyRenderingFiber$1, queue)"),(0,o.kt)("p",null,"\u5229\u7528bind\u8fd4\u56dedispatch\u51fd\u6570"),(0,o.kt)("p",null,"\u8fd9\u4e5f\u662f\u4e3a\u4ec0\u4e48\u867d\u7136 dispatchSetState \u672c\u8eab\u9700\u8981\u4e09\u4e2a\u53c2\u6570\uff0c\u4f46\u6211\u4eec\u4f7f\u7528\u7684\u65f6\u5019\u90fd\u662f setState(params)\uff0c\u53ea\u7528\u4f20\u4e00\u4e2a\u53c2\u6570\u7684\u539f\u56e0\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function mountState(initialState) {\n  var hook = mountWorkInProgressHook();\n\n  if (typeof initialState === 'function') {\n    // $FlowFixMe: Flow doesn't like mixed types\n    initialState = initialState();\n  }\n\n  hook.memoizedState = hook.baseState = initialState;\n  var queue = {\n    pending: null,\n    interleaved: null,\n    lanes: NoLanes,\n    dispatch: null,\n    lastRenderedReducer: basicStateReducer,\n    lastRenderedState: initialState\n  };\n  hook.queue = queue;\n\n  var dispatch = queue.dispatch = dispatchSetState.bind(null, currentlyRenderingFiber$1, queue)\n  console.log('=useState=dom=\u5229\u7528bind\u8fd4\u56dedispatch:', { dispatch })\n  return [hook.memoizedState, dispatch];\n}\n")),(0,o.kt)("h1",{id:"setstate--dispatchsetstate-\u91cd\u70b9\u51fd\u6570\u5728\u8fd9\u91cc\u89e6\u53d1\u7ec4\u4ef6\u66f4\u65b0"},"setState()--\x3edispatchSetState() \u91cd\u70b9\u51fd\u6570\u5728\u8fd9\u91cc\u89e6\u53d1\u7ec4\u4ef6\u66f4\u65b0"),(0,o.kt)("p",null,"\u6ce8\u610f: \u672c\u793a\u4f8b\u4e2d\u867d\u7136\u540c\u65f6\u6267\u884c\u4e86 2 \u6b21 dispatch, \u4f1a\u8bf7\u6c42 3 \u6b21\u8c03\u5ea6, \u7531\u4e8e\u8c03\u5ea6\u4e2d\u5fc3\u7684\u8282\u6d41\u4f18\u5316, \u6700\u540e\u53ea\u4f1a\u6267\u884c\u4e00\u6b21\u6e32\u67d3"),(0,o.kt)("p",null,"\u4e4b\u524d mountState \u65f6\uff0c\u6211\u4eec\u8fd4\u56de\u4e86\u4e00\u4e2a\u7ed1\u5b9a\u4e86 fiber\u3001queue \u53c2\u6570\u7684 dispatchSetState"),(0,o.kt)("p",null,"\u7b2c\u4e00\u4e2a setState \u5728\u88ab\u8c03\u7528\u65f6\u4f1a\u7acb\u5373\u8ba1\u7b97\u65b0\u72b6\u6001\uff0c\u8fd9\u662f\u4e3a\u4e86 \u505a\u65b0\u65e7 state \u5bf9\u6bd4\uff0c\u51b3\u5b9a\u662f\u5426\u66f4\u65b0\u7ec4\u4ef6\u3002\u5982\u679c\u5bf9\u6bd4\u53d1\u73b0\u72b6\u6001\u6ca1\u53d8\uff0c\u7ee7\u7eed\u8ba1\u7b97\u4e0b\u4e00\u4e2a setState \u7684\u65b0\u72b6\u6001\uff0c\u76f4\u5230\u627e\u5230\u4e3a\u6b62\u3002\u5982\u679c\u6ca1\u627e\u5230\uff0c\u5c31\u4e0d\u8fdb\u884c\u66f4\u65b0\u3002"),(0,o.kt)("p",null,"\u5176\u540e\u7684 setState \u5219\u4e0d\u4f1a\u8ba1\u7b97\uff0c\u7b49\u5230\u7ec4\u4ef6\u91cd\u65b0 render \u518d\u8ba1\u7b97\u3002"),(0,o.kt)("p",null,"\u4e3a\u5bf9\u6bd4\u65b0\u65e7\u72b6\u6001\u8ba1\u7b97\u51fa\u6765\u7684\u72b6\u6001\u503c\uff0c\u4f1a\u4fdd\u5b58\u5230 update.eagerState\uff0c\u5e76\u5c06 update.hasEagerState \u8bbe\u7f6e\u4e3a true\uff0c\u4e4b\u540e\u66f4\u65b0\u65f6\u901a\u8fc7\u5b83\u6765\u76f4\u63a5\u62ff\u5230\u8ba1\u7b97\u540e\u7684\u6700\u65b0\u503c\u3002"),(0,o.kt)("p",null,"dispatchSetState \u4f1a\u62ff\u5230\u5bf9\u5e94\u7684 fiber\u3001queue\uff08\u5bf9\u5e94 hook \u7684 queue\uff09\u3001action\uff08\u65b0\u7684\u72b6\u6001\uff09\u3002"),(0,o.kt)("p",null,"\u521b\u5efa\u4e00\u4e2a update \u7a7a\u5bf9\u8c61\uff1b"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"\u8ba1\u7b97\u51fa\u6700\u65b0\u72b6\u6001\uff0c\u653e\u5165\u5230 update.egerState\u3002"),(0,o.kt)("li",{parentName:"ol"},"\u5bf9\u6bd4\u65b0\u65e7\u72b6\u6001\u662f\u5426\u76f8\u540c\uff08\u4f7f\u7528 Object.is \u5bf9\u6bd4\uff09\u3002\u76f8\u540c\u5c31\u4e0d\u66f4\u65b0\u4e86\uff0c\u7ed3\u675f\u3002\u4e0d\u76f8\u540c\uff0c\u8fdb\u884c\u540e\u7eed\u7684\u64cd\u4f5c\u3002"),(0,o.kt)("li",{parentName:"ol"},"\u5c06 update \u653e\u5230 queue.interleaved \u6216 concurrentQueues \u94fe\u8868\u4e0a\uff08.new \u548c .old \u6587\u4ef6\u7684\u903b\u8f91\u5dee\u5f97\u6709\u70b9\u591a\uff09\uff0c\u4e4b\u540e\u66f4\u65b0\u9636\u6bb5\u4f1a\u642c\u5230 queue.pending\u3002"),(0,o.kt)("li",{parentName:"ol"},"\u5c06\u5f53\u524d fiber \u7684 lanes \u8bbe\u7f6e\u4e3a SyncLane\uff0c\u8fd9\u6837\u540e\u9762\u7684 setState \u5c31\u4e0d\u4f1a\u7acb\u523b\u8ba1\u7b97\u6700\u65b0\u72b6\u6001\u4e86\uff0c\u800c\u662f\u5728\u66f4\u65b0\u9636\u6bb5\u624d\u8ba1\u7b97\u3002"),(0,o.kt)("li",{parentName:"ol"},"\u63a5\u7740\u662f\u8c03\u5ea6\u66f4\u65b0\uff08scheduleUpdateOnFiber\uff09\uff0c\u8ba9\u8c03\u5ea6\u5668\u8fdb\u884c\u8c03\u5ea6\uff0c\u6267\u884c\u66f4\u65b0\u64cd\u4f5c")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function dispatchSetState(fiber, queue, action) {\n  {\n    if (typeof arguments[3] === 'function') {\n      error(\"State updates from the useState() and useReducer() Hooks don't support the \" + 'second callback argument. To execute a side effect after ' + 'rendering, declare it in the component body with useEffect().');\n    }\n  }\n\n  console.log('=useState=app=dispatchSetState:', { fiber, queue, action })\n\n  var lane = requestUpdateLane(fiber);\n  // \u521b\u5efa\u4e00\u4e2a update \u66f4\u65b0\u5bf9\u8c61\n  var update = {\n    lane: lane,\n    action: action,\n    hasEagerState: false,\n    eagerState: null,\n    next: null\n  };\n\n  if (isRenderPhaseUpdate(fiber)) {\n    console.log('=useState=app=dispatchSetState\u8c03\u7528enqueueRenderPhaseUpdate\u6e32\u67d3\u9636\u6bb5\u66f4\u65b0:')\n    enqueueRenderPhaseUpdate(queue, update);\n  } else {\n    enqueueUpdate$1(fiber, queue, update);\n    var alternate = fiber.alternate;\n\n    if (fiber.lanes === NoLanes && (alternate === null || alternate.lanes === NoLanes)) {\n      // The queue is currently empty, which means we can eagerly compute the\n      // next state before entering the render phase. If the new state is the\n      // same as the current state, we may be able to bail out entirely.\n\n      var lastRenderedReducer = queue.lastRenderedReducer;\n      console.log('=useState=app=dispatchSetState \u8ba1\u7b97\u65b0\u72b6\u6001', { queue, lastRenderedReducer })\n\n      if (lastRenderedReducer !== null) {\n        var prevDispatcher;\n\n        {\n          prevDispatcher = ReactCurrentDispatcher$1.current;\n          ReactCurrentDispatcher$1.current = InvalidNestedHooksDispatcherOnUpdateInDEV;\n        }\n\n        try {\n          // currentState \u65e7\u503c\n          var currentState = queue.lastRenderedState;\n          // currentState \u65b0\u503c\n          var eagerState = lastRenderedReducer(currentState, action); // Stash the eagerly computed state, and the reducer used to compute\n          // it, on the update object. If the reducer hasn't changed by the\n          // time we enter the render phase, then the eager state can be used\n          // without calling the reducer again.\n\n          update.hasEagerState = true;\n          update.eagerState = eagerState;\n          console.log('=useState=app=dispatchSetState \u5bf9\u6bd4\u65b0\u65e7\u72b6\u6001\u662f\u5426\u4e0d\u540c', { eagerState, currentState, objectIs: objectIs(eagerState, currentState) })\n          if (objectIs(eagerState, currentState)) {\n            // Fast path. We can bail out without scheduling React to re-render.\n            // It's still possible that we'll need to rebase this update later,\n            // if the component re-renders for a different reason and by that\n            // time the reducer has changed.\n            return;\n          }\n        } catch (error) {// Suppress the error. It will throw again in the render phase.\n        } finally {\n          {\n            ReactCurrentDispatcher$1.current = prevDispatcher;\n          }\n        }\n      }\n    }\n\n    var eventTime = requestEventTime();\n    console.log('=useState=app=dispatchSetState\u8c03\u7528scheduleUpdateOnFiber\u8c03\u5ea6fiber\u66f4\u65b0')\n    var root = scheduleUpdateOnFiber(fiber, lane, eventTime);\n\n    if (root !== null) {\n      entangleTransitionUpdate(root, queue, lane);\n    }\n  }\n\n  markUpdateInDevTools(fiber, lane);\n}\n")),(0,o.kt)("h3",{id:"enqueueupdate1"},"enqueueUpdate$1"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"\u521b\u5efaupdate\u5bf9\u8c61, \u5176\u4e2dupdate.lane\u4ee3\u8868\u4f18\u5148\u7ea7(\u53ef\u56de\u987efiber \u6811\u6784\u9020(\u57fa\u7840\u51c6\u5907)\u4e2d\u7684update\u4f18\u5148\u7ea7).")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"\u5c06update\u5bf9\u8c61\u6dfb\u52a0\u5230hook.queue.pending\u73af\u5f62\u94fe\u8868."))),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"\u73af\u5f62\u94fe\u8868\u7684\u7279\u5f81: \u4e3a\u4e86\u65b9\u4fbf\u6dfb\u52a0\u65b0\u5143\u7d20\u548c\u5feb\u901f\u62ff\u5230\u961f\u9996\u5143\u7d20(\u90fd\u662fO(1)), \u6240\u4ee5pending\u6307\u9488\u6307\u5411\u4e86\u94fe\u8868\u4e2d\u6700\u540e\u4e00\u4e2a\u5143\u7d20."),(0,o.kt)("li",{parentName:"ul"},"\u94fe\u8868\u7684\u4f7f\u7528\u65b9\u5f0f\u53ef\u4ee5\u53c2\u8003React \u7b97\u6cd5\u4e4b\u94fe\u8868\u64cd\u4f5c")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"  function enqueueUpdate$1(fiber, queue, update, lane) {\n    if (isInterleavedUpdate(fiber)) {\n      var interleaved = queue.interleaved;\n\n      if (interleaved === null) {\n        // This is the first update. Create a circular list.\n        update.next = update; // At the end of the current render, this queue's interleaved updates will\n        // be transferred to the pending queue.\n\n        pushInterleavedQueue(queue);\n      } else {\n        update.next = interleaved.next;\n        interleaved.next = update;\n      }\n\n      queue.interleaved = update;\n    } else {\n\n      console.log('=useState=app=enqueueUpdate$1\u5c06update\u5bf9\u8c61\u6dfb\u52a0\u5230hook.queue.pending\u961f\u5217')\n      var pending = queue.pending;\n\n      if (pending === null) {\n        // This is the first update. Create a circular list.\n        console.log('=useState=app=\u9996\u4e2aupdate, \u521b\u5efa\u4e00\u4e2a\u73af\u5f62\u94fe\u8868')\n        update.next = update;\n      } else {\n        update.next = pending.next;\n        pending.next = update;\n      }\n\n      queue.pending = update;\n    }\n  }\n")),(0,o.kt)("h2",{id:"update\u4f1a\u6267\u884cusestate-\u83b7\u53d6\u6700\u65b0\u72b6\u6001"},"update\u4f1a\u6267\u884cuseState \u83b7\u53d6\u6700\u65b0\u72b6\u6001"),(0,o.kt)("p",null,"\u89c1\u6d41\u7a0b\u56fe\uff0cchildren=Component(props,secondArg) \u91cd\u65b0\u6267\u884c\u51fd\u6570\u7ec4\u4ef6\u83b7\u53d6\u6700\u65b0\u72b6\u6001"),(0,o.kt)("p",null,"fiber\u6811\u6784\u9020(\u5bf9\u6bd4\u66f4\u65b0)\u9636\u6bb5, \u6267\u884cupdateFunctionComponent->renderWithHooks\u65f6\u518d\u6b21\u8c03\u7528function"),(0,o.kt)("p",null,"\u6ce8\u610f: \u5728renderWithHooks\u51fd\u6570\u4e2d\u5df2\u7ecf\u8bbe\u7f6e\u4e86workInProgress.memoizedState = null, \u7b49\u5f85\u8c03\u7528function\u65f6\u91cd\u65b0\u8bbe\u7f6e."),(0,o.kt)("p",null,"\u63a5\u4e0b\u6765\u8c03\u7528function, \u540c\u6837\u4f9d\u6b21\u8c03\u7528useState, useEffect, useState, useEffect. \u800cuseState, useEffect\u5728fiber\u5bf9\u6bd4\u66f4\u65b0\u65f6\u5206\u522b\u5bf9\u5e94updateState->updateReducer\u548cupdateEffect->updateEffectImpl"),(0,o.kt)("p",null,"\u65e0\u8bbauseState, useEffect, \u5185\u90e8\u8c03\u7528updateWorkInProgressHook\u83b7\u53d6\u4e00\u4e2a hook."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"HooksDispatcherOnUpdateInDEV = {\n  // \u7701\u7565\u4ee3\u7801\n  useState: function (initialState) {\n        currentHookNameInDev = 'useState';\n        updateHookTypesDev();\n        var prevDispatcher = ReactCurrentDispatcher$1.current;\n        ReactCurrentDispatcher$1.current = InvalidNestedHooksDispatcherOnUpdateInDEV;\n\n        try {\n          console.log('=updateState=4', { initialState })\n          return updateState(initialState);\n        } finally {\n          ReactCurrentDispatcher$1.current = prevDispatcher;\n        }\n  }\n  // \u7701\u7565\u4ee3\u7801\n}\n\n")),(0,o.kt)("h3",{id:"updatestate--updatereducer\u4f5c\u7528\u6700\u540e\u66f4\u65b0-hook-\u4e0a\u7684\u53c2\u6570\u8fd4\u56de-state-\u548c-dispatch"},"updateState--\x3eupdateReducer\u4f5c\u7528:\u6700\u540e\u66f4\u65b0 hook \u4e0a\u7684\u53c2\u6570\uff0c\u8fd4\u56de state \u548c dispatch\u3002"),(0,o.kt)("p",null,"updateReducer \u4e3b\u8981\u5de5\u4f5c\u6709\u4e24\u4e2a\uff1a"),(0,o.kt)("p",null,"\u4ece current.memorizedState \u62f7\u8d1d hook \u5230 workInProcess \u4e0b\uff08updateWorkInProgressHook \u65b9\u6cd5\uff09\u3002\n\u5c06 hook.queue.pending \u961f\u5217\u5408\u5e76\u5230 currentHook.baseQueue \u4e0b\uff0c\u7136\u540e\u904d\u5386\u961f\u5217\u4e2d\u7684 update \u5bf9\u8c61\uff0c\u4f7f\u7528 action \u548c reducer \u8ba1\u7b97\u51fa\u6700\u65b0\u7684\u72b6\u6001\uff0c\u66f4\u65b0\u5230 hook \u4e0a\uff0c\u6700\u540e\u8fd4\u56de\u65b0\u72b6\u6001\u548c\u65b0 setState\u3002"),(0,o.kt)("p",null,"updateReducer\uff0c\u53ea\u662f reducer \u662f\u56fa\u5b9a\u597d\u7684\uff0c\u4f5c\u7528\u5c31\u662f\u7528\u6765\u76f4\u63a5\u6267\u884c setValue\uff08\u5373 dispath\uff09 \u51fd\u6570\u4f20\u8fdb\u6765\u7684 action\uff0c\u5373 useState \u5176\u5b9e\u662f\u5bf9 useReducer \u7684\u4e00\u4e2a\u5c01\u88c5\uff0c\u53ea\u662f reducer \u51fd\u6570\u662f\u9884\u7f6e\u597d\u7684\u3002"),(0,o.kt)("p",null,"useState \u672c\u8d28\u4e0a\u5728\u4f7f\u7528 useReducer\uff0c\u5728 React \u6e90\u7801\u5c42\u63d0\u4f9b\u4e86\u7279\u6b8a\u7684\u540d\u4e3a basicStateReducer \u7684 reducer"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function updateState(initialState) {\n  console.log('=updateState\u8c03\u7528updateReducer')\n  return updateReducer(basicStateReducer);\n}\n\n// reducer \u51fd\u6570\nfunction basicStateReducer(state, action) {\n  // $FlowFixMe: Flow doesn't like mixed types\n  return typeof action === 'function' ? action(state) : action;\n}\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"// setReducer \u66f4\u65b0\u9636\u6bb5\u5bf9\u5e94\u7684 updateReducer\nfunction updateReducer(reducer, initialArg, init) {\n  // ----- \u30101\u3011 \u62f7\u8d1d hook\uff08current -> workInProcess\uff09\uff0c\u5e76\u8fd4\u56de\u8fd9\u4e2a hook -----\n  const hook = updateWorkInProgressHook();\n  \n  // ----- \u30102\u3011 \u8bfb\u53d6\u961f\u5217\uff0c\u8ba1\u7b97\u51fa\u6700\u65b0\u72b6\u6001\uff0c\u66f4\u65b0 hook \u7684\u72b6\u6001 -----\n  // ...\n}\n")),(0,o.kt)("h3",{id:"\u7ee7\u7eed\u770b-updateworkinprogresshook"},"\u7ee7\u7eed\u770b updateWorkInProgressHook()"),(0,o.kt)("p",null,"updateWorkInProgressHook\u51fd\u6570\u903b\u8f91\u7b80\u5355: \u76ee\u7684\u662f\u4e3a\u4e86\u8ba9currentHook\u548cworkInProgressHook\u4e24\u4e2a\u6307\u9488\u540c\u65f6\u5411\u540e\u79fb\u52a8."),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"\u7531\u4e8erenderWithHooks\u51fd\u6570\u8bbe\u7f6e\u4e86workInProgress.memoizedState=null, \u6240\u4ee5workInProgressHook\u521d\u59cb\u503c\u5fc5\u7136\u4e3anull, \u53ea\u80fd\u4ececurrentHook\u514b\u9686.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"\u800c\u4ececurrentHook\u514b\u9686\u800c\u6765\u7684newHook.next=null, \u8fdb\u800c\u5bfc\u81f4workInProgressHook\u94fe\u8868\u9700\u8981\u5b8c\u5168\u91cd\u5efa."))),(0,o.kt)("p",null,"\u53ef\u4ee5\u770b\u5230:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"\u4ee5\u53cc\u7f13\u51b2\u6280\u672f\u4e3a\u57fa\u7840, \u5c06current.memoizedState\u6309\u7167\u987a\u5e8f\u514b\u9686\u5230\u4e86workInProgress.memoizedState\u4e2d."),(0,o.kt)("li",{parentName:"ol"},"Hook\u7ecf\u8fc7\u4e86\u4e00\u6b21\u514b\u9686, \u5185\u90e8\u7684\u5c5e\u6027(hook.memoizedState\u7b49)\u90fd\u6ca1\u6709\u53d8\u52a8, \u6240\u4ee5\u5176\u72b6\u6001\u5e76\u4e0d\u4f1a\u4e22\u5931.")),(0,o.kt)("p",null,"\u603b\u7ed3\uff1a\nrenderWithHooks\u51fd\u6570, \u628aHook\u94fe\u8868\u6302\u8f7d\u5230\u4e86fiber.memoizedState\u4e4b\u4e0a. \u5229\u7528fiber\u6811\u5185\u90e8\u7684\u53cc\u7f13\u51b2\u6280\u672f, \u5b9e\u73b0\u4e86Hook\u4ececurrent\u5230workInProgress\u8f6c\u79fb, \u8fdb\u800c\u5b9e\u73b0\u4e86Hook\u72b6\u6001\u7684\u6301\u4e45\u5316."),(0,o.kt)("p",null,"\u8be5\u65b9\u6cd5\u4e2d\uff0ccurrentHook \u8bbe\u7f6e\u4e3a current.memoizedState \u94fe\u8868\u7684\u4e0b\u4e00\u4e2a hook\uff0c\u62f7\u8d1d\u5b83\u5230 currentlyRenderingFiber.memoizedState \u94fe\u8868\u4e0a\uff0c\u8fd4\u56de\u8fd9\u4e2a hook\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function updateWorkInProgressHook() {\n  // 1. \u79fb\u52a8 currentHook \u6307\u9488\n  //\uff08\u6765\u81ea current.memoizedState \u94fe\u8868\uff09\n  var nextCurrentHook; \n  if (currentHook === null) {\n    var current = currentlyRenderingFiber.alternate;\n    if (current !== null) {\n      nextCurrentHook = current.memoizedState;\n    } else {\n      nextCurrentHook = null;\n    }\n  } else {\n    nextCurrentHook = currentHook.next;\n  }\n\n  // 2. \u79fb\u52a8 workInProgressHook \u6307\u9488\n  //\uff08\u6765\u81ea currentlyRenderingFiber.memoizedState \u94fe\u8868\uff09\n  var nextWorkInProgressHook;\n  if (workInProgressHook === null) {\n    nextWorkInProgressHook = currentlyRenderingFiber.memoizedState;\n  } else {\n    nextWorkInProgressHook = workInProgressHook.next;\n  }\n\n  if (nextWorkInProgressHook !== null) {\n    // \u8fd9\u79cd\u60c5\u51b5\u4e3a \u201c\u6e32\u67d3\u65f6\u66f4\u65b0\u903b\u8f91\u201d\uff08\u5728 render \u65f6\u8c03\u7528\u4e86 setState\uff09\n    // \u4e3a\u4e86\u66f4\u805a\u7126\u666e\u901a\u60c5\u51b5\uff0c\u8fd9\u91cc\u4e0d\u8ba8\u8bba\n    workInProgressHook = nextWorkInProgressHook;\n    nextWorkInProgressHook = workInProgressHook.next;\n    currentHook = nextCurrentHook;\n  } else {\n    // 3. \u6e32\u67d3\u65f6\u4e0d\u66f4\u65b0\uff0cnextWorkInProgressHook \u5c31\u4e00\u5b9a\u662f null\n    if (nextCurrentHook === null) {\n      throw new Error('Rendered more hooks than during the previous render.');\n    }\n\n    currentHook = nextCurrentHook;\n    var newHook = {\n      memoizedState: currentHook.memoizedState,\n      baseState: currentHook.baseState,\n      baseQueue: currentHook.baseQueue,\n      queue: currentHook.queue,\n      next: null // next \u5c31\u4e0d\u62f7\u8d1d\u4e86\n    };\n\n    // 4. \u7ecf\u5178\u5355\u94fe\u8868\u672b\u5c3e\u52a0\u8282\u70b9\u5199\u6cd5\n    if (workInProgressHook === null) {\n      currentlyRenderingFiber.memoizedState = workInProgressHook = newHook;\n    } else {\n      workInProgressHook = workInProgressHook.next = newHook;\n    }\n  }\n\n  // 5. \u8fd4\u56de\u62f7\u8d1d hook \u5bf9\u8c61\n  return workInProgressHook;\n}\n")),(0,o.kt)("p",null,"\u62ff\u5230\u62f7\u8d1d\u540e\u7684hook\uff0c\u53ef\u4ee5\u8ba1\u7b97\u65b0\u72b6\u6001\u503c\u4e86\u3002"),(0,o.kt)("p",null,"\u9996\u5148\u5c06 hook.queue.pending \u961f\u5217\u5408\u5e76\u5230 currentHook.baseQueue \u4e0b\u3002\u8be5\u961f\u5217\u5305\u542b\u4e86\u4e00\u7cfb\u5217 update \u5bf9\u8c61\uff08\u56e0\u4e3a\u53ef\u80fd\u8c03\u7528\u4e86\u591a\u6b21 setState\uff09\uff0c\u91cc\u9762\u4fdd\u5b58\u6709 setState \u4f20\u5165\u7684\u6700\u65b0\u72b6\u6001\u503c\uff08\u51fd\u6570\u6216\u5176\u4ed6\u503c\uff09\u3002"),(0,o.kt)("p",null,"\u7136\u540e\u904d\u5386 update \u8ba1\u7b97\u51fa\u6700\u65b0\u72b6\u6001\uff0c\u4fdd\u5b58\u56de hook\uff0c\u5e76\u8fd4\u56de\u6700\u65b0\u72b6\u6001\u503c\u548c setState \u65b9\u6cd5\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function updateReducer(reducer, initialArg, init) {\n  // ----- \u30101\u3011 \u62f7\u8d1d hook\uff08current -> workInProcess\uff09\uff0c\u5e76\u8fd4\u56de\u8fd9\u4e2a hook ----\n  const hook = updateWorkInProgressHook();\n  \n  // ----- \u30102\u3011 \u8bfb\u53d6\u961f\u5217\uff0c\u8ba1\u7b97\u51fa\u6700\u65b0\u72b6\u6001\uff0c\u66f4\u65b0 hook \u7684\u72b6\u6001 -----\n  // \u53d6\u51fa hook.queue \u94fe\u8868\uff0c\u6dfb\u52a0\u5230 current.baseQueue \u672b\u5c3e\n  const queue = hook.queue;\n  queue.lastRenderedReducer = reducer;\n  const current = currentHook;\n  let baseQueue = current.baseQueue;\n  const pendingQueue = queue.pending;\n  if (pendingQueue !== null) {\n    if (baseQueue !== null) {\n      const baseFirst = baseQueue.next;\n      const pendingFirst = pendingQueue.next;\n      baseQueue.next = pendingFirst;\n      pendingQueue.next = baseFirst;\n    }\n    current.baseQueue = baseQueue = pendingQueue;\n    queue.pending = null;\n  }\n\n  // \u5904\u7406\u66f4\u65b0\u961f\u5217\n  if (baseQueue !== null) {\n    const first = baseQueue.next;\n    let newState = current.baseState;\n\n    let newBaseState = null;\n    let newBaseQueueFirst = null;\n    let newBaseQueueLast = null;\n    let update = first;\n  \n    // \u5faa\u73af\uff0c\u6839\u636e baseQueue \u94fe\u8868\u4e0b\u7684 update \u5bf9\u8c61\u8ba1\u7b97\u65b0\u72b6\u6001\n    do {   \n      // \u5220\u6389\u4e86\u4e00\u4e9b\u8df3\u8fc7\u66f4\u65b0\u7684\u903b\u8f91\n\n      if (update.hasEagerState) {\n        // \u4e3a\u4e86\u5bf9\u6bd4\u65b0\u65e7\u72b6\u6001\u6765\u51b3\u5b9a\u662f\u5426\u66f4\u65b0\uff0c\u6240\u8ba1\u7b97\u7684\u65b0\u72b6\u6001\u3002\n        // \u5982\u679c\u4e0d\u540c\uff0c\u7ed9 update.hasEagerState \u8bbe\u7f6e\u4e3a true\n        // \u65b0\u72b6\u6001\u8d4b\u503c\u7ed9 update.eagerState\n        newState = update.eagerState;\n      } else {\n        // \u8ba1\u7b97\u65b0\u72b6\u6001\n        const action = update.action;\n        newState = reducer(newState, action);\n      }     \n      update = update.next;\n    } while (update !== null && update !== first);   \n    if (newBaseQueueLast === null) {\n      newBaseState = newState;\n    } else {\n      newBaseQueueLast.next = newBaseQueueFirst;\n    }\n    if (!is(newState, hook.memoizedState)) {\n      markWorkInProgressReceivedUpdate();\n    }\n  // \u66f4\u65b0 hook \u72b6\u6001\n    hook.memoizedState = newState;\n    hook.baseState = newBaseState;\n    hook.baseQueue = newBaseQueueLast;\n    queue.lastRenderedState = newState;\n  }\n  const dispatch = queue.dispatch;\n  return [hook.memoizedState, dispatch];\n}\n")))}c.isMDXComponent=!0},30145:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/hooks\u94fe\u8868\u7ed3\u6784-75c957b0b0f7eb1d29c161db4128c18e.png"},58877:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/hook\u8fde\u63a5\u6210\u94fe\u8868-\u5b9e\u4f8b-b60ef359d94460ad4100d2d7203bd7b3.png"},44754:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/hook\u8fde\u63a5\u6210\u94fe\u8868-3b4489a95f588c69799a6df18fab5d6f.png"},18861:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/\u56fe1hooks\u94fe\u8868-5457b99e0b5fe7ea05c58c615a209aa1.png"}}]);