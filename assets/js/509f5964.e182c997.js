"use strict";(self.webpackChunkprogramming_technology=self.webpackChunkprogramming_technology||[]).push([[1035],{3905:(e,n,r)=>{r.d(n,{Zo:()=>d,kt:()=>k});var t=r(67294);function o(e,n,r){return n in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r,e}function a(e,n){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),r.push.apply(r,t)}return r}function l(e){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?a(Object(r),!0).forEach((function(n){o(e,n,r[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):a(Object(r)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(r,n))}))}return e}function i(e,n){if(null==e)return{};var r,t,o=function(e,n){if(null==e)return{};var r,t,o={},a=Object.keys(e);for(t=0;t<a.length;t++)r=a[t],n.indexOf(r)>=0||(o[r]=e[r]);return o}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(t=0;t<a.length;t++)r=a[t],n.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(o[r]=e[r])}return o}var c=t.createContext({}),s=function(e){var n=t.useContext(c),r=n;return e&&(r="function"==typeof e?e(n):l(l({},n),e)),r},d=function(e){var n=s(e.components);return t.createElement(c.Provider,{value:n},e.children)},u="mdxType",p={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},m=t.forwardRef((function(e,n){var r=e.components,o=e.mdxType,a=e.originalType,c=e.parentName,d=i(e,["components","mdxType","originalType","parentName"]),u=s(r),m=o,k=u["".concat(c,".").concat(m)]||u[m]||p[m]||a;return r?t.createElement(k,l(l({ref:n},d),{},{components:r})):t.createElement(k,l({ref:n},d))}));function k(e,n){var r=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var a=r.length,l=new Array(a);l[0]=m;var i={};for(var c in n)hasOwnProperty.call(n,c)&&(i[c]=n[c]);i.originalType=e,i[u]="string"==typeof e?e:o,l[1]=i;for(var s=2;s<a;s++)l[s]=r[s];return t.createElement.apply(null,l)}return t.createElement.apply(null,r)}m.displayName="MDXCreateElement"},90940:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>p,frontMatter:()=>a,metadata:()=>i,toc:()=>s});var t=r(87462),o=(r(67294),r(3905));const a={title:"render\u9636\u6bb5\u603b\u89c8",sidebar_position:1},l=void 0,i={unversionedId:"React/render\u9636\u6bb5\u603b\u89c8",id:"React/render\u9636\u6bb5\u603b\u89c8",title:"render\u9636\u6bb5\u603b\u89c8",description:"\u6d41\u7a0b\u56fe-\u5e94\u7528\u5165\u53e3",source:"@site/programming-tech/React/03-render\u9636\u6bb5\u603b\u89c8.md",sourceDirName:"React",slug:"/React/render\u9636\u6bb5\u603b\u89c8",permalink:"/React/render\u9636\u6bb5\u603b\u89c8",draft:!1,editUrl:"https://github.com/huiruo/programming-tech-website/edit/main/programming-tech/React/03-render\u9636\u6bb5\u603b\u89c8.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{title:"render\u9636\u6bb5\u603b\u89c8",sidebar_position:1},sidebar:"docs",previous:{title:"\u7f16\u8bd1\u9636\u6bb5-jsx-ast",permalink:"/React/\u7f16\u8bd1\u9636\u6bb5-jsx-ast"},next:{title:"setState\u7ec4\u4ef6\u66f4\u65b0\u548chooks\u7684\u521d\u59cb\u5316",permalink:"/React/setState\u7ec4\u4ef6\u66f4\u65b0\u548chooks\u7684\u521d\u59cb\u5316"}},c={},s=[{value:"\u6d41\u7a0b\u56fe-\u5e94\u7528\u5165\u53e3",id:"\u6d41\u7a0b\u56fe-\u5e94\u7528\u5165\u53e3",level:2},{value:"\u5165\u53e3\u6d41\u7a0b-\u6b64\u65f6\u8fd8\u4e0d\u662ffiber\u6811,\u6ca1\u6709\u5f00\u542frender\u9636\u6bb5",id:"\u5165\u53e3\u6d41\u7a0b-\u6b64\u65f6\u8fd8\u4e0d\u662ffiber\u6811\u6ca1\u6709\u5f00\u542frender\u9636\u6bb5",level:2},{value:"17\u7248\u672c\u5165\u53e3\u51fd\u6570\u548c18\u4e0d\u4e00\u6837",id:"17\u7248\u672c\u5165\u53e3\u51fd\u6570\u548c18\u4e0d\u4e00\u6837",level:3},{value:"17\u7248\u672clegacyRenderSubtreeIntoContainer()",id:"17\u7248\u672clegacyrendersubtreeintocontainer",level:3},{value:"React.createElement \u65e7api",id:"reactcreateelement-\u65e7api",level:3},{value:"17\u7248\u672c-createFiberRoot \u521b\u5efafiberRoot\u5bf9\u8c61",id:"17\u7248\u672c-createfiberroot-\u521b\u5efafiberroot\u5bf9\u8c61",level:3},{value:"\u6d41\u7a0b\u56fe\u6784\u5efafiber tree-\u63a5\u4e0a\u9762updateContainer",id:"\u6d41\u7a0b\u56fe\u6784\u5efafiber-tree-\u63a5\u4e0a\u9762updatecontainer",level:2},{value:"beginWork\u524d\u7f6e\u5de5\u4f5c\u548cbeginWork\u8fdb\u884c\u4e2d",id:"beginwork\u524d\u7f6e\u5de5\u4f5c\u548cbeginwork\u8fdb\u884c\u4e2d",level:3},{value:"workInProgress\u6784\u5efa\u6b65\u9aa41",id:"workinprogress\u6784\u5efa\u6b65\u9aa41",level:3},{value:"render\u9636\u6bb5completeUnitOfWork",id:"render\u9636\u6bb5completeunitofwork",level:3},{value:"render\u9636\u6bb5\u7ed3\u675f,commit\u9636\u6bb5\u524d:\u6b64\u65f6fiber\u6811\u751f\u6210",id:"render\u9636\u6bb5\u7ed3\u675fcommit\u9636\u6bb5\u524d\u6b64\u65f6fiber\u6811\u751f\u6210",level:3}],d={toc:s},u="wrapper";function p(e){let{components:n,...r}=e;return(0,o.kt)(u,(0,t.Z)({},d,r,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"\u6d41\u7a0b\u56fe-\u5e94\u7528\u5165\u53e3"},"\u6d41\u7a0b\u56fe-\u5e94\u7528\u5165\u53e3"),(0,o.kt)("p",null,"\u57fa\u4e8e18"),(0,o.kt)("mermaid",{value:'flowchart TD\nA1("ReactDOM.createRoot(document.getElementById(\'root\'))")--1FiberRoot\u521b\u5efa--\x3eA2("return new ReactDOMRoot(root)")--\x3e1FiberRoot--\x3eA6("root=createContainer(container")--\x3eA7("return createFiberRoot(containerInfo")--1FiberRoot\u521d\u59cb\u5316\u76f8\u5173\u53ea\u8c03\u7528\u4e00\u6b21--\x3eA8("root=new FiberRootNode(containerInfo")\n\nA7--2root.current=uninitializedFiber--\x3eA11("uninitializedFiber=createHostRootFiber(tag,isStrictMode)")--\x3eA12("return createFiber(HostRoot")\n\nA1--2\u5f00\u542frender--\x3eA3("root.render(<\u7ec4\u4ef6>)")--\x3eA4("ReactDOMRoot.prototype.render")\nA4--\u5f00\u59cb\u6e32\u67d3,\u6ce8\u610f\u975e\u6279\u91cf--\x3eA5("updateContainer(children, root")'}),(0,o.kt)("h2",{id:"\u5165\u53e3\u6d41\u7a0b-\u6b64\u65f6\u8fd8\u4e0d\u662ffiber\u6811\u6ca1\u6709\u5f00\u542frender\u9636\u6bb5"},"\u5165\u53e3\u6d41\u7a0b-\u6b64\u65f6\u8fd8\u4e0d\u662ffiber\u6811,\u6ca1\u6709\u5f00\u542frender\u9636\u6bb5"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"<script type=\"text/babel\">\n  const root = ReactDOM.createRoot(document.getElementById('root'))\n  root.render(<Test />);\n<\/script>\n")),(0,o.kt)("p",null,"createRoot--\x3eReactDOMRoot"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function createRoot(container, options) {\n  return new ReactDOMRoot(root);\n}\n\nReactDOMHydrationRoot.prototype.render = ReactDOMRoot.prototype.render = function (children) {\n    console.log('%c ==\u4e00\u5207\u5f00\u59cb3:', 'color:red', 'ReactDOMRoot.prototype.render\u8c03\u7528updateContainer()\u5f00\u542frender\u9636\u6bb5==', children);\n    var root = this._internalRoot;\n}\n")),(0,o.kt)("h3",{id:"17\u7248\u672c\u5165\u53e3\u51fd\u6570\u548c18\u4e0d\u4e00\u6837"},"17\u7248\u672c\u5165\u53e3\u51fd\u6570\u548c18\u4e0d\u4e00\u6837"),(0,o.kt)("p",null,"\u572818\u4e2d\u76f4\u63a5\u8c03\u7528\u4ee5\u4e0b\u51fd\u6570\uff0c\u662f\u4e0d\u7528\u8d70\u4e0b\u9762\u7684\u6d41\u7a0b\u7684,18\u76f4\u63a5\u6d41\u7a0b\u56fe\u7684\u6d41\u7a0b\u6784\u5efafiber\u548c\u66f4\u65b0"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"ReactDOM.createRoot(domRoot).render(Ast)\n")),(0,o.kt)("p",null,"\u4ee5\u4e0b\u662f17\u6216\u5219\u572818\u4e2d\u8c03\u7528ReactDOM.render(ast,domRoot)\u7684\u6d41\u7a0b"),(0,o.kt)("h3",{id:"17\u7248\u672clegacyrendersubtreeintocontainer"},"17\u7248\u672clegacyRenderSubtreeIntoContainer()"),(0,o.kt)("p",null,"\u6839\u636e container \u662f\u5426\u5b58\u5728 root \u533a\u5206\u521d\u59cb\u5316/\u66f4\u65b0\uff0c\u521b\u5efa\u6216\u83b7\u53d6 fiberRoot;"),(0,o.kt)("p",null,"Babel \u4f1a\u628a JSX \u8f6c\u8bd1\u6210\u4e00\u4e2a\u540d\u4e3a React.createElement() \u51fd\u6570\u8c03\u7528,\n\u56e0\u6b64legacyRenderSubtreeIntoContainer \u4e2d\u6253\u5370\u7684children\u5b9e\u9645\u4e0a\u662f\u901a\u8fc7React.createElement()\u5904\u7406\u8fc7\u7684"),(0,o.kt)("p",null,"17\u4e2d\u7684React.createElement\u505a\u7684\u4e8b\u60c5\u5c31\u662f\u751f\u6210react\u7684ast\u6811\n\u5c06\u53c2\u6570\u8bfb\u53d6\u8f6c\u6362\u4e3aast\u6811\u7684\u4e00\u4e9b\u6240\u9700\u53c2\u6570\u5b57\u6bb5,\u6700\u7ec8\u8fd4\u56deast\u6811\u7684\u7ed3\u6784"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function createElement(type, config, children) {\n    //\u6839\u636e\u4e0a\u9762\u7684\u793a\u4f8b\u4ee3\u7801\uff0ctype=div,config= {className:'red'},children='Click Me'\n  var propName; // Reserved names are extracted\n  var props = {};// \u6211\u4eec\u5e38\u7528\u7684props \u76ee\u524d\u7ec4\u4ef6\n  var key = null;//\u8be5\u7ec4\u4ef6\u7684\u552f\u4e00key\n  var ref = null;// \u6211\u4eec\u7684ref\n  var self = null;\n  var source = null;\n\n  // ...\n  ...\n  // ...\n\n    // \u5f53\u53d1\u73b0arguments\u7684\u53c2\u6570\u5927\u4e8e1\u7684\u65f6\u5019\u3002\u8bf4\u660e\u662f\u6709\u591a\u4e2a\u5144\u5f1f\u5b50\u5143\u7d20\u7684\uff0c\u5982\u679c\u7b49\u4e8e1\u7684\u8bdd\u8bf4\u660e\u53ea\u6709\u4e00\u4e2a\u5143\u7d20\n  var childrenLength = arguments.length - 2;\n\n  if (childrenLength === 1) {\n      // \u76f4\u63a5\u5c06props\u7684children\u8bbe\u4e3a\u5f53\u524dchildren\n    props.children = children;\n  } else if (childrenLength > 1) {\n    var childArray = Array(childrenLength);\n\n    for (var i = 0; i < childrenLength; i++) {\n      childArray[i] = arguments[i + 2];\n    }\n\n    {\n      if (Object.freeze) {\n        Object.freeze(childArray);\n      }\n    }\n    // \u6709\u591a\u4e2a\u5144\u5f1f\u5143\u7d20\u7684\u8bdd\uff0c\u5c06\u5144\u5f1f\u8282\u70b9\u653e\u7f6e\u5728\u4e00\u4e2a\u6570\u7ec4\u91cc\u9762\uff0c\u8d4b\u503c\u7ed9props\u7684children\n    props.children = childArray;\n  } // Resolve default props\n\n  // ...\n  ...\n  // ...\n\n    // ReactElement \u8fd4\u56de\u56de\u6765\u7684\u662f\u6211\u4eec\u6700\u7ec8\u7684ast\u6811\u7684\u7ed3\u6784\n  return ReactElement(type, key, ref, self, source, ReactCurrentOwner.current, props);\n}\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"// \u4ece container \u53d6\u51fa _reactRootContainer \u4f5c\u4e3a react \u7684\u4e00\u4e2a\u6839:\nvar maybeRoot = container._reactRootContainer;\n")),(0,o.kt)("p",null,"\u68c0\u67e5 root \u662f\u5426\u5b58\u5728\uff0c\u5982\u679c\u5b58\u5728\u5c31\u662f Update\uff0c\u5982\u679c\u4e0d\u5b58\u5728\u5c31\u662f\u521d\u59cb\u5316\u3002"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"1.\u82e5root\u4e0d\u5b58\u5728\uff1a",(0,o.kt)("br",null),"\u8c03\u7528 legacyCreateRootFromDOMContainer\u521d\u59cb\u5316 root\u3002\n\u5c06 root \u8d4b\u503c\u7ed9 container._reactRootContainer,\u53d6\u51fa root \u4e2d\u7684_internalRoot \u4f5c\u4e3a fiberRoot\u3002")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"2.\u82e5 root \u5b58\u5728, \u4ece root \u4e2d\u53d6\u51fa fiberRoot:"))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"root = maybeRoot;\n")),(0,o.kt)("p",null,"\u8c03\u7528 updateContainer(children,fiberRoot,parentComponent,callBack)"),(0,o.kt)("p",null,"\u6ce8\u610f\uff1a\u8fd9\u91cc callBack \u4f1a\u901a\u8fc7 getPublicRootInstance() \u9012\u5f52\u627e\u5230 fiberRoot \u4e0a\u7b2c\u4e00\u4e2a\u975e HTMlElement \u7ed3\u70b9,\u5e76\u5c06 callback \u7ed1\u5b9a\u5728\u5b83\u4e0a\u8fb9\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function render(element, container, callback) {\n    return legacyRenderSubtreeIntoContainer(null, element, container, false, callback); \n}\n\n/*\n\u53ef\u4ee5\u89c1\u5230\u521d\u59cb\u5316\u9636\u6bb5:legacyCreateRootFromDOMContainer \u4e0d\u6279\u91cf\u8c03\u7528 updateContainer\n\nupdate\u9636\u6bb5\uff1a\u76f4\u63a5\u8c03\u7528 updateContainer\n*/\nfunction legacyRenderSubtreeIntoContainer(parentComponent, children, container, forceHydrate, callback) {\n  if (!maybeRoot) {\n    console.log('\u5f00\u59cb\u8c03\u7528--\x3e0-a0:\u521d\u59cb\u5316\u6e32\u67d3')\n    // Initial mount\n    root = legacyCreateRootFromDOMContainer(container, children, parentComponent, callback, forceHydrate);\n  } else {\n    root = maybeRoot;\n\n    if (typeof callback === 'function') {\n      var originalCallback = callback;\n\n      callback = function () {\n        var instance = getPublicRootInstance(root);\n        originalCallback.call(instance);\n      };\n    } // Update\n\n    console.log('\u66f4\u65b0\u6d41\u7a0b--\x3e1-a1:\u5373\u66f4\u65b0')\n    updateContainer(children, root, parentComponent, callback);\n  }\n\n  return getPublicRootInstance(root);\n}\n\n// \u7b2c\u4e00\u6b21\u6e32\u67d3\nlegacyCreateRootFromDOMContainer(){\n      \n  console.log('--\x3e0-a,\u521d\u59cb\u5316\u6e32\u67d3\u4e0d\u6267\u884c\u6279\u91cf\u66f4\u65b0,\u800c\u662f\u6267\u884cflushSync',)\n  flushSync(function () {\n    updateContainer(initialChildren, _root, parentComponent, callback);\n  });\n}\n")),(0,o.kt)("h3",{id:"reactcreateelement-\u65e7api"},"React.createElement \u65e7api"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://cloud.tencent.com/developer/article/2135083"},"https://cloud.tencent.com/developer/article/2135083")),(0,o.kt)("p",null,"react17 \u4e4b\u540e\u6211\u4eec\u53ef\u4ee5\u4e0d\u518d\u4f9d\u8d56 React.createElement \u8fd9\u4e2a api \u4e86\uff0c\u4f46\u662f\u5b9e\u9645\u573a\u666f\u4e2d\u4ee5\u53ca\u5f88\u591a\u5f00\u6e90\u5305\u4e2d\u53ef\u80fd\u4f1a\u6709\u5f88\u591a\u901a\u8fc7 React.createElement \u624b\u52a8\u521b\u5efa\u5143\u7d20\u7684\u573a\u666f:"),(0,o.kt)("p",null,"React.createElement \u5176\u63a5\u6536\u4e09\u4e2a\u6216\u4ee5\u4e0a\u53c2\u6570\uff1a"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"type\uff1a\u8981\u521b\u5efa\u7684 React \u5143\u7d20\u7c7b\u578b\uff0c\u53ef\u4ee5\u662f\u6807\u7b7e\u540d\u79f0\u5b57\u7b26\u4e32\uff0c\u5982 'div' \u6216\u8005 'span' \u7b49\uff1b\u4e5f\u53ef\u4ee5\u662f React\u7ec4\u4ef6 \u7c7b\u578b(class\u7ec4\u4ef6\u6216\u8005\u51fd\u6570\u7ec4\u4ef6)\uff1b\u6216\u8005\u662f React fragment \u7c7b\u578b\u3002"),(0,o.kt)("li",{parentName:"ul"},"config\uff1a\u5199\u5728\u6807\u7b7e\u4e0a\u7684\u5c5e\u6027\u7684\u96c6\u5408\uff0cjs \u5bf9\u8c61\u683c\u5f0f\uff0c\u82e5\u6807\u7b7e\u4e0a\u672a\u6dfb\u52a0\u4efb\u4f55\u5c5e\u6027\u5219\u4e3a null\u3002"),(0,o.kt)("li",{parentName:"ul"},"children\uff1a\u4ece\u7b2c\u4e09\u4e2a\u53c2\u6570\u5f00\u59cb\u540e\u7684\u53c2\u6570\u4e3a\u5f53\u524d\u521b\u5efa\u7684React\u5143\u7d20\u7684\u5b50\u8282\u70b9\uff0c\u6bcf\u4e2a\u53c2\u6570\u7684\u7c7b\u578b\uff0c\u82e5\u662f\u5f53\u524d\u5143\u7d20\u8282\u70b9\u7684 textContent \u5219\u4e3a\u5b57\u7b26\u4e32\u7c7b\u578b\uff1b\u5426\u5219\u4e3a\u65b0\u7684 React.createElement \u521b\u5efa\u7684\u5143\u7d20\u3002")),(0,o.kt)("h3",{id:"17\u7248\u672c-createfiberroot-\u521b\u5efafiberroot\u5bf9\u8c61"},"17\u7248\u672c-createFiberRoot \u521b\u5efafiberRoot\u5bf9\u8c61"),(0,o.kt)("p",null,"\u6700\u7ec8\u521b\u5efa\u4e86 fiberRoot \u548c rootFiber\uff1a"),(0,o.kt)("mermaid",{value:"flowchart LR\nA1(createContainer)--\x3eA2(createFiberRoot)--\x3eE12(createHostRootFiber)\nA2--\x3eFiberRootNode"}),(0,o.kt)("h2",{id:"\u6d41\u7a0b\u56fe\u6784\u5efafiber-tree-\u63a5\u4e0a\u9762updatecontainer"},"\u6d41\u7a0b\u56fe\u6784\u5efafiber tree-\u63a5\u4e0a\u9762updateContainer"),(0,o.kt)("p",null,"fiber \u534f\u8c03\u8fc7\u7a0b,\u6784\u5efafiber\u6811\u7684\u9636\u6bb5\u53ef\u4e2d\u65ad"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"\u6ce8\u610f\uff1a\nmountIndeterminateComponent()\u51fd\u6570,code\u51fd\u6570\u521d\u59cb\u5316\u5728renderWithHooks\u8fd9\u91cc\u6267\u884c"),(0,o.kt)("ul",{parentName:"blockquote"},(0,o.kt)("li",{parentName:"ul"},"\u8c03\u7528  renderWithHooks \u751f\u6210 value,value\u5c31\u662fcode()\u8fd4\u56de\u7684\u6811\u7ed3\u6784"),(0,o.kt)("li",{parentName:"ul"},"\u6267\u884c reconcileChildren(null, workInProgress, value, renderLanes) \u53c2\u6570value"))),(0,o.kt)("mermaid",{value:'flowchart TD\nA1("updateContainer(children, root")--\x3eA2("root=scheduleUpdateOnFiber(current$1,lane")--\x3e A3("ensureRootIsScheduled(root,eventTime)")\n\nA3--"ensureRootIsScheduled(root,currentTime)\u51fd\u6570\u4e2d"--\x3eifB{{"\u66f4\u65b0\u65b9\u5f0f?newCallbackPriority ===SyncLane"}}\n\nD1("scheduleLegacySyncCallback(performSyncWorkOnRoot.bind(null,root))")\nD2("newCallbackNode=scheduleCallback$1(schedulerPriorityLevel, performConcurrentWorkOnRoot.bind(null,root))")\n\nifB--true\u5f02\u6b65\u66f4\u65b0legacy\u6a21\u5f0f--\x3eD1\nifB--\u521d\u6b21\u6e32\u67d3\u9ed8\u8ba4false,\u540c\u6b65\u66f4\u65b0concurrent\u6a21\u5f0f--\x3eD2\n\nD2--\x3eD3("scheduleCallback$1")--\x3eD4("performConcurrentWorkOnRoot(root, didTimeout){<br> exitStatus = renderRootSync(root,lanes)}")\n\nD4--1--\x3eD5("renderRootSync(root,lanes)")\n\nD4--"2.exitStatus!==RootInProgress"--\x3eC1("finishConcurrentRender(root,exitStatus)render\u9636\u6bb5\u7ed3\u675f,commit\u9636\u6bb5\u524d")\n\nD5(workLoopSync\u5f00\u59cb\u5faa\u73af-beginWork\u5f00\u59cb)--\x3eA0Aif\nA0Aif{{workInProgress!=null? \u4e3anull\u7ed3\u675f\u5f53\u524d\u5faa\u73af,\u8fdb\u5165commit}}--\u4e0d\u4e3anull--\x3eE1\n%% A0Aif--\u4e3anull--\x3eendW(\u7ed3\u675f\u5f53\u524d\u5faa\u73af)\n\nsubgraph render1[\u6784\u5efafiber\u6811/\u534f\u8c03\u9636\u6bb5:render\u662f\u4e00\u4e2a\u6df1\u5ea6\u4f18\u5148\u904d\u5386\u7684\u8fc7\u7a0b\u6838\u5fc3\u51fd\u6570beginWork\u548ccompleteUnitOfWork]\n\n  E1(performUnitOfWork:\u6df1\u5ea6\u904d\u5386)\n\n  E1--1.\u904d\u5386\u5230\u7684\u8282\u70b9\u6267\u884cbeginWork\u521b\u5efa\u5b50fiber\u8282\u70b9--\x3eE2(beginWork$1\u5904\u7406\u5b8c\u8fd4\u56denext)\n\n  E1--2.\u82e5\u5f53\u524d\u8282\u70b9\u4e0d\u5b58\u5728\u5b50\u8282\u70b9:next=null--\x3eE6B(completeUnitOfWork)\n  \n  E2--current=null\u521d\u59cb\u5316:tag\u8fdb\u5165\u4e0d\u540ccase--\x3eworkCase("switch (workInProgress.tag)")\n  \n  workCase--1--\x3eHostRoot("\u9996\u6b21\u8fdb\u5165HostRoot<br/>\u66f4\u65b0updateHostRoot")\n\n  workCase--2--\x3emountIndeterminateComponent("\u7b2c\u4e8c\u6b21case IndeterminateComponent<br/>\u8c03\u7528mountIndeterminateComponent")\n\n  mountIndeterminateComponent--\x3eq1("renderWithHooks(null, workInProgress, Component<br/>\u8fd9\u4e2a\u51fd\u6570\u521d\u59cb\u5316hook\u51fd\u6570\u5e76\u6267\u884ccode\u51fd\u6570")\n\n  q1--1--\x3ehooks("ReactCurrentDispatcher$1.current=HooksDispatcherOnMountInDEV")\n  q1--2--\x3ecode("children=Component(props,secondArg)<br/>\u6267\u884cast\u751f\u6210\u7684code")\n\n  workCase--3--\x3eE6A(case:HostComponent\u4e3a\u4f8b)--\x3eE6A1(updateHostComponent$1)--\x3eE6A2(reconcileChildren-diff\u7b97\u6cd5)--current!=null--\x3eE6A3(reconcileChildFibers)\n\n\t%% subgraph beginWork2[beginWork\u7b2c\u4e8c\u9636\u6bb5]\n\tE6A2--current==null--\x3ez1("mountChildFibers:beginWork\u7b2c\u4e8c\u9636\u6bb5")--\x3ez2(ChildReconciler)--case--\x3ez3(placeSingleChild)\n\n  E2-.current!=null\u66f4\u65b0\u6d41\u7a0b.->E51(attemptEarlyBailoutIfNoScheduledUpdate)--\x3eE52(bailoutOnAlreadyFinishedWork)--\x3eE53(cloneChildFibers)\n\n  E6B--\x3eE6B1[\u4e3a\u4f20\u5165\u7684\u8282\u70b9\u6267\u884ccompleteWork:\u6267\u884c\u4e0d\u540ctag]--case:HostComponent\u5e76\u4e14current!=null--\x3eE6B2(update\u6d41\u7a0b:updateHostComponent)--\x3eE6A1A(prepareUpdate:\u5bf9\u6bd4props)--\x3eE6A1B(diffProperties)--\x3eE6A1C(markUpdate:\u8d4b\u503c\u66f4\u65b0\u7684flags\u4e5f\u53ebupdate)\n\n  E6B1--case:HostComponent-current=null--\x3eE6B3(\u4e3afiber\u521b\u5efadom:createInstance)\n  E6B3--case:HostComponent-current=null--\x3eE6B4(add child dom:appendAllChildren)\n  E6B3--\x3eE6B3A(createElement)--\x3eE6B3B(document.createElement)\n\n  E53--\x3ecreateWorkInProgress\n  E53-.tag\u7c7b\u578b\u8fdb\u5165\u4e0d\u540ccase.->workCase\n\n\t%% subgraph render2[\u6784\u5efaFiberNode]\n\tE6A3-.\u6839\u636e\u5b50\u8282\u70b9\u7c7b\u578b\u521b\u5efafiber\u8282\u70b9.->o1(reconcileSingleElement) --\x3eo2(createFiberFromElement) --\x3e o3(createFiberFromTypeAndProps) --fiber.type\u4e5f\u662f\u5728\u8fd9\u91cc\u8d4b\u503c--\x3e o4(createFiber)--\x3e o5(return new FiberNode)\n\t%% end\nend'}),(0,o.kt)("h3",{id:"beginwork\u524d\u7f6e\u5de5\u4f5c\u548cbeginwork\u8fdb\u884c\u4e2d"},"beginWork\u524d\u7f6e\u5de5\u4f5c\u548cbeginWork\u8fdb\u884c\u4e2d"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"performConcurrentWorkOnRoot(root, didTimeout)--\x3erenderRootSync",(0,o.kt)("br",null),"\nbeginWork\u524d\u7f6e\u5de5\u4f5c")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function renderRootSync(root, lanes) {\n  // \u7701\u7565\n    do {\n    try {\n      console.log('%c=render\u9636\u6bb5\u51c6\u5907:', 'color:red', 'renderRootSync()\u8c03\u7528workLoopSync()-root:', { root });\n      workLoopSync();\n      break;\n    } catch (thrownValue) {\n      handleError(root, thrownValue);\n    }\n  } while (true);\n  // \u7701\u7565\n}\n\nfunction workLoopSync() {\n  // Already timed out, so perform work without checking if we need to yield.\n  while (workInProgress !== null) {\n    performUnitOfWork(workInProgress);\n  }\n}\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"performUnitOfWork--\x3e",(0,o.kt)("inlineCode",{parentName:"li"},"beginWork$1"),"\u5f00\u542fbeginWork"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"mountChildFibers"),"\u4e0e",(0,o.kt)("inlineCode",{parentName:"li"},"reconcileChildFibers"),"\u8fd9\u4e24\u4e2a\u65b9\u6cd5\u7684\u903b\u8f91\u57fa\u672c\u4e00\u81f4\u3002\u552f\u4e00\u7684\u533a\u522b\u662f\uff1areconcileChildFibers \u4f1a\u4e3a\u751f\u6210\u7684 Fiber \u8282\u70b9\u5e26\u4e0aeffectTag\u5c5e\u6027\uff0c\u800c mountChildFibers \u4e0d\u4f1a\u3002")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function reconcileChildren(current, workInProgress, nextChildren, renderLanes) {\n  if (current === null) {\n    // If this is a fresh new component that hasn't been rendered yet, we\n    // won't update its child set by applying minimal side-effects. Instead,\n    // we will add them all to the child before it gets rendered. That means\n    // we can optimize this reconciliation pass by not tracking side-effects.\n    // \u5bf9\u4e8e mount \u7684\u7ec4\u4ef6\n    workInProgress.child = mountChildFibers(workInProgress, null, nextChildren, renderLanes);\n  } else {\n    // If the current child is the same as the work in progress, it means that\n    // we haven't yet started any work on these children. Therefore, we use\n    // the clone algorithm to create a copy of all the current children.\n    // If we had any progressed work already, that is invalid at this point so\n    // let's throw it out.\n    // \u5bf9\u4e8e update \u7684\u7ec4\u4ef6\n    workInProgress.child = reconcileChildFibers(workInProgress, current.child, nextChildren, renderLanes);\n  }\n}\n")),(0,o.kt)("h3",{id:"workinprogress\u6784\u5efa\u6b65\u9aa41"},"workInProgress\u6784\u5efa\u6b65\u9aa41"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"beginWork\u7b2c\u4e00\u6b21\u4f1a\u8c03\u7528updateHostRoot\u8fdb\u884c\u521d\u59cb\u5316:updateHostRoot"),(0,o.kt)("li",{parentName:"ul"},"\u7b2c\u4e8c\u6b21\u624d\u8d70 mountIndeterminateComponent \u6267\u884ccode()\u51fd\u6570,\u6b64\u65f6\u7684workInProgress.type \u624d\u6709\u503c;")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"  function beginWork(current, workInProgress, renderLanes) {\n    console.log('workInProgress', workInProgress, root)\n    debugger\n    workInProgress.lanes = NoLanes;\n    console.log('%c=beginWork()===start1-\u521d\u59cb\u5316', 'color:magenta', { getFiberName: getFiberName(workInProgress), current, renderLanes, workInProgress })\n    switch (workInProgress.tag) {\n      case IndeterminateComponent:\n        {\n          console.log('%c=beginWork()==end 2 mountIndeterminateComponent', 'color:magenta', workInProgress)\n          console.log(`%c=\u63a2\u7a76\u521d\u59cb\u548chook=\u8c03\u7528mountIndeterminateComponent`, 'color:blueviolet', workInProgress.type)\n          return mountIndeterminateComponent(current, workInProgress, workInProgress.type, renderLanes);\n      }\n      case HostRoot:\n        console.log('%c=beginWork()=end 6\u7b2c\u4e00\u6b21\u4f1a\u8d70\u8fd9\u91cc\u521d\u59cb\u5316workInProgress', 'color:magenta')\n        console.log('%c=beginWork()=end 6 updateHostRoot', 'color:magenta')\n        return updateHostRoot(current, workInProgress, renderLanes);\n    }\n  }\n")),(0,o.kt)("h3",{id:"render\u9636\u6bb5completeunitofwork"},"render\u9636\u6bb5completeUnitOfWork"),(0,o.kt)("h3",{id:"render\u9636\u6bb5\u7ed3\u675fcommit\u9636\u6bb5\u524d\u6b64\u65f6fiber\u6811\u751f\u6210"},"render\u9636\u6bb5\u7ed3\u675f,commit\u9636\u6bb5\u524d:\u6b64\u65f6fiber\u6811\u751f\u6210"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function performConcurrentWorkOnRoot(root, didTimeout) {\n  // \u4e0a\u9762\u7684render\u9636\u6bb5\u6d41\u7a0b\n  var exitStatus = shouldTimeSlice ? renderRootConcurrent(root, lanes) : renderRootSync(root, lanes);\n\n  // \u7701\u7565\n  // \u8fd9\u91cc\u5c06\u4f1a\u5f00\u542fcommit\u9636\u6bb5\u7684\u524d\u7f6e\u5de5\u4f5c\n  finishConcurrentRender(root, exitStatus, lanes)\n  // \u7701\u7565\n}\n")))}p.isMDXComponent=!0}}]);