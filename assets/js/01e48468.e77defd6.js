"use strict";(self.webpackChunkprogramming_technology=self.webpackChunkprogramming_technology||[]).push([[5585],{3905:(e,n,t)=>{t.d(n,{Zo:()=>c,kt:()=>k});var r=t(67294);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,r,o=function(e,n){if(null==e)return{};var t,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var i=r.createContext({}),p=function(e){var n=r.useContext(i),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},c=function(e){var n=p(e.components);return r.createElement(i.Provider,{value:n},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},m=r.forwardRef((function(e,n){var t=e.components,o=e.mdxType,a=e.originalType,i=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),d=p(t),m=o,k=d["".concat(i,".").concat(m)]||d[m]||u[m]||a;return t?r.createElement(k,l(l({ref:n},c),{},{components:t})):r.createElement(k,l({ref:n},c))}));function k(e,n){var t=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var a=t.length,l=new Array(a);l[0]=m;var s={};for(var i in n)hasOwnProperty.call(n,i)&&(s[i]=n[i]);s.originalType=e,s[d]="string"==typeof e?e:o,l[1]=s;for(var p=2;p<a;p++)l[p]=t[p];return r.createElement.apply(null,l)}return r.createElement.apply(null,t)}m.displayName="MDXCreateElement"},31610:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>i,contentTitle:()=>l,default:()=>u,frontMatter:()=>a,metadata:()=>s,toc:()=>p});var r=t(87462),o=(t(67294),t(3905));const a={},l=void 0,s={unversionedId:"React/render\u9636\u6bb52-completeWork",id:"React/render\u9636\u6bb52-completeWork",title:"render\u9636\u6bb52-completeWork",description:"render\u9636\u6bb52:completeWork",source:"@site/programming-tech/React/22-render\u9636\u6bb52-completeWork.md",sourceDirName:"React",slug:"/React/render\u9636\u6bb52-completeWork",permalink:"/React/render\u9636\u6bb52-completeWork",draft:!1,editUrl:"https://github.com/huiruo/programming-tech-website/programming-tech/React/22-render\u9636\u6bb52-completeWork.md",tags:[],version:"current",sidebarPosition:22,frontMatter:{},sidebar:"docs",previous:{title:"render\u9636\u6bb51-beginWork",permalink:"/React/render\u9636\u6bb51-beginWork"},next:{title:"render\u9636\u6bb5\u7ed3\u675f\u540e-\u8fdb\u5165commit\u9636\u6bb5",permalink:"/React/render\u9636\u6bb5\u7ed3\u675f\u540e-\u8fdb\u5165commit\u9636\u6bb5"}},i={},p=[{value:"render\u9636\u6bb52:completeWork",id:"render\u9636\u6bb52completework",level:2},{value:"render\u9636\u6bb52:completeWork",id:"render\u9636\u6bb52completework-1",level:2},{value:"effectList",id:"effectlist",level:3},{value:"completeUnitOfWork",id:"completeunitofwork",level:3},{value:"\u6b63\u5f0f\u8fdb\u5165completeWork",id:"\u6b63\u5f0f\u8fdb\u5165completework",level:3},{value:"\u8c03\u7528createElement\u4e3a\u5f53\u524dfiber\u521b\u5efadom\u8282\u70b9",id:"\u8c03\u7528createelement\u4e3a\u5f53\u524dfiber\u521b\u5efadom\u8282\u70b9",level:3},{value:"appendAllChildren\u8d1f\u8d23\u5c06\u5b50\u5b59DOM\u8282\u70b9\u63d2\u5165\u521a\u751f\u6210\u7684DOM\u8282\u70b9\u4e2d",id:"appendallchildren\u8d1f\u8d23\u5c06\u5b50\u5b59dom\u8282\u70b9\u63d2\u5165\u521a\u751f\u6210\u7684dom\u8282\u70b9\u4e2d",level:3},{value:"\u89e3\u6790\uff1a\u5728&quot;\u5f52&quot;\u9636\u6bb5\u4f1a\u8c03\u7528completeWork\u5904\u7406 Fiber \u8282\u70b9",id:"\u89e3\u6790\u5728\u5f52\u9636\u6bb5\u4f1a\u8c03\u7528completework\u5904\u7406-fiber-\u8282\u70b9",level:2},{value:"\u66f4\u65b0\u9636\u6bb5",id:"\u66f4\u65b0\u9636\u6bb5",level:2},{value:"render\u9636\u6bb5\u4e4bupdate\u65f6: fiber \u53cc\u7f13\u5b58 \u548c diff\uff1bbeginWork\u4e0ecompleteWork\u7684\u4e0d\u540c",id:"render\u9636\u6bb5\u4e4bupdate\u65f6-fiber-\u53cc\u7f13\u5b58-\u548c-diffbeginwork\u4e0ecompletework\u7684\u4e0d\u540c",level:3},{value:"render\u9636\u6bb5\u4e4bupdate\u65f6\u4e24\u4e2a\u51fd\u6570\u5bf9\u6bd4",id:"render\u9636\u6bb5\u4e4bupdate\u65f6\u4e24\u4e2a\u51fd\u6570\u5bf9\u6bd4",level:3},{value:"update\u6d41\u7a0b\u4e4bbeginWork current\u4e0d\u4e3anull\u7684\u903b\u8f91\uff1a",id:"update\u6d41\u7a0b\u4e4bbeginwork-current\u4e0d\u4e3anull\u7684\u903b\u8f91",level:3},{value:"update\u6d41\u7a0b\u4e4bbeginWork\u7b2c\u4e8c\u9636\u6bb5",id:"update\u6d41\u7a0b\u4e4bbeginwork\u7b2c\u4e8c\u9636\u6bb5",level:3},{value:"update\u6d41\u7a0b\u4e4bcompleteWork--&gt;updateHostComponent",id:"update\u6d41\u7a0b\u4e4bcompletework--updatehostcomponent",level:3},{value:"update\u6d41\u7a0b\u4e4bcompleteWork:\u8fd9\u4e2atag\u6807\u8bc6\u6709\u4ec0\u4e48\u7528\u5462",id:"update\u6d41\u7a0b\u4e4bcompletework\u8fd9\u4e2atag\u6807\u8bc6\u6709\u4ec0\u4e48\u7528\u5462",level:3},{value:"\u6269\u5c55\uff1auseState \u66f4\u65b0",id:"\u6269\u5c55usestate-\u66f4\u65b0",level:2},{value:"effectList",id:"effectlist-1",level:2},{value:"\u4f8b\u5b50:\u4ece\u6e32\u67d3\u5230performConcurrentWorkOnRoot\u5728render\u7ed3\u675f\u4f1a\u5f00\u542fcommit\u9636\u6bb5",id:"\u4f8b\u5b50\u4ece\u6e32\u67d3\u5230performconcurrentworkonroot\u5728render\u7ed3\u675f\u4f1a\u5f00\u542fcommit\u9636\u6bb5",level:2},{value:"\u7a0b\u5e8f\u5f00\u5934--&gt;<code>ReactDOM.createRoot</code>",id:"\u7a0b\u5e8f\u5f00\u5934--reactdomcreateroot",level:3},{value:"createFiberRoot--&gt;FiberRootNode\u662f\u521d\u59cb\u5316\u76f8\u5173\u53ea\u8c03\u7528\u4e00\u6b21",id:"createfiberroot--fiberrootnode\u662f\u521d\u59cb\u5316\u76f8\u5173\u53ea\u8c03\u7528\u4e00\u6b21",level:3},{value:"\u53ef\u89c1children \u5c31\u662froot(\u6839\u8282\u70b9)",id:"\u53ef\u89c1children-\u5c31\u662froot\u6839\u8282\u70b9",level:3},{value:"\u5f00\u59cb2:render--&gt;updateContainer()--scheduleUpdateOnFiber",id:"\u5f00\u59cb2render--updatecontainer--scheduleupdateonfiber",level:3},{value:"ensureRootIsScheduled--&gt;performConcurrentWorkOnRoot",id:"ensurerootisscheduled--performconcurrentworkonroot",level:3},{value:"performConcurrentWorkOnRoot \u8fd9\u4e2a\u51fd\u6570\u5728render\u7ed3\u675f\u4f1a\u5f00\u542fcommit\u9636\u6bb5",id:"performconcurrentworkonroot-\u8fd9\u4e2a\u51fd\u6570\u5728render\u7ed3\u675f\u4f1a\u5f00\u542fcommit\u9636\u6bb5",level:3},{value:"\u6d41\u7a0b\u7ed3\u5c3e:render \u9636\u6bb5\u5168\u90e8\u5de5\u4f5c\u5b8c\u6210",id:"\u6d41\u7a0b\u7ed3\u5c3erender-\u9636\u6bb5\u5168\u90e8\u5de5\u4f5c\u5b8c\u6210",level:2},{value:"\u8fd9\u91cc\u4ee5\u4e00\u4e2a\u7b80\u5355\u7684jsx\u7ed3\u6784\u4e3a\u4f8b\uff1a",id:"\u8fd9\u91cc\u4ee5\u4e00\u4e2a\u7b80\u5355\u7684jsx\u7ed3\u6784\u4e3a\u4f8b",level:3}],c={toc:p},d="wrapper";function u(e){let{components:n,...a}=e;return(0,o.kt)(d,(0,r.Z)({},c,a,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"render\u9636\u6bb52completework"},"render\u9636\u6bb52:completeWork"),(0,o.kt)("p",null,"completeWork\u9636\u6bb5\u5904\u5728beginWork\u4e4b\u540e\uff0ccommit\u4e4b\u524d\uff0c\u8d77\u5230\u7684\u662f\u4e00\u4e2a\u627f\u4e0a\u542f\u4e0b\u7684\u4f5c\u7528\u3002\u5b83\u63a5\u6536\u5230\u7684\u662f\u7ecf\u8fc7diff\u540e\u7684fiber\u8282\u70b9\uff0c\u7136\u540e\u4ed6\u81ea\u5df1\u8981\u5c06DOM\u8282\u70b9\u548ceffectList\u90fd\u51c6\u5907\u597d\u3002\u56e0\u4e3acommit\u9636\u6bb5\u662f\u4e0d\u80fd\u88ab\u6253\u65ad\u7684\uff0c\u6240\u4ee5\u5145\u5206\u51c6\u5907\u6709\u5229\u4e8ecommit\u9636\u6bb5\u505a\u66f4\u5c11\u7684\u5de5\u4f5c\u3002"),(0,o.kt)("p",null,"\u6bcf\u4e2afiber\u8282\u70b9\u5728\u66f4\u65b0/\u521b\u5efa\u65f6\u90fd\u4f1a\u7ecf\u5386\u4e24\u4e2a\u9636\u6bb5\uff1abeginWork\u548ccompleteWork\u3002"),(0,o.kt)("p",null,"workLoopSync \u5faa\u73af\u8c03\u7528 performUnitOfWork "),(0,o.kt)("p",null,"\u4f5c\u7528\uff1a"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"\u4e3a\u65b0\u589e\u7684 fiber \u8282\u70b9\u751f\u6210\u5bf9\u5e94\u7684DOM\u8282\u70b9\u3002"),(0,o.kt)("li",{parentName:"ol"},"\u66f4\u65b0DOM\u8282\u70b9\u7684\u5c5e\u6027\u3002"),(0,o.kt)("li",{parentName:"ol"},"\u8fdb\u884c\u4e8b\u4ef6\u7ed1\u5b9a\u3002"),(0,o.kt)("li",{parentName:"ol"},"\u6536\u96c6effectTag\u3002")),(0,o.kt)("h2",{id:"render\u9636\u6bb52completework-1"},"render\u9636\u6bb52:completeWork"),(0,o.kt)("p",null,"complete\u9636\u6bb5workInProgress\u8282\u70b9\u90fd\u662f\u7ecf\u8fc7diff\u7b97\u6cd5\u8c03\u548c\u8fc7\u7684\uff0c\u4e5f\u5c31\u610f\u5473\u7740\u5bf9\u4e8e\u67d0\u4e2a\u8282\u70b9\u6765\u8bf4\u5b83fiber\u7684\u5f62\u6001\u5df2\u7ecf\u57fa\u672c\u786e\u5b9a\u4e86\uff0c\u4f46\u9664\u6b64\u4e4b\u5916\u8fd8\u6709\u4e24\u70b9\uff1a"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"\u76ee\u524d\u53ea\u6709fiber\u5f62\u6001\u53d8\u4e86\uff0c\u5bf9\u4e8e\u539f\u751fDOM\u7ec4\u4ef6\uff08HostComponent\uff09\u548c\u6587\u672c\u8282\u70b9\uff08HostText\uff09\u7684fiber\u6765\u8bf4\uff0c\u5bf9\u5e94\u7684DOM\u8282\u70b9\uff08fiber.stateNode\uff09\u5e76\u672a\u53d8\u5316\u3002"),(0,o.kt)("li",{parentName:"ul"},"\u7ecf\u8fc7Diff\u751f\u6210\u7684\u65b0\u7684workInProgress\u8282\u70b9\u6301\u6709\u4e86flag(\u5373effectTag)")),(0,o.kt)("p",null,"workInProgress\u8282\u70b9\u7684completeWork\u9636\u6bb5\u4e3b\u8981\u505a\u7684:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"\u771f\u5b9eDOM\u8282\u70b9\u7684\u521b\u5efa\u4ee5\u53ca\u6302\u8f7d")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"\u6784\u5efa\u8fc7\u7a0b\u4e2d\uff0c\u4f1a\u81ea\u4e0b\u800c\u4e0a\u5c06\u5b50\u8282\u70b9\u7684\u7b2c\u4e00\u5c42\u7b2c\u4e00\u5c42\u63d2\u5165\u5230\u5f53\u524d\u8282\u70b9\u3002\n\u66f4\u65b0\u8fc7\u7a0b\u4e2d\uff0c\u4f1a\u8ba1\u7b97DOM\u8282\u70b9\u7684\u5c5e\u6027\uff0c\u4e00\u65e6\u5c5e\u6027\u9700\u8981\u66f4\u65b0\uff0c\u4f1a\u4e3aDOM\u8282\u70b9\u5bf9\u5e94\u7684workInProgress\u8282\u70b9\u6807\u8bb0Update\u7684effectTag\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"effectList\u7684\u6536\u96c6")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"\u6267\u884cbeginWork\u540e\u4f1a\u521b\u5efa\u5b50 Fiber \u8282\u70b9\uff0c\u8282\u70b9\u4e0a\u53ef\u80fd\u5b58\u5728effectTag\u3002\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"DOM\u5c5e\u6027\u7684\u5904\u7406,\u6b21\u8981\u7406\u89e3"),(0,o.kt)("li",{parentName:"ul"},"\u9519\u8bef\u5904\u7406,\u6b21\u8981\u7406\u89e3")),(0,o.kt)("p",null,"\u4e00\u65e6workInProgress\u6811\u7684\u6240\u6709\u8282\u70b9\u90fd\u5b8c\u6210complete\uff0c\u5219\u8bf4\u660eworkInProgress\u6811\u5df2\u7ecf\u6784\u5efa\u5b8c\u6210\uff0c\u6240\u6709\u7684\u66f4\u65b0\u5de5\u4f5c\u5df2\u7ecf\u505a\u5b8c\uff0c\u63a5\u4e0b\u6765\u8fd9\u68f5\u6811\u4f1a\u8fdb\u5165commit\u9636\u6bb5"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"\u5982\u679c\u6ca1\u6709\u5b50Fiber\u8282\u70b9\u5219\u8fd4\u56denull, \u53ea\u6709\u5f53next\u4e3anull\u7684\u65f6\u5019\u624d\u4f1a\u8fdb\u5165completeWork;")),(0,o.kt)("p",null,"\u5f53\u524dFiber\u8282\u70b9\u6ca1\u6709\u5b50\u8282\u70b9\u65f6\u5c31\u8fdb\u5165\u4e86completeWork, \u53ef\u4ee5\u7406\u89e3\u4e3a\u9012\u5f52\u9636\u6bb5\u7684\u5f52\u9636\u6bb5\u3002 "),(0,o.kt)("p",null,"workLoopSync \u5faa\u73af\u8c03\u7528 performUnitOfWork "),(0,o.kt)("p",null,"performUnitOfWork--\x3ecompleteUnitOfWork--\x3ecompleteWork "),(0,o.kt)("p",null,"completeWork\u662f\u4e00\u4e2ado while\u5faa\u73af, \u7ec8\u6b62\u6761\u4ef6\u6709completeWork !== null\u6216\u8005\u5faa\u73af\u5185return\u524d\u7684\u51e0\u4e2a\u7ec8\u6b62\u6761\u4ef6"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function performUnitOfWork(unitOfWork) {\n  workInProgressNums = workInProgressNums + 1\n  // The current, flushed, state of this fiber is the alternate. Ideally\n  // nothing should rely on this, but relying on it here means that we don't\n  // need an additional field on the work in progress.\n  var current = unitOfWork.alternate;\n  setCurrentFiber(unitOfWork);\n  var next;\n\n  if ((unitOfWork.mode & ProfileMode) !== NoMode) {\n    startProfilerTimer(unitOfWork);\n    //\u5bf9\u5f53\u524d\u8282\u70b9\u8fdb\u884c\u534f\u8c03\uff0c\u5982\u679c\u5b58\u5728\u5b50\u8282\u70b9\uff0c\u5219\u8fd4\u56de\u5b50\u8282\u70b9\u7684\u5f15\u7528\n    next = beginWork$1(current, unitOfWork, subtreeRenderLanes);\n    stopProfilerTimerIfRunningAndRecordDelta(unitOfWork, true);\n  } else {\n    next = beginWork$1(current, unitOfWork, subtreeRenderLanes);\n  }\n\n  resetCurrentFiber();\n  unitOfWork.memoizedProps = unitOfWork.pendingProps;\n\n  //\u5982\u679c\u65e0\u5b50\u8282\u70b9\uff0c\u5219\u4ee3\u8868\u5f53\u524d\u7684child\u94fe\u8868\u5df2\u7ecf\u904d\u5386\u5b8c\n  if (next === null) {\n    // If this doesn't spawn new work, complete the current work.\n    //\u6b64\u51fd\u6570\u5185\u90e8\u4f1a\u5e2e\u6211\u4eec\u627e\u5230\u4e0b\u4e00\u4e2a\u53ef\u6267\u884c\u7684\u8282\u70b9\n    console.log(`%c \u65e0\u5b50\u8282\u70b9\uff0c\u5219\u4ee3\u8868\u5f53\u524d\u7684child\u94fe\u8868\u5df2\u7ecf\u904d\u5386\u5b8c,\u5f00\u542f\u5b50\u7ec4\u4ef6\u94fecompleteUnitOfWork:${unitOfWork.type}`, 'color:black');\n    completeUnitOfWork(unitOfWork);\n  } else {\n    workInProgress = next;\n  }\n\n  ReactCurrentOwner$2.current = null;\n}\n")),(0,o.kt)("h3",{id:"effectlist"},"effectList"),(0,o.kt)("p",null,"\u6211\u4eec\u5728\u4ecb\u7ecdcompleteUnitOfWork\u51fd\u6570\u7684\u65f6\u5019\u63d0\u5230\uff0c\u4ed6\u7684\u5176\u4e2d\u4e00\u4e2a\u4f5c\u7528\u662f\u7528\u4e8e\u8fdb\u884c\u7236\u8282\u70b9\u7684effectList\u7684\u6536\u96c6\uff1a"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"\u628a\u5f53\u524d fiber \u8282\u70b9\u7684 effectList \u5408\u5e76\u5230\u7236\u8282\u70b9\u7684effectList\u4e2d\u3002"),(0,o.kt)("li",{parentName:"ul"},"\u82e5\u5f53\u524d fiber \u8282\u70b9\u5b58\u5728\u5b58\u5728\u526f\u4f5c\u7528(\u589e,\u5220,\u6539)\uff0c \u5219\u5c06\u5176\u52a0\u5165\u5230\u7236\u8282\u70b9\u7684effectList\u4e2d\u3002")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"  // \u5c06\u6b64\u8282\u70b9\u7684effectList\u5408\u5e76\u5230\u5230\u7236\u8282\u70b9\u7684effectList\u4e2d\n  if (returnFiber.firstEffect === null) {\n    returnFiber.firstEffect = completedWork.firstEffect;\n  }\n    \n  if (completedWork.lastEffect !== null) {\n    if (returnFiber.lastEffect !== null) {\n      returnFiber.lastEffect.nextEffect = completedWork.firstEffect;\n    }\n    returnFiber.lastEffect = completedWork.lastEffect;\n  }\n  // \u82e5\u5f53\u524d fiber \u8282\u70b9\u5b58\u5728\u5b58\u5728\u526f\u4f5c\u7528(\u589e,\u5220,\u6539)\uff0c \u5219\u5c06\u5176\u52a0\u5165\u5230\u7236\u8282\u70b9\u7684`effectList`\u4e2d\u3002\n  const flags = completedWork.flags;\n  if (flags > PerformedWork) {\n    if (returnFiber.lastEffect !== null) {\n      returnFiber.lastEffect.nextEffect = completedWork;\n    } else {\n      returnFiber.firstEffect = completedWork;\n    }\n    returnFiber.lastEffect = completedWork;\n  }\n")),(0,o.kt)("p",null,"effectList\u5b58\u5728\u7684\u76ee\u7684\u662f\u4e3a\u4e86\u63d0\u5347commit\u9636\u6bb5\u7684\u5de5\u4f5c\u6548\u7387\u3002\n\u5728commit\u9636\u6bb5\uff0c\u6211\u4eec\u9700\u8981\u627e\u51fa\u6240\u6709\u5b58\u5728effectTag\u7684fiber\u8282\u70b9\u5e76\u4f9d\u6b21\u6267\u884ceffectTag\u5bf9\u5e94\u64cd\u4f5c\u3002\u4e3a\u4e86\u907f\u514d\u5728commit\u9636\u6bb5\u518d\u53bb\u505a\u904d\u5386\u64cd\u4f5c\u53bb\u5bfb\u627eeffectTag\n\u4e0d\u4e3a\u7a7a\u7684fiber\u8282\u70b9\uff0cReact\u5728completeUnitOfWork\u51fd\u6570\u8c03\u7528\u7684\u8fc7\u7a0b\u4e2d\u63d0\u524d\u628a\u6240\u6709\u5b58\u5728effectTag\u7684\u8282\u70b9\u6536\u96c6\u5230effectList\u4e2d\uff0c\u5728commit\u9636\u6bb5\uff0c\u53ea\u9700\u8981\u904d\u5386effectList\uff0c\u5e76\u6267\u884c\u5404\u4e2a\u8282\u70b9\u7684effectTag\u7684\u5bf9\u5e94\u64cd\u4f5c\u5c31\u597d\u3002"),(0,o.kt)("h3",{id:"completeunitofwork"},"completeUnitOfWork"),(0,o.kt)("p",null,"completeUnitOfWork\u4e3b\u8981\u6d41\u7a0b"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"\u8c03\u7528completeWork\u3002"),(0,o.kt)("li",{parentName:"ol"},"\u7528\u4e8e\u8fdb\u884c\u7236\u8282\u70b9\u7684effectList\u7684\u6536\u96c6\uff1a",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"\u628a\u5f53\u524d fiber \u8282\u70b9\u7684 effectList \u5408\u5e76\u5230\u7236\u8282\u70b9\u7684effectList\u4e2d\u3002"),(0,o.kt)("li",{parentName:"ul"},"\u82e5\u5f53\u524d fiber \u8282\u70b9\u5b58\u5728\u5b58\u5728\u526f\u4f5c\u7528(\u589e,\u5220,\u6539)\uff0c \u5219\u5c06\u5176\u52a0\u5165\u5230\u7236\u8282\u70b9\u7684effectList\u4e2d\u3002"))),(0,o.kt)("li",{parentName:"ol"},"\u6cbf\u7740\u6b64\u8282\u70b9\u6240\u5728\u7684\u5144 -> \u5f1f\u94fe\u8868\u67e5\u770b\u5176\u662f\u5426\u62e5\u6709\u5144\u5f1ffiber\u8282\u70b9\uff08\u5373fiber.sibling !== null\uff09\uff0c\u5982\u679c\u5b58\u5728\uff0c\u5219\u8fdb\u5165\u5176\u5144\u5f1ffiber\u7236 -> \u5b50\u94fe\u8868\n\u7684\u904d\u5386\uff08\u5373\u8fdb\u5165\u5176\u5144\u5f1f\u8282\u70b9\u7684beginWork\u9636\u6bb5\uff09\u3002\u5982\u679c\u4e0d\u5b58\u5728\u5144\u5f1ffiber\uff0c\u4f1a\u901a\u8fc7\u5b50 -> \u7236\u94fe\u8868\u56de\u6eaf\u5230\u7236\u8282\u70b9\u4e0a\uff0c\u76f4\u5230\u56de\u6eaf\u5230\u6839\u8282\u70b9\uff0c\u4e5f\u5373\u5b8c\u6210\u672c\u6b21\u534f\u8c03")),(0,o.kt)("p",null,"completeUnitOfWork \u4ece\u6e90\u7801\u4e2d\u53ef\u4ee5\u770b\u5230\u662f\u4e00\u4e2ado while\u5faa\u73af, \u7ec8\u6b62\u6761\u4ef6\u6709completeWork !== null\u6216\u8005\u5faa\u73af\u5185return\u524d\u7684\u51e0\u4e2a\u7ec8\u6b62\u6761\u4ef6, \u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6709\u4e00\u4e2a\u662fsiblingFiber\u4e0d\u4e3anull\u7684\u60c5\u51b5. \u5373\u5f53\u524d\u7684\u8282\u70b9\u5b58\u5728\u5144\u5f1f\u8282\u70b9\u65f6\u5e76\u4e14\u5df2\u7ecf\u6ca1\u6709\u5b50\u8282\u70b9, \u5f53\u524d\u8282\u70b9\u4f1a\u7ed3\u675fcompleteWork, \u8df3\u51fa\u8c03\u7528\u6808, \u6267\u884c\u4e0b\u4e00\u6b21\u5faa\u73af, \u8fdb\u5165\u5144\u5f1f\u8282\u70b9\u7684beginWork.\u5f53\u5144\u5f1f\u8282\u70b9\u4e3anull\u7684\u65f6\u5019, \u90a3\u4e48completeWork\u4f1a\u88ab\u8d4b\u503c\u4e3areturnFiber, \u8fd9\u4e2a\u65f6\u5019\u6ce8\u610f\u5e76\u6ca1\u6709\u7528return\u8df3\u51fa\u8c03\u7528\u6808, \u56e0\u4e3a\u7236\u7ea7\u8282\u70b9\u7684beginWork\u5df2\u7ecf\u88ab\u6267\u884c, \u56e0\u6b64\u4f1a\u8fdb\u5165\u7236\u7ea7\u8282\u70b9\u7684completeWork, \u7531\u6b64\u5411\u4e0a, \u5f53completeWork\u4e3anull\u65f6\u610f\u5473\u7740\u5f52\u5230\u6839\u8282\u70b9"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function completeUnitOfWork(unitOfWork) {\n  var completedWork = unitOfWork;\n\n  do {\n    var current = completedWork.alternate;\n    var returnFiber = completedWork.return; // Check if the work completed or if something threw.\n\n    if ((completedWork.flags & Incomplete) === NoFlags) {\n      setCurrentFiber(completedWork);\n      var next = void 0;\n\n      if ((completedWork.mode & ProfileMode) === NoMode) {\n        console.log(`%c ==\u5f00\u59cbcompleteWork-1`, 'color:black')\n        next = completeWork(current, completedWork, subtreeRenderLanes);\n      } else {\n        console.log(`%c ==\u5f00\u59cbcompleteWork-2`, 'color:black')\n        startProfilerTimer(completedWork);\n        next = completeWork(current, completedWork, subtreeRenderLanes); // Update render duration assuming we didn't error.\n\n        stopProfilerTimerIfRunningAndRecordDelta(completedWork, false);\n      }\n\n      resetCurrentFiber();\n\n      if (next !== null) {\n        // Completing this fiber spawned new work. Work on that next.\n        workInProgress = next;\n        return;\n      }\n    }else{\n      // ...\n    }\n\n    // \u67e5\u770b\u5f53\u524d\u8282\u70b9\u662f\u5426\u5b58\u5728\u5144\u5f1f\u8282\u70b9\n    var siblingFiber = completedWork.sibling;\n    if (siblingFiber !== null) {\n      // If there is more work to do in this returnFiber, do that next.\n      // \u82e5\u5b58\u5728\uff0c\u4fbf\u628asiblingFiber\u8282\u70b9\u4f5c\u4e3a\u4e0b\u4e00\u4e2a\u5de5\u4f5c\u5355\u5143\uff0c\n      // \u7ee7\u7eed\u6267\u884cperformUnitOfWork\uff0c\u6267\u884c\u5f53\u524d\u8282\u70b9\u5e76\u5c1d\u8bd5\u904d\u5386\u5f53\u524d\u8282\u70b9\u6240\u5728\u7684child\u94fe\u8868\n      workInProgress = siblingFiber;\n      return;\n    }\n\n    // \u5982\u679c\u4e0d\u5b58\u5728\u5144\u5f1f\u8282\u70b9\uff0c\u5219\u56de\u6eaf\u5230\u7236\u8282\u70b9\uff0c\u5c1d\u8bd5\u67e5\u627e\u7236\u8282\u70b9\u7684\u5144\u5f1f\u8282\u70b9\n    completedWork = returnFiber; // Update the next thing we're working on in case something throws.\n    workInProgress = completedWork;\n  } while (completedWork !== null); // We've reached the root.\n}\n")),(0,o.kt)("h3",{id:"\u6b63\u5f0f\u8fdb\u5165completework"},"\u6b63\u5f0f\u8fdb\u5165completeWork"),(0,o.kt)("p",null,"completeWork\u7684\u4f5c\u7528\u5305\u62ec\uff1a"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"\u4e3a\u65b0\u589e\u7684 fiber \u8282\u70b9\u751f\u6210\u5bf9\u5e94\u7684DOM\u8282\u70b9\u3002"),(0,o.kt)("li",{parentName:"ol"},"\u66f4\u65b0DOM\u8282\u70b9\u7684\u5c5e\u6027\u3002"),(0,o.kt)("li",{parentName:"ol"},"\u8fdb\u884c\u4e8b\u4ef6\u7ed1\u5b9a\u3002"),(0,o.kt)("li",{parentName:"ol"},"\u6536\u96c6effectTag\u3002")),(0,o.kt)("p",null,"\u7c7b\u4f3c beginWork\uff0ccompleteWork \u4e5f\u662f\u9488\u5bf9\u4e0d\u540c fiber.tag \u8c03\u7528\u4e0d\u540c\u7684\u5904\u7406\u903b\u8f91\u3002"),(0,o.kt)("p",null,"\u91cd\u70b9\u5173\u6ce8\u9875\u9762\u6e32\u67d3\u6240\u5fc5\u987b\u7684 HostComponent\uff08\u5373\u539f\u751f DOM \u7ec4\u4ef6\u5bf9\u5e94\u7684 Fiber \u8282\u70b9\uff09,"),(0,o.kt)("p",null,"\u540c\u65f6\u9488\u5bf9 HostComponent \uff0c\u5224\u65adupdate\u65f6\u6211\u4eec\u8fd8\u9700\u8981\u8003\u8651 workInProgress.stateNode != null ?\uff08\u5373\u8be5 Fiber \u8282\u70b9\u662f\u5426\u5b58\u5728\u5bf9\u5e94\u7684 DOM \u8282\u70b9\uff09\u3002"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"case HostComponent\u4e3a\u4f8b\u5b50:")),(0,o.kt)("p",null,"\u8fd8\u8bb0\u5f97\u6211\u4eec\u8bb2\u5230\uff1amount \u65f6\u53ea\u4f1a\u5728 rootFiber \u5b58\u5728 Placement effectTag\u3002\u90a3\u4e48commit \u9636\u6bb5\u662f\u5982\u4f55\u901a\u8fc7\u4e00\u6b21\u63d2\u5165 DOM \u64cd\u4f5c\uff08\u5bf9\u5e94\u4e00\u4e2aPlacement effectTag\uff09\u5c06\u6574\u68f5 DOM \u6811\u63d2\u5165\u9875\u9762\u7684\u5462\uff1f"),(0,o.kt)("p",null,"\u539f\u56e0\u5c31\u5728\u4e8e completeWork \u4e2d\u7684appendAllChildren \u65b9\u6cd5\u3002"),(0,o.kt)("p",null,"\u7531\u4e8e completeWork \u5c5e\u4e8e\u201c\u5f52\u201d\u9636\u6bb5\u8c03\u7528\u7684\u51fd\u6570\uff0c\u6bcf\u6b21\u8c03\u7528 appendAllChildren \u65f6\u90fd\u4f1a\u5c06\u5df2\u751f\u6210\u7684\u5b50\u5b59 DOM \u8282\u70b9\u63d2\u5165\u5f53\u524d\u751f\u6210\u7684 DOM \u8282\u70b9\u4e0b\u3002\u90a3\u4e48\u5f53\u201c\u5f52\u201d\u5230 rootFiber \u65f6\uff0c\u6211\u4eec\u5df2\u7ecf\u6709\u4e00\u4e2a\u6784\u5efa\u597d\u7684\u79bb\u5c4f DOM \u6811\u3002"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"hostComponent\u4e3a\u4f8b\u5b50:")),(0,o.kt)("p",null,"\u6839\u636ecurrent\u72b6\u6001\u8fdb\u5165\u4e0d\u540c\u903b\u8f91\uff0c\u6211\u4eec\u5206\u6790\u9996\u5c4f\u6e32\u67d3\u65f6\u7684\u903b\u8f91\uff0c\u4e3b\u8981\u6709\u4ee5\u4e0b\u51e0\u6b65:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"createInstance \u4e3a\u5f53\u524dfiber\u521b\u5efadom\u5b9e\u4f8b")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"createInstance =>\ncreateElement => \ndocument.createElement\n")),(0,o.kt)("ol",{start:2},(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"appendAllChildren \u904d\u5386\u6240\u6709\u540c\u7ea7\u5b50\u4ee3\u8282\u70b9\uff0c\u6267\u884c\u7236\u8282\u70b9\u7684appenChild\u65b9\u6cd5\uff0c\u5373\u6b64\u65b9\u6cd5\u4f1a\u5c06\u6240\u6709\u5b50dom\u8282\u70b9\u4e0e\u5f53\u524d\u521b\u5efa\u7684dom\u5b9e\u4f8b\u8fde\u63a5")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"\u8d4b\u503cstateNode\u5c5e\u6027")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"finalizeInitialChildren \u5904\u7406props"))),(0,o.kt)("p",null,"\u81f3\u6b64\uff0c\u9996\u5c4f\u6e32\u67d3\u65f6render\u9636\u6bb5\u7684\u5927\u4f53\u6d41\u7a0b\u5c31\u68b3\u7406\u5b8c\u4e86"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function completeWork(current, workInProgress, renderLanes) {\n  const newProps = workInProgress.pendingProps;\n\n  switch (workInProgress.tag) {\n    case IndeterminateComponent:\n    case LazyComponent:\n    case SimpleMemoComponent:\n    case FunctionComponent:\n    case ForwardRef:\n    case Fragment:\n    case Mode:\n    case Profiler:\n    case ContextConsumer:\n    case MemoComponent:\n      return null;\n    case ClassComponent: {\n      // ...\u7701\u7565\n      return null;\n    }\n    case HostRoot: {\n      // ...\u7701\u7565\n      updateHostContainer(workInProgress);\n      return null;\n    }\n    case HostComponent:\n        {\n          popHostContext(workInProgress);\n          var rootContainerInstance = getRootHostContainer();\n          var type = workInProgress.type;\n\n          if (current !== null && workInProgress.stateNode != null) {\n            console.log(`%c=completeWork->\u66f4\u65b0\u6d41\u7a0bHostComponent\u8c03\u7528updateHostComponent`, 'color:chartreuse')\n            updateHostComponent(current, workInProgress, type, newProps, rootContainerInstance);\n\n            if (current.ref !== workInProgress.ref) {\n              markRef(workInProgress);\n            }\n          } else {\n            if (!newProps) {\n              if (workInProgress.stateNode === null) {\n                throw new Error('We must have new props for new mounts. This error is likely ' + 'caused by a bug in React. Please file an issue.');\n              } // This can happen when we abort work.\n\n\n              bubbleProperties(workInProgress);\n              return null;\n            }\n\n            var currentHostContext = getHostContext(); // TODO: Move createInstance to beginWork and keep it on a context\n            // \"stack\" as the parent. Then append children as we go in beginWork\n            // or completeWork depending on whether we want to add them top->down or\n            // bottom->up. Top->down is faster in IE11.\n\n            var _wasHydrated = popHydrationState(workInProgress);\n\n            if (_wasHydrated) {\n              // TODO: Move this and createInstance step into the beginPhase\n              // to consolidate.\n              if (prepareToHydrateHostInstance(workInProgress, rootContainerInstance, currentHostContext)) {\n                // If changes to the hydrated node need to be applied at the\n                // commit-phase we mark this as such.\n                markUpdate(workInProgress);\n              }\n            } else {\n              // \u4e3a\u5f53\u524dfiber\u521b\u5efadom\u5b9e\u4f8b\n              console.log('%c=beginWork->HostComponent\u521d\u59cb\u5316\u6d41\u7a0b\u8c03\u7528createInstance\u4e3a\u5f53\u524dfiber\u521b\u5efadom\u5b9e\u4f8b==>start', 'color:chartreuse')\n              var instance = createInstance(type, newProps, rootContainerInstance, currentHostContext, workInProgress);\n              // \u5c06\u5b50\u5b59dom\u8282\u70b9\u8ffd\u52a0\u5230\u5f53\u524d\u521b\u5efa\u7684dom\u8282\u70b9\u4e0a\n              console.log('%c=beginWork->HostComponent\u521d\u59cb\u5316\u6d41\u7a0b-\u5c06\u5b50\u5b59dom\u8282\u70b9\u8ffd\u52a0\u5230\u5f53\u524d\u521b\u5efa\u7684dom\u8282\u70b9\u4e0a', 'color:green', { instance })\n              appendAllChildren(instance, workInProgress, false, false);\n              // \u5c06\u5f53\u524d\u521b\u5efa\u7684\u6302\u8f7d\u5230stateNode\u5c5e\u6027\u4e0a\n              workInProgress.stateNode = instance; // Certain renderers require commit-time effects for initial mount.\n              console.log('%c=beginWork->HostComponent\u521d\u59cb\u5316\u6d41\u7a0b\u5c06\u5f53\u524d\u521b\u5efa\u7684\u6302\u8f7d\u5230workInProgress.stateNode:', 'color:green', { workInProgress_stateNode: workInProgress.stateNode });\n              // (eg DOM renderer supports auto-focus for certain elements).\n              // Make sure such renderers get scheduled for later work.\n              // \u5904\u7406props\uff08\u7ed1\u5b9a\u56de\u8c03\uff0c\u8bbe\u7f6edom\u5c5e\u6027...\uff09\n              if (finalizeInitialChildren(instance, type, newProps, rootContainerInstance)) {\n                markUpdate(workInProgress);\n              }\n            }\n            // ref\u5c5e\u6027\u76f8\u5173\u903b\u8f91\n            if (workInProgress.ref !== null) {\n              // If there is a ref on a host node we need to schedule a callback\n              markRef(workInProgress);\n            }\n          }\n\n          bubbleProperties(workInProgress);\n          return null;\n        }\n}\n")),(0,o.kt)("h3",{id:"\u8c03\u7528createelement\u4e3a\u5f53\u524dfiber\u521b\u5efadom\u8282\u70b9"},"\u8c03\u7528createElement\u4e3a\u5f53\u524dfiber\u521b\u5efadom\u8282\u70b9"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function createElement(type, props, rootContainerElement, parentNamespace) {\n  var isCustomComponentTag; // We create tags in the namespace of their parent container, except HTML\n  // tags get no namespace.\n\n  var ownerDocument = getOwnerDocumentFromRootContainer(rootContainerElement);\n  var domElement;\n  var namespaceURI = parentNamespace;\n\n  if (namespaceURI === HTML_NAMESPACE) {\n    namespaceURI = getIntrinsicNamespace(type);\n  }\n\n  if (namespaceURI === HTML_NAMESPACE) {\n    {\n      isCustomComponentTag = isCustomComponent(type, props); // Should this check be gated by parent namespace? Not sure we want to\n      // allow <SVG> or <mATH>.\n\n      if (!isCustomComponentTag && type !== type.toLowerCase()) {\n        error('<%s /> is using incorrect casing. ' + 'Use PascalCase for React components, ' + 'or lowercase for HTML elements.', type);\n      }\n    }\n\n    if (type === 'script') {\n      // Create the script via .innerHTML so its \"parser-inserted\" flag is\n      // set to true and it does not execute\n      var div = ownerDocument.createElement('div');\n\n      div.innerHTML = '<script><' + '/script>'; // eslint-disable-line\n      // This is guaranteed to yield a script element.\n\n      var firstChild = div.firstChild;\n      domElement = div.removeChild(firstChild);\n    } else if (typeof props.is === 'string') {\n      // $FlowIssue `createElement` should be updated for Web Components\n      domElement = ownerDocument.createElement(type, {\n        is: props.is\n      });\n    } else {\n      // Separate else branch instead of using `props.is || undefined` above because of a Firefox bug.\n      // See discussion in https://github.com/facebook/react/pull/6896\n      // and discussion in https://bugzilla.mozilla.org/show_bug.cgi?id=1276240\n      domElement = ownerDocument.createElement(type); // Normally attributes are assigned in `setInitialDOMProperties`, however the `multiple` and `size`\n      // attributes on `select`s needs to be added before `option`s are inserted.\n      // This prevents:\n      // - a bug where the `select` does not scroll to the correct option because singular\n      //  `select` elements automatically pick the first item #13222\n      // - a bug where the `select` set the first item as selected despite the `size` attribute #14239\n      // See https://github.com/facebook/react/issues/13222\n      // and https://github.com/facebook/react/issues/14239\n\n      if (type === 'select') {\n        var node = domElement;\n\n        if (props.multiple) {\n          node.multiple = true;\n        } else if (props.size) {\n          // Setting a size greater than 1 causes a select to behave like `multiple=true`, where\n          // it is possible that no option is selected.\n          //\n          // This is only necessary when a select in \"single selection mode\".\n          node.size = props.size;\n        }\n      }\n    }\n  } else {\n    domElement = ownerDocument.createElementNS(namespaceURI, type);\n  }\n\n  {\n    if (namespaceURI === HTML_NAMESPACE) {\n      if (!isCustomComponentTag && Object.prototype.toString.call(domElement) === '[object HTMLUnknownElement]' && !hasOwnProperty.call(warnedUnknownTags, type)) {\n        warnedUnknownTags[type] = true;\n\n        error('The tag <%s> is unrecognized in this browser. ' + 'If you meant to render a React component, start its name with ' + 'an uppercase letter.', type);\n      }\n    }\n  }\n\n  console.log(`%c=createElement`, 'color:green', { type, props, domElement })\n  return domElement;\n}\n")),(0,o.kt)("h3",{id:"appendallchildren\u8d1f\u8d23\u5c06\u5b50\u5b59dom\u8282\u70b9\u63d2\u5165\u521a\u751f\u6210\u7684dom\u8282\u70b9\u4e2d"},"appendAllChildren\u8d1f\u8d23\u5c06\u5b50\u5b59DOM\u8282\u70b9\u63d2\u5165\u521a\u751f\u6210\u7684DOM\u8282\u70b9\u4e2d"),(0,o.kt)("p",null,"beginWork\u65f6\u4ecb\u7ecd\u8fc7\uff0c\u5728mount\u65f6\uff0c\u4e3a\u4e86\u907f\u514d\u6bcf\u4e2afiber\u8282\u70b9\u90fd\u9700\u8981\u8fdb\u884c\u63d2\u5165\u64cd\u4f5c\uff0c\u5728mount\u65f6\uff0c\u53ea\u6709\u6839\u8282\u70b9\u4f1a\u6536\u96c6effectTag\uff0c\n\u5176\u4f59\u8282\u70b9\u4e0d\u4f1a\u8fdb\u884ceffectTag\u7684\u6536\u96c6\u3002\u7531\u4e8e\u6bcf\u6b21\u6267\u884cappendAllChildren\u540e\uff0c\u6211\u4eec\u90fd\u80fd\u5f97\u5230\u4e00\u68f5\u4ee5\u5f53\u524dworkInProgress\u4e3a\n\u6839\u8282\u70b9\u7684DOM\u6811\u3002\u56e0\u6b64\u5728commit\u9636\u6bb5\u6211\u4eec\u53ea\u9700\u8981\u5bf9mount\u7684\u6839\u8282\u70b9\u8fdb\u884c\u4e00\u6b21\u63d2\u5165\u64cd\u4f5c\u5c31\u53ef\u4ee5\u4e86\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"  appendAllChildren = function(\n    parent: Instance,\n    workInProgress: Fiber,\n    needsVisibilityToggle: boolean,\n    isHidden: boolean,\n  ) {\n    // \u83b7\u53d6workInProgress\u7684\u5b50fiber\u8282\u70b9\n    let node = workInProgress.child;\n\n    // \u5f53\u5b58\u5728\u5b50\u8282\u70b9\u65f6\uff0c\u53bb\u5f80\u4e0b\u904d\u5386\n    while (node !== null) {\n      if (node.tag === HostComponent || node.tag === HostText) {\n        // \u5f53node\u8282\u70b9\u4e3aHostComponent\u540eHostText\u65f6\uff0c\u76f4\u63a5\u63d2\u5165\u5230\u5b50DOM\u8282\u70b9\u5217\u8868\u7684\u5c3e\u90e8\n        appendInitialChild(parent, node.stateNode);\n      } else if (enableFundamentalAPI && node.tag === FundamentalComponent) {\n        appendInitialChild(parent, node.stateNode.instance);\n      } else if (node.tag === HostPortal) {\n        // \u5f53node\u8282\u70b9\u4e3aHostPortal\u7c7b\u578b\u7684\u8282\u70b9\uff0c\u4ec0\u4e48\u90fd\u4e0d\u505a\n      } else if (node.child !== null) {\n        // \u4e0a\u9762\u5206\u652f\u90fd\u6ca1\u6709\u547d\u4e2d\uff0c\u8bf4\u660enode\u8282\u70b9\u4e0d\u5b58\u5728\u5bf9\u5e94DOM\uff0c\u5411\u4e0b\u67e5\u627e\u62e5\u6709stateNode\u5c5e\u6027\u7684\u5b50\u8282\u70b9\n        node.child.return = node;\n        node = node.child;\n        continue;\n      }\n      if (node === workInProgress) {\n        // \u56de\u6eaf\u5230workInProgress\u65f6\uff0c\u4ee5\u6dfb\u52a0\u5b8c\u6240\u6709\u5b50\u8282\u70b9\n        return;\n      }\n\n      // \u5f53node\u8282\u70b9\u4e0d\u5b58\u5728\u5144\u5f1f\u8282\u70b9\u65f6\uff0c\u5411\u4e0a\u56de\u6eaf\n      while (node.sibling === null) {\n        // \u56de\u6eaf\u5230workInProgress\u65f6\uff0c\u4ee5\u6dfb\u52a0\u5b8c\u6240\u6709\u5b50\u8282\u70b9\n        if (node.return === null || node.return === workInProgress) {\n          return;\n        }\n        node = node.return;\n      }\n      \n      // \u6b64\u65f6workInProgress\u7684\u7b2c\u4e00\u4e2a\u5b50DOM\u8282\u70b9\u5df2\u7ecf\u63d2\u5165\u5230\u8fdb\u5165workInProgress\u5bf9\u5e94\u7684DOM\u8282\u70b9\u4e86\uff0c\u5f00\u59cb\u8fdb\u5165node\u8282\u70b9\u7684\u5144\u5f1f\u8282\u70b9\u7684\u63d2\u5165\u64cd\u4f5c\n      node.sibling.return = node.return;\n      node = node.sibling;\n    }\n  };\n")),(0,o.kt)("h2",{id:"\u89e3\u6790\u5728\u5f52\u9636\u6bb5\u4f1a\u8c03\u7528completework\u5904\u7406-fiber-\u8282\u70b9"},'\u89e3\u6790\uff1a\u5728"\u5f52"\u9636\u6bb5\u4f1a\u8c03\u7528completeWork\u5904\u7406 Fiber \u8282\u70b9'),(0,o.kt)("p",null,"completeWork \u5c06\u6839\u636e workInProgress \u8282\u70b9\u7684 tag \u5c5e\u6027\u7684\u4e0d\u540c\uff0c\u8fdb\u5165\u4e0d\u540c\u7684 DOM \u8282\u70b9\u7684\u521b\u5efa\u3001\u5904\u7406\u903b\u8f91\u3002"),(0,o.kt)("p",null,"completeWork \u5185\u90e8\u6709 3 \u4e2a\u5173\u952e\u52a8\u4f5c\uff1a"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"\u521b\u5efa DOM \u8282\u70b9\uff08CreateInstance\uff09"),(0,o.kt)("li",{parentName:"ul"},"\u5c06 DOM \u8282\u70b9\u63d2\u5165\u5230 DOM \u6811\u4e2d\uff08AppendAllChildren\uff09"),(0,o.kt)("li",{parentName:"ul"},"\u4e3a DOM \u8282\u70b9\u8bbe\u7f6e\u5c5e\u6027\uff08FinalizeInitialChildren\uff09")),(0,o.kt)("p",null,'\u5f53\u67d0\u4e2a Fiber \u8282\u70b9\u6267\u884c\u5b8ccompleteWork\uff0c\u5982\u679c\u5176\u5b58\u5728\u5144\u5f1f Fiber \u8282\u70b9\uff08\u5373fiber.sibling !== null\uff09\uff0c\u4f1a\u8fdb\u5165\u5176\u5144\u5f1f Fiber \u7684"\u9012"\u9636\u6bb5\u3002'),(0,o.kt)("p",null,'\u5982\u679c\u4e0d\u5b58\u5728\u5144\u5f1f Fiber\uff0c\u4f1a\u8fdb\u5165\u7236\u7ea7 Fiber \u7684"\u5f52"\u9636\u6bb5\u3002'),(0,o.kt)("p",null,'"\u9012"\u548c"\u5f52"\u9636\u6bb5\u4f1a\u4ea4\u9519\u6267\u884c\u76f4\u5230"\u5f52"\u5230 rootFiber\u3002\u81f3\u6b64\uff0c\u534f\u8c03\u9636\u6bb5\u7684\u5de5\u4f5c\u5c31\u7ed3\u675f\u4e86\u3002'),(0,o.kt)("h2",{id:"\u66f4\u65b0\u9636\u6bb5"},"\u66f4\u65b0\u9636\u6bb5"),(0,o.kt)("p",null,"\u4f1a\u6839\u636e\u65b0\u7684\u72b6\u6001\u5f62\u6210\u7684jsx\uff08ClassComponent\u7684render\u6216\u8005FuncComponent\u7684\u8fd4\u56de\u503c\uff09\u548ccurrent Fiber\u5bf9\u6bd4\u5f62\uff08diff\u7b97\u6cd5\uff09\u6784\u5efa",(0,o.kt)("strong",{parentName:"p"},"workInProgress\u7684Fiber\u6811")),(0,o.kt)("p",null,"\u7136\u540e\u5c06fiberRoot\u7684current\u6307\u5411workInProgress\u6811\uff0c\u6b64\u65f6workInProgress\u5c31\u53d8\u6210\u4e86current Fiber\u3002"),(0,o.kt)("p",null,"\u5728update\u7684\u65f6\u5019\uff0crender\u9636\u6bb5\u4f1a\u6839\u636e\u6700\u65b0\u7684jsx\u548c\u8001\u7684Fiber\u8fdb\u884c\u5bf9\u6bd4\uff0c\u751f\u6210\u65b0\u7684Fiber\u3002\n\u8fd9\u4e9bFiber\u4f1a\u5e26\u6709\u5404\u79cd\u526f\u4f5c\u7528\uff0c\u6bd4\u5982\u2018Deletion\u2019\u3001\u2018Update\u2019\u3001\u2018Placement\u2019\u7b49\uff0c\u8fd9\u4e00\u4e2a\u5bf9\u6bd4\u7684\u8fc7\u7a0b\u5c31\u662fdiff\u7b97\u6cd5 \uff0c\u5728commit\u9636\u6bb5\u4f1a\u64cd\u4f5c\u771f\u5b9e\u8282\u70b9\uff0c\u6267\u884c\u76f8\u5e94\u7684\u526f\u4f5c\u7528\u3002"),(0,o.kt)("p",null,"diff \u2f50\u8f83\u7684\u662f\u4ec0\u4e48\uff1f \u2f50\u8f83\u7684\u662f current fiber \u548c vdom\uff0c\u2f50\u8f83\u4e4b\u540e\u2f63\u6210 workInProgress Fiber"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"render\u9636\u6bb5\u4f1a\u6839\u636e\u6700\u65b0\u7684jsx\u751f\u6210\u7684\u865a\u62dfdom\u548ccurrent Fiber\u6811\u8fdb\u884c\u5bf9\u6bd4\uff0c\u6bd4\u8f83\u4e4b\u540e\u751f\u6210workInProgress Fiber(workInProgress Fiber\u6811\u7684alternate\u6307\u5411Current Fiber\u6811\u7684\u5bf9\u5e94\u8282\u70b9\uff0c\u8fd9\u4e9bFiber\u4f1a\u5e26\u6709\u5404\u79cd\u526f\u4f5c\u7528\uff0c\u6bd4\u5982\u2018Deletion\u2019\u3001\u2018Update\u2019\u3001'Placement\u2019\u7b49)\u8fd9\u4e00\u5bf9\u6bd4\u8fc7\u7a0b\u5c31\u662fdiff\u7b97\u6cd5\n")),(0,o.kt)("p",null,"\u5f53workInProgress Fiber\u6811\u6784\u5efa\u5b8c\u6210\uff0cworkInProgress \u5219\u6210\u4e3a\u4e86current Fiber\u6e32\u67d3\u5230\u9875\u9762\u4e0a"),(0,o.kt)("h3",{id:"render\u9636\u6bb5\u4e4bupdate\u65f6-fiber-\u53cc\u7f13\u5b58-\u548c-diffbeginwork\u4e0ecompletework\u7684\u4e0d\u540c"},"render\u9636\u6bb5\u4e4bupdate\u65f6: fiber \u53cc\u7f13\u5b58 \u548c diff\uff1bbeginWork\u4e0ecompleteWork\u7684\u4e0d\u540c"),(0,o.kt)("p",null,"\u5728update diff \u6bd4\u8f83\u65f6\uff1a \u5c31\u662f\u5728\u6784\u5efa workInProgress fiber tree \u7684\u8fc7\u7a0b\u4e2d\uff0c\u4f1a\u6839\u636e\u65b0\u7684\u72b6\u6001\u5f62\u6210\u7684jsx\uff08ClassComponent\u7684render\u6216\u8005FuncComponent\u7684\u8fd4\u56de\u503c\uff09\u548ccurrent Fiber\u5bf9\u6bd4\u5f62\uff08diff\u7b97\u6cd5\uff09\u6784\u5efa",(0,o.kt)("strong",{parentName:"p"},"workInProgress\u7684Fiber\u6811"),"\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"\u5224\u65ad current fiber tree \u4e2d\u7684 fiber node \u662f\u5426\u53ef\u4ee5\u88ab workInProgress fiber tree \u590d\u7528\u3002\n\n\u80fd\u88ab\u590d\u7528\uff0c\u610f\u5473\u5728\u672c\u6b21\u66f4\u65b0\u4e2d\uff0c\u9700\u8981\u505a:\n\u7ec4\u4ef6\u7684 update \u4ee5\u53ca dom \u8282\u70b9\u7684 move\u3001update \u7b49\u64cd\u4f5c\uff1b\n\n\u4e0d\u53ef\u590d\u7528\uff0c\u5219\u610f\u5473\u7740\u9700\u8981\u505a:\n\u7ec4\u4ef6\u7684 mount\u3001unmount \u4ee5\u53ca dom \u8282\u70b9\u7684 insert\u3001delete \u7b49\u64cd\u4f5c\u3002\n")),(0,o.kt)("p",null,"\u5f53\u66f4\u65b0\u5b8c\u6210\u4ee5\u540e\uff0cfiberRootNode \u7684 current \u6307\u9488\u4f1a\u6307\u5411 workInProgress fiber tree\uff0c\u4f5c\u4e3a\u4e0b\u4e00\u6b21\u66f4\u65b0\u7684 current fiber tree"),(0,o.kt)("p",null,"\u5f53 update \u65f6\uff0cFiber \u8282\u70b9\u5df2\u7ecf\u5b58\u5728\u5bf9\u5e94 DOM \u8282\u70b9\uff0c\u6240\u4ee5\u4e0d\u9700\u8981\u751f\u6210 DOM \u8282\u70b9\u3002\u9700\u8981\u505a\u7684\u4e3b\u8981\u662f\u5904\u7406 props\uff0c\u6bd4\u5982\uff1a"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"onClick\u3001onChange \u7b49\u56de\u8c03\u51fd\u6570\u7684\u6ce8\u518c\uff1b"),(0,o.kt)("li",{parentName:"ul"},"\u5904\u7406style prop\uff1b"),(0,o.kt)("li",{parentName:"ul"},"\u5904\u7406DANGEROUSLY_SET_INNER_HTML prop\uff1b"),(0,o.kt)("li",{parentName:"ul"},"\u5904\u7406children prop\u3002")),(0,o.kt)("p",null,"\u6211\u4eec\u53bb\u6389\u4e00\u4e9b\u5f53\u524d\u4e0d\u9700\u8981\u5173\u6ce8\u7684\u529f\u80fd\uff08\u6bd4\u5982 ref\uff09\u3002\u53ef\u4ee5\u770b\u5230\u6700\u4e3b\u8981\u7684\u903b\u8f91\u662f\u8c03\u7528 updateHostComponent \u65b9\u6cd5\u3002\u4f60\u53ef\u4ee5\u4ece\u8fd9\u91cc\u770b\u5230updateHostComponent \u65b9\u6cd5\u5b9a\u4e49\u3002"),(0,o.kt)("p",null,"\u5728 updateHostComponent \u5185\u90e8\uff0c\u88ab\u5904\u7406\u5b8c\u7684 props \u4f1a\u88ab\u8d4b\u503c\u7ed9 workInProgress.updateQueue\uff0c\u5e76\u6700\u7ec8\u4f1a\u5728 commit \u9636\u6bb5\u88ab\u6e32\u67d3\u5728\u9875\u9762\u4e0a\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"workInProgress.updateQueue = (updatePayload: any);\n")),(0,o.kt)("p",null,"\u5176\u4e2dupdatePayload\u4e3a\u6570\u7ec4\u5f62\u5f0f\uff0c\u4ed6\u7684\u5947\u6570\u7d22\u5f15\u7684\u503c\u4e3a\u53d8\u5316\u7684 prop key\uff0c\u5076\u6570\u7d22\u5f15\u7684\u503c\u4e3a\u53d8\u5316\u7684 prop value\u3002"),(0,o.kt)("h3",{id:"render\u9636\u6bb5\u4e4bupdate\u65f6\u4e24\u4e2a\u51fd\u6570\u5bf9\u6bd4"},"render\u9636\u6bb5\u4e4bupdate\u65f6\u4e24\u4e2a\u51fd\u6570\u5bf9\u6bd4"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function beginWork(current, workInProgress, renderLanes) {\n  // mount current !== null \u4e3anull,\u4e0d\u8d70\u4ee5\u4e0b\u903b\u8f91\n  if (current !== null) {\n    console.log('%c=beginWork()===start1-\u66f4\u65b0', 'color:magenta', { getFiberName: getFiberName(workInProgress), current, renderLanes, workInProgress })\n    // \u901a\u8fc7\u4e00\u7cfb\u5217\u5224\u65ad\u903b\u8f91\u5224\u65ad\u5f53\u524d\u8282\u70b9\u662f\u5426\u53ef\u590d\u7528\uff0c\u7528didReceiveUpdate\u6765\u6807\u8bb0\uff0c\n  }{\n  console.log('%c=beginWork()===start1-\u521d\u59cb\u5316', 'color:magenta', { getFiberName: getFiberName(workInProgress), current, renderLanes, workInProgress })\n  workInProgress.lanes = NoLanes;\n\n  switch (workInProgress.tag) {\n    case IndeterminateComponent: \n      // ...\u7701\u7565\n    case LazyComponent: \n      // ...\u7701\u7565\n    case FunctionComponent: \n      // ...\u7701\u7565\n    case ClassComponent: \n      // ...\u7701\u7565\n    case HostRoot:\n      // ...\u7701\u7565\n    case HostComponent:\n      console.log(`%c=beginWork()=end 7 updateHostComponent$1,\u5373\u539f\u751f DOM \u7ec4\u4ef6\u5bf9\u5e94\u7684 Fiber\u8282\u70b9:`, 'color:magenta', { type: workInProgress.type })\n      return updateHostComponent$1(current, workInProgress, renderLanes);\n    case HostText:\n  }\n  }\n}\n\nfunction completeWork(current, workInProgress, renderLanes) {\n  const newProps = workInProgress.pendingProps;\n\n  switch (workInProgress.tag) {\n    case IndeterminateComponent:\n    case LazyComponent:\n    case SimpleMemoComponent:\n    case FunctionComponent:\n    case ForwardRef:\n    case Fragment:\n    case Mode:\n    case Profiler:\n    case ContextConsumer:\n    case MemoComponent:\n      return null;\n    case ClassComponent: {\n      // ...\u7701\u7565\n      return null;\n    }\n    case HostRoot: {\n      // ...\u7701\u7565\n      updateHostContainer(workInProgress);\n      return null;\n    }\n    case HostComponent:\n        {\n          popHostContext(workInProgress);\n          var rootContainerInstance = getRootHostContainer();\n          var type = workInProgress.type;\n\n          if (current !== null && workInProgress.stateNode != null) {\n            console.log(`%c=completeWork->\u66f4\u65b0\u6d41\u7a0bHostComponent\u8c03\u7528updateHostComponent`, 'color:chartreuse')\n            updateHostComponent(current, workInProgress, type, newProps, rootContainerInstance);\n\n            if (current.ref !== workInProgress.ref) {\n              markRef(workInProgress);\n            }\n          } else {\n            if (!newProps) {\n              if (workInProgress.stateNode === null) {\n                throw new Error('We must have new props for new mounts. This error is likely ' + 'caused by a bug in React. Please file an issue.');\n              } // This can happen when we abort work.\n\n\n              bubbleProperties(workInProgress);\n              return null;\n            }\n\n            var currentHostContext = getHostContext(); // TODO: Move createInstance to beginWork and keep it on a context\n            // \"stack\" as the parent. Then append children as we go in beginWork\n            // or completeWork depending on whether we want to add them top->down or\n            // bottom->up. Top->down is faster in IE11.\n\n            var _wasHydrated = popHydrationState(workInProgress);\n\n            if (_wasHydrated) {\n              // TODO: Move this and createInstance step into the beginPhase\n              // to consolidate.\n              if (prepareToHydrateHostInstance(workInProgress, rootContainerInstance, currentHostContext)) {\n                // If changes to the hydrated node need to be applied at the\n                // commit-phase we mark this as such.\n                markUpdate(workInProgress);\n              }\n            } else {\n              // \u4e3a\u5f53\u524dfiber\u521b\u5efadom\u5b9e\u4f8b\n              console.log('%c=beginWork->HostComponent\u521d\u59cb\u5316\u6d41\u7a0b\u8c03\u7528createInstance\u4e3a\u5f53\u524dfiber\u521b\u5efadom\u5b9e\u4f8b==>start', 'color:chartreuse')\n              var instance = createInstance(type, newProps, rootContainerInstance, currentHostContext, workInProgress);\n              // \u5c06\u5b50\u5b59dom\u8282\u70b9\u8ffd\u52a0\u5230\u5f53\u524d\u521b\u5efa\u7684dom\u8282\u70b9\u4e0a\n              console.log('%c=beginWork->HostComponent\u521d\u59cb\u5316\u6d41\u7a0b-\u5c06\u5b50\u5b59dom\u8282\u70b9\u8ffd\u52a0\u5230\u5f53\u524d\u521b\u5efa\u7684dom\u8282\u70b9\u4e0a', 'color:green', { instance })\n              appendAllChildren(instance, workInProgress, false, false);\n              // \u5c06\u5f53\u524d\u521b\u5efa\u7684\u6302\u8f7d\u5230stateNode\u5c5e\u6027\u4e0a\n              workInProgress.stateNode = instance; // Certain renderers require commit-time effects for initial mount.\n              console.log('%c=beginWork->HostComponent\u521d\u59cb\u5316\u6d41\u7a0b\u5c06\u5f53\u524d\u521b\u5efa\u7684\u6302\u8f7d\u5230workInProgress.stateNode:', 'color:green', { workInProgress_stateNode: workInProgress.stateNode });\n              // (eg DOM renderer supports auto-focus for certain elements).\n              // Make sure such renderers get scheduled for later work.\n              // \u5904\u7406props\uff08\u7ed1\u5b9a\u56de\u8c03\uff0c\u8bbe\u7f6edom\u5c5e\u6027...\uff09\n              if (finalizeInitialChildren(instance, type, newProps, rootContainerInstance)) {\n                markUpdate(workInProgress);\n              }\n            }\n            // ref\u5c5e\u6027\u76f8\u5173\u903b\u8f91\n            if (workInProgress.ref !== null) {\n              // If there is a ref on a host node we need to schedule a callback\n              markRef(workInProgress);\n            }\n          }\n\n          bubbleProperties(workInProgress);\n          return null;\n        }\n}\n")),(0,o.kt)("p",null,"update\u6d41\u7a0b\u6211\u4eec\u53ea\u9700\u6293\u4f4f\u4e0emount\u7684\u4e0d\u540c\uff1acurrent\u4e0d\u4e3anull\uff0c\u7531\u4e8e\u4e8c\u8005\u7684\u4e0d\u540c\u4e3b\u8981\u4f53\u73b0\u5728render\u9636\u6bb5\uff0c\u56e0\u4e3a\u6211\u4eec\u5206\u522b\u5206\u6790beginWork\u4e0ecompleteWork\u7684\u4e0d\u540c\u3002"),(0,o.kt)("h3",{id:"update\u6d41\u7a0b\u4e4bbeginwork-current\u4e0d\u4e3anull\u7684\u903b\u8f91"},"update\u6d41\u7a0b\u4e4bbeginWork current\u4e0d\u4e3anull\u7684\u903b\u8f91\uff1a"),(0,o.kt)("p",null,"\u901a\u8fc7\u4e00\u7cfb\u5217\u5224\u65ad\u903b\u8f91\u5224\u65ad\u5f53\u524d\u8282\u70b9\u662f\u5426\u53ef\u590d\u7528\uff0c\u7528didReceiveUpdate\u6765\u6807\u8bb0\uff0c\n\u82e5\u53ef\u590d\u7528\u5219\u8d70attemptEarlyBailoutIfNoScheduledUpdate\u3002\u8c03\u7528\u6808\u5982\u4e0b:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"\u987e\u540d\u601d\u4e49\uff0c\u4f1a\u76f4\u63a5\u514b\u9686\u4e00\u4e2afiber\u8282\u70b9\u5e76\u8fd4\u56de\u3002\nattemptEarlyBailoutIfNoScheduledUpdate =>bailoutOnAlreadyFinishedWork=>cloneChildFibers\n")),(0,o.kt)("h3",{id:"update\u6d41\u7a0b\u4e4bbeginwork\u7b2c\u4e8c\u9636\u6bb5"},"update\u6d41\u7a0b\u4e4bbeginWork\u7b2c\u4e8c\u9636\u6bb5"),(0,o.kt)("p",null,"beginWork\u7b2c\u4e8c\u9636\u6bb5\u7684\u903b\u8f91\u662fmount\u4e0eupdate\u5171\u7528\u7684\uff0c\u5f53\u8282\u70b9\u65e0\u6cd5\u590d\u7528\u65f6\u4f1a\u8c03\u7528 reconcileChildren \u751f\u6210\u5b50\u8282\u70b9\uff0c\n\u5176\u5185\u90e8\u4f1a\u6839\u636ecurrent\u662f\u5426\u5b58\u5728\u8fdb\u5165 mountChildFibers\uff08current\u4e3anull\uff09\u6216 reconcileChildFibers\uff08current\u4e0d\u4e3anull\uff09\uff0c"),(0,o.kt)("p",null,"\u6211\u4eec\u5df2\u7ecf\u77e5\u9053\u8fd9\u4e24\u8005\u7684\u903b\u8f91\u57fa\u672c\u662f\u76f8\u540c\u7684\uff0c\u53ea\u662f reconcileChildFibers \u4f1a\u4e3a\u5f53\u524dfiber\u6253\u4e0a flags\uff0c\u5b83\u4ee3\u8868\u5f53\u524ddom\u9700\u8981\u6267\u884c\u7684\u64cd\u4f5c\uff08\u63d2\u5165\uff0c\u66f4\u65b0\uff0c\u5220\u9664\u7b49\uff09\uff0c"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function placeSingleChild(newFiber: Fiber): Fiber {\n   // shouldTrackSideEffects\u4ee3\u8868\u9700\u8981\u8ffd\u8e2a\u526f\u4f5c\u7528\uff0cupdate\u65f6\u4f1a\u5c06\u5176\u6807\u8bb0\u4e3atrue\n   // \u5f53\u524dfiber\u4e0d\u5b58\u5728dom\u5b9e\u4f8b\u65f6\uff0c\u624d\u53ef\u6807\u8bb0Placement\n    if (shouldTrackSideEffects && newFiber.alternate === null) {\n      newFiber.flags |= Placement;\n    }\n    return newFiber;\n  }\n")),(0,o.kt)("p",null,"\u53e6\u5916\uff0c\u7531\u4e8emount\u65f6current\u4e0d\u5b58\u5728\uff0c\u56e0\u6b64reconcileChildFibers\u4e0d\u4f1a\u6709\u5bf9\u6bd4\u66f4\u65b0\u7684\u903b\u8f91\uff0c\u76f4\u63a5\u521b\u5efa\u8282\u70b9\uff0c\u800cupdate\u65f6\u5219\u4f1a\u5c06current\u4e0e\u5f53\u524d\u7684ReactElement\n\u505a\u5bf9\u6bd4\u751f\u6210WIP\uff0c\u4e5f\u5c31\u662fdiff\u7b97\u6cd5\uff0c\u5177\u4f53\u5b9e\u73b0\u7ec6\u8282\u8fd9\u91cc\u4e0d\u5c55\u5f00"),(0,o.kt)("h3",{id:"update\u6d41\u7a0b\u4e4bcompletework--updatehostcomponent"},"update\u6d41\u7a0b\u4e4bcompleteWork--\x3eupdateHostComponent"),(0,o.kt)("p",null,"updateHostComponent \u7528\u4e8e\u66f4\u65b0DOM\u8282\u70b9\u7684\u5c5e\u6027\u5e76\u5728\u5f53\u524d\u8282\u70b9\u5b58\u5728\u66f4\u65b0\u5c5e\u6027\uff0c\u6536\u96c6Update effectTag\u3002"),(0,o.kt)("p",null,"\u6839\u636e\u9700\u4ee3\u7801\uff1a\n\u8981\u53d8\u5316\u7684prop\u4f1a\u88ab\u5b58\u50a8\u5230updatePayload \u4e2d\uff0cupdatePayload \u4e3a\u4e00\u4e2a\u5076\u6570\u7d22\u5f15\u7684\u503c\u4e3a\u53d8\u5316\u7684prop key\uff0c\u5947\u6570\u7d22\u5f15\u7684\u503c\u4e3a\u53d8\u5316\u7684prop value\u7684\u6570\u7ec4\u3002\n\u5e76\u6700\u7ec8\u6302\u8f7d\u5230\u6302\u8f7d\u5230workInProgress.updateQueue\u4e0a\uff0c\u4f9b\u540e\u7eedcommit\u9636\u6bb5\u4f7f\u7528\u3002"),(0,o.kt)("p",null,"\u6211\u4eec\u5df2\u7ecf\u77e5\u9053\uff0cmount\u65f6completeWork\u4f1a\u76f4\u63a5\u521b\u5efadom\u5b9e\u4f8b\uff0c\u800cupdate\u4f1a\u8c03\u7528updateHostComponent\uff0c\u6211\u4eec\u6765\u5206\u6790\u5176\u5b9e\u73b0\u903b\u8f91:"),(0,o.kt)("p",null,"\u5728\u65b0\u65e7props\u4e0d\u540c\u65f6\u8c03\u7528prepareUpdate\uff0c\u4ed6\u4f1a\u5bf9\u6bd4\u65b0\u65e7props\u5e76\u751f\u6210updatePayload\uff0c\u5176\u8c03\u7528\u6808\u5982\u4e0b:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"prepareUpdate--\x3ediffProperties\n")),(0,o.kt)("p",null,"diffProperties\u5185\u90e8\u4e3b\u903b\u8f91\u662f\u5bf9props\u8fdb\u884c\u4e24\u8f6e\u5faa\u73af\uff0c\u5206\u522b\u5904\u7406\u5c5e\u6027\u5220\u9664\u4e0e\u5c5e\u6027\u65b0\u589e\u7684\u60c5\u51b5\uff0c\u6700\u7ec8\u8fd4\u56deupdatePayload\uff0c\u8fd9\u662f\u4e00\u4e2a\u6570\u7ec4\uff0c\n\u7b2ci\u9879\u548c\u7b2ci+1\u9879\u5206\u522b\u662f\u66f4\u65b0\u540e\u7684\u7684key\u548cvalue\u3002\u4ed6\u4f1a\u5728mutation\u9636\u6bb5\u88ab\u7528\u4e8e\u66f4\u65b0\u8282\u70b9\u5c5e\u6027\u3002\nupdateHostComponent\u7684\u6700\u540e\u8c03\u7528\u8fdb\u884cmarkUpdate\uff0c\u8d4b\u503c\u66f4\u65b0\u7684flags\uff08Update\uff09\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"updateHostComponent = function (current, workInProgress, type, newProps, rootContainerInstance) {\n  // If we have an alternate, that means this is an update and we need to\n  // schedule a side-effect to do the updates.\n  var oldProps = current.memoizedProps;\n  console.log(`%c=updateHostComponent\u66f4\u65b0\u6d41\u7a0b`, 'color:chartreuse')\n\n  if (oldProps === newProps) {\n    // In mutation mode, this is sufficient for a bailout because\n    // we won't touch this node even if children changed.\n    return;\n  } // If we get updated because one of our children updated, we don't\n  // have newProps so we'll have to reuse them.\n  // TODO: Split the update API as separate for the props vs. children.\n  // Even better would be if children weren't special cased at all tho.\n\n\n  var instance = workInProgress.stateNode;\n  var currentHostContext = getHostContext(); // TODO: Experiencing an error where oldProps is null. Suggests a host\n  // component is hitting the resume path. Figure out why. Possibly\n  // related to `hidden`.\n\n  // \u5bf9\u6bd4props\u751f\u6210updatePayload\n  var updatePayload = prepareUpdate(instance, type, oldProps, newProps, rootContainerInstance, currentHostContext); // TODO: Type this specific to this type of component.\n\n  workInProgress.updateQueue = updatePayload; // If the update payload indicates that there is a change or if there\n  // is a new ref we mark this as an update. All the work is done in commitWork.\n\n  if (updatePayload) {\n    markUpdate(workInProgress);\n  }\n};\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function diffProperties(\n  domElement: Element,\n  tag: string,\n  lastRawProps: Object,\n  nextRawProps: Object,\n  rootContainerElement: Element | Document,\n): null | Array<mixed> {\n  let updatePayload: null | Array<any> = null;\n  let lastProps: Object;\n  let nextProps: Object;\n  //\u5904\u7406\u65b0\u65e7props \u9488\u5bf9\u8868\u5355\u6807\u7b7e\u505a\u7279\u6b8a\u5904\u7406\n  switch (tag) {\n    case 'input':\n      lastProps = ReactDOMInputGetHostProps(domElement, lastRawProps);\n      nextProps = ReactDOMInputGetHostProps(domElement, nextRawProps);\n      updatePayload = [];\n      break;\n    case 'select':\n      lastProps = ReactDOMSelectGetHostProps(domElement, lastRawProps);\n      nextProps = ReactDOMSelectGetHostProps(domElement, nextRawProps);\n      updatePayload = [];\n      break;\n    case 'textarea':\n      lastProps = ReactDOMTextareaGetHostProps(domElement, lastRawProps);\n      nextProps = ReactDOMTextareaGetHostProps(domElement, nextRawProps);\n      updatePayload = [];\n      break;\n    default:\n      lastProps = lastRawProps;\n      nextProps = nextRawProps;\n      if (\n        typeof lastProps.onClick !== 'function' &&\n        typeof nextProps.onClick === 'function'\n      ) {\n        // TODO: This cast may not be sound for SVG, MathML or custom elements.\n        trapClickOnNonInteractiveElement(((domElement: any): HTMLElement));\n      }\n      break;\n  }\n\n  assertValidProps(tag, nextProps);\n\n  let propKey;\n  let styleName;\n  let styleUpdates = null;\n  for (propKey in lastProps) {\n    if (\n      nextProps.hasOwnProperty(propKey) ||\n      !lastProps.hasOwnProperty(propKey) ||\n      lastProps[propKey] == null\n    ) {\n      continue;\n    }\n    // \u65b0\u65e0\u65e7\u6709\u65f6\u8fdb\u5165\u4e00\u4e0b\u903b\u8f91\uff0c\u5373\u5c5e\u6027\u88ab\u5220\u9664\n    if (propKey === STYLE) {\n      const lastStyle = lastProps[propKey];\n      // \u5c06\u5bf9\u5e94style\u5c5e\u6027\u7f6e\u7a7a\n      for (styleName in lastStyle) {\n        if (lastStyle.hasOwnProperty(styleName)) {\n          if (!styleUpdates) {\n            styleUpdates = {};\n          }\n          styleUpdates[styleName] = '';\n        }\n      }\n    } else {\n      // \u5c06\u5bf9\u5e94key\u53cavalue\uff08null\uff09\u63a8\u5165\u66f4\u65b0\u961f\u5217\uff0c\n      (updatePayload = updatePayload || []).push(propKey, null);\n    }\n  }\n  for (propKey in nextProps) {\n    const nextProp = nextProps[propKey];\n    const lastProp = lastProps != null ? lastProps[propKey] : undefined;\n    if (\n      !nextProps.hasOwnProperty(propKey) ||\n      nextProp === lastProp ||\n      (nextProp == null && lastProp == null)\n    ) {\n      continue;\n    }\n    // \u65b0\u6709\u65e7\u65e0\u6216\u65b0\u65e7\u90fd\u6709\u5207\u4e0d\u76f8\u7b49\u65f6\u8fdb\u5165\u4ee5\u4e0b\u903b\u8f91\n\n    // style\u5c5e\u6027\u7279\u6b8a\u5904\u7406 \u603b\u7ed3\u5982\u4e0b\n    // \u65b0\u6709\u65e7\u65e0 \u63a8\u5165style\u961f\u5217\n    // \u65b0\u65e7\u90fd\u6709 \u7528\u65b0\u7684\n    // \u65b0\u65e0\u65e7\u6709 \u5c06\u5bf9\u5e94\u5c5e\u6027\u7f6e\u7a7a\n    if (propKey === STYLE) {\n      if (lastProp) {\n        for (styleName in lastProp) {\n          if (\n            lastProp.hasOwnProperty(styleName) &&\n            (!nextProp || !nextProp.hasOwnProperty(styleName))\n          ) {\n            if (!styleUpdates) {\n              styleUpdates = {};\n            }\n            styleUpdates[styleName] = '';\n          }\n        }\n        for (styleName in nextProp) {\n          if (\n            nextProp.hasOwnProperty(styleName) &&\n            lastProp[styleName] !== nextProp[styleName]\n          ) {\n            if (!styleUpdates) {\n              styleUpdates = {};\n            }\n            styleUpdates[styleName] = nextProp[styleName];\n          }\n        }\n      } else {\n        if (!styleUpdates) {\n          if (!updatePayload) {\n            updatePayload = [];\n          }\n          updatePayload.push(propKey, styleUpdates);\n        }\n        styleUpdates = nextProp;\n      }\n    } else {\n      // \u5c06\u5bf9\u5e94key\u53cavalue\u63a8\u5165\u66f4\u65b0\u961f\u5217\n      (updatePayload = updatePayload || []).push(propKey, nextProp);\n    }\n  }\n  if (styleUpdates) {\n    (updatePayload = updatePayload || []).push(STYLE, styleUpdates);\n  }\n  return updatePayload;\n}\n")),(0,o.kt)("h3",{id:"update\u6d41\u7a0b\u4e4bcompletework\u8fd9\u4e2atag\u6807\u8bc6\u6709\u4ec0\u4e48\u7528\u5462"},"update\u6d41\u7a0b\u4e4bcompleteWork:\u8fd9\u4e2atag\u6807\u8bc6\u6709\u4ec0\u4e48\u7528\u5462"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"render\u9636\u6bb5\u7ec4\u4ef6\u66f4\u65b0\u4f1a\u6839\u636echeckHasForceUpdateAfterProcessing\uff0c\u548ccheckShouldComponentUpdate\u6765\u5224\u65ad\uff0c\n\n\u5982\u679cUpdate\u7684tag\u662fForceUpdate\uff0c\u5219 checkHasForceUpdateAfterProcessing \u4e3atrue\uff0c\u5f53\u7ec4\u4ef6\u662fPureComponent\u65f6;  checkShouldComponentUpdate \u4f1a\u6d45\u6bd4\u8f83state\u548cprops\uff0c\u6240\u4ee5\u5f53\u4f7f\u7528this.forceUpdate\u4e00\u5b9a\u4f1a\u66f4\u65b0.\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function resumeMountClassInstance(workInProgress, ctor, newProps, renderLanes) {\n  var instance = workInProgress.stateNode;\n  var oldProps = workInProgress.memoizedProps;\n  instance.props = oldProps;\n  var oldContext = instance.context;\n  var contextType = ctor.contextType;\n  var nextContext = emptyContextObject;\n    ...\n  var shouldUpdate = checkHasForceUpdateAfterProcessing() || checkShouldComponentUpdate(workInProgress, ctor, oldProps, newProps, oldState, newState, nextContext);\n  if (shouldUpdate) {\n    // In order to support react-lifecycles-compat polyfilled components,\n    // Unsafe lifecycles should not be invoked for components using the new APIs.\n    if (!hasNewLifecycles && (typeof instance.UNSAFE_componentWillMount === 'function' || typeof instance.componentWillMount === 'function')) {\n      if (typeof instance.componentWillMount === 'function') {\n        instance.componentWillMount();\n      }\n\n      if (typeof instance.UNSAFE_componentWillMount === 'function') {\n        instance.UNSAFE_componentWillMount();\n      }\n    }\n\n    if (typeof instance.componentDidMount === 'function') {\n      workInProgress.flags |= Update;\n    }\n  } else {\n    // If an update was already in progress, we should schedule an Update\n    // effect even though we're bailing out, so that cWU/cDU are called.\n    if (typeof instance.componentDidMount === 'function') {\n      workInProgress.flags |= Update;\n    } // If shouldComponentUpdate returned false, we should still update the\n    // memoized state to indicate that this work can be reused.\n\n\n    workInProgress.memoizedProps = newProps;\n    workInProgress.memoizedState = newState;\n  } // Update the existing instance's state, props, and context pointers even\n}\n")),(0,o.kt)("h2",{id:"\u6269\u5c55usestate-\u66f4\u65b0"},"\u6269\u5c55\uff1auseState \u66f4\u65b0"),(0,o.kt)("p",null,"\u5728react\u4e2d\u89e6\u53d1\u72b6\u6001\u66f4\u65b0\u7684\u51e0\u79cd\u65b9\u5f0f\uff1a"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"ReactDOM.render")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"this.forceUpdate")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"useState")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"useReducer"))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"react \u5408\u6210\u4e8b\u4ef6\u4e2d\u6539\u53d8\u72b6\u6001\u662f\u5f02\u6b65\u7684\uff0c\u51fa\u4e8e\u51cf\u5c11 render \u6b21\u6570\uff0creact \u4f1a\u6536\u96c6\u6240\u6709\u72b6\u6001\u53d8\u66f4\uff0c\u7136\u540e\u6bd4\u5bf9\u4f18\u5316\uff0c\u6700\u540e\u505a\u4e00\u6b21\u53d8\u66f4\n")),(0,o.kt)("h2",{id:"effectlist-1"},"effectList"),(0,o.kt)("p",null,"\u81f3\u6b64render \u9636\u6bb5\u7684\u7edd\u5927\u90e8\u5206\u5de5\u4f5c\u5c31\u5b8c\u6210\u4e86"),(0,o.kt)("p",null,"\u8fd8\u6709\u4e00\u4e2a\u95ee\u9898\uff1a\u4f5c\u4e3a DOM \u64cd\u4f5c\u7684\u4f9d\u636e\uff0ccommit \u9636\u6bb5\u9700\u8981\u627e\u5230\u6240\u6709\u6709 effectTag \u7684 Fiber \u8282\u70b9\u5e76\u4f9d\u6b21\u6267\u884c effectTag \u5bf9\u5e94\u64cd\u4f5c\u3002\u96be\u9053\u9700\u8981\u5728commit \u9636\u6bb5\u518d\u904d\u5386\u4e00\u6b21 Fiber \u6811\u5bfb\u627e effectTag !== null\u7684Fiber \u8282\u70b9\u4e48\uff1f"),(0,o.kt)("p",null,"\u8fd9\u663e\u7136\u662f\u5f88\u4f4e\u6548\u7684\u3002"),(0,o.kt)("p",null,"\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u5728 completeWork \u7684\u4e0a\u5c42\u51fd\u6570 completeUnitOfWork \u4e2d\uff0c\u6bcf\u4e2a\u6267\u884c\u5b8c completeWork \u4e14\u5b58\u5728 effectTag \u7684 Fiber \u8282\u70b9\u4f1a\u88ab\u4fdd\u5b58\u5728\u4e00\u6761\u88ab\u79f0\u4e3aeffectList\u7684\u5355\u5411\u94fe\u8868\u4e2d\u3002"),(0,o.kt)("p",null,"effectList \u4e2d\u7b2c\u4e00\u4e2a Fiber \u8282\u70b9\u4fdd\u5b58\u5728 fiber.firstEffect \uff0c\u6700\u540e\u4e00\u4e2a\u5143\u7d20\u4fdd\u5b58\u5728 fiber.lastEffect\u3002"),(0,o.kt)("p",null,"\u7c7b\u4f3c appendAllChildren\uff0c\u5728\u201c\u5f52\u201d\u9636\u6bb5\uff0c\u6240\u6709\u6709 effectTag \u7684 Fiber \u8282\u70b9\u90fd\u4f1a\u88ab\u8ffd\u52a0\u5728 effectList \u4e2d\uff0c\u6700\u7ec8\u5f62\u6210\u4e00\u6761\u4ee5rootFiber.firstEffect \u4e3a\u8d77\u70b9\u7684\u5355\u5411\u94fe\u8868\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"                       nextEffect         nextEffect\nrootFiber.firstEffect -----------\x3e fiber -----------\x3e fiber\n")),(0,o.kt)("p",null,"\u8fd9\u6837\uff0c\u5728commit \u9636\u6bb5\u53ea\u9700\u8981\u904d\u5386 effectList \u5c31\u80fd\u6267\u884c\u6240\u6709 effect \u4e86\u3002"),(0,o.kt)("p",null,"\u4f60\u53ef\u4ee5\u5728\u8fd9\u91cc\u770b\u5230\u8fd9\u6bb5\u4ee3\u7801\u903b\u8f91\u3002"),(0,o.kt)("p",null,"\u501f\u7528 React \u56e2\u961f\u6210\u5458Dan Abramov\u7684\u8bdd\uff1aeffectList \u76f8\u8f83\u4e8e Fiber \u6811\uff0c\u5c31\u50cf\u5723\u8bde\u6811\u4e0a\u6302\u7684\u90a3\u4e00\u4e32\u5f69\u706f\u3002"),(0,o.kt)("h2",{id:"\u4f8b\u5b50\u4ece\u6e32\u67d3\u5230performconcurrentworkonroot\u5728render\u7ed3\u675f\u4f1a\u5f00\u542fcommit\u9636\u6bb5"},"\u4f8b\u5b50:\u4ece\u6e32\u67d3\u5230performConcurrentWorkOnRoot\u5728render\u7ed3\u675f\u4f1a\u5f00\u542fcommit\u9636\u6bb5"),(0,o.kt)("h3",{id:"\u7a0b\u5e8f\u5f00\u5934--reactdomcreateroot"},"\u7a0b\u5e8f\u5f00\u5934--\x3e",(0,o.kt)("inlineCode",{parentName:"h3"},"ReactDOM.createRoot")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"const root = ReactDOM.createRoot(document.getElementById('root'))\n\nconsole.log(\"=app=root:\", root)\n\nroot.render(<Test />);\n\nfunction createRoot(container, options) {\n        // \u7701\u7565\n    console.log('%c=\u4e00\u5207\u5f00\u59cb1:createRoot(', 'color:red', { createRoot: container, options })\n    var root = createContainer(container, ConcurrentRoot, null, isStrictMode, concurrentUpdatesByDefaultOverride, identifierPrefix, onRecoverableError);\n    markContainerAsRoot(root.current, container);\n    var rootContainerElement = container.nodeType === COMMENT_NODE ? container.parentNode : container;\n    listenToAllSupportedEvents(rootContainerElement);\n    return new ReactDOMRoot(root);\n}\n\nfunction createContainer(containerInfo, tag, hydrationCallbacks, isStrictMode, concurrentUpdatesByDefaultOverride, identifierPrefix, onRecoverableError, transitionCallbacks) {\n    var hydrate = false;\n    var initialChildren = null;\n    console.log('\u521d\u59cb/\u66f4\u65b0--\x3eFiberRoot:a--\x3ecreateContainer')\n    return createFiberRoot(containerInfo, tag, hydrate, initialChildren, hydrationCallbacks, isStrictMode, concurrentUpdatesByDefaultOverride, identifierPrefix, onRecoverableError);\n}\n")),(0,o.kt)("h3",{id:"createfiberroot--fiberrootnode\u662f\u521d\u59cb\u5316\u76f8\u5173\u53ea\u8c03\u7528\u4e00\u6b21"},"createFiberRoot--\x3eFiberRootNode\u662f\u521d\u59cb\u5316\u76f8\u5173\u53ea\u8c03\u7528\u4e00\u6b21"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function createFiberRoot(containerInfo, tag, hydrate, initialChildren, hydrationCallbacks, isStrictMode, concurrentUpdatesByDefaultOverride, // TODO: We have several of these arguments that are conceptually part of the\n    // host config, but because they are passed in at runtime, we have to thread\n    // them through the root constructor. Perhaps we should put them all into a\n    // single type, like a DynamicHostConfig that is defined by the renderer.\n    identifierPrefix, onRecoverableError, transitionCallbacks) {\n    var root = new FiberRootNode(containerInfo, tag, hydrate, identifierPrefix, onRecoverableError);\n\n    return root;\n}\n\nfunction FiberRootNode(containerInfo, tag, hydrate, identifierPrefix, onRecoverableError) {\n    console.log('==FiberRootNode\u662f\u521d\u59cb\u5316\u76f8\u5173\u53ea\u8c03\u7528\u4e00\u6b21===')\n    this.tag = tag;\n    this.containerInfo = containerInfo;\n    this.pendingChildren = null;\n    this.current = null;\n    this.pingCache = null;\n    this.finishedWork = null;\n    this.timeoutHandle = noTimeout;\n    this.context = null;\n    this.pendingContext = null;\n    this.callbackNode = null;\n    this.callbackPriority = NoLane;\n    this.eventTimes = createLaneMap(NoLanes);\n    this.expirationTimes = createLaneMap(NoTimestamp);\n    this.pendingLanes = NoLanes;\n    this.suspendedLanes = NoLanes;\n    this.pingedLanes = NoLanes;\n    this.expiredLanes = NoLanes;\n    this.mutableReadLanes = NoLanes;\n    this.finishedLanes = NoLanes;\n    this.entangledLanes = NoLanes;\n    this.entanglements = createLaneMap(NoLanes);\n    this.identifierPrefix = identifierPrefix;\n    this.onRecoverableError = onRecoverableError;\n\n    {\n        this.mutableSourceEagerHydrationData = null;\n    }\n\n    {\n        this.effectDuration = 0;\n        this.passiveEffectDuration = 0;\n    }\n\n    {\n        this.memoizedUpdaters = new Set();\n        var pendingUpdatersLaneMap = this.pendingUpdatersLaneMap = [];\n\n        for (var _i = 0; _i < TotalLanes; _i++) {\n            pendingUpdatersLaneMap.push(new Set());\n        }\n    }\n\n    {\n        switch (tag) {\n            case ConcurrentRoot:\n                this._debugRootType = hydrate ? 'hydrateRoot()' : 'createRoot()';\n                break;\n\n            case LegacyRoot:\n                this._debugRootType = hydrate ? 'hydrate()' : 'render()';\n                break;\n        }\n    }\n}\n")),(0,o.kt)("h3",{id:"\u53ef\u89c1children-\u5c31\u662froot\u6839\u8282\u70b9"},"\u53ef\u89c1children \u5c31\u662froot(\u6839\u8282\u70b9)"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"ReactDOMHydrationRoot.prototype.render = ReactDOMRoot.prototype.render = function (children) {\n    console.log('%c=\u4e00\u5207\u5f00\u59cb3:', 'color:red', 'ReactDOMRoot.prototype.render\u8c03\u7528updateContainer()\u5f00\u542frender\u9636\u6bb5==', { children });\n    var root = this._internalRoot;\n    // \u7701\u7565\u51fd\u6570\n    updateContainer(children, root, null, null);\n};\n")),(0,o.kt)("h3",{id:"\u5f00\u59cb2render--updatecontainer--scheduleupdateonfiber"},"\u5f00\u59cb2:render--\x3eupdateContainer()--scheduleUpdateOnFiber"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function updateContainer(element, container, parentComponent, callback) {\n    {\n        onScheduleRoot(container, element);\n    }\n\n    var current$1 = container.current;\n    var eventTime = requestEventTime();\n    var lane = requestUpdateLane(current$1);\n\n    {\n        markRenderScheduled(lane);\n    }\n\n    var context = getContextForSubtree(parentComponent);\n\n    if (container.context === null) {\n        container.context = context;\n    } else {\n        container.pendingContext = context;\n    }\n\n    // \u7701\u7565\n    var update = createUpdate(eventTime, lane); // Caution: React DevTools currently depends on this property\n    // being called \"element\".\n\n    update.payload = {\n        element: element\n    };\n    callback = callback === undefined ? null : callback;\n\n\n    // \u7701\u7565\n    console.log('==render\u9636\u6bb5\u51c6\u5907\uff1aupdateContainer\u8c03\u7528enqueueUpdate()\u548cscheduleUpdateOnFiber()==')\n    enqueueUpdate(current$1, update);\n    var root = scheduleUpdateOnFiber(current$1, lane, eventTime);\n\n    if (root !== null) {\n        entangleTransitions(root, current$1, lane);\n    }\n\n    return lane;\n}\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function scheduleUpdateOnFiber(fiber, lane, eventTime) {\n    var root = markUpdateLaneFromFiberToRoot(fiber, lane);\n    console.log('==render\u9636\u6bb5\u51c6\u5907:scheduleUpdateOnFiber()\u8c03\u7528ensureRootIsScheduled()==')\n    ensureRootIsScheduled(root, eventTime);\n    return root;\n}\n")),(0,o.kt)("h3",{id:"ensurerootisscheduled--performconcurrentworkonroot"},"ensureRootIsScheduled--\x3eperformConcurrentWorkOnRoot"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function ensureRootIsScheduled(root, currentTime) {\n    // \u7701\u7565\n    if (newCallbackPriority === SyncLane) {\n        // Special case: Sync React callbacks are scheduled on a special\n        // internal queue\n        if (root.tag === LegacyRoot) {\n            if (ReactCurrentActQueue$1.isBatchingLegacy !== null) {\n                ReactCurrentActQueue$1.didScheduleLegacyUpdate = true;\n            }\n\n            console.log('%c=render\u9636\u6bb5\u51c6\u5907:ensureRootIsScheduled\u8c03\u7528performSyncWorkOnRoot\uff1a\u5f02\u6b65\u66f4\u65b0legacy\u6a21\u5f0f1==', 'color:red')\n            scheduleLegacySyncCallback(performSyncWorkOnRoot.bind(null, root));\n        } else {\n\n            console.log('%c=render\u9636\u6bb5\u51c6\u5907:ensureRootIsScheduled\u8c03\u7528performSyncWorkOnRoot\uff1a\u5f02\u6b65\u66f4\u65b0legacy\u6a21\u5f0f2==', 'color:red')\n            scheduleSyncCallback(performSyncWorkOnRoot.bind(null, root));\n        }\n\n        // \u7701\u7565\n    } else {\n        // \u7701\u7565\n        // console.log('\u66f4\u65b0\u6d41\u7a0b--\x3e0-c2: performConcurrentWorkOnRoot')\n        console.log('%c=render\u9636\u6bb5\u51c6\u5907:', 'color:red', 'ensureRootIsScheduled()\u8c03\u7528performConcurrentWorkOnRoot--\u540c\u6b65\u66f4\u65b0:concurrent\u6a21\u5f0f==')\n        newCallbackNode = scheduleCallback$1(schedulerPriorityLevel, performConcurrentWorkOnRoot.bind(null, root));\n    }\n\n    root.callbackPriority = newCallbackPriority;\n    root.callbackNode = newCallbackNode;\n}\n")),(0,o.kt)("h3",{id:"performconcurrentworkonroot-\u8fd9\u4e2a\u51fd\u6570\u5728render\u7ed3\u675f\u4f1a\u5f00\u542fcommit\u9636\u6bb5"},"performConcurrentWorkOnRoot \u8fd9\u4e2a\u51fd\u6570\u5728render\u7ed3\u675f\u4f1a\u5f00\u542fcommit\u9636\u6bb5"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function performConcurrentWorkOnRoot(root, didTimeout) {\n    // \u7701\u7565\n    console.log('%c==render\u9636\u6bb5\u51c6\u5907:\u91cd\u70b9\u51fd\u6570performConcurrentWorkOnRoot,\u8fd9\u4e2a\u51fd\u6570\u5728render\u7ed3\u675f\u4f1a\u5f00\u542fcommit\u9636\u6bb5', 'color:red', 'color:cyan');\n\n    console.log('==render\u9636\u6bb5\u51c6\u5907:performConcurrentWorkOnRoot\u8c03\u7528renderRootSync():\u540c\u6b65\u66f4\u65b0concurrent\u6a21\u5f0f:', { shouldTimeSlice });\n    var exitStatus = shouldTimeSlice ? renderRootConcurrent(root, lanes) : renderRootSync(root, lanes);\n\n    if (exitStatus !== RootInProgress) {\n        // \u7701\u7565\n\n        if (exitStatus === RootDidNotComplete) {\n            markRootSuspended$1(root, lanes);\n        } else {\n            // \u7701\u7565\n\n            root.finishedWork = finishedWork;\n            root.finishedLanes = lanes;\n            console.log(`%c=commit\u9636\u6bb5=\u524d=render\u9636\u6bb5\u7ed3\u675f=performConcurrentWorkOnRoot\u8c03\u7528finishConcurrentRender--\x3ecommitRoot`, 'color:cyan')\n            finishConcurrentRender(root, exitStatus, lanes);\n        }\n    }\n\n    // \u7701\u7565\n\n    return null;\n}\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function renderRootSync(root, lanes) {\n    var prevExecutionContext = executionContext;\n    executionContext |= RenderContext;\n    var prevDispatcher = pushDispatcher(); // If the root or lanes have changed, throw out the existing stack\n    // \u7701\u7565\n\n    do {\n        try {\n            console.log('%c=render\u9636\u6bb5\u51c6\u5907:', 'color:red', 'renderRootSync()\u8c03\u7528workLoopSync()-root:', { root });\n            workLoopSync();\n            break;\n        } catch (thrownValue) {\n            handleError(root, thrownValue);\n        }\n    } while (true);\n\n    // \u7701\u7565\n    workInProgressRoot = null;\n    workInProgressRootRenderLanes = NoLanes;\n    return workInProgressRootExitStatus;\n}\n")),(0,o.kt)("p",null,"\u56fe\u4f8b"),(0,o.kt)("p",null,(0,o.kt)("img",{src:t(53687).Z,width:"1808",height:"665"}),"\n",(0,o.kt)("img",{src:t(15458).Z,width:"1738",height:"580"}),"\n",(0,o.kt)("img",{src:t(21552).Z,width:"1920",height:"376"})),(0,o.kt)("h2",{id:"\u6d41\u7a0b\u7ed3\u5c3erender-\u9636\u6bb5\u5168\u90e8\u5de5\u4f5c\u5b8c\u6210"},"\u6d41\u7a0b\u7ed3\u5c3e:render \u9636\u6bb5\u5168\u90e8\u5de5\u4f5c\u5b8c\u6210"),(0,o.kt)("p",null,"\u81f3\u6b64\uff0crender \u9636\u6bb5\u5168\u90e8\u5de5\u4f5c\u5b8c\u6210\u3002\u5728 performSyncWorkOnRoot \u51fd\u6570\u4e2d fiberRootNode \u88ab\u4f20\u9012\u7ed9 commitRoot \u65b9\u6cd5\uff0c\u5f00\u542fcommit \u9636\u6bb5\u5de5\u4f5c\u6d41\u7a0b\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"commitRoot(root);\n")),(0,o.kt)("h3",{id:"\u8fd9\u91cc\u4ee5\u4e00\u4e2a\u7b80\u5355\u7684jsx\u7ed3\u6784\u4e3a\u4f8b"},"\u8fd9\u91cc\u4ee5\u4e00\u4e2a\u7b80\u5355\u7684jsx\u7ed3\u6784\u4e3a\u4f8b\uff1a"),(0,o.kt)("p",null,"beginWork\u4e0ecompleteWork\u8fd9\u4e8c\u8005\u662f\u5982\u4f55\u76f8\u4e92\u914d\u5408\u5171\u540c\u5b8c\u6210fiber\u6811\u7684\u6784\u5efa\u7684\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"return (\n    <>\n      <div>\n        <span>age: 18</span>\n        <p>\n          <span>name: zs</span>\n        </p>\n      </div>\n    </>\n);\n")),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"\u6267\u884cdiv\u7684beginWork\uff0c\u521b\u5efa\u7b2c\u4e00\u4e2aspan1\u5bf9\u5e94\u7684fiber\u8282\u70b9\u4e0ep\u5bf9\u5e94\u7684fiber\u8282\u70b9\uff0c\u540c\u65f6\u4f1a\u5c06span.sibling\u6307\u5411p\uff0c\u4f7f\u5f97span\u6267\u884c\u5b8ccompleteWork\u53ef\u4ee5\u8fdb\u5165p\u7684beginWork\u9636\u6bb5"),(0,o.kt)("li",{parentName:"ol"},"\u6267\u884cspan\u7684beginWork"),(0,o.kt)("li",{parentName:"ol"},"\u6267\u884cspan\u7684completeWork"),(0,o.kt)("li",{parentName:"ol"},"\u6267\u884cp\u7684beginWork"),(0,o.kt)("li",{parentName:"ol"},"\u6267\u884cspan2\u7684completeWork"),(0,o.kt)("li",{parentName:"ol"},"\u6267\u884cspan2\u7684completeWork"),(0,o.kt)("li",{parentName:"ol"},"\u6267\u884cp\u7684completeWork"),(0,o.kt)("li",{parentName:"ol"},"\u6267\u884cdiv\u7684completeWork")),(0,o.kt)("p",null,"\u6700\u7ec8\u4f1a\u5f97\u5230\u8fd9\u6837\u7684\u4e00\u9897Fiber\u6811:"),(0,o.kt)("mermaid",{value:"flowchart LR\n  App--child--\x3ediv--child--\x3espan\n  \n  div--return--\x3eApp\n\n  p--return--\x3ediv\n  p--child--\x3espan2[span]\n  span2--return--\x3ep\n\n  span--return--\x3ediv\n  span--sibling--\x3ep"}),(0,o.kt)("p",null,"\u81f3\u6b64\uff0crender\u9636\u6bb5\u5168\u90e8\u5de5\u4f5c\u5df2\u7ecf\u5b8c\u6210\uff0c\u6211\u4eec\u5f97\u5230\u4e86WIP\u4ee5\u53ca\u5bf9\u5e94\u7684dom\u6811\uff0c\u4f1a\u88ab\u8d4b\u503c\u7ed9fiberRoot.finishWork\uff0c\u63a5\u4e0b\u6765\u7684\u5de5\u4f5c\u5c31\u662f\u5c06\u6e32\u67d3WIP\uff0c\u4e5f\u5c31\u662f\u63d0\u4ea4\u9636\u6bb5\uff08commit\uff09\u7684\u6d41\u7a0b\u3002"))}u.isMDXComponent=!0},53687:(e,n,t)=>{t.d(n,{Z:()=>r});const r=t.p+"assets/images/react18-\u51fd\u6570\u8c03\u7528\u68081-42f3ffba1fb000b0e08ecae006d115e6.png"},15458:(e,n,t)=>{t.d(n,{Z:()=>r});const r=t.p+"assets/images/react18-\u51fd\u6570\u8c03\u7528\u68082-7015d72d9ac315e37e89e4d3b703ca60.png"},21552:(e,n,t)=>{t.d(n,{Z:()=>r});const r=t.p+"assets/images/react\u6784\u5efa\u4e09\u4e2a\u9636\u6bb5\u53c2\u8003-27d40456ad9d91ac37f0f096c2661e03.png"}}]);