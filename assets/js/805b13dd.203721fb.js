"use strict";(self.webpackChunkprogramming_technology=self.webpackChunkprogramming_technology||[]).push([[3485],{3905:(e,n,r)=>{r.d(n,{Zo:()=>u,kt:()=>m});var o=r(67294);function t(e,n,r){return n in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r,e}function l(e,n){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);n&&(o=o.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),r.push.apply(r,o)}return r}function i(e){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?l(Object(r),!0).forEach((function(n){t(e,n,r[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):l(Object(r)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(r,n))}))}return e}function s(e,n){if(null==e)return{};var r,o,t=function(e,n){if(null==e)return{};var r,o,t={},l=Object.keys(e);for(o=0;o<l.length;o++)r=l[o],n.indexOf(r)>=0||(t[r]=e[r]);return t}(e,n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(o=0;o<l.length;o++)r=l[o],n.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(t[r]=e[r])}return t}var a=o.createContext({}),c=function(e){var n=o.useContext(a),r=n;return e&&(r="function"==typeof e?e(n):i(i({},n),e)),r},u=function(e){var n=c(e.components);return o.createElement(a.Provider,{value:n},e.children)},p="mdxType",d={inlineCode:"code",wrapper:function(e){var n=e.children;return o.createElement(o.Fragment,{},n)}},k=o.forwardRef((function(e,n){var r=e.components,t=e.mdxType,l=e.originalType,a=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),p=c(r),k=t,m=p["".concat(a,".").concat(k)]||p[k]||d[k]||l;return r?o.createElement(m,i(i({ref:n},u),{},{components:r})):o.createElement(m,i({ref:n},u))}));function m(e,n){var r=arguments,t=n&&n.mdxType;if("string"==typeof e||t){var l=r.length,i=new Array(l);i[0]=k;var s={};for(var a in n)hasOwnProperty.call(n,a)&&(s[a]=n[a]);s.originalType=e,s[p]="string"==typeof e?e:t,i[1]=s;for(var c=2;c<l;c++)i[c]=r[c];return o.createElement.apply(null,i)}return o.createElement.apply(null,r)}k.displayName="MDXCreateElement"},65023:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>a,contentTitle:()=>i,default:()=>d,frontMatter:()=>l,metadata:()=>s,toc:()=>c});var o=r(87462),t=(r(67294),r(3905));const l={},i=void 0,s={unversionedId:"React/render\u9636\u6bb51-beginWork",id:"React/render\u9636\u6bb51-beginWork",title:"render\u9636\u6bb51-beginWork",description:"render\u9636\u6bb5\uff1a",source:"@site/programming-tech/React/20-render\u9636\u6bb51-beginWork.md",sourceDirName:"React",slug:"/React/render\u9636\u6bb51-beginWork",permalink:"/React/render\u9636\u6bb51-beginWork",draft:!1,editUrl:"https://github.com/huiruo/programming-tech-website/edit/main/programming-tech/React/20-render\u9636\u6bb51-beginWork.md",tags:[],version:"current",sidebarPosition:20,frontMatter:{},sidebar:"docs",previous:{title:"react\u4e2d\u7684ts",permalink:"/React/react\u4e2d\u7684ts"},next:{title:"render\u9636\u6bb52-completeWork",permalink:"/React/render\u9636\u6bb52-completeWork"}},a={},c=[{value:"render\u9636\u6bb5\uff1a",id:"render\u9636\u6bb5",level:2},{value:"beginWork\u9636\u6bb5:\u5c06ast\u6811\u8f6c\u6362\u4e3afiber \u6811",id:"beginwork\u9636\u6bb5\u5c06ast\u6811\u8f6c\u6362\u4e3afiber-\u6811",level:3},{value:"completeWork\u9636\u6bb5:\u751f\u6210\u5b9e\u4f8b",id:"completework\u9636\u6bb5\u751f\u6210\u5b9e\u4f8b",level:3},{value:"\u6bcf\u4e2afiber\u8282\u70b9\u90fd\u4f1a\u7ecf\u5386\u4e24\u4e2a\u9636\u6bb5beginWork\u548ccompleteWork",id:"\u6bcf\u4e2afiber\u8282\u70b9\u90fd\u4f1a\u7ecf\u5386\u4e24\u4e2a\u9636\u6bb5beginwork\u548ccompletework",level:3},{value:"update\u65f6",id:"update\u65f6",level:3},{value:"beginWork--&gt;completeUnitOfWork",id:"beginwork--completeunitofwork",level:3},{value:"render\u4e4b\u4efb\u52a1\u8c03\u5ea6",id:"render\u4e4b\u4efb\u52a1\u8c03\u5ea6",level:2},{value:"\u4efb\u52a1\u8c03\u5ea6\u4f8b\u5b50",id:"\u4efb\u52a1\u8c03\u5ea6\u4f8b\u5b50",level:3},{value:"\u63a2\u7a76\u6d41\u7a0brender\u9636\u6bb5\u524d\u7f6e\u5de5\u4f5c",id:"\u63a2\u7a76\u6d41\u7a0brender\u9636\u6bb5\u524d\u7f6e\u5de5\u4f5c",level:2},{value:"render\u524d\u7f6e\u5de5\u4f5c: \u7b2c\u4e00\u6b21\u6e32\u67d3\u4e2d\u8c03\u7528performConcurrentWorkOnRoot()",id:"render\u524d\u7f6e\u5de5\u4f5c-\u7b2c\u4e00\u6b21\u6e32\u67d3\u4e2d\u8c03\u7528performconcurrentworkonroot",level:3},{value:"\u7b2c2\u6b65.\u6e32\u67d3:workLoopSync()--&gt;performUnitOfWork()",id:"\u7b2c2\u6b65\u6e32\u67d3workloopsync--performunitofwork",level:3},{value:"\u6269\u5c55\uff1aworkLoopConcurrent()\u548cworkLoopSync()\u533a\u522b",id:"\u6269\u5c55workloopconcurrent\u548cworkloopsync\u533a\u522b",level:3},{value:"render\u9636\u6bb5\u4e4bbeginWork",id:"render\u9636\u6bb5\u4e4bbeginwork",level:2},{value:"\u7b2c1\u6b65:\u63a5\u4e0a\u9762:performUnitOfWork()--&gt;beginWork()",id:"\u7b2c1\u6b65\u63a5\u4e0a\u9762performunitofwork--beginwork",level:3},{value:"beginWork\u7b2c2\u6b65:\u4f20\u5165\u5f53\u524d Fiber \u8282\u70b9\uff0c\u521b\u5efa\u5b50 Fiber \u8282\u70b9",id:"beginwork\u7b2c2\u6b65\u4f20\u5165\u5f53\u524d-fiber-\u8282\u70b9\u521b\u5efa\u5b50-fiber-\u8282\u70b9",level:3},{value:"RootFiber\u7ed3\u6784\u904d\u5386\u4f8b\u5b50",id:"rootfiber\u7ed3\u6784\u904d\u5386\u4f8b\u5b50",level:3},{value:"\u7ee7\u7eed\u770b\u770bbeginWork\u4e2d\u662f\u5982\u4f55\u5224\u65ad\u4e0b\u4e00\u4e2a\u5de5\u4f5c\u5355\u5143\u7684\u3002",id:"\u7ee7\u7eed\u770b\u770bbeginwork\u4e2d\u662f\u5982\u4f55\u5224\u65ad\u4e0b\u4e00\u4e2a\u5de5\u4f5c\u5355\u5143\u7684",level:3},{value:"beginWork()\u603b\u7ed3",id:"beginwork\u603b\u7ed3",level:3},{value:"\u5f53\u7ec4\u4ef6update\u65f6",id:"\u5f53\u7ec4\u4ef6update\u65f6",level:3},{value:"beginWork()\u5b8c\u6574\u7684\u51fd\u6570",id:"beginwork\u5b8c\u6574\u7684\u51fd\u6570",level:3},{value:"\u4ee5updateHostComponent\u539f\u751f\u7684DOM\u5143\u7d20\u8282\u70b9\u4e3a\u4f8b\u5206\u6790",id:"\u4ee5updatehostcomponent\u539f\u751f\u7684dom\u5143\u7d20\u8282\u70b9\u4e3a\u4f8b\u5206\u6790",level:2},{value:"\u5e38\u89c1\u7684\u4e0d\u9700\u8981\u66f4\u65b0\u7684\u60c5\u51b5",id:"\u5e38\u89c1\u7684\u4e0d\u9700\u8981\u66f4\u65b0\u7684\u60c5\u51b5",level:3},{value:"bailoutOnAlreadyFinishedWork",id:"bailoutonalreadyfinishedwork",level:3},{value:"effectTag \u7528\u4e8e\u4fdd\u5b58\u8981\u6267\u884cDOM\u64cd\u4f5c\u7684\u5177\u4f53\u7c7b\u578b",id:"effecttag-\u7528\u4e8e\u4fdd\u5b58\u8981\u6267\u884cdom\u64cd\u4f5c\u7684\u5177\u4f53\u7c7b\u578b",level:3},{value:"beginWork\u7b2c3\u6b65-Reconciliation-\u53cc\u7f13\u5b58-diff,\u8fd9\u4e2a\u4ee3\u7801\u5f88\u957f 1k",id:"beginwork\u7b2c3\u6b65-reconciliation-\u53cc\u7f13\u5b58-diff\u8fd9\u4e2a\u4ee3\u7801\u5f88\u957f-1k",level:2},{value:"\u53cc\u7f13\u5b58\u673a\u5236-diff\u7b97\u6cd5",id:"\u53cc\u7f13\u5b58\u673a\u5236-diff\u7b97\u6cd5",level:3},{value:"reconcileChildren\u7b80\u7565\u51fd\u6570",id:"reconcilechildren\u7b80\u7565\u51fd\u6570",level:3},{value:"reconcileChildren\u7b80\u7565\u51fd\u6570",id:"reconcilechildren\u7b80\u7565\u51fd\u6570-1",level:3},{value:"\u8981\u6267\u884c DOM \u64cd\u4f5c\u7684\u5177\u4f53\u7c7b\u578b\u5c31\u4fdd\u5b58\u5728fiber.effectTag\u4e2d",id:"\u8981\u6267\u884c-dom-\u64cd\u4f5c\u7684\u5177\u4f53\u7c7b\u578b\u5c31\u4fdd\u5b58\u5728fibereffecttag\u4e2d",level:3}],u={toc:c},p="wrapper";function d(e){let{components:n,...l}=e;return(0,t.kt)(p,(0,o.Z)({},u,l,{components:n,mdxType:"MDXLayout"}),(0,t.kt)("h2",{id:"render\u9636\u6bb5"},"render\u9636\u6bb5\uff1a"),(0,t.kt)("p",null,"render\u9636\u6bb5\u7684\u6267\u884c\u662f\u4e00\u4e2a\u6df1\u5ea6\u4f18\u5148\u904d\u5386\u7684\u8fc7\u7a0b\uff0c\u5b83\u6709\u4e24\u4e2a\u6838\u5fc3\u51fd\u6570\uff0cbeginWork\u548ccompleteUnitOfWork,"),(0,t.kt)("blockquote",null,(0,t.kt)("p",{parentName:"blockquote"},"\u53c2\u8003\uff1a\u56fe\u7684\u4e24\u79cd\u904d\u5386:structure-algorithm/\u56fe-\u6df1\u5ea6\u4f18\u5148\u904d\u5386-\u5e7f\u5ea6\u4f18\u5148\u904d\u5386/\u56fe\u7684\u4e24\u79cd\u904d\u5386")),(0,t.kt)("h3",{id:"beginwork\u9636\u6bb5\u5c06ast\u6811\u8f6c\u6362\u4e3afiber-\u6811"},"beginWork\u9636\u6bb5:\u5c06ast\u6811\u8f6c\u6362\u4e3afiber \u6811"),(0,t.kt)("p",null,"\u8fd9\u4e9bFiber\u8282\u70b9\u4f1a\u88ab\u6807\u8bb0\u6210\u5e26\u6709'Placement'\u7684\u526f\u4f5c\u7528\uff0c\u8bf4\u660e\u5b83\u4eec\u662f\u65b0\u589e\u7684\u8282\u70b9\uff0c\u9700\u8981\u88ab\u63d2\u5165\u5230\u771f\u5b9e\u8282\u70b9\u4e2d\u4e86"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre"},"- \u6267\u884c\u90e8\u5206\u751f\u547d\u5468\u671f\u548crender\uff0c\u5f97\u5230\u6700\u65b0\u7684 children\n- \u5411\u4e0b\u904d\u5386\u8c03\u548c children \uff0c\u590d\u7528 oldFiber\n- \u6253\u4e0d\u540c\u7684\u526f\u4f5c\u7528\u6807\u7b7eeffectTag\uff0c\u6bd4\u5982\u7c7b\u7ec4\u4ef6\u7684\u751f\u547d\u5468\u671f\uff0c\u6216\u8005\u5143\u7d20\u7684\u589e\u52a0\uff0c\u5220\u9664\uff0c\u66f4\u65b0\u3002\n")),(0,t.kt)("h3",{id:"completework\u9636\u6bb5\u751f\u6210\u5b9e\u4f8b"},"completeWork\u9636\u6bb5:\u751f\u6210\u5b9e\u4f8b"),(0,t.kt)("p",null,"completeUnitOfWork \u7684\u6d41\u7a0b\u662f\u81ea\u4e0b\u5411\u4e0a\u7684"),(0,t.kt)("ol",null,(0,t.kt)("li",{parentName:"ol"},"\u5c06effectTag \u7684 Fiber \u8282\u70b9\u4fdd\u5b58\u5230 effectList \u7684\u5355\u5411\u94fe\u8868\u4e2d\u3002 \u5728 commit \u9636\u6bb5\uff0c\u5c06\u4e0d\u518d\u9700\u8981\u904d\u5386\u6bcf\u4e00\u4e2a fiber \uff0c\u53ea\u9700\u8981\u6267\u884c\u66f4\u65b0 effectList \u5c31\u53ef\u4ee5\u4e86\u3002"),(0,t.kt)("li",{parentName:"ol"},"\u5904\u7406\u7ec4\u4ef6\u7684context\uff0c\u521d\u59cb\u5316\u5143\u7d20\u6807\u7b7e\uff0c\u751f\u6210\u771f\u5b9eDOM\uff0c\u5904\u7406props\uff0c\u7b49")),(0,t.kt)("p",null,"\u6b63\u5728\u6784\u5efaFiber\u6811\u53ebworkInProgress Fiber\uff0c\u8fd9\u4e24\u9897\u6811\u7684\u8282\u70b9\u901a\u8fc7alternate\u76f8\u8fde."),(0,t.kt)("p",null,"\u771f\u5b9edom\u5bf9\u5e94\u5728\u5185\u5b58\u4e2d\u7684Fiber\u8282\u70b9\u5f62\u6210Fiber\u6811\uff0c\u8fd9\u9897Fiber\u6811\u5728react\u4e2d\u53ebcurrent Fiber"),(0,t.kt)("p",null,"\u7ec4\u4ef6\u7684\u72b6\u6001\u8ba1\u7b97\u3001diff\u7684\u64cd\u4f5c:\u901a\u8fc7 Diff \u7b97\u6cd5\u627e\u51fa\u6240\u6709\u8282\u70b9\u53d8\u66f4\uff0c\u4f8b\u5982\u8282\u70b9\u65b0\u589e\u3001\u5220\u9664\u3001\u5c5e\u6027\u53d8\u66f4\u7b49\u7b49, \u83b7\u5f97\u9700\u8981\u66f4\u65b0\u7684\u8282\u70b9\u4fe1\u606f\uff0c\u4ee5\u53carender\u51fd\u6570\u7684\u6267\u884c\uff0c\u53d1\u751f\u5728beginWork\u9636\u6bb5"),(0,t.kt)("p",null,"effect\u94fe\u8868\u7684\u6536\u96c6\u3001\u88ab\u8df3\u8fc7\u7684\u4f18\u5148\u7ea7\u7684\u6536\u96c6\uff0c\u53d1\u751f\u5728completeWork\u9636\u6bb5\u3002"),(0,t.kt)("p",null,"render/reconciliation \u534f\u8c03\u9636\u6bb5(\u53ef\u4e2d\u65ad/\u5f02\u6b65)\uff1a"),(0,t.kt)("p",null,"render \u9636\u6bb5\uff1a\u7eaf\u51c0\u4e14\u6ca1\u6709\u526f\u4f5c\u7528\uff0c\u53ef\u80fd\u4f1a\u88ab React \u6682\u505c\u3001\u7ec8\u6b62\u6216\u91cd\u65b0\u542f\u52a8\u3002"),(0,t.kt)("p",null,"\u5728 render \u9636\u6bb5\uff0cReact \u4e3b\u8981\u662f\u5728\u5185\u5b58\u4e2d\u505a\u8ba1\u7b97\uff0c\u660e\u786e DOM \u6811\u7684\u66f4\u65b0\u70b9\uff1b\u800c commit \u9636\u6bb5\uff0c\u5219\u8d1f\u8d23\u628a render \u9636\u6bb5\u751f\u6210\u7684\u66f4\u65b0\u771f\u6b63\u5730\u6267\u884c\u6389\u3002"),(0,t.kt)("p",null,"\u5728 render \u9636\u6bb5\uff0c\u4e00\u4e2a\u5e9e\u5927\u7684\u66f4\u65b0\u4efb\u52a1\u88ab\u5206\u89e3\u4e3a\u4e86\u4e00\u4e2a\u4e2a\u7684\u5de5\u4f5c\u5355\u5143\uff0c\u8fd9\u4e9b\u5de5\u4f5c\u5355\u5143\u6709\u7740\u4e0d\u540c\u7684\u4f18\u5148\u7ea7\uff0cReact \u53ef\u4ee5\u6839\u636e\u4f18\u5148\u7ea7\u7684\u9ad8\u4f4e\u53bb\u5b9e\u73b0\u5de5\u4f5c\u5355\u5143\u7684\u6253\u65ad\u548c\u6062\u590d\u3002"),(0,t.kt)("h3",{id:"\u6bcf\u4e2afiber\u8282\u70b9\u90fd\u4f1a\u7ecf\u5386\u4e24\u4e2a\u9636\u6bb5beginwork\u548ccompletework"},"\u6bcf\u4e2afiber\u8282\u70b9\u90fd\u4f1a\u7ecf\u5386\u4e24\u4e2a\u9636\u6bb5beginWork\u548ccompleteWork"),(0,t.kt)("p",null,"\u9996\u6b21\u6e32\u67d3\uff0c workInProgress fiber tree\u4e2d\u9664\u4e86\u6839\u8282\u70b9\u4e4b\u5916\uff0c\u6240\u6709\u8282\u70b9\u7684alternate\u90fd\u4e3a\u7a7a\u3002"),(0,t.kt)("p",null,"\u6240\u4ee5\u5728mount\u65f6\uff0c\u9664\u4e86\u6839\u8282\u70b9fiberRootNode\u4e4b\u5916\uff0c\u5176\u4f59\u8282\u70b9\u8c03\u7528beginWork\u65f6\u53c2\u6570current\u7b49\u4e8enull\u3002"),(0,t.kt)("p",null,"render\u9636\u6bb5\u662f\u5728\u5185\u5b58\u4e2d\u6784\u5efa\u4e00\u68f5\u65b0\u7684fiber\u6811\uff08\u79f0\u4e3aworkInProgress\u6811\uff09,\u6784\u5efa\u8fc7\u7a0b\u662f\u4f9d\u7167\u73b0\u6709fiber\u6811\uff08current\u6811\uff09\u4eceroot\u5f00\u59cb\u6df1\u5ea6\u4f18\u5148\u904d\u5386\u518d\u56de\u6eaf\u5230root\u7684\u8fc7\u7a0b\uff0c",(0,t.kt)("inlineCode",{parentName:"p"},"\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\u6bcf\u4e2afiber\u8282\u70b9\u90fd\u4f1a\u7ecf\u5386\u4e24\u4e2a\u9636\u6bb5\uff1abeginWork\u548ccompleteWork\u3002")),(0,t.kt)("h3",{id:"update\u65f6"},"update\u65f6"),(0,t.kt)("p",null,"workInProgress fiber tree\u6240\u6709\u8282\u70b9\u90fd\u5b58\u5728\u4e0a\u4e00\u6b21\u66f4\u65b0\u65f6\u7684fiber\u8282\u70b9\uff0c\u6240\u4ee5current !== null\u3002"),(0,t.kt)("p",null,"\u5f53current\u548cworkInProgress\u6ee1\u8db3\u4e00\u5b9a\u6761\u4ef6\u65f6,\u53ef\u4ee5\u590d\u7528current\u8282\u70b9\u7684\u5b50\u8282\u70b9\u7684\u4f5c\u4e3aworkInProgress\u7684\u5b50\u8282\u70b9\uff0c\n\u53cd\u4e4b\u5219\u9700\u8981\u8fdb\u5165\u5bf9\u6bd4\uff08diff\uff09\u7684\u6d41\u7a0b\uff0c\u6839\u636e\u6bd4\u5bf9\u7684\u7ed3\u679c\u521b\u5efaworkInProgress\u7684\u5b50\u8282\u70b9\u3002"),(0,t.kt)("p",null,"beginWork\u5728\u521b\u5efafiber\u8282\u70b9\u7684\u8fc7\u7a0b\u4e2d\u4e2d\u4f1a\u4f9d\u8d56\u4e00\u4e2adidReceiveUpdate\u53d8\u91cf\u6765\u6807\u8bc6\u5f53\u524d\u7684current\u662f\u5426\u6709\u66f4\u65b0\u3002\n\u5728\u6ee1\u8db3\u4e0b\u9762\u7684\u51e0\u79cd\u60c5\u51b5\u65f6\uff0cdidReceiveUpdate === false\uff1a"),(0,t.kt)("ol",null,(0,t.kt)("li",{parentName:"ol"},(0,t.kt)("p",{parentName:"li"},"\u672a\u4f7f\u7528forceUpdate\uff0c\u4e14oldProps === newProps && workInProgress.type === current.type && \uff01hasLegacyContextChanged() \uff0c\u5373props\u3001fiber.type\u548ccontext\u90fd\u672a\u53d1\u751f\u53d8\u5316")),(0,t.kt)("li",{parentName:"ol"},(0,t.kt)("p",{parentName:"li"},"\u672a\u4f7f\u7528forceUpdate\uff0c\u4e14!includesSomeLane(renderLanes, updateLanes)\uff0c\u5373\u5f53\u524dfiber\u8282\u70b9\u4f18\u5148\u7ea7\u4f4e\u4e8e\u5f53\u524d\u66f4\u65b0\u7684\u4f18\u5148\u7ea7"))),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"const updateLanes = workInProgress.lanes;\nif (current !== null) {\n  //update\u65f6\n  const oldProps = current.memoizedProps;\n  const newProps = workInProgress.pendingProps;\n  if (\n    oldProps !== newProps ||\n    hasLegacyContextChanged() ||\n    (__DEV__ ? workInProgress.type !== current.type : false)\n  ) {\n    didReceiveUpdate = true;\n  } else if (!includesSomeLane(renderLanes, updateLanes)) {\n    // \u672c\u6b21\u7684\u6e32\u67d3\u4f18\u5148\u7ea7renderLanes\u4e0d\u5305\u542bfiber.lanes, \u8868\u660e\u5f53\u524dfiber\u8282\u70b9\u4f18\u5148\u7ea7\u4f4e\u4e8e\u672c\u6b21\u7684\u6e32\u67d3\u4f18\u5148\u7ea7\uff0c\u4e0d\u9700\u6e32\u67d3\n    didReceiveUpdate = false;\n    //...\n    // \u867d\u7136\u5f53\u524d\u8282\u70b9\u4e0d\u9700\u8981\u66f4\u65b0\uff0c\u4f46\u9700\u8981\u4f7f\u7528bailoutOnAlreadyFinishedWork\u5faa\u73af\u68c0\u6d4b\u5b50\u8282\u70b9\u662f\u5426\u9700\u8981\u66f4\u65b0\n    return bailoutOnAlreadyFinishedWork(current, workInProgress, renderLanes);\n  } else {\n    if ((current.effectTag & ForceUpdateForLegacySuspense) !== NoEffect) {\n      // forceUpdate\u4ea7\u751f\u7684\u66f4\u65b0\uff0c\u9700\u8981\u5f3a\u5236\u6e32\u67d3\n      didReceiveUpdate = true;\n    } else {\n      didReceiveUpdate = false;\n    }\n  }\n} else {\n  //mount\u65f6\n  //...\n}\n")),(0,t.kt)("h3",{id:"beginwork--completeunitofwork"},"beginWork--\x3ecompleteUnitOfWork"),(0,t.kt)("p",null,"\u5728\u904d\u5386\u7684\u8fc7\u7a0b\u4e2d\uff0c\u4f1a\u5bf9\u6bcf\u4e2a\u904d\u5386\u5230\u7684\u8282\u70b9\u6267\u884cbeginWork\u521b\u5efa\u5b50fiber\u8282\u70b9\u3002\u82e5\u5f53\u524d\u8282\u70b9\u4e0d\u5b58\u5728\u5b50\u8282\u70b9\uff08next === null\uff09\uff0c\u5219\u5bf9\u5176\u6267\u884ccompleteUnitOfWork\u3002"),(0,t.kt)("p",null,"completeUnitOfWork\u65b9\u6cd5\u5185\u90e8\u4f1a\u5224\u65ad\u5f53\u524d\u8282\u70b9\u6709\u65e0\u5144\u5f1f\u8282\u70b9\uff0c\u6709\u5219\u8fdb\u5165\u5144\u5f1f\u8282\u70b9\u7684beginWork\u6d41\u7a0b\uff0c\u5426\u5219\u8fdb\n\u5165\u7236\u8282\u70b9\u7684completeUnitOfWork\u6d41\u7a0b"),(0,t.kt)("p",null,"\u5f53beginWork\u8fd4\u56de\u503c\u4e3a\u7a7a\u65f6\uff0c\u4ee3\u8868\u5728\u904d\u5386\u7236->\u5b50\u94fe\u8868\u7684\u8fc7\u7a0b\u4e2d\u53d1\u73b0\u5f53\u524d\u94fe\u8868\u5df2\u7ecf\u65e0\u4e0b\u4e00\u4e2a\u8282\u70b9\u4e86\uff08\u4e5f\u5c31\u662f\u5df2\u904d\u5386\u5b8c\u5f53\u524d\u7236->\u5b50\u94fe\u8868\uff09\uff0c\u6b64\u65f6\u4f1a\u8fdb\u5165\u5230completeUnitOfWork\u51fd\u6570\u3002"),(0,t.kt)("h2",{id:"render\u4e4b\u4efb\u52a1\u8c03\u5ea6"},"render\u4e4b\u4efb\u52a1\u8c03\u5ea6"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"\u540c\u6b65\u4e0d\u53ef\u4e2d\u65ad\u66f4\u65b0\uff0c\u610f\u5473\u7740\u5728\u66f4\u65b0\u8fc7\u7a0b\u4e2d\uff0c\u5373\u4f7f\u4ea7\u751f\u4e86\u66f4\u9ad8\u4f18\u5148\u7ea7\u7684\u66f4\u65b0\uff0c\u539f\u6765\u7684\u66f4\u65b0\u4e5f\u4f1a\u7ee7\u7eed\u5904\u7406\uff0c\u7b49\u5904\u7406\u5b8c\u6bd5\u6e32\u67d3\u5230\u5c4f\u5e55\u4e0a\u4ee5\u540e\u624d\u4f1a\u5f00\u59cb\u5904\u7406\u66f4\u9ad8\u4f18\u5148\u7ea7\u7684\u66f4\u65b0\u3002")),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"\u5f02\u6b65\u53ef\u4e2d\u65ad\u66f4\u65b0\uff0c\u5728\u6784\u5efa workInProgress \u7684\u8fc7\u7a0b\u4e2d\uff0c\u5982\u679c\u6709\u66f4\u9ad8\u4f18\u5148\u7ea7\u7684\u66f4\u65b0\u4ea7\u751f\uff0c React \u4f1a\u505c\u6b62 workInProgress fiber tree \u7684\u6784\u5efa\uff0c\u7136\u540e\u5f00\u59cb\u5904\u7406\u66f4\u9ad8\u4f18\u5148\u7ea7\u7684\u66f4\u65b0\uff0c\u91cd\u65b0\u6784\u5efa workInProgress fiber tree\u3002"))),(0,t.kt)("p",null,"\u7b49\u66f4\u9ad8\u4f18\u5148\u7ea7\u7684\u66f4\u65b0\u5904\u7406\u5b8c\u6bd5\u4e4b\u540e\uff0c\u624d\u4f1a\u5904\u7406\u539f\u6765\u88ab\u4e2d\u65ad\u7684\u66f4\u65b0\u3002"),(0,t.kt)("p",null,"React fiber\u7684\u6784\u5efa\u7684\u8fc7\u7a0b\u4ee5\u6bcf\u4e2afiber\u4f5c\u4e3a\u4e00\u4e2a\u5de5\u4f5c\u5355\u5143\uff0c\u8fdb\u884c\u5de5\u4f5c\u5faa\u73af\uff0c\u5de5\u4f5c\u5faa\u73af\u4e2d\u6bcf\u6b21\u5904\u7406\u4e00\u4e2a\u4efb\u52a1\uff08\u5de5\u4f5c\u5355\u5143\uff09\uff0c\u5904\u7406\u5b8c\u6bd5\u6709\u4e00\u6b21\u5598\u606f\u7684\u673a\u4f1a\uff1a"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"while (nextUnitOfWork !== null && !shouldYieldToRenderer()) {\n  nextUnitOfWork = performUnitOfWork(nextUnitOfWork);\n}\n")),(0,t.kt)("p",null,"shouldYieldToRenderer\u5c31\u662f\u770b\u65f6\u95f4\u7528\u5b8c\u4e86\u6ca1\uff0c\u6ca1\u7528\u5b8c\u7684\u8bdd\u7ee7\u7eed\u5904\u7406\u4e0b\u4e00\u4e2a\u4efb\u52a1\uff0c\u7528\u5b8c\u4e86\u5c31\u7ed3\u675f\uff0c\u628a\u65f6\u95f4\u63a7\u5236\u6743\u8fd8\u7ed9\u4e3b\u7ebf\u7a0b\uff0c\u7b49\u4e0b\u4e00\u6b21requestIdleCallback\u56de\u8c03\u518d\u63a5\u7740\u505a\u3002\u4f46\u5982\u679c\u5f53\u524d\u6e32\u67d3\u6267\u884c\u5f88\u957f\u4e00\u6bb5\u65f6\u95f4\u540e\u8fd8\u672a\u7ed3\u675f\uff0c\u90a3\u4e48\u5c31\u4e0d\u518d\u4f1a\u5598\u606f\uff0c\u800c\u662f\u4e00\u6b21\u6027\u628a\u5269\u4f59\u5de5\u4f5c\u5168\u90e8\u505a\u5b8c\u3002"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"if (!isYieldy) {\n  // Flush work without yielding\n  while (nextUnitOfWork !== null) {\n    nextUnitOfWork = performUnitOfWork(nextUnitOfWork);\n  }\n}\n")),(0,t.kt)("p",null,"React Fiber\u7684\u5de5\u4f5c\u8c03\u5ea6\u4e0e\u6d4f\u89c8\u5668\u7684\u6838\u5fc3\u4ea4\u4e92\u6d41\u7a0b\u5982\u4e0b\uff1a\n",(0,t.kt)("img",{src:r(34812).Z,width:"812",height:"396"})),(0,t.kt)("h3",{id:"\u4efb\u52a1\u8c03\u5ea6\u4f8b\u5b50"},"\u4efb\u52a1\u8c03\u5ea6\u4f8b\u5b50"),(0,t.kt)("p",null,"\u6211\u4eec\u70b9\u51fb Child \u7684 button \u6309\u94ae\uff0c\u540c\u65f6\u7ed9 Child \u548c Parent \u7684 number \u52a0 1\u3002\u5176\u4e2d Child \u7684\u52a0 1 \u64cd\u4f5c\u5148\u5f00\u59cb\uff0c\u5e76\u4e14 Parent \u7684\u52a0 1 \u64cd\u4f5c\u4f18\u5148\u7ea7\u66f4\u9ad8\u3002"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'function Parent() {\n    const [number, setNumber] = useState(1);\n    const buttonRef = useRef(null);\n    const add = () => { setNumber(number + 1) }\n    const click = () => { buttonRef.current.click() }\n    return (\n        <div>\n            <button ref={buttonRef} onClick={add}>\u4fee\u6539 Parent</button>\n            <span>{number}</span>\n            <Child callback={click} />\n        </div>\n    )\n }\n\nconst Child = (props) => {\n    const [number, setNumber] = useState(1);\n    const click = () => {\n        setTimeout(() => {\n            // setTimeout \u5185\u90e8\u4ea7\u751f\u7684\u66f4\u65b0\uff0c\u4f18\u5148\u7ea7\u4e3a\u666e\u901a\u4f18\u5148\u7ea7\n            setNumber(number + 1);\n        }, 10)\n        setTimeout(() => {\n            // click \u89e6\u53d1\u7684\u66f4\u65b0\uff0c\u4f18\u5148\u7ea7\u4e3a\u7528\u6237 block \u4f18\u5148\u7ea7\uff0c\u8981\u66f4\u9ad8\u4e00\u4e9b\n            props.callback && props.callback();\n        }, 10);\n     }\n\n    return (\n        <div>\n            <button onClick={click}>\u4fee\u6539 Child + Parent</button>\n            <div  className="box">\n                {Array(50000).fill(number).map(item => (<span>{item}</span>))}\n            </div>\n        </div>\n                \n    )\n}\n')),(0,t.kt)("h2",{id:"\u63a2\u7a76\u6d41\u7a0brender\u9636\u6bb5\u524d\u7f6e\u5de5\u4f5c"},"\u63a2\u7a76\u6d41\u7a0brender\u9636\u6bb5\u524d\u7f6e\u5de5\u4f5c"),(0,t.kt)("h3",{id:"render\u524d\u7f6e\u5de5\u4f5c-\u7b2c\u4e00\u6b21\u6e32\u67d3\u4e2d\u8c03\u7528performconcurrentworkonroot"},"render\u524d\u7f6e\u5de5\u4f5c: \u7b2c\u4e00\u6b21\u6e32\u67d3\u4e2d\u8c03\u7528performConcurrentWorkOnRoot()"),(0,t.kt)("p",null,(0,t.kt)("inlineCode",{parentName:"p"},"\u8c03\u7528 ReactDOMRoot.prototype.render() \u5f00\u59cbrender\u9636\u6bb5")),(0,t.kt)("p",null,"18\u4e2d\u521d\u59cb\u5316\u8c03\u7528",(0,t.kt)("inlineCode",{parentName:"p"},"performSyncWorkOnRoot()"),"\u6216",(0,t.kt)("inlineCode",{parentName:"p"},"performConcurrentWorkOnRoot()"),"\u7684\u8c03\u7528,\u8fd9\u53d6\u51b3\u4e8e\u672c\u6b21\u66f4\u65b0\u662f\u540c\u6b65\u66f4\u65b0\u8fd8\u662f\u5f02\u6b65\u66f4\u65b0."),(0,t.kt)("p",null,"\u603b\u7ed3:\nrender \u9636\u6bb5\u5f00\u59cb\u4e8e performSyncWorkOnRoot \u6216 performConcurrentWorkOnRoot \u65b9\u6cd5\u7684\u8c03\u7528\u3002\u524d\u9762\u6709\u63d0\u5230\uff1a\u8fd9\u53d6\u51b3\u4e8e\u672c\u6b21\u66f4\u65b0\u662f\u540c\u6b65\u66f4\u65b0\u8fd8\u662f\u5f02\u6b65\u66f4\u65b0\u3002"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"// performConcurrentWorkOnRoot \u8c03\u7528 renderRootSync --\x3eworkLoopSync\nfunction performConcurrentWorkOnRoot(root, didTimeout) {\n  var exitStatus = shouldTimeSlice ? renderRootConcurrent(root, lanes) : renderRootSync(root, lanes);\n  return null;\n}\n\n// \u7b2c\u4e00\u6b21\u6e32\u67d3\u8d70\u8fd9\u4e2a renderRootSync --\x3e renderRootSync --\x3eworkLoopSync\nfunction renderRootSync(root, lanes) {\n  do {\n    try {\n      console.log('renderRootSync---\x3e', root);\n      workLoopSync();\n      break;\n    } catch (thrownValue) {\n      handleError(root, thrownValue);\n    }\n  } while (true);\n}\n\nfunction renderRootConcurrent(root, lanes) {\ndo {\n  try {\n    workLoopConcurrent();\n    break;\n  } catch (thrownValue) {\n    handleError(root, thrownValue);\n  }\n} while (true);\n}\n")),(0,t.kt)("h3",{id:"\u7b2c2\u6b65\u6e32\u67d3workloopsync--performunitofwork"},"\u7b2c2\u6b65.\u6e32\u67d3:workLoopSync()--\x3eperformUnitOfWork()"),(0,t.kt)("h3",{id:"\u6269\u5c55workloopconcurrent\u548cworkloopsync\u533a\u522b"},"\u6269\u5c55\uff1aworkLoopConcurrent()\u548cworkLoopSync()\u533a\u522b"),(0,t.kt)("p",null,"\u5b83\u4eec\u552f\u4e00\u7684\u533a\u522b\u662f\u662f\u5426\u8c03\u7528shouldYield\u3002\u5982\u679c\u5f53\u524d\u6d4f\u89c8\u5668\u5e27\u6ca1\u6709\u5269\u4f59\u65f6\u95f4\uff0cshouldYield\u4f1a\u4e2d\u6b62\u5faa\u73af\uff0c\u76f4\u5230\u6d4f\u89c8\u5668\u6709\u7a7a\u95f2\u65f6\u95f4\u540e\u518d\u7ee7\u7eed\u904d\u5386\u3002"),(0,t.kt)("p",null,"workInProgress \u4ee3\u8868\u5f53\u524d\u5df2\u521b\u5efa\u7684 workInProgress fiber\u3002"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"function workLoopConcurrent() {\n  // Perform work until Scheduler asks us to yield\n  while (workInProgress !== null && !shouldYield()) {\n    performUnitOfWork(workInProgress);\n  }\n}\n\n// \u7b2c\u4e00\u6b21\u6e32\u67d3\u8d70\u8fd9\u4e2a\nfunction workLoopSync() {\n  // Already timed out, so perform work without checking if we need to yield.\n  while (workInProgress !== null) {\n    performUnitOfWork(workInProgress);\n  }\n}\n")),(0,t.kt)("h2",{id:"render\u9636\u6bb5\u4e4bbeginwork"},"render\u9636\u6bb5\u4e4bbeginWork"),(0,t.kt)("h3",{id:"\u7b2c1\u6b65\u63a5\u4e0a\u9762performunitofwork--beginwork"},"\u7b2c1\u6b65:\u63a5\u4e0a\u9762:performUnitOfWork()--\x3ebeginWork()"),(0,t.kt)("p",null,(0,t.kt)("inlineCode",{parentName:"p"},"performUnitOfWork()"),"\u5c06\u89e6\u53d1\u5bf9 beginWork \u7684\u8c03\u7528\uff0c\u8fdb\u800c\u5b9e\u73b0\u5bf9\u65b0 Fiber \u8282\u70b9\u7684\u521b\u5efa\u3002\n\u82e5 beginWork \u6240\u521b\u5efa\u7684 Fiber \u8282\u70b9\u4e0d\u4e3a\u7a7a\uff0c\u5219 performUniOfWork \u4f1a\u7528\u8fd9\u4e2a\u65b0\u7684 Fiber \u8282\u70b9\u6765\u66f4\u65b0 workInProgress \u7684\u503c\uff0c\u4e3a\u4e0b\u4e00\u6b21\u5faa\u73af\u505a\u51c6\u5907\u3002"),(0,t.kt)("p",null,"\u901a\u8fc7\u5faa\u73af\u8c03\u7528",(0,t.kt)("inlineCode",{parentName:"p"},"performUnitOfWork()"),"\u6765\u89e6\u53d1 beginWork\uff0c\u65b0\u7684 Fiber \u8282\u70b9\u5c31\u4f1a\u88ab\u4e0d\u65ad\u5730\u521b\u5efa\u3002\u5f53 workInProgress \u7ec8\u4e8e\u4e3a\u7a7a\u65f6\uff0c\u8bf4\u660e\u6ca1\u6709\u65b0\u7684\u8282\u70b9\u53ef\u4ee5\u521b\u5efa\u4e86\uff0c\u4e5f\u5c31\u610f\u5473\u7740\u5df2\u7ecf\u5b8c\u6210\u5bf9\u6574\u68f5 Fiber \u6811\u7684\u6784\u5efa\u3002"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre"},"performUnitOfWork \u4f5c\u7528\u521b\u5efa\u4e0b\u4e00\u4e2a Fiber \u8282\u70b9\uff0c\u5e76\u8d4b\u503c\u7ed9workInProgress\uff0c\u540c\u65f6\u628a workInProgress \u4e0e\u5df2\u521b\u5efa\u7684 Fiber \u8282\u70b9\u8fde\u63a5\u8d77\u6765\u6784\u6210 Fiber \u6811\u3002\n")),(0,t.kt)("p",null,"react\u628a\u6bcf\u4e2afiber\u5f53\u6210\u751f\u6210fiber\u6700\u5c0f\u5355\u5143,\u53ea\u8981\u8fed\u4ee3\u6240\u6709fiber\u5219\u5230\u9876\u7ea7Fiber\u65f6\u6574\u9897FiberTree\u4fbf\u751f\u6210\u4e86\u3002"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"// performConcurrentWorkOnRoot\u4f1a\u8c03\u7528\u8be5\u65b9\u6cd5\nfunction workLoopConcurrent() {\n  while (workInProgress !== null && !shouldYield()) {\n    performUnitOfWork(workInProgress)\n  }\n}\n\n// performSyncWorkOnRoot \u4f1a\u8c03\u7528\u8be5\u65b9\u6cd5,react 18 \u521d\u59cb\u5316\u8c03\u7528\u8fd9\u4e2a\nfunction workLoopSync() {\n  while (workInProgress !== null) {\n    performUnitOfWork(workInProgress)\n  }\n}\n/*\n\u5b83\u4eec\u552f\u4e00\u7684\u533a\u522b\u662f\u662f\u5426\u8c03\u7528shouldYield\u3002\u5982\u679c\u5f53\u524d\u6d4f\u89c8\u5668\u5e27\u6ca1\u6709\u5269\u4f59\u65f6\u95f4\uff0cshouldYield\u4f1a\u4e2d\u6b62\u5faa\u73af\uff0c\u76f4\u5230\u6d4f\u89c8\u5668\u6709\u7a7a\u95f2\u65f6\u95f4\u540e\u518d\u7ee7\u7eed\u904d\u5386\u3002\n\nworkInProgress\u4ee3\u8868\u5f53\u524d\u5df2\u521b\u5efa\u7684 workInProgress fiber\u3002\n* */\n\nfunction performUnitOfWork(unitOfWork) {\n  workInProgressNums = workInProgressNums + 1\n  // The current, flushed, state of this fiber is the alternate. Ideally\n  // nothing should rely on this, but relying on it here means that we don't\n  // need an additional field on the work in progress.\n  var current = unitOfWork.alternate;\n  setCurrentFiber(unitOfWork);\n  var next;\n\n  if ((unitOfWork.mode & ProfileMode) !== NoMode) {\n    startProfilerTimer(unitOfWork);\n    //\u5bf9\u5f53\u524d\u8282\u70b9\u8fdb\u884c\u534f\u8c03\uff0c\u5982\u679c\u5b58\u5728\u5b50\u8282\u70b9\uff0c\u5219\u8fd4\u56de\u5b50\u8282\u70b9\u7684\u5f15\u7528\n    next = beginWork$1(current, unitOfWork, subtreeRenderLanes);\n    stopProfilerTimerIfRunningAndRecordDelta(unitOfWork, true);\n  } else {\n    next = beginWork$1(current, unitOfWork, subtreeRenderLanes);\n  }\n\n  resetCurrentFiber();\n  unitOfWork.memoizedProps = unitOfWork.pendingProps;\n\n  //\u5982\u679c\u65e0\u5b50\u8282\u70b9\uff0c\u5219\u4ee3\u8868\u5f53\u524d\u7684child\u94fe\u8868\u5df2\u7ecf\u904d\u5386\u5b8c\n  if (next === null) {\n    // If this doesn't spawn new work, complete the current work.\n    //\u6b64\u51fd\u6570\u5185\u90e8\u4f1a\u5e2e\u6211\u4eec\u627e\u5230\u4e0b\u4e00\u4e2a\u53ef\u6267\u884c\u7684\u8282\u70b9\n    completeUnitOfWork(unitOfWork);\n  } else {\n    workInProgress = next;\n  }\n\n  ReactCurrentOwner$2.current = null;\n}\n")),(0,t.kt)("h3",{id:"beginwork\u7b2c2\u6b65\u4f20\u5165\u5f53\u524d-fiber-\u8282\u70b9\u521b\u5efa\u5b50-fiber-\u8282\u70b9"},"beginWork\u7b2c2\u6b65:\u4f20\u5165\u5f53\u524d Fiber \u8282\u70b9\uff0c\u521b\u5efa\u5b50 Fiber \u8282\u70b9"),(0,t.kt)("p",null,"beginWork\u7684\u4e3b\u8981\u529f\u80fd\u5c31\u662f\u5904\u7406\u5f53\u524d\u904d\u5386\u5230\u7684fiber\uff0c\u7ecf\u8fc7\u4e00\u756a\u5904\u7406\u4e4b\u540e\u8fd4\u56de\u5b83\u7684\u5b50fiber\uff0c\u4e00\u4e2a\u4e00\u4e2a\u5730\u5f80\u5916\u5410\u51fafiber\u8282\u70b9\uff0c\u90a3\u4e48workInProgress\u6811\u4e5f\u5c31\u4f1a\u88ab\u4e00\u70b9\u4e00\u70b9\u5730\u6784\u5efa\u51fa\u6765"),(0,t.kt)("p",null,"\u9996\u5148\u4ece rootFiber \u5f00\u59cb\u5411\u4e0b\u6df1\u5ea6\u4f18\u5148\u904d\u5386\u3002\u4e3a\u904d\u5386\u5230\u7684\u6bcf\u4e2a Fiber \u8282\u70b9\u8c03\u7528beginWork\u65b9\u6cd5\u3002"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"current\uff1a\u5f53\u524d\u7ec4\u4ef6\u5bf9\u5e94\u7684 Fiber \u8282\u70b9\u5728\u4e0a\u4e00\u6b21\u66f4\u65b0\u65f6\u7684 Fiber \u8282\u70b9\uff0c\u5373 workInProgress.alternate\uff1b"),(0,t.kt)("li",{parentName:"ul"},"workInProgress\uff1a\u5f53\u524d\u7ec4\u4ef6\u5bf9\u5e94\u7684 Fiber \u8282\u70b9\uff1b"),(0,t.kt)("li",{parentName:"ul"},"renderLanes\uff1a\u4f18\u5148\u7ea7\u76f8\u5173\uff0c\u5728\u8bb2\u89e3Scheduler\u65f6\u518d\u8bb2\u89e3\u3002")),(0,t.kt)("p",null,"\u66f4\u65b0\u7684\u65f6\u5019\u5b83\u4f1a\u4ee5\u65e7\u7684fiber tree\u4e3a\u84dd\u672c\uff0c\u628a\u6bcf\u4e2afiber\u4f5c\u4e3a\u4e00\u4e2a\u5de5\u4f5c\u5355\u5143\uff0c\u81ea\u9876\u5411\u4e0b\u9010\u8282\u70b9\u6784\u9020workInProgress tree\uff08\u6784\u5efa\u4e2d\u7684\u65b0fiber tree\uff09, \u6df1\u5ea6\u4f18\u5148\u904d\u5386:"),(0,t.kt)("ol",null,(0,t.kt)("li",{parentName:"ol"},"\u4ece\u9876\u70b9\u5f00\u59cb\u904d\u5386"),(0,t.kt)("li",{parentName:"ol"},"\u5982\u679c\u6709\u5b50\u8282\u70b9\uff0c\u5148\u904d\u5386\u5b50\u8282\u70b9\uff1b"),(0,t.kt)("li",{parentName:"ol"},"\u5982\u679c\u6ca1\u6709\u5b50\u8282\u70b9\uff0c\u5219\u770b\u6709\u6ca1\u6709\u5144\u5f1f\u8282\u70b9\uff0c\u6709\u5219\u904d\u5386\u5144\u5f1f\u8282\u70b9\uff0c\u5e76\u628aeffect\u5411\u4e0a\u5f52\u5e76"),(0,t.kt)("li",{parentName:"ol"},"\u5982\u679c\u6ca1\u6709\u5144\u5f1f\u8282\u70b9\uff0c\u5219\u770b\u6709\u6ca1\u6709\u7236\u5144\u5f1f\u8282\u70b9\uff0c\u6709\u5219\u904d\u5386\u7236\u5144\u5f1f\u8282\u70b9"),(0,t.kt)("li",{parentName:"ol"},"\u5982\u679c\u6ca1\u6709\u90fd\u6ca1\u6709\u4e86\uff0c\u90a3\u4e48\u904d\u5386\u7ed3\u675f")),(0,t.kt)("h3",{id:"rootfiber\u7ed3\u6784\u904d\u5386\u4f8b\u5b50"},"RootFiber\u7ed3\u6784\u904d\u5386\u4f8b\u5b50"),(0,t.kt)("mermaid",{value:"%% flowchart LR\nflowchart RL\nA1--child--\x3eB1--child--\x3eC1--sibling--\x3eC2\nB1--sibling--\x3eB2\nB2--return--\x3eA1\nB2--child--\x3eC3\nC3--return--\x3eB2\nC3--sibling--\x3eC4\nC4--return--\x3eB2\nB1--return--\x3eA1\nC1--return--\x3eB1\nC2--return--\x3eB1"}),(0,t.kt)("p",null,"\u904d\u5386\u8fc7\u7a0b:"),(0,t.kt)("mermaid",{value:"flowchart LR\n%% flowchart TD\nstart--\x3eA1--1--\x3eB1--2--\x3eC1--3--\x3eC2\n\nC2--4--\x3eB1\nB1--5--\x3eB2\nB2--9--\x3eA1\nB2--6--\x3eC3\nC3--7--\x3eC4\nC4--8--\x3eB2"}),(0,t.kt)("h3",{id:"\u7ee7\u7eed\u770b\u770bbeginwork\u4e2d\u662f\u5982\u4f55\u5224\u65ad\u4e0b\u4e00\u4e2a\u5de5\u4f5c\u5355\u5143\u7684"},"\u7ee7\u7eed\u770b\u770bbeginWork\u4e2d\u662f\u5982\u4f55\u5224\u65ad\u4e0b\u4e00\u4e2a\u5de5\u4f5c\u5355\u5143\u7684\u3002"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"function performUnitOfWork(unitOfWork) {\n\n  workInProgressNums = workInProgressNums + 1\n  // The current, flushed, state of this fiber is the alternate. Ideally\n  // nothing should rely on this, but relying on it here means that we don't\n  // need an additional field on the work in progress.\n  var current = unitOfWork.alternate;\n  setCurrentFiber(unitOfWork);\n  var next;\n\n  if ((unitOfWork.mode & ProfileMode) !== NoMode) {\n    startProfilerTimer(unitOfWork);\n    //\u5bf9\u5f53\u524d\u8282\u70b9\u8fdb\u884c\u534f\u8c03\uff0c\u5982\u679c\u5b58\u5728\u5b50\u8282\u70b9\uff0c\u5219\u8fd4\u56de\u5b50\u8282\u70b9\u7684\u5f15\u7528\n    next = beginWork$1(current, unitOfWork, subtreeRenderLanes);\n    stopProfilerTimerIfRunningAndRecordDelta(unitOfWork, true);\n  } else {\n    next = beginWork$1(current, unitOfWork, subtreeRenderLanes);\n  }\n\n  resetCurrentFiber();\n  unitOfWork.memoizedProps = unitOfWork.pendingProps;\n\n  //\u5982\u679c\u65e0\u5b50\u8282\u70b9\uff0c\u5219\u4ee3\u8868\u5f53\u524d\u7684child\u94fe\u8868\u5df2\u7ecf\u904d\u5386\u5b8c\n  if (next === null) {\n    // If this doesn't spawn new work, complete the current work.\n    //\u6b64\u51fd\u6570\u5185\u90e8\u4f1a\u5e2e\u6211\u4eec\u627e\u5230\u4e0b\u4e00\u4e2a\u53ef\u6267\u884c\u7684\u8282\u70b9\n    console.log(`%c=\u65e0\u5b50\u8282\u70b9\uff0c\u5219\u4ee3\u8868\u5f53\u524d\u7684child\u94fe\u8868\u5df2\u7ecf\u904d\u5386\u5b8c,\u5f00\u542f\u5b50\u7ec4\u4ef6\u94fecompleteUnitOfWork`, 'color:black', { type: unitOfWork.type });\n    completeUnitOfWork(unitOfWork);\n  } else {\n    workInProgress = next;\n  }\n\n  ReactCurrentOwner$2.current = null;\n}\n\nfunction getFiberName(unitOfWork) {\n  if (unitOfWork === null) return null\n\n  if (typeof unitOfWork.type === 'function') {\n    var re = /function\\s*(\\w*)/i;\n    var matches = re.exec(unitOfWork.type);\n    // console.log('%c=getFiberName:', 'color:green', matches[1])\n    return 'function ' + matches[1]\n  } else {\n    // console.log('%c=getFiberName:', 'color:green', unitOfWork.type)\n    return unitOfWork.type\n  }\n}\n\nfunction completeUnitOfWork(unitOfWork) {\n  // Attempt to complete the current unit of work, then move to the next\n  // sibling. If there are no more siblings, return to the parent fiber.\n  var completedWork = unitOfWork;\n\n  do {\n    // The current, flushed, state of this fiber is the alternate. Ideally\n    // nothing should rely on this, but relying on it here means that we don't\n    // need an additional field on the work in progress.\n    var current = completedWork.alternate;\n    var returnFiber = completedWork.return; // Check if the work completed or if something threw.\n\n    if ((completedWork.flags & Incomplete) === NoFlags) {\n      setCurrentFiber(completedWork);\n      var next = void 0;\n\n      if ((completedWork.mode & ProfileMode) === NoMode) {\n        // console.log(`%c=\u5f00\u59cbcompleteWork-1-${completedWork.type}`, 'color:black')\n        console.log(`%c=\u5f00\u59cbcompleteWork-1-`, 'color:black', { getFiberName: getFiberName(completedWork) })\n        next = completeWork(current, completedWork, subtreeRenderLanes);\n      } else {\n        console.log(`%c=\u5f00\u59cbcompleteWork-2`, 'color:black')\n        startProfilerTimer(completedWork);\n        next = completeWork(current, completedWork, subtreeRenderLanes); // Update render duration assuming we didn't error.\n\n        stopProfilerTimerIfRunningAndRecordDelta(completedWork, false);\n      }\n\n      resetCurrentFiber();\n\n      if (next !== null) {\n        // Completing this fiber spawned new work. Work on that next.\n        workInProgress = next;\n        return;\n      }\n    } else {\n      // This fiber did not complete because something threw. Pop values off\n      // the stack without entering the complete phase. If this is a boundary,\n      // capture values if possible.\n      var _next = unwindWork(current, completedWork); // Because this fiber did not complete, don't reset its lanes.\n\n      if (_next !== null) {\n        // If completing this work spawned new work, do that next. We'll come\n        // back here again.\n        // Since we're restarting, remove anything that is not a host effect\n        // from the effect tag.\n        _next.flags &= HostEffectMask;\n        workInProgress = _next;\n        return;\n      }\n\n      if ((completedWork.mode & ProfileMode) !== NoMode) {\n        // Record the render duration for the fiber that errored.\n        stopProfilerTimerIfRunningAndRecordDelta(completedWork, false); // Include the time spent working on failed children before continuing.\n\n        var actualDuration = completedWork.actualDuration;\n        var child = completedWork.child;\n\n        while (child !== null) {\n          actualDuration += child.actualDuration;\n          child = child.sibling;\n        }\n\n        completedWork.actualDuration = actualDuration;\n      }\n\n      if (returnFiber !== null) {\n        // Mark the parent fiber as incomplete and clear its subtree flags.\n        returnFiber.flags |= Incomplete;\n        returnFiber.subtreeFlags = NoFlags;\n        returnFiber.deletions = null;\n      } else {\n        // We've unwound all the way to the root.\n        workInProgressRootExitStatus = RootDidNotComplete;\n        workInProgress = null;\n        return;\n      }\n    }\n\n    //\u67e5\u770b\u5f53\u524d\u8282\u70b9\u662f\u5426\u5b58\u5728\u5144\u5f1f\u8282\u70b9\n    var siblingFiber = completedWork.sibling;\n\n    if (siblingFiber !== null) {\n      // If there is more work to do in this returnFiber, do that next.\n      // \u82e5\u5b58\u5728\uff0c\u4fbf\u628asiblingFiber\u8282\u70b9\u4f5c\u4e3a\u4e0b\u4e00\u4e2a\u5de5\u4f5c\u5355\u5143\uff0c\n      // \u7ee7\u7eed\u6267\u884cperformUnitOfWork\uff0c\u6267\u884c\u5f53\u524d\u8282\u70b9\u5e76\u5c1d\u8bd5\u904d\u5386\u5f53\u524d\u8282\u70b9\u6240\u5728\u7684child\u94fe\u8868\n      console.log(`%c=completeUnitOfWork--getFiberName:${getFiberName(completedWork)}\u5b58\u5728\u5144\u5f1f\u8282\u70b9,\u628asiblingFiber:${getFiberName(siblingFiber)}\u8282\u70b9\u4f5c\u4e3a\u4e0b\u4e00\u4e2a\u5de5\u4f5c\u5355\u5143`, 'color:grey')\n      console.log(`%c=siblingFiber:`, 'color:grey', siblingFiber)\n      workInProgress = siblingFiber;\n      return;\n    } // Otherwise, return to the parent\n\n    console.log(`%c=completeUnitOfWork-getFiberName:${getFiberName(completedWork)}\u4e0d\u5b58\u5728\u5144\u5f1f\u8282\u70b9,\u5219\u56de\u6eaf\u5230\u7236\u8282\u70b9:returnFiber:${getFiberName(returnFiber)},\u5c1d\u8bd5\u67e5\u627e\u7236\u8282\u70b9\u7684\u5144\u5f1f\u8282\u70b9`, 'color:grey')\n    console.log(`%c=returnFiber:`, 'color:grey', { returnFiber })\n    // \u5982\u679c\u4e0d\u5b58\u5728\u5144\u5f1f\u8282\u70b9\uff0c\u5219\u56de\u6eaf\u5230\u7236\u8282\u70b9\uff0c\u5c1d\u8bd5\u67e5\u627e\u7236\u8282\u70b9\u7684\u5144\u5f1f\u8282\u70b9\n    completedWork = returnFiber; // Update the next thing we're working on in case something throws.\n    workInProgress = completedWork;\n  } while (completedWork !== null); // We've reached the root.\n\n\n  if (workInProgressRootExitStatus === RootInProgress) {\n    workInProgressRootExitStatus = RootCompleted;\n  }\n}\n")),(0,t.kt)("h3",{id:"beginwork\u603b\u7ed3"},"beginWork()\u603b\u7ed3"),(0,t.kt)("p",null,"\u8be5\u65b9\u6cd5\u4f1a\u6839\u636e\u4f20\u5165\u7684 Fiber \u8282\u70b9\u521b\u5efa\u5b50 Fiber \u8282\u70b9\uff0c\u5e76\u5c06\u8fd9\u4e24\u4e2a Fiber \u8282\u70b9\u8fde\u63a5\u8d77\u6765\u3002"),(0,t.kt)("p",null,'\u5f53\u904d\u5386\u5230\u5b50\u8282\u70b9\uff08\u5373\u6ca1\u6709\u5b50\u7ec4\u4ef6\u7684\u7ec4\u4ef6\uff09\u65f6\u5c31\u4f1a\u8fdb\u5165"\u5f52"\u9636\u6bb5\u3002'),(0,t.kt)("p",null,"\u5176\u4e2d\u4f20\u53c2\uff1a"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"current\uff1a\u5f53\u524d\u7ec4\u4ef6\u5bf9\u5e94\u7684 Fiber \u8282\u70b9\u5728\u4e0a\u4e00\u6b21\u66f4\u65b0\u65f6\u7684 Fiber \u8282\u70b9\uff0c\u5373 workInProgress.alternate\uff1b"),(0,t.kt)("li",{parentName:"ul"},"workInProgress\uff1a\u5f53\u524d\u7ec4\u4ef6\u5bf9\u5e94\u7684 Fiber \u8282\u70b9\uff1b"),(0,t.kt)("li",{parentName:"ul"},"renderLanes\uff1a\u4f18\u5148\u7ea7\u76f8\u5173\uff0c\u5728\u8bb2\u89e3Scheduler\u65f6\u518d\u8bb2\u89e3\u3002")),(0,t.kt)("p",null,(0,t.kt)("inlineCode",{parentName:"p"},"\u901a\u8fc7 current === null \u6765\u533a\u5206\u7ec4\u4ef6\u662f\u5904\u4e8e mount \u8fd8\u662f update")),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"\u7ec4\u4ef6 mount \u65f6\uff0c\u7531\u4e8e\u662f\u9996\u6b21\u6e32\u67d3\uff0c\u662f\u4e0d\u5b58\u5728\u5f53\u524d\u7ec4\u4ef6\u5bf9\u5e94\u7684 Fiber\u8282\u70b9\u5728\u4e0a\u4e00\u6b21\u66f4\u65b0\u65f6\u7684 Fiber \u8282\u70b9\uff0c\u5373 mount \u65f6current === null\u3002"),(0,t.kt)("li",{parentName:"ul"},"\u7ec4\u4ef6 update \u65f6\uff0c\u7531\u4e8e\u4e4b\u524d\u5df2\u7ecf mount \u8fc7\uff0c\u6240\u4ee5 current !== null\u3002")),(0,t.kt)("p",null,"\u57fa\u4e8e\u6b64\u539f\u56e0\uff0cbeginWork \u7684\u5de5\u4f5c\u53ef\u4ee5\u5206\u4e3a\u4e24\u90e8\u5206\uff1a"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"mount \u65f6\uff1a\u9664 fiberRootNode \u4ee5\u5916\uff0ccurrent === null\u3002\u4f1a\u6839\u636efiber.tag\u4e0d\u540c\uff0c\u521b\u5efa\u4e0d\u540c\u7c7b\u578b\u7684\u5b50 Fiber \u8282\u70b9\u3002"),(0,t.kt)("li",{parentName:"ul"},"update \u65f6\uff1a\u5982\u679c current \u5b58\u5728\uff0c\u5728\u6ee1\u8db3\u4e00\u5b9a\u6761\u4ef6\u65f6\u53ef\u4ee5\u590d\u7528 current \u8282\u70b9\uff0c\u8fd9\u6837\u5c31\u80fd\u514b\u9686 current.child \u4f5c\u4e3a workInProgress.child\uff0c\u800c\u4e0d\u9700\u8981\u65b0\u5efa workInProgress.child\u3002")),(0,t.kt)("p",null,"\u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff0c\u6839\u636efiber.tag\u4e0d\u540c\uff0c\u8fdb\u5165\u4e0d\u540c\u7c7b\u578b Fiber \u7684\u521b\u5efa\u903b\u8f91;"),(0,t.kt)("p",null,"\u7b80\u7565\u51fd\u6570"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"function beginWork(current, workInProgress, renderLanes) {\n  // mount current !== null \u4e3anull,\u4e0d\u8d70\u4ee5\u4e0b\u903b\u8f91\n  if (current !== null) {\n    console.log('%c=beginWork()===start1-\u66f4\u65b0', 'color:magenta', { getFiberName: getFiberName(workInProgress), current, renderLanes, workInProgress })\n    // \u901a\u8fc7\u4e00\u7cfb\u5217\u5224\u65ad\u903b\u8f91\u5224\u65ad\u5f53\u524d\u8282\u70b9\u662f\u5426\u53ef\u590d\u7528\uff0c\u7528didReceiveUpdate\u6765\u6807\u8bb0\uff0c\n  }{\n  console.log('%c=beginWork()===start1-\u521d\u59cb\u5316', 'color:magenta', { getFiberName: getFiberName(workInProgress), current, renderLanes, workInProgress })\n  workInProgress.lanes = NoLanes;\n\n  switch (workInProgress.tag) {\n    case IndeterminateComponent: \n      // ...\u7701\u7565\n    case LazyComponent: \n      // ...\u7701\u7565\n    case FunctionComponent: \n      // ...\u7701\u7565\n    case ClassComponent: \n      // ...\u7701\u7565\n    case HostRoot:\n      // ...\u7701\u7565\n    case HostComponent:\n      console.log(`%c=beginWork()=end 7 updateHostComponent$1,\u5373\u539f\u751f DOM \u7ec4\u4ef6\u5bf9\u5e94\u7684 Fiber\u8282\u70b9:`, 'color:magenta', { type: workInProgress.type })\n      return updateHostComponent$1(current, workInProgress, renderLanes);\n    case HostText:\n  }\n  }\n}\n")),(0,t.kt)("h3",{id:"\u5f53\u7ec4\u4ef6update\u65f6"},"\u5f53\u7ec4\u4ef6update\u65f6"),(0,t.kt)("p",null,"\u6211\u4eec\u53ef\u4ee5\u770b\u5230,didReceiveUpdate === false\uff08\u5373\u53ef\u4ee5\u76f4\u63a5\u590d\u7528\u524d\u4e00\u6b21\u66f4\u65b0\u7684\u5b50 Fiber\uff0c\u4e0d\u9700\u8981\u65b0\u5efa\u5b50 Fiber\uff09\uff0c\u9700\u6ee1\u8db3\u5982\u4e0b\u60c5\u51b5\uff1a"),(0,t.kt)("ol",null,(0,t.kt)("li",{parentName:"ol"},(0,t.kt)("p",{parentName:"li"},"oldProps === newProps && workInProgress.type === current.type\uff0c\u5373 props \u4e0e fiber.type \u4e0d\u53d8\uff1b")),(0,t.kt)("li",{parentName:"ol"},(0,t.kt)("p",{parentName:"li"},"!includesSomeLane(renderLanes, updateLanes)\uff0c\u5373\u5f53\u524d Fiber \u8282\u70b9\u4f18\u5148\u7ea7\u4e0d\u591f\uff0c\u4f1a\u5728\u8bb2\u89e3 Scheduler \u65f6\u4ecb\u7ecd\u3002")),(0,t.kt)("li",{parentName:"ol"},(0,t.kt)("p",{parentName:"li"},"attemptEarlyBailoutIfNoScheduledUpdate--\x3ebailoutOnAlreadyFinishedWork=> cloneChildFibers \u987e\u540d\u601d\u4e49\uff0c\u4f1a\u76f4\u63a5\u514b\u9686\u4e00\u4e2afiber\u8282\u70b9\u5e76\u8fd4\u56de\u3002"))),(0,t.kt)("h3",{id:"beginwork\u5b8c\u6574\u7684\u51fd\u6570"},"beginWork()\u5b8c\u6574\u7684\u51fd\u6570"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"function beginWork(current, workInProgress, renderLanes) {\n  {\n    if (workInProgress._debugNeedsRemount && current !== null) {\n      console.log('%c=beginWork()===end->\u7ed3\u675f', 'color:magenta')\n      // This will restart the begin phase with a new fiber.\n      console.log('%c=beginWork()\u8c03\u7528 createFiberFromTypeAndProps(workInProgress.type, workInProgress,...)', 'color:yellow');\n      return remountFiber(current, workInProgress, createFiberFromTypeAndProps(workInProgress.type, workInProgress.key, workInProgress.pendingProps, workInProgress._debugOwner || null, workInProgress.mode, workInProgress.lanes));\n    }\n  }\n\n  // update\u65f6\uff1a\u5982\u679ccurrent\u5b58\u5728\u53ef\u80fd\u5b58\u5728\u4f18\u5316\u8def\u5f84\uff0c\u53ef\u4ee5\u590d\u7528current\uff08\u5373\u4e0a\u4e00\u6b21\u66f4\u65b0\u7684Fiber\u8282\u70b9\uff09\n  if (current !== null) {\n    console.log('%c=beginWork()===start1-\u66f4\u65b0', 'color:magenta', { getFiberName: getFiberName(workInProgress), current, renderLanes, workInProgress })\n\n    // \u901a\u8fc7\u4e00\u7cfb\u5217\u5224\u65ad\u903b\u8f91\u5224\u65ad\u5f53\u524d\u8282\u70b9\u662f\u5426\u53ef\u590d\u7528\uff0c\u7528didReceiveUpdate\u6765\u6807\u8bb0\uff0c\n    // \u82e5\u53ef\u590d\u7528\u5219\u8d70attemptEarlyBailoutIfNoScheduledUpdate\u3002\n    var oldProps = current.memoizedProps;\n    var newProps = workInProgress.pendingProps;\n\n    if (oldProps !== newProps || hasContextChanged() || ( // Force a re-render if the implementation changed due to hot reload:\n      workInProgress.type !== current.type)) {\n      // If props or context changed, mark the fiber as having performed work.\n      // This may be unset if the props are determined to be equal later (memo).\n      didReceiveUpdate = true;\n    } else {\n      // Neither props nor legacy context changes. Check if there's a pending\n      // update or context change.\n      var hasScheduledUpdateOrContext = checkScheduledUpdateOrContext(current, renderLanes);\n\n      if (!hasScheduledUpdateOrContext && // If this is the second pass of an error or suspense boundary, there\n        // may not be work scheduled on `current`, so we check for this flag.\n        (workInProgress.flags & DidCapture) === NoFlags) {\n        // No pending updates or context. Bail out now.\n        didReceiveUpdate = false;\n        console.log('%c=beginWork()end 1', 'color:magenta')\n        // bailoutOnAlreadyFinishedWork=> cloneChildFibers \u987e\u540d\u601d\u4e49\uff0c\u4f1a\u76f4\u63a5\u514b\u9686\u4e00\u4e2afiber\u8282\u70b9\u5e76\u8fd4\u56de\u3002\n        return attemptEarlyBailoutIfNoScheduledUpdate(current, workInProgress, renderLanes);\n      }\n\n      if ((current.flags & ForceUpdateForLegacySuspense) !== NoFlags) {\n        // This is a special case that only exists for legacy mode.\n        // See https://github.com/facebook/react/pull/19216.\n        didReceiveUpdate = true;\n      } else {\n        // An update was scheduled on this fiber, but there are no new props\n        // nor legacy context. Set this to false. If an update queue or context\n        // consumer produces a changed value, it will set this to true. Otherwise,\n        // the component will assume the children have not changed and bail out.\n        didReceiveUpdate = false;\n      }\n    }\n  } else {\n    didReceiveUpdate = false;\n\n    if (getIsHydrating() && isForkedChild(workInProgress)) {\n      // Check if this child belongs to a list of muliple children in\n      // its parent.\n      //\n      // In a true multi-threaded implementation, we would render children on\n      // parallel threads. This would represent the beginning of a new render\n      // thread for this subtree.\n      //\n      // We only use this for id generation during hydration, which is why the\n      // logic is located in this special branch.\n      var slotIndex = workInProgress.index;\n      var numberOfForks = getForksAtLevel();\n      pushTreeId(workInProgress, numberOfForks, slotIndex);\n    }\n  } // Before entering the begin phase, clear pending update priority.\n  // TODO: This assumes that we're about to evaluate the component and process\n  // the update queue. However, there's an exception: SimpleMemoComponent\n  // sometimes bails out later in the begin phase. This indicates that we should\n  // move this assignment out of the common path and into each branch.\n\n\n  workInProgress.lanes = NoLanes;\n  console.log('%c=beginWork()===start1-\u521d\u59cb\u5316', 'color:magenta', { getFiberName: getFiberName(workInProgress), current, renderLanes, workInProgress })\n  switch (workInProgress.tag) {\n    case IndeterminateComponent:\n      {\n        console.log('%c=beginWork()==end 2 mountIndeterminateComponent', 'color:magenta')\n        return mountIndeterminateComponent(current, workInProgress, workInProgress.type, renderLanes);\n      }\n\n    case LazyComponent:\n      {\n        var elementType = workInProgress.elementType;\n        console.log('%c=beginWork()=end 3 mountLazyComponent', 'color:magenta')\n        return mountLazyComponent(current, workInProgress, elementType, renderLanes);\n      }\n\n    case FunctionComponent:\n      {\n        var Component = workInProgress.type;\n        var unresolvedProps = workInProgress.pendingProps;\n        var resolvedProps = workInProgress.elementType === Component ? unresolvedProps : resolveDefaultProps(Component, unresolvedProps);\n        console.log('%c=beginWork()=end 4 updateFunctionComponent', 'color:magenta')\n        return updateFunctionComponent(current, workInProgress, Component, resolvedProps, renderLanes);\n      }\n\n    case ClassComponent:\n      {\n        var _Component = workInProgress.type;\n        var _unresolvedProps = workInProgress.pendingProps;\n\n        var _resolvedProps = workInProgress.elementType === _Component ? _unresolvedProps : resolveDefaultProps(_Component, _unresolvedProps);\n        console.log('%c=beginWork()=end 5 updateClassComponent', 'color:magenta')\n        return updateClassComponent(current, workInProgress, _Component, _resolvedProps, renderLanes);\n      }\n\n    case HostRoot:\n      console.log('%c=beginWork()=end 6 updateHostRoot', 'color:magenta')\n      return updateHostRoot(current, workInProgress, renderLanes);\n\n    case HostComponent:\n      console.log(`%c=beginWork()=end 7 updateHostComponent$1,\u5373\u539f\u751f DOM \u7ec4\u4ef6\u5bf9\u5e94\u7684 Fiber\u8282\u70b9:`, 'color:magenta', { type: workInProgress.type })\n      return updateHostComponent$1(current, workInProgress, renderLanes);\n\n    case HostText:\n      console.log('%c=beginWork()=end 8 updateHostText$1', 'color:magenta')\n      return updateHostText$1(current, workInProgress);\n\n    case SuspenseComponent:\n      console.log('%c=beginWork()=end 9 updateSuspenseComponent', 'color:magenta')\n      return updateSuspenseComponent(current, workInProgress, renderLanes);\n\n    case HostPortal:\n      console.log('%c=beginWork()=end 10 updatePortalComponent', 'color:magenta')\n      return updatePortalComponent(current, workInProgress, renderLanes);\n\n    case ForwardRef:\n      {\n        var type = workInProgress.type;\n        var _unresolvedProps2 = workInProgress.pendingProps;\n\n        var _resolvedProps2 = workInProgress.elementType === type ? _unresolvedProps2 : resolveDefaultProps(type, _unresolvedProps2);\n\n        console.log('%c=beginWork()=end 11 updateForwardRef', 'color:magenta')\n        return updateForwardRef(current, workInProgress, type, _resolvedProps2, renderLanes);\n      }\n\n    case Fragment:\n      console.log('%c=beginWork()=end 12 updateFragment', 'color:magenta')\n      return updateFragment(current, workInProgress, renderLanes);\n\n    case Mode:\n      console.log('%c=beginWork()=end 13 updateMode', 'color:magenta')\n      return updateMode(current, workInProgress, renderLanes);\n\n    case Profiler:\n      console.log('%c=beginWork()=end 14 updateProfiler', 'color:magenta')\n      return updateProfiler(current, workInProgress, renderLanes);\n\n    case ContextProvider:\n      console.log('%c=beginWork()=end 15 updateContextProvider', 'color:magenta')\n      return updateContextProvider(current, workInProgress, renderLanes);\n\n    case ContextConsumer:\n      console.log('%c=beginWork()=end 16 updateContextConsumer', 'color:magenta')\n      return updateContextConsumer(current, workInProgress, renderLanes);\n\n    case MemoComponent:\n      {\n        var _type2 = workInProgress.type;\n        var _unresolvedProps3 = workInProgress.pendingProps; // Resolve outer props first, then resolve inner props.\n\n        var _resolvedProps3 = resolveDefaultProps(_type2, _unresolvedProps3);\n\n        {\n          if (workInProgress.type !== workInProgress.elementType) {\n            var outerPropTypes = _type2.propTypes;\n\n            if (outerPropTypes) {\n              checkPropTypes(outerPropTypes, _resolvedProps3, // Resolved for outer only\n                'prop', getComponentNameFromType(_type2));\n            }\n          }\n        }\n\n        _resolvedProps3 = resolveDefaultProps(_type2.type, _resolvedProps3);\n        console.log('%c=beginWork()=end 17 updateMemoComponent', 'color:magenta')\n        return updateMemoComponent(current, workInProgress, _type2, _resolvedProps3, renderLanes);\n      }\n\n    case SimpleMemoComponent:\n      {\n        console.log('%c=beginWork()=end 18 updateSimpleMemoComponent', 'color:magenta')\n        return updateSimpleMemoComponent(current, workInProgress, workInProgress.type, workInProgress.pendingProps, renderLanes);\n      }\n\n    case IncompleteClassComponent:\n      {\n        var _Component2 = workInProgress.type;\n        var _unresolvedProps4 = workInProgress.pendingProps;\n\n        var _resolvedProps4 = workInProgress.elementType === _Component2 ? _unresolvedProps4 : resolveDefaultProps(_Component2, _unresolvedProps4);\n        console.log('%c=beginWork()=end 19 mountIncompleteClassComponent', 'color:magenta')\n        return mountIncompleteClassComponent(current, workInProgress, _Component2, _resolvedProps4, renderLanes);\n      }\n\n    case SuspenseListComponent:\n      {\n        console.log('%c=beginWork()=end 20 updateSuspenseListComponent', 'color:magenta')\n        return updateSuspenseListComponent(current, workInProgress, renderLanes);\n      }\n\n    case ScopeComponent:\n      {\n\n        break;\n      }\n\n    case OffscreenComponent:\n      {\n        console.log('%c=beginWork()=end 21 updateOffscreenComponent', 'color:magenta')\n        return updateOffscreenComponent(current, workInProgress, renderLanes);\n      }\n  }\n  throw new Error(\"Unknown unit of work tag (\" + workInProgress.tag + \"). This error is likely caused by a bug in \" + 'React. Please file an issue.');\n}\n")),(0,t.kt)("h2",{id:"\u4ee5updatehostcomponent\u539f\u751f\u7684dom\u5143\u7d20\u8282\u70b9\u4e3a\u4f8b\u5206\u6790"},"\u4ee5updateHostComponent\u539f\u751f\u7684DOM\u5143\u7d20\u8282\u70b9\u4e3a\u4f8b\u5206\u6790"),(0,t.kt)("p",null,"HostComponent\u4ee3\u8868\u539f\u751f\u7684DOM\u5143\u7d20\u8282\u70b9(\u5982div,span,p\u7b49\u8282\u70b9)\uff0c\u8fd9\u4e9b\u8282\u70b9\u7684\u66f4\u65b0\u4f1a\u8fdb\u5165updateHostComponent\u3002"),(0,t.kt)("p",null,"\u5728\u5404\u4e2aupdateXXX\u51fd\u6570\u4e2d\uff0c\u4f1a\u5224\u65ad\u5f53\u524d\u8282\u70b9\u662f\u5426\u9700\u8981\u66f4\u65b0\uff0c\u5982\u679c\u4e0d\u9700\u8981\u66f4\u65b0\u5219\u4f1a\u8fdb\u5165bailoutOnAlreadyFinishedWork\uff0c"),(0,t.kt)("p",null,"\u5e76\u4f7f\u7528bailoutOnAlreadyFinishedWork\u7684\u7ed3\u679c\u4f5c\u4e3abeginWork\u7684\u8fd4\u56de\u503c\uff0c\u63d0\u524dbeginWork\uff0c\u800c\u4e0d\u9700\u8981\u8fdb\u5165diff\u9636\u6bb5\u3002"),(0,t.kt)("h3",{id:"\u5e38\u89c1\u7684\u4e0d\u9700\u8981\u66f4\u65b0\u7684\u60c5\u51b5"},"\u5e38\u89c1\u7684\u4e0d\u9700\u8981\u66f4\u65b0\u7684\u60c5\u51b5"),(0,t.kt)("ol",null,(0,t.kt)("li",{parentName:"ol"},"updateClassComponent\u65f6\u82e5!shouldUpdate && !didCaptureError"),(0,t.kt)("li",{parentName:"ol"},"updateFunctionComponent\u65f6\u82e5current !== null && !didReceiveUpdate"),(0,t.kt)("li",{parentName:"ol"},"updateMemoComponent\u65f6\u82e5compare(prevProps, nextProps) && current.ref === workInProgress.ref"),(0,t.kt)("li",{parentName:"ol"},"updateHostRoot\u65f6\u82e5nextChildren === prevChildren")),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"function updateHostComponent(\n  current: Fiber | null,\n  workInProgress: Fiber,\n  renderLanes: Lanes,\n) {\n  //...\n\n  //1. \u72b6\u6001\u8ba1\u7b97, \u7531\u4e8eHostComponent\u662f\u65e0\u72b6\u6001\u7ec4\u4ef6, \u6240\u4ee5\u53ea\u9700\u8981\u6536\u96c6 nextProps\u5373\u53ef, \u5b83\u6ca1\u6709 memoizedState\n  const type = workInProgress.type;\n  const nextProps = workInProgress.pendingProps;\n  const prevProps = current !== null ? current.memoizedProps : null;\n  // 2. \u83b7\u53d6\u4e0b\u7ea7`ReactElement`\u5bf9\u8c61\n  let nextChildren = nextProps.children;\n  const isDirectTextChild = shouldSetTextContent(type, nextProps);\n\n  if (isDirectTextChild) {\n    // \u5982\u679c\u5b50\u8282\u70b9\u53ea\u6709\u4e00\u4e2a\u6587\u672c\u8282\u70b9, \u4e0d\u7528\u518d\u521b\u5efa\u4e00\u4e2aHostText\u7c7b\u578b\u7684fiber\n    nextChildren = null;\n  } else if (prevProps !== null && shouldSetTextContent(type, prevProps)) {\n  // \u7279\u6b8a\u64cd\u4f5c\u9700\u8981\u8bbe\u7f6efiber.effectTag \n    workInProgress.effectTag |= ContentReset;\n  }\n  // \u7279\u6b8a\u64cd\u4f5c\u9700\u8981\u8bbe\u7f6efiber.effectTag \n  markRef(current, workInProgress);\n  // 3. \u6839\u636e`ReactElement`\u5bf9\u8c61, \u8c03\u7528`reconcilerChildren`\u751f\u6210`fiber`\u5b50\u8282\u70b9\uff0c\u5e76\u5c06\u7b2c\u4e00\u4e2a\u5b50fiber\u8282\u70b9\u8d4b\u503c\u7ed9workInProgress.child\u3002\n  reconcileChildren(current, workInProgress, nextChildren, renderLanes);\n  return workInProgress.child;\n}\n")),(0,t.kt)("h3",{id:"bailoutonalreadyfinishedwork"},"bailoutOnAlreadyFinishedWork"),(0,t.kt)("p",null,"bailoutOnAlreadyFinishedWork\u5185\u90e8\u5148\u4f1a\u5224\u65ad!includesSomeLane(renderLanes, workInProgress.childLanes)\u662f\u5426\u6210\u7acb\u3002"),(0,t.kt)("p",null,"\u82e5!includesSomeLane(renderLanes, workInProgress.childLanes)\u6210\u7acb\u5219\u6240\u6709\u7684\u5b50\u8282\u70b9\u90fd\u4e0d\u9700\u8981\u66f4\u65b0,\u6216\u66f4\u65b0\u7684\u4f18\u5148\u7ea7\u90fd\u4f4e\u4e8e\u5f53\u524d\u66f4\u65b0\u7684\u6e32\u67d3\u4f18\u5148\u7ea7\u3002"),(0,t.kt)("p",null,"\u6b64\u65f6\u4ee5\u6b64\u8282\u70b9\u4e3a\u5934\u8282\u70b9\u7684\u6574\u9897\u5b50\u6811\u90fd\u53ef\u4ee5\u76f4\u63a5\u590d\u7528\u3002\u6b64\u65f6\u4f1a\u8df3\u8fc7\u6574\u9897\u5b50\u6811\uff0c\u5e76\u4f7f\u7528null\u4f5c\u4e3abeginWork\u7684\u8fd4\u56de\u503c\uff08\u8fdb\u5165\u56de\u6eaf\u7684\u903b\u8f91\uff09\uff1b"),(0,t.kt)("p",null,"\u82e5\u4e0d\u6210\u7acb\uff0c\u5219\u8868\u793a\u867d\u7136\u5f53\u524d\u8282\u70b9\u4e0d\u9700\u8981\u66f4\u65b0\uff0c\u4f46\u5f53\u524d\u8282\u70b9\u5b58\u5728\u67d0\u4e9bfiber\u5b50\u8282\u70b9\u9700\u8981\u5728\u6b64\u6b21\u6e32\u67d3\u4e2d\u8fdb\u884c\u66f4\u65b0\uff0c\u5219\u590d\u7528current fiber\n\u751f\u6210workInProgress\u7684\u6b21\u7ea7\u8282\u70b9\uff1b"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"function bailoutOnAlreadyFinishedWork(\n  current: Fiber | null,\n  workInProgress: Fiber,\n  renderLanes: Lanes,\n): Fiber | null {\n  //...\n\n  if (!includesSomeLane(renderLanes, workInProgress.childLanes)) {\n    // renderLanes \u4e0d\u5305\u542b workInProgress.childLanes\n    // \u6240\u6709\u7684\u5b50\u8282\u70b9\u90fd\u4e0d\u9700\u8981\u5728\u672c\u6b21\u66f4\u65b0\u8fdb\u884c\u66f4\u65b0\u64cd\u4f5c\uff0c\u76f4\u63a5\u8df3\u8fc7\uff0c\u8fdb\u884c\u56de\u6eaf\n    return null;\n  } \n\n  //...\n\n  // \u867d\u7136\u6b64\u8282\u70b9\u4e0d\u9700\u8981\u66f4\u65b0\uff0c\u6b64\u8282\u70b9\u7684\u67d0\u4e9b\u5b50\u8282\u70b9\u9700\u8981\u66f4\u65b0\uff0c\u9700\u8981\u7ee7\u7eed\u8fdb\u884c\u534f\u8c03\n  cloneChildFibers(current, workInProgress);\n  return workInProgress.child;\n}\n")),(0,t.kt)("h3",{id:"effecttag-\u7528\u4e8e\u4fdd\u5b58\u8981\u6267\u884cdom\u64cd\u4f5c\u7684\u5177\u4f53\u7c7b\u578b"},"effectTag \u7528\u4e8e\u4fdd\u5b58\u8981\u6267\u884cDOM\u64cd\u4f5c\u7684\u5177\u4f53\u7c7b\u578b"),(0,t.kt)("p",null,"\u4e0a\u9762\u4ecb\u7ecd\u5230\u5728updateXXX\u7684\u4e3b\u8981\u903b\u8f91\u4e2d\uff0c\u5728\u83b7\u53d6\u4e0b\u7ea7ReactElement\u4ee5\u53ca\u6839\u636eReactElement\u5bf9\u8c61, \u8c03\u7528reconcileChildren\u751f\u6210fiber\u5b50\u8282\u70b9\u65f6\uff0c\n\u90fd\u4f1a\u6839\u636e\u5b9e\u9645\u60c5\u51b5\uff0c\u8fdb\u884ceffectTag\u7684\u8bbe\u7f6e\u3002\u90a3\u4e48effectTag\u7684\u4f5c\u7528\u5230\u5e95\u662f\u4ec0\u4e48\u5462\uff1f"),(0,t.kt)("p",null,"reconciler \u7684\u76ee\u7684\u4e4b\u4e00\u5c31\u662f\u8d1f\u8d23\u627e\u51fa\u53d8\u5316\u7684\u7ec4\u4ef6\uff0c\u968f\u540e\u901a\u77e5Renderer\u9700\u8981\u6267\u884c\u7684DOM\u64cd\u4f5c\uff0ceffectTag\u6b63\u662f\u7528\u4e8e\u4fdd\u5b58\u8981\u6267\u884cDOM\u64cd\u4f5c\u7684\u5177\u4f53\u7c7b\u578b\u3002"),(0,t.kt)("p",null,"effectTag\u901a\u8fc7\u4e8c\u8fdb\u5236\u8868\u793a\uff1a"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"//...\n// \u610f\u5473\u7740\u8be5Fiber\u8282\u70b9\u5bf9\u5e94\u7684DOM\u8282\u70b9\u9700\u8981\u63d2\u5165\u5230\u9875\u9762\u4e2d\u3002\nexport const Placement = /*                    */ 0b000000000000010;\n//\u610f\u5473\u7740\u8be5Fiber\u8282\u70b9\u9700\u8981\u66f4\u65b0\u3002\nexport const Update = /*                       */ 0b000000000000100;\nexport const PlacementAndUpdate = /*           */ 0b000000000000110;\n//\u610f\u5473\u7740\u8be5Fiber\u8282\u70b9\u5bf9\u5e94\u7684DOM\u8282\u70b9\u9700\u8981\u4ece\u9875\u9762\u4e2d\u5220\u9664\u3002\nexport const Deletion = /*                     */ 0b000000000001000;\n//...\n")),(0,t.kt)("p",null,"\u901a\u8fc7\u8fd9\u79cd\u65b9\u5f0f\u4fdd\u5b58effectTag\u53ef\u4ee5\u65b9\u4fbf\u7684\u4f7f\u7528\u4f4d\u64cd\u4f5c\u4e3afiber\u8d4b\u503c\u591a\u4e2aeffect\u4ee5\u53ca\u5224\u65ad\u5f53\u524dfiber\u662f\u5426\u5b58\u5728\u67d0\u79cdeffect\u3002"),(0,t.kt)("blockquote",null,(0,t.kt)("p",{parentName:"blockquote"},"React \u7684\u4f18\u5148\u7ea7 lane \u6a21\u578b\u4e2d\u540c\u6837\u4f7f\u7528\u4e86\u4e8c\u8fdb\u5236\u7684\u65b9\u5f0f\u6765\u8868\u793a\u4f18\u5148\u7ea7\u3002")),(0,t.kt)("h2",{id:"beginwork\u7b2c3\u6b65-reconciliation-\u53cc\u7f13\u5b58-diff\u8fd9\u4e2a\u4ee3\u7801\u5f88\u957f-1k"},"beginWork\u7b2c3\u6b65-Reconciliation-\u53cc\u7f13\u5b58-diff,\u8fd9\u4e2a\u4ee3\u7801\u5f88\u957f 1k"),(0,t.kt)("p",null,(0,t.kt)("a",{parentName:"p",href:"./beginWork%E7%AC%AC3%E6%AD%A5-Reconciliation-%E5%8F%8C%E7%BC%93%E5%AD%98-diff"},"beginWork\u7b2c3\u6b65-Reconciliation-\u53cc\u7f13\u5b58-diff")),(0,t.kt)("p",null,"\u4e86\u89e3\u4e86\u904d\u5386\u6d41\u7a0b\u4e0e\u4efb\u52a1\u8c03\u5ea6\u65b9\u6cd5\u4e4b\u540e\uff0c\u63a5\u4e0b\u6765\u5c31\u662f\u5c31\u662f\u6211\u4eec\u719f\u77e5\u7684Reconciliation\u9636\u6bb5\u4e86\uff08\u4e3a\u4e86\u65b9\u4fbf\u7406\u89e3\uff0c\u8fd9\u91cc\u4e0d\u533a\u5206Diff\u548cReconciliation, \u4e24\u8005\u662f\u540c\u4e00\u4e2a\u4e1c\u897f\uff09\u3002\u601d\u8def\u548c Fiber \u91cd\u6784\u4e4b\u524d\u5dee\u522b\u4e0d\u5927\uff0c\u53ea\u4e0d\u8fc7\u8fd9\u91cc\u4e0d\u4f1a\u518d\u9012\u5f52\u53bb\u6bd4\u5bf9\u3001\u800c\u4e14\u4e0d\u4f1a\u9a6c\u4e0a\u63d0\u4ea4\u53d8\u66f4\u3002"),(0,t.kt)("p",null,"\u5bf9\u4e8e\u6211\u4eec\u5e38\u89c1\u7684\u7ec4\u4ef6\u7c7b\u578b\uff0c\u5982\uff08FunctionComponent/ClassComponent/HostComponent\uff09\uff0c\u6700\u7ec8\u4f1a\u8fdb\u5165 reconcileChildren \u65b9\u6cd5,\u4ece\u8be5\u51fd\u6570\u540d\u5c31\u80fd\u770b\u51fa\u8fd9\u662fReconciler\u6a21\u5757\u7684\u6838\u5fc3\u90e8\u5206\u3002\u90a3\u4e48\u4ed6\u7a76\u7adf\u505a\u4e86\u4ec0\u4e48\u5462\uff1f"),(0,t.kt)("p",null,"\u548c beginWork \u4e00\u6837\uff0c\u4ed6\u4e5f\u662f\u901a\u8fc7 current === null ? \u533a\u5206 mount \u4e0e update\u3002"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"\u5bf9\u4e8e mount \u7684\u7ec4\u4ef6\uff0c\u4ed6\u4f1a\u521b\u5efa\u65b0\u7684\u5b50 Fiber \u8282\u70b9\uff1b"),(0,t.kt)("li",{parentName:"ul"},"\u5bf9\u4e8e update \u7684\u7ec4\u4ef6\uff0c\u4ed6\u4f1a\u5c06\u5f53\u524d\u7ec4\u4ef6\u4e0e\u8be5\u7ec4\u4ef6\u5728\u4e0a\u6b21\u66f4\u65b0\u65f6\u5bf9\u5e94\u7684 Fiber \u8282\u70b9\u6bd4\u8f83\uff08\u4e5f\u5c31\u662f\u4fd7\u79f0\u7684Diff \u7b97\u6cd5\uff09\uff0c\u5c06\u6bd4\u8f83\u7684\u7ed3\u679c\u751f\u6210\u65b0 Fiber \u8282\u70b9\u3002")),(0,t.kt)("p",null,"updateXXX\u51fd\u6570\u4e2d\uff0c\u4f1a\u6839\u636e\u83b7\u53d6\u5230\u7684\u4e0b\u7ea7ReactElement\u5bf9\u8c61, \u8c03\u7528reconcileChildren\n\u751f\u6210\u5f53\u524dworkInProgress fiber\u8282\u70b9\u7684\u4e0b\u7ea7fiber\u5b50\u8282\u70b9\u3002"),(0,t.kt)("h3",{id:"\u53cc\u7f13\u5b58\u673a\u5236-diff\u7b97\u6cd5"},"\u53cc\u7f13\u5b58\u673a\u5236-diff\u7b97\u6cd5"),(0,t.kt)("p",null,"\u5728\u534f\u8c03\u9636\u6bb5\uff0cReact\u5229\u7528diff\u7b97\u6cd5\uff0c\u5c06\u4ea7\u751fupdate\u7684ReactElement\u4e0ecurrent fiber tree\u4e2d\u5bf9\u5e94\u7684\u8282\u70b9\u8fdb\u884c\u6bd4\u8f83\uff0c\u5e76\u6700\u7ec8\u5728\u5185\u5b58\u4e2d\u751f\u6210workInProgress fiber tree\u3002\u968f\u540eRenderer\u4f1a\u4f9d\u636eworkInProgress fiber tree\u5c06update\u6e32\u67d3\u5230\u9875\u9762\u4e0a\u3002"),(0,t.kt)("p",null,"\u540c\u65f6\u6839\u8282\u70b9\u7684current\u5c5e\u6027\u4f1a\u6307\u5411workInProgress fiber tree\uff0c\u6b64\u65f6workInProgress fiber tree\u5c31\u53d8\u4e3acurrent fiber tree\u3002"),(0,t.kt)("h3",{id:"reconcilechildren\u7b80\u7565\u51fd\u6570"},"reconcileChildren\u7b80\u7565\u51fd\u6570"),(0,t.kt)("p",null,"\u4e0d\u8bba\u8d70\u54ea\u4e2a\u903b\u8f91\uff0c\u6700\u7ec8\u4ed6\u4f1a\u751f\u6210\u65b0\u7684\u5b50 Fiber \u8282\u70b9\u5e76\u8d4b\u503c\u7ed9workInProgress.child\uff0c\u4f5c\u4e3a\u672c\u6b21 beginWork \u8fd4\u56de\u503c\uff0c\u5e76\u4f5c\u4e3a\u4e0b\u6b21performUnitOfWork\u6267\u884c\u65f6workInProgress\u7684\u4f20\u53c2\u3002"),(0,t.kt)("p",null,"mountChildFibers\u4e0ereconcileChildFibers\u8fd9\u4e24\u4e2a\u65b9\u6cd5\u7684\u903b\u8f91\u57fa\u672c\u4e00\u81f4\u3002\u552f\u4e00\u7684\u533a\u522b\u662f\uff1areconcileChildFibers \u4f1a\u4e3a\u751f\u6210\u7684 Fiber \u8282\u70b9\u5e26\u4e0aeffectTag\u5c5e\u6027\uff0c\u800c mountChildFibers \u4e0d\u4f1a\u3002"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"export function reconcileChildren(\n  current: Fiber | null,\n  workInProgress: Fiber,\n  nextChildren: any,\n  renderLanes: Lanes\n) {\n  if (current === null) {\n    // \u5bf9\u4e8e mount \u7684\u7ec4\u4ef6\n    workInProgress.child = mountChildFibers(\n      workInProgress,\n      null,\n      nextChildren,\n      renderLanes,\n    );\n  } else {\n    // \u5bf9\u4e8e update \u7684\u7ec4\u4ef6\n    workInProgress.child = reconcileChildFibers(\n      workInProgress,\n      current.child,\n      nextChildren,\n      renderLanes,\n    );\n  }\n}\n")),(0,t.kt)("p",null,"\u5177\u4f53\u8fc7\u7a0b\u5982\u4e0b\uff08\u4ee5\u7ec4\u4ef6\u8282\u70b9\u4e3a\u4f8b\uff09\uff1a"),(0,t.kt)("ol",null,(0,t.kt)("li",{parentName:"ol"},"\u5982\u679c\u5f53\u524d\u8282\u70b9\u4e0d\u9700\u8981\u66f4\u65b0\uff0c\u76f4\u63a5\u628a\u5b50\u8282\u70b9clone\u8fc7\u6765\uff0c\u8df3\u52305\uff1b\u8981\u66f4\u65b0\u7684\u8bdd\u6253\u4e2atag"),(0,t.kt)("li",{parentName:"ol"},"\u66f4\u65b0\u5f53\u524d\u8282\u70b9\u72b6\u6001\uff08props, state, context\u7b49\uff09"),(0,t.kt)("li",{parentName:"ol"},"\u8c03\u7528shouldComponentUpdate()\uff0cfalse\u7684\u8bdd\uff0c\u8df3\u52305"),(0,t.kt)("li",{parentName:"ol"},"\u8c03\u7528render()\u83b7\u5f97\u65b0\u7684\u5b50\u8282\u70b9\uff0c\u5e76\u4e3a\u5b50\u8282\u70b9\u521b\u5efafiber\uff08\u521b\u5efa\u8fc7\u7a0b\u4f1a\u5c3d\u91cf\u590d\u7528\u73b0\u6709fiber\uff0c\u5b50\u8282\u70b9\u589e\u5220\u4e5f\u53d1\u751f\u5728\u8fd9\u91cc\uff09"),(0,t.kt)("li",{parentName:"ol"},"\u5982\u679c\u6ca1\u6709\u4ea7\u751fchild fiber\uff0c\u8be5\u5de5\u4f5c\u5355\u5143\u7ed3\u675f\uff0c\u628aeffect list\u5f52\u5e76\u5230return\uff0c\u5e76\u628a\u5f53\u524d\u8282\u70b9\u7684sibling\u4f5c\u4e3a\u4e0b\u4e00\u4e2a\u5de5\u4f5c\u5355\u5143\uff1b\u5426\u5219\u628achild\u4f5c\u4e3a\u4e0b\u4e00\u4e2a\u5de5\u4f5c\u5355\u5143"),(0,t.kt)("li",{parentName:"ol"},"\u5982\u679c\u6ca1\u6709\u5269\u4f59\u53ef\u7528\u65f6\u95f4\u4e86\uff0c\u7b49\u5230\u4e0b\u4e00\u6b21\u4e3b\u7ebf\u7a0b\u7a7a\u95f2\u65f6\u624d\u5f00\u59cb\u4e0b\u4e00\u4e2a\u5de5\u4f5c\u5355\u5143\uff1b\u5426\u5219\uff0c\u7acb\u5373\u5f00\u59cb\u505a"),(0,t.kt)("li",{parentName:"ol"},"\u5982\u679c\u6ca1\u6709\u4e0b\u4e00\u4e2a\u5de5\u4f5c\u5355\u5143\u4e86\uff08\u56de\u5230\u4e86workInProgress tree\u7684\u6839\u8282\u70b9\uff09\uff0c\u7b2c1\u9636\u6bb5\u7ed3\u675f\uff0c\u8fdb\u5165pendingCommit\u72b6\u6001")),(0,t.kt)("p",null,"\u5b9e\u9645\u4e0a\u662f1-6\u7684\u5de5\u4f5c\u5faa\u73af\uff0c7\u662f\u51fa\u53e3\uff0c\u5de5\u4f5c\u5faa\u73af\u6bcf\u6b21\u53ea\u505a\u4e00\u4ef6\u4e8b\uff0c\u505a\u5b8c\u770b\u8981\u4e0d\u8981\u5598\u53e3\u6c14\u3002\u5de5\u4f5c\u5faa\u73af\u7ed3\u675f\u65f6\uff0cworkInProgress tree\u7684\u6839\u8282\u70b9\u8eab\u4e0a\u7684effect list\u5c31\u662f\u6536\u96c6\u5230\u7684\u6240\u6709side effect\uff08\u56e0\u4e3a\u6bcf\u505a\u5b8c\u4e00\u4e2a\u90fd\u5411\u4e0a\u5f52\u5e76\uff09"),(0,t.kt)("p",null,"\u63a5\u4ee5\u4e0a\u4ee3\u7801\uff1a\n\u5bf9\u4e8e\u6211\u4eec\u5e38\u89c1\u7684\u7ec4\u4ef6\u7c7b\u578b\uff0c\u5982\uff08FunctionComponent/ClassComponent/HostComponent\uff09\uff0c\u6700\u7ec8\u4f1a\u8fdb\u5165 reconcileChildren \u65b9\u6cd5\u3002"),(0,t.kt)("p",null,"\u4ece\u8be5\u51fd\u6570\u540d\u5c31\u80fd\u770b\u51fa\u8fd9\u662fReconciler\u6a21\u5757\u7684\u6838\u5fc3\u90e8\u5206\u3002\u90a3\u4e48\u4ed6\u7a76\u7adf\u505a\u4e86\u4ec0\u4e48\u5462\uff1f"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"\u5bf9\u4e8e mount \u7684\u7ec4\u4ef6\uff0c\u4ed6\u4f1a\u521b\u5efa\u65b0\u7684\u5b50 Fiber \u8282\u70b9\uff1b"),(0,t.kt)("li",{parentName:"ul"},"\u5bf9\u4e8e update \u7684\u7ec4\u4ef6\uff0c\u4ed6\u4f1a\u5c06\u5f53\u524d\u7ec4\u4ef6\u4e0e\u8be5\u7ec4\u4ef6\u5728\u4e0a\u6b21\u66f4\u65b0\u65f6\u5bf9\u5e94\u7684 Fiber \u8282\u70b9\u6bd4\u8f83\uff08\u4e5f\u5c31\u662f\u4fd7\u79f0\u7684Diff \u7b97\u6cd5\uff09\uff0c\u5c06\u6bd4\u8f83\u7684\u7ed3\u679c\u751f\u6210\u65b0 Fiber \u8282\u70b9\u3002")),(0,t.kt)("p",null,"\u4e0d\u8bba\u8d70\u54ea\u4e2a\u903b\u8f91\uff0c\u6700\u7ec8\u4ed6\u4f1a\u751f\u6210\u65b0\u7684\u5b50 Fiber \u8282\u70b9\u5e76\u8d4b\u503c\u7ed9workInProgress.child\uff0c\u4f5c\u4e3a\u672c\u6b21 beginWork \u8fd4\u56de\u503c\uff0c\u5e76\u4f5c\u4e3a\u4e0b\u6b21performUnitOfWork\u6267\u884c\u65f6workInProgress\u7684\u4f20\u53c2\u3002"),(0,t.kt)("p",null,"mountChildFibers\u4e0ereconcileChildFibers\u8fd9\u4e24\u4e2a\u65b9\u6cd5\u7684\u903b\u8f91\u57fa\u672c\u4e00\u81f4\u3002\u552f\u4e00\u7684\u533a\u522b\u662f\uff1areconcileChildFibers \u4f1a\u4e3a\u751f\u6210\u7684 Fiber \u8282\u70b9\u5e26\u4e0aeffectTag\u5c5e\u6027\uff0c\u800c mountChildFibers \u4e0d\u4f1a\u3002"),(0,t.kt)("h3",{id:"reconcilechildren\u7b80\u7565\u51fd\u6570-1"},"reconcileChildren\u7b80\u7565\u51fd\u6570"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"var reconcileChildFibers = ChildReconciler(true);\nvar mountChildFibers = ChildReconciler(false);\nfunction reconcileChildren(current, workInProgress, nextChildren, renderLanes) {\n  if (current === null) {\n    console.log('%c reconcileChildren mount', 'yellow');\n    workInProgress.child = mountChildFibers(workInProgress, null, nextChildren, renderLanes);\n  } else {\n    console.log('%c reconcileChildren update', 'yellow');\n    workInProgress.child = reconcileChildFibers(workInProgress, current.child, nextChildren, renderLanes);\n  }\n}\n\n// \u8fd9\u4e2a\u4ee3\u7801\u5f88\u957f 1k\nfunction ChildReconciler(shouldTrackSideEffects) {\n\n}\n")),(0,t.kt)("p",null,"\u6d41\u7a0b\u5f00\u6253\u5370\u6bd4\u8f83\u76f4\u89c2\uff0c\u753b\u56fe\u592a\u590d\u6742\uff1a"),(0,t.kt)("mermaid",{value:"flowchart TD\nreconcileChildren--\u521d\u59cb\u5316--\x3eA1(mountChildFibers\u6216\u5219\u53ebChildReconciler)"}),(0,t.kt)("h3",{id:"\u8981\u6267\u884c-dom-\u64cd\u4f5c\u7684\u5177\u4f53\u7c7b\u578b\u5c31\u4fdd\u5b58\u5728fibereffecttag\u4e2d"},"\u8981\u6267\u884c DOM \u64cd\u4f5c\u7684\u5177\u4f53\u7c7b\u578b\u5c31\u4fdd\u5b58\u5728fiber.effectTag\u4e2d"),(0,t.kt)("p",null,"render \u9636\u6bb5\u7684\u5de5\u4f5c\u662f\u5728\u5185\u5b58\u4e2d\u8fdb\u884c\uff0c\u5f53\u5de5\u4f5c\u7ed3\u675f\u540e\u4f1a\u901a\u77e5Renderer\u9700\u8981\u6267\u884c\u7684 DOM \u64cd\u4f5c\u3002"),(0,t.kt)("p",null,"\u901a\u8fc7\u4e8c\u8fdb\u5236\u8868\u793a effectTag\uff0c\u53ef\u4ee5\u65b9\u4fbf\u7684\u4f7f\u7528\u4f4d\u64cd\u4f5c\u4e3a fiber.effectTag \u8d4b\u503c\u591a\u4e2a effect\u3002"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"// DOM \u9700\u8981\u63d2\u5165\u5230\u9875\u9762\u4e2d\nexport const Placement = /*                */ 0b00000000000010;\n// DOM \u9700\u8981\u66f4\u65b0\nexport const Update = /*                   */ 0b00000000000100;\n// DOM \u9700\u8981\u63d2\u5165\u5230\u9875\u9762\u4e2d\u5e76\u66f4\u65b0\nexport const PlacementAndUpdate = /*       */ 0b00000000000110;\n// DOM \u9700\u8981\u5220\u9664\nexport const Deletion = /*                 */ 0b00000000001000;\n")),(0,t.kt)("p",null,"\u90a3\u4e48\uff0c\u5982\u679c\u8981\u901a\u77e5 Renderer \u5c06 Fiber \u8282\u70b9\u5bf9\u5e94\u7684 DOM \u8282\u70b9\u63d2\u5165\u9875\u9762\u4e2d\uff0c\u9700\u8981\u6ee1\u8db3\u4e24\u4e2a\u6761\u4ef6\uff1a"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"fiber.stateNode \u5b58\u5728\uff0c\u5373 Fiber \u8282\u70b9\u4e2d\u4fdd\u5b58\u4e86\u5bf9\u5e94\u7684 DOM \u8282\u70b9\uff1b"),(0,t.kt)("li",{parentName:"ul"},"(fiber.effectTag & Placement) !== 0\uff0c\u5373 Fiber \u8282\u70b9\u5b58\u5728 Placement effectTag\u3002")),(0,t.kt)("p",null,"\u6211\u4eec\u77e5\u9053\uff0cmount \u65f6\uff0cfiber.stateNode === null\uff0c\u4e14\u5728 reconcileChildren \u4e2d\u8c03\u7528\u7684 mountChildFibers \u4e0d\u4f1a\u4e3a Fiber \u8282\u70b9\u8d4b\u503c effectTag\u3002\u90a3\u4e48\u9996\u5c4f\u6e32\u67d3\u5982\u4f55\u5b8c\u6210\u5462\uff1f"),(0,t.kt)("p",null,"\u9488\u5bf9\u7b2c\u4e00\u4e2a\u95ee\u9898\uff0cfiber.stateNode \u4f1a\u5728 completeWork \u4e2d\u521b\u5efa\uff0c\u6211\u4eec\u4f1a\u5728\u4e0b\u4e00\u8282\u4ecb\u7ecd\u3002"),(0,t.kt)("p",null,"\u5047\u8bbe mountChildFibers \u4e5f\u4f1a\u8d4b\u503c effectTag\uff0c\u90a3\u4e48\u53ef\u4ee5\u9884\u89c1 mount \u65f6\u6574\u68f5 Fiber \u6811\u6240\u6709\u8282\u70b9\u90fd\u4f1a\u6709Placement effectTag\u3002\u90a3\u4e48commit \u9636\u6bb5\u5728\u6267\u884c DOM \u64cd\u4f5c\u65f6\u6bcf\u4e2a\u8282\u70b9\u90fd\u4f1a\u6267\u884c\u4e00\u6b21\u63d2\u5165\u64cd\u4f5c\uff0c\u8fd9\u6837\u5927\u91cf\u7684 DOM \u64cd\u4f5c\u662f\u6781\u4f4e\u6548\u7684\u3002"),(0,t.kt)("p",null,"\u603b\u7ed3:\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u5728mount \u65f6\u53ea\u6709 rootFiber \u4f1a\u8d4b\u503c Placement effectTag\uff0c\u5728 commit \u9636\u6bb5\u53ea\u6267\u884c\u4e00\u6b21\u63d2\u5165\u64cd\u4f5c\u3002"))}d.isMDXComponent=!0},34812:(e,n,r)=>{r.d(n,{Z:()=>o});const o=r.p+"assets/images/\u56fe1-Fiber\u7684\u5de5\u4f5c\u8c03\u5ea6\u4e0e\u6d4f\u89c8\u5668\u4ea4\u4e92-221c1216f1cbd14ddb8ee57928adfacc.png"}}]);