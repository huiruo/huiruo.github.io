"use strict";(self.webpackChunkprogramming_technology=self.webpackChunkprogramming_technology||[]).push([[1509],{3905:(e,n,t)=>{t.d(n,{Zo:()=>c,kt:()=>h});var o=t(67294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);n&&(o=o.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,o)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,o,r=function(e,n){if(null==e)return{};var t,o,r={},a=Object.keys(e);for(o=0;o<a.length;o++)t=a[o],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(o=0;o<a.length;o++)t=a[o],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var p=o.createContext({}),l=function(e){var n=o.useContext(p),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},c=function(e){var n=l(e.components);return o.createElement(p.Provider,{value:n},e.children)},m="mdxType",u={inlineCode:"code",wrapper:function(e){var n=e.children;return o.createElement(o.Fragment,{},n)}},d=o.forwardRef((function(e,n){var t=e.components,r=e.mdxType,a=e.originalType,p=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),m=l(t),d=r,h=m["".concat(p,".").concat(d)]||m[d]||u[d]||a;return t?o.createElement(h,i(i({ref:n},c),{},{components:t})):o.createElement(h,i({ref:n},c))}));function h(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var a=t.length,i=new Array(a);i[0]=d;var s={};for(var p in n)hasOwnProperty.call(n,p)&&(s[p]=n[p]);s.originalType=e,s[m]="string"==typeof e?e:r,i[1]=s;for(var l=2;l<a;l++)i[l]=t[l];return o.createElement.apply(null,i)}return o.createElement.apply(null,t)}d.displayName="MDXCreateElement"},15746:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>p,contentTitle:()=>i,default:()=>u,frontMatter:()=>a,metadata:()=>s,toc:()=>l});var o=t(87462),r=(t(67294),t(3905));const a={title:"compiler-baseCompile\u751f\u6210ast-\u9759\u6001\u63d0\u5347-vnode-patch",sidebar_position:-3},i=void 0,s={unversionedId:"Vue/compiler-baseCompile\u751f\u6210ast-\u9759\u6001\u63d0\u5347-vnode-patch",id:"Vue/compiler-baseCompile\u751f\u6210ast-\u9759\u6001\u63d0\u5347-vnode-patch",title:"compiler-baseCompile\u751f\u6210ast-\u9759\u6001\u63d0\u5347-vnode-patch",description:"\u5e94\u7528\u5165\u53e3",source:"@site/programming-tech/Vue/01-compiler-baseCompile\u751f\u6210ast-\u9759\u6001\u63d0\u5347-vnode-patch.md",sourceDirName:"Vue",slug:"/Vue/compiler-baseCompile\u751f\u6210ast-\u9759\u6001\u63d0\u5347-vnode-patch",permalink:"/Vue/compiler-baseCompile\u751f\u6210ast-\u9759\u6001\u63d0\u5347-vnode-patch",draft:!1,editUrl:"https://github.com/huiruo/programming-tech-website/edit/main/programming-tech/Vue/01-compiler-baseCompile\u751f\u6210ast-\u9759\u6001\u63d0\u5347-vnode-patch.md",tags:[],version:"current",sidebarPosition:-3,frontMatter:{title:"compiler-baseCompile\u751f\u6210ast-\u9759\u6001\u63d0\u5347-vnode-patch",sidebar_position:-3},sidebar:"docs",previous:{title:"vue3-\u5e38\u7528",permalink:"/Vue/vue3/vue3-\u5e38\u7528"},next:{title:"compiler-\u7f16\u8bd1AST-\u8f6c\u6362AST\u4e3arender",permalink:"/Vue/compiler-\u751f\u6210AST-\u8f6c\u6362AST\u4e3arender"}},p={},l=[{value:"\u5e94\u7528\u5165\u53e3",id:"\u5e94\u7528\u5165\u53e3",level:2},{value:"\u521d\u59cb\u5316",id:"\u521d\u59cb\u5316",level:2},{value:"\u6d41\u7a0b\u56fe-\u751f\u6210AST-\u8f6c\u6362AST\u4e3arender\u603b\u7ed3",id:"\u6d41\u7a0b\u56fe-\u751f\u6210ast-\u8f6c\u6362ast\u4e3arender\u603b\u7ed3",level:2},{value:"\u751f\u6210AST-\u8f6c\u6362AST\u4e3arender\u603b\u89c8",id:"\u751f\u6210ast-\u8f6c\u6362ast\u4e3arender\u603b\u89c8",level:3},{value:"1.\u63a5<code>\u521d\u59cb\u5316\u6d41\u7a0b</code>,finishComponentSetup()\u5f00\u59cb\u6267\u884c",id:"1\u63a5\u521d\u59cb\u5316\u6d41\u7a0bfinishcomponentsetup\u5f00\u59cb\u6267\u884c",level:3},{value:"2.\u7b2c\u4e8c\u6b65\u7f16\u8bd1,\u6839\u636east--&gt;\u751f\u6210code\u5b57\u7b26\u4e32",id:"2\u7b2c\u4e8c\u6b65\u7f16\u8bd1\u6839\u636east--\u751f\u6210code\u5b57\u7b26\u4e32",level:3},{value:"2-1. \u9759\u6001\u63d0\u5347\u53d1\u751f\u5728\u8fd9\u4e00\u9636\u6bb5:transform\u5bf9ast\u8fdb\u884c\u8f6c\u6362,\u53d8\u6362AST\u7684\u7ed3\u6784",id:"2-1-\u9759\u6001\u63d0\u5347\u53d1\u751f\u5728\u8fd9\u4e00\u9636\u6bb5transform\u5bf9ast\u8fdb\u884c\u8f6c\u6362\u53d8\u6362ast\u7684\u7ed3\u6784",level:3},{value:"vue\u521d\u59cb\u5316\u6e90\u7801",id:"vue\u521d\u59cb\u5316\u6e90\u7801",level:2},{value:"<code>patch</code>",id:"patch",level:3},{value:"<code>processComponent</code>",id:"processcomponent",level:3},{value:"<code>mountComponent = (initialVNode</code>",id:"mountcomponent--initialvnode",level:3},{value:"<code>handleSetupResult</code>--&gt;<code>finishComponentSetup</code>",id:"handlesetupresult--finishcomponentsetup",level:3},{value:"\u6536\u96c6\u548c\u66f4\u65b0\u526f\u4f5c\u7528\uff1a",id:"\u6536\u96c6\u548c\u66f4\u65b0\u526f\u4f5c\u7528",level:2},{value:"render\u751f\u6210\u4e4b\u540e-vnode\u6784\u5efa",id:"render\u751f\u6210\u4e4b\u540e-vnode\u6784\u5efa",level:2},{value:"VNode\u6784\u5efa\u4e4b\u540e-\u5f00\u59cb\u6e32\u67d3",id:"vnode\u6784\u5efa\u4e4b\u540e-\u5f00\u59cb\u6e32\u67d3",level:2}],c={toc:l},m="wrapper";function u(e){let{components:n,...a}=e;return(0,r.kt)(m,(0,o.Z)({},c,a,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"\u5e94\u7528\u5165\u53e3"},"\u5e94\u7528\u5165\u53e3"),(0,r.kt)("p",null,"\u6d41\u7a0b\u56fe\u53c2\u8003\uff1a",(0,r.kt)("a",{parentName:"p",href:"../Vue%E6%A6%82%E8%A7%88"},"Vue\u6982\u89c8")),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/huiruo/programming-tech-website/blob/main/programming-tech/Vue/vue3%E6%BA%90%E7%A0%81%E8%BF%90%E8%A1%8C%E4%BE%8B%E5%AD%90/02-vue3-%E6%B5%8B%E8%AF%95%E4%B8%BB%E8%A6%81%E7%94%A8%E4%BE%8B.html"},"vue3-\u6d4b\u8bd5\u4e3b\u8981\u7528\u4f8b")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"<script>\n  const { ref, reactive, nextTick } = Vue\n\n  Vue.createApp({\n    data() {\n      return {\n        msg: '\u6539\u53d8\u6211',\n        showDiv: false\n      }\n    },\n    methods: {\n      onClickText() {\n        this.msg = '\u52aa\u529b'\n        this.showDiv = !this.showDiv\n        this.info.msg2 = this.showDiv ? '\u76f4\u63a5\u70b9' : '\u5176\u4ed6\u9009\u62e9'\n        nextTick(() => {\n          console.log('--nextTick--', this.showDiv, this.msg);\n        })\n      }\n    },\n\n    setup(props) {\n      const refData = ref({\n        myName: 'Ruo'\n      })\n\n      const info = reactive({\n        msg2: 'hello',\n      });\n\n      nextTick(() => {\n        console.log('--nextTick--');\n      })\n\n      Vue.onBeforeMount(() => {\n        console.log('--1:\u7ec4\u4ef6\u6302\u8f7d\u524d onBeforeMount--\x3e')\n      })\n\n      Vue.onMounted(() => {\n        console.log('--2:\u7ec4\u4ef6\u6302\u8f7d\u540e onMounted--\x3e')\n      });\n\n      return {\n        info,\n        refData\n      };\n    },\n\n  }).mount('#root')\n<\/script>\n")),(0,r.kt)("h2",{id:"\u521d\u59cb\u5316"},"\u521d\u59cb\u5316"),(0,r.kt)("p",null,(0,r.kt)("img",{src:t(56359).Z,width:"831",height:"390"})),(0,r.kt)("p",null,"\u63a5\uff1a",(0,r.kt)("a",{parentName:"p",href:"../../Vue%E6%A6%82%E8%A7%88"},"\u9996\u6b21\u6e32\u67d3\u6d41\u7a0b-patch\u51fd\u6570")),(0,r.kt)("mermaid",{value:'flowchart TD\nA1("patch(container._vnode,vnode,container,...")--\u5904\u7406\u7ec4\u4ef6\u5143\u7d20\u4e3a\u4f8b--\x3eA2("processComponent(n1, n2, container")\n\nA2--\u521b\u5efa--\x3eb6("mountComponent(n2, container, anchor")--\x3eA-2\nA2--\u66f4\u65b0--\x3eb7("updateComponent(n1, n2,optimized)")\n\nA-2("mountComponent = (initialVNode, container")--\x3eA-1("setupComponent(instance,")--\x3eB0("setupStatefulComponent(instance,")--\x3eB1("handleSetupResult()")--\x3eB2("finishComponentSetup(instance")\n\nB2--\u5f00\u59cb\u6784\u5efa\u4f20\u5165\u6a21\u677f\u5b57\u7b26\u4e32--\x3e\u63a5\u4e0b\u9762\u6d41\u7a0b\u56fe'}),(0,r.kt)("p",null,"\u8fd9\u4e2a\u9636\u6bb5",(0,r.kt)("inlineCode",{parentName:"p"},"finishComponentSetup()"),"\u662f\u91cd\u70b9\u51fd\u6570\uff0c\u8c03\u7528",(0,r.kt)("inlineCode",{parentName:"p"},"compileToFunction()"),"\u8fd4\u56de\u4e86ast\u751f\u6210\u7684\u51fd\u6570"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"  function finishComponentSetup(instance, isSSR, skipOptions) {\n    const Component = instance.type;\n    // ...\n    if (!instance.render) {\n      // only do on-the-fly compile if not in SSR - SSR on-the-fly compilation\n      // is done by server-renderer\n      if (!isSSR && compile && !Component.render) {\n        const template = Component.template ||\n          resolveMergedOptions(instance).template;\n        if (template) {\n          {\n            startMeasure(instance, `compile`);\n          }\n          const { isCustomElement, compilerOptions } = instance.appContext.config;\n          const { delimiters, compilerOptions: componentCompilerOptions } = Component;\n          const finalCompilerOptions = extend(extend({\n            isCustomElement,\n            delimiters\n          }, compilerOptions), componentCompilerOptions);\n          console.log('finishComponentSetup=>compileToFunction\u88ab\u8c03\u7528:', { template, finalCompilerOptions })\n          // debugger\n          Component.render = compile(template, finalCompilerOptions);\n          {\n            endMeasure(instance, `compile`);\n          }\n        }\n      }\n\n      // ...\n      instance.render = (Component.render || NOOP);\n    }\n  }\n\n  let compile;\n  let installWithProxy;\n  registerRuntimeCompiler(compileToFunction);\n  /**\n   * For runtime-dom to register the compiler.\n   * Note the exported method uses any to avoid d.ts relying on the compiler types.\n   */\n  function registerRuntimeCompiler(_compile) {\n    console.log('\u63a2\u7a76\u521d\u59cb\u5316==>registerRuntimeCompiler')\n    compile = _compile;\n    installWithProxy = i => {\n      if (i.render._rc) {\n        i.withProxy = new Proxy(i.ctx, RuntimeCompiledPublicInstanceProxyHandlers);\n      }\n    };\n  }\n\n  function compileToFunction(template, options) {\n  console.log('compileToFunction\u88ab\u8c03\u7528:', { template, options })\n    // ...\n  }\n")),(0,r.kt)("h2",{id:"\u6d41\u7a0b\u56fe-\u751f\u6210ast-\u8f6c\u6362ast\u4e3arender\u603b\u7ed3"},"\u6d41\u7a0b\u56fe-\u751f\u6210AST-\u8f6c\u6362AST\u4e3arender\u603b\u7ed3"),(0,r.kt)("h3",{id:"\u751f\u6210ast-\u8f6c\u6362ast\u4e3arender\u603b\u89c8"},"\u751f\u6210AST-\u8f6c\u6362AST\u4e3arender\u603b\u89c8"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u751f\u6210ast\u5bf9\u8c61"),(0,r.kt)("li",{parentName:"ul"},"\u5c06ast\u5bf9\u8c61\u4f5c\u4e3a\u53c2\u6570\u4f20\u5165transform\u51fd\u6570\uff0c\u5bf9 ast \u8282\u70b9\u8fdb\u884c\u8f6c\u6362\u64cd\u4f5c"),(0,r.kt)("li",{parentName:"ul"},"\u5c06ast\u5bf9\u8c61\u4f5c\u4e3a\u53c2\u6570\u4f20\u5165generate\u51fd\u6570\uff0c\u8fd4\u56de\u7f16\u8bd1\u7ed3\u679c")),(0,r.kt)("mermaid",{value:'flowchart TD\nA1(baseCompile)--\x3eA2(baseParse\u751f\u6210ast)--\x3eA3(transform\u5bf9ast\u8fdb\u884c\u8f6c\u6362)--\x3eA4(generate\u6839\u636e\u53d8\u6362\u540e\u7684ast\u751f\u6210code\u5e76\u8fd4\u56de)\n\n\u5176\u4ed6--\u7ec4\u4ef6\u6302\u8f7d\u548c\u66f4\u65b0\u7684\u903b\u8f91--\x3eA5("patch()\u7528vnode\u5bf9\u8c61\u6784\u5efa\u7684DOM\u5143\u7d20")--\x3eA6("\u6839\u636eVNode\u7c7b\u578b\u7684\u4e0d\u540c\u4f7f\u7528\u4e0d\u540c\u7684\u51fd\u6570\u8fdb\u884c\u5904\u7406")'}),(0,r.kt)("h3",{id:"1\u63a5\u521d\u59cb\u5316\u6d41\u7a0bfinishcomponentsetup\u5f00\u59cb\u6267\u884c"},"1.\u63a5",(0,r.kt)("inlineCode",{parentName:"h3"},"\u521d\u59cb\u5316\u6d41\u7a0b"),",finishComponentSetup()\u5f00\u59cb\u6267\u884c"),(0,r.kt)("p",null,"\u63a5\u4e0a\u9762\u7684finishComponentSetup()\u5f00\u59cb\u6267\u884c\uff0c\u53bb\u6784\u5efaast:"),(0,r.kt)("mermaid",{value:'flowchart TD\n\nA0(`finishComponentSetup-\u5f00\u59cb`)--\u4f20\u5165\u6a21\u677f\u5b57\u7b26\u4e32--\x3eA1(compileToFunction)--\x3eA2("compile$1(template, options = {}){<br/>return baseCompile(template,...")--\x3eA4("baseCompile(template, options = {})")\n\nA4--1\u751f\u6210Ast--\x3eA5("ast = baseParse(template, options)")--\x3eA6("return createRoot(parseChildren(context")\n\nA4--2\u7f16\u8bd1_ast\u8fdb\u884c\u53d8\u6362--\x3eA4A("transform(ast, extend({}, options")\nA4--3\u53d8\u6362\u4e4b\u540e\u751f\u6210code\u5b57\u7b26\u4e32--\x3eA4B("generate(ast, extend({}")\n\nA6--\x3eA7("parseChildren{")\n\nA7--\u89e3\u6790\u6848\u4f8b1\u5219\u5f53\u505a\u63d2\u503c\u8868\u8fbe\u5f0f\u8fdb\u884c\u89e3\u6790--\x3eb1("node = parseInterpolation(context, mode)")\n\nA7--\u89e3\u6790\u6848\u4f8b2\u89e3\u6790\u5143\u7d20\u6216\u7ec4\u4ef6--\x3eb2("node = parseElement(context, ancestors)")--\x3eb3("const element = parseTag(context, 0")--\u8c03\u7528parseAttributes\u89e3\u6790\u5c5e\u6027_\u7279\u6027_\u6307\u4ee4--\x3eb4("props = parseAttributes(context, type)")\n\nb4--\u5faa\u73af\u8c03\u7528--\x3eb5("attr = parseAttribute(context, attributeNames)")'}),(0,r.kt)("h3",{id:"2\u7b2c\u4e8c\u6b65\u7f16\u8bd1\u6839\u636east--\u751f\u6210code\u5b57\u7b26\u4e32"},"2.\u7b2c\u4e8c\u6b65\u7f16\u8bd1,\u6839\u636east--\x3e\u751f\u6210code\u5b57\u7b26\u4e32"),(0,r.kt)("p",null,"\u7f16\u8bd1\u7ec8\u70b9-\u751f\u6210\u4ee3\u7801\u5b57\u7b26\u4e32,\u6839\u636e\u53d8\u6362\u540e\u7684\u8f6c\u6362AST\u751f\u6210render()\u51fd\u6570"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"\u4ee3\u7801\u751f\u6210\u9636\u6bb5\u3001\u4f1a\u6839\u636e\u89e3\u6790\u4ee5\u53ca\u53d8\u6362\u6dfb\u52a0\u76f8\u5e94\u6807\u8bb0\u540e\u7684ast\u4ee5\u53ca\u4f7f\u7528vue\u7684\u73af\u5883\uff0c\u751f\u6210\u5bf9\u5e94\u7684\u7528\u6237\u751f\u6210\u865a\u62df\u8282\u70b9\u7684\u4ee3\u7801\u5b57\u7b26\u4e32\u3002")),(0,r.kt)("p",null,"generate\u867d\u7565\u957f\uff0c\u4f46\u4e0d\u590d\u6742\u3002\u4e3b\u8981\u662f\u6839\u636e\u4e0d\u540c\u7684\u73af\u5883\uff0cnodejs\u3001\u6d4f\u89c8\u5668\u3001ssr\u751f\u6210\u5bf9\u5e94\u7684\u4ee3\u7801\u683c\u5f0f\u3002genNode\u66f4\u662f\u7b80\u5355\uff0cswitch\u5224\u522b\u4e0d\u540c\u7684ast\u8282\u70b9\u7c7b\u578b\uff0c\u6839\u636e\u4e0d\u540c\u7c7b\u578b\u63d2\u5165\u76f8\u5e94\u7684\u8fd0\u884c\u65f6\u7528\u4e8e\u521b\u5efa\u865a\u62df\u8282\u70b9\u7684\u51fd\u6570\u7684\u4ee3\u7801\u5b57\u7b26\u4e32\u3002"),(0,r.kt)("p",null,"\u53c2\u8003\uff1a",(0,r.kt)("a",{parentName:"p",href:"./compiler-%E7%94%9F%E6%88%90AST-%E8%BD%AC%E6%8D%A2AST%E4%B8%BArender"},"compiler-\u751f\u6210AST-\u8f6c\u6362AST\u4e3arender")),(0,r.kt)("mermaid",{value:'flowchart TD\nA1("baseCompile(template, options")--\u7b2c\u4e8c\u6b65\u7f16\u8bd1_ast\u8fdb\u884c\u53d8\u6362--\x3eA2("transform(ast, extend({}, options")--\x3eA3("traverseNode(root, context)")\n\nA1--\u6700\u540e\u4e00\u6b65\u53d8\u6362\u4e4b\u540e\u751f\u6210code\u5b57\u7b26\u4e32--\x3ec1("generate(ast, extend({}")--\x3ec2("return code\u51fd\u6570")\n\nA3--\u53d8\u6362\u4f8b\u5b50v_once--\x3eb2("getBaseTransformPreset()")--\x3eb3("transformOnce = (node, context)")\n\nA2--\u9759\u6001\u63d0\u5347--\x3eb1("hoistStatic(root, context)")'}),(0,r.kt)("h3",{id:"2-1-\u9759\u6001\u63d0\u5347\u53d1\u751f\u5728\u8fd9\u4e00\u9636\u6bb5transform\u5bf9ast\u8fdb\u884c\u8f6c\u6362\u53d8\u6362ast\u7684\u7ed3\u6784"},"2-1. \u9759\u6001\u63d0\u5347\u53d1\u751f\u5728\u8fd9\u4e00\u9636\u6bb5:transform\u5bf9ast\u8fdb\u884c\u8f6c\u6362,\u53d8\u6362AST\u7684\u7ed3\u6784"),(0,r.kt)("p",null,"\u56e0\u4e3a\u53ea\u6709\u62ff\u5230\u751f\u6210\u7684 AST \u6211\u4eec\u624d\u80fd\u904d\u5386 AST \u7684\u8282\u70b9\u8fdb\u884c transform \u8f6c\u6362\u64cd\u4f5c\uff0c\u6bd4\u5982\u89e3\u6790 v-if\u3001v-for \u7b49\u5404\u79cd\u6307\u4ee4\u3002"),(0,r.kt)("p",null,"\u4e5f\u80fd\u5bf9\u6e90\u7801\u8fdb\u884c\u4f18\u5316: vue3\u65b0\u7279\u6027\uff1a\nvue3 \u5728\u6a21\u677f\u7684compile-time\u505a\u4e86\u7684\u4f18\u5316:\u6bd4\u5982\u63d0\u5347\u4e0d\u53d8\u7684vNode(\u9759\u6001\u63d0\u5347)\uff0c\u4ee5\u53cablockTree\u914d\u5408patchFlag\u9776\u5411\u66f4\u65b0"),(0,r.kt)("p",null,"transform\u4e2d\u7684hoistStatic\u53d1\u751f\u9759\u6001\u63d0\u5347,hoistStatic\u4f1a\u9012\u5f52ast\u5e76\u53d1\u73b0\u4e00\u4e9b\u4e0d\u4f1a\u53d8\u7684\u8282\u70b9\u4e0e\u5c5e\u6027\uff0c\u7ed9\u4ed6\u4eec\u6253\u4e0a\u53ef\u4ee5\u9759\u6001\u63d0\u5347\u7684\u6807\u8bb0\u3002\u5728\u751f\u6210\u4ee3\u7801\u5b57\u7b26\u4e32\u9636\u6bb5\uff0c\u5c06\u5176\u5e8f\u5217\u5316\u6210\u5b57\u7b26\u4e32\u3001\u4ee5\u51cf\u5c11\u7f16\u8bd1\u548c\u6e32\u67d3\u6210\u672c\u3002"),(0,r.kt)("p",null,"\u7531\u4e8e\u662f\u5bf9AST\u7684\u53d8\u6362\uff0c\u6240\u4ee5\u4e0d\u4f1a\u6709\u8fd4\u56de\u503c\uff0c\u6240\u4ee5\u5728baseCompile\u7684transform\u51fd\u6570\uff0c\u53ea\u4f1a\u4f20\u5165ast\u62bd\u8c61\u8bed\u6cd5\u6811\u548c\u76f8\u5e94\u7684\u53d8\u6362\u9009\u9879\u3002"),(0,r.kt)("h2",{id:"vue\u521d\u59cb\u5316\u6e90\u7801"},"vue\u521d\u59cb\u5316\u6e90\u7801"),(0,r.kt)("h3",{id:"patch"},(0,r.kt)("inlineCode",{parentName:"h3"},"patch")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"else if (shapeFlag & 6 /* ShapeFlags.COMPONENT */) {\n  console.log(`%c\u8fd0\u884c\u65f6==>patch--\x3e\u8f83\u4e3a\u91cd\u70b9\u76842:COMPONENT:\u8c03\u7528processComponent\u5904\u7406\u7ec4\u4ef6\u5143\u7d20:`, 'color:red')\n  processComponent(n1, n2, container, anchor, parentComponent, parentSuspense, isSVG, slotScopeIds, optimized);\n}\n")),(0,r.kt)("h3",{id:"processcomponent"},(0,r.kt)("inlineCode",{parentName:"h3"},"processComponent")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const processComponent = (n1, n2, container, anchor, parentComponent, parentSuspense, isSVG, slotScopeIds, optimized) => {\n  n2.slotScopeIds = slotScopeIds;\n  if (n1 == null) {\n    if (n2.shapeFlag & 512 /* ShapeFlags.COMPONENT_KEPT_ALIVE */) {\n      parentComponent.ctx.activate(n2, container, anchor, isSVG, optimized);\n    }\n    else {\n      console.log(`%cpath\u4e4bprocessComponent:1\u8c03\u7528mountComponent:`, 'color:magenta')\n      mountComponent(n2, container, anchor, parentComponent, parentSuspense, isSVG, optimized);\n    }\n  }\n  else {\n    console.log(`%cpath\u4e4bprocessComponent:2\u8c03\u7528updateComponent:`, 'color:magenta')\n    updateComponent(n1, n2, optimized);\n  }\n};\n")),(0,r.kt)("h3",{id:"mountcomponent--initialvnode"},(0,r.kt)("inlineCode",{parentName:"h3"},"mountComponent = (initialVNode")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const mountComponent = (initialVNode, container, anchor, parentComponent, parentSuspense, isSVG, optimized) => {\n  const instance = (initialVNode.component = createComponentInstance(initialVNode, parentComponent, parentSuspense));\n  console.log(`%c\u7ec4\u4ef6\u6302\u8f7d\uff1amountComponent:1\u8c03\u7528createComponentInstance\u521b\u5efa\u7ec4\u4ef6\u5b9e\u4f8b:`, 'color:magenta', instance)\n  if (instance.type.__hmrId) {\n    registerHMR(instance);\n  }\n  {\n    pushWarningContext(initialVNode);\n    startMeasure(instance, `mount`);\n  }\n  // inject renderer internals for keepAlive\n  // \u5c06keepAlive\u6ce8\u5165\u6e32\u67d3\u5668\u5185\u90e8\n  if (isKeepAlive(initialVNode)) {\n    instance.ctx.renderer = internals;\n  }\n  // resolve props and slots for setup context\n  {\n    {\n      startMeasure(instance, `init`);\n    }\n\n    console.log(`%c\u7ec4\u4ef6\u6302\u8f7d\uff1amountComponent:2\u8c03\u7528setupComponent\u8bbe\u7f6e\u7ec4\u4ef6\u5b9e\u4f8b:`, 'color:magenta')\n    console.log('test:\u5b9a\u4e49\u5728data\u7684\u54cd\u5e94\u5f0fstart==>mountComponent\u8c03\u7528setupComponent')\n    setupComponent(instance);\n    {\n      endMeasure(instance, `init`);\n    }\n  }\n")),(0,r.kt)("h3",{id:"handlesetupresult--finishcomponentsetup"},(0,r.kt)("inlineCode",{parentName:"h3"},"handleSetupResult"),"--\x3e",(0,r.kt)("inlineCode",{parentName:"h3"},"finishComponentSetup")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"function handleSetupResult(instance, setupResult, isSSR) {\n  if (isFunction(setupResult)) {\n    // setup returned an inline render function\n    {\n      instance.render = setupResult;\n    }\n  }\n  else if (isObject(setupResult)) {\n    if (isVNode(setupResult)) {\n      warn$1(`setup() should not return VNodes directly - ` +\n        `return a render function instead.`);\n    }\n    // setup returned bindings.\n    // assuming a render function compiled from template is present.\n    {\n      instance.devtoolsRawSetupState = setupResult;\n    }\n    instance.setupState = proxyRefs(setupResult);\n    {\n      exposeSetupStateOnRenderContext(instance);\n    }\n  }\n  else if (setupResult !== undefined) {\n    warn$1(`setup() should return an object. Received: ${setupResult === null ? 'null' : typeof setupResult}`);\n  }\n  console.log('%ctest:\u54cd\u5e94\u5f0f=>handleSetupResult\u8c03\u7528finishComponentSetup', 'color:chartreuse')\n  finishComponentSetup(instance, isSSR);\n}\n")),(0,r.kt)("h2",{id:"\u6536\u96c6\u548c\u66f4\u65b0\u526f\u4f5c\u7528"},"\u6536\u96c6\u548c\u66f4\u65b0\u526f\u4f5c\u7528\uff1a"),(0,r.kt)("p",null,"\u8c03\u7528patch\u5904\u7406\u7ec4\u4ef6\u5143\u7d20\u4e3a\u4f8b"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u5728mountComponent\u8d70reactive\u6d41\u7a0b")),(0,r.kt)("p",null,"\u53c2\u8003\uff1a",(0,r.kt)("a",{parentName:"p",href:"./%E9%A6%96%E6%AC%A1%E6%B8%B2%E6%9F%93%E7%9A%84track%E5%92%8Cdata%E6%94%B9%E5%8F%98%E7%9A%84trigger"},"\u9996\u6b21\u6e32\u67d3\u7684track\u548cdata\u6539\u53d8\u7684trigger")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u5728 componentUpdateFn \u51fd\u6570\u4e2d\uff0c\u8fdb\u884c\u4e86\u7ec4\u4ef6\u7684\u521d\u59cb\u6302\u8f7d\u548c\u66f4\u65b0\uff0c\u751f\u547d\u5468\u671f\u51fd\u6570\u5c31\u662f\u5728\u8fd9\u4e9b\u64cd\u4f5c\u7684\u524d\u540e\u89e6\u53d1\u6267\u884c\u7684\uff0c\u5728\u4e0a\u9762\u7684\u6e90\u7801\u4e2d\uff0c\u4f7f\u7528 invokeArrayFns \u51fd\u6570\u8fdb\u884c\u751f\u547d\u5468\u671f\u51fd\u6570\u7684\u89e6\u53d1\u6267\u884c")),(0,r.kt)("mermaid",{value:'flowchart TD\n%% \u8c03\u7528patch\u5904\u7406\u7ec4\u4ef6\u5143\u7d20\u4e3a\u4f8b\nA1("patch(container._vnode,vnode,container,...")--\u5904\u7406dom\u5143\u7d20\u4e3a\u4f8b--\x3eA2("processComponent(n1, n2, container")\n\nA2--\u521b\u5efa--\x3eb6("mountComponent(n2, container, anchor")\nA2--\u66f4\u65b0--\x3eb7("updateComponent(n1, n2,optimized)")\n\n%% \u521b\u5efaproxy\nb6--1data\u4e2d\u58f0\u660e\u6570\u636e--\x3ed1("setupComponent(instance")--\x3ed2("setupStatefulComponent(instance")--2--\x3ed3("handleSetupResult(instance,setupResult,isSSR)")--\x3ed4("finishComponentSetup(instance")--\x3ed5("applyOptions(instance)")--\x3ed6("reactive(target)")\n\nd2--1--\x3ed9("setup()\u8fd4\u56desetupResult")\n\nb13(setup\u58f0\u660e\u8c03\u7528reactive)--1\u76f4\u63a5\u8c03\u7528--\x3ed6\n\nd6--\x3ed7("createReactiveObject(target,false,mutableHandlers){<br/>proxy=new Proxy(target,collectionHandlers|baseHandlers);return proxy}")\n\n\n%% \u4f9d\u8d56\u6536\u96c6\u548c\u7ec4\u4ef6\u6302\u8f7d\u7b49\u751f\u547d\u5468\u671f\nb6--2\u4f9d\u8d56\u6536\u96c6\u548c\u7ec4\u4ef6\u6302\u8f7d\u7ec4\u4ef6\u66f4\u65b0--\x3eb8("setupRenderEffect(instance,initialVNode,container,anchor")--1--\x3eb9("new ReactiveEffect\u521d\u59cb\u5316effect")\n\nb8--2\u751f\u547d\u5468\u671f\u5728componentUpdateFn--\x3eb10("effect.run()\u5185\u90e8\u8c03\u7528componentUpdateFn\u7ec4\u4ef6\u7684\u521d\u59cb\u6302\u8f7d\u548c\u66f4\u65b0")\n\nb10--\x3eb11(renderComponentRoot)--\x3eb12("render(props)\u4f1a\u89e6\u53d1\u4e00\u6b21\u4f9d\u8d56\u6536\u96c6")'}),(0,r.kt)("h2",{id:"render\u751f\u6210\u4e4b\u540e-vnode\u6784\u5efa"},"render\u751f\u6210\u4e4b\u540e-vnode\u6784\u5efa"),(0,r.kt)("p",null,"\u53c2\u8003\uff1a",(0,r.kt)("a",{parentName:"p",href:"./runtime-render%E7%94%9F%E6%88%90%E4%B9%8B%E5%90%8E-vnode%E6%9E%84%E5%BB%BA"},"vnode\u521b\u5efa")),(0,r.kt)("h2",{id:"vnode\u6784\u5efa\u4e4b\u540e-\u5f00\u59cb\u6e32\u67d3"},"VNode\u6784\u5efa\u4e4b\u540e-\u5f00\u59cb\u6e32\u67d3"),(0,r.kt)("p",null,"\u53c2\u8003\uff1a",(0,r.kt)("a",{parentName:"p",href:"./runtime-VNode%E6%9E%84%E5%BB%BA%E4%B9%8B%E5%90%8E-%E5%BC%80%E5%A7%8B%E6%B8%B2%E6%9F%93"},"runtime-VNode\u6784\u5efa\u4e4b\u540e-\u5f00\u59cb\u6e32\u67d3")))}u.isMDXComponent=!0},56359:(e,n,t)=>{t.d(n,{Z:()=>o});const o=t.p+"assets/images/compileToFunction\u751f\u6210code-76ecb7e304dcfef264e69b3d5c67b3ee.png"}}]);