"use strict";(self.webpackChunkprogramming_technology=self.webpackChunkprogramming_technology||[]).push([[6144],{3905:(e,t,n)=>{n.d(t,{Zo:()=>l,kt:()=>m});var r=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},s=Object.keys(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var p=r.createContext({}),i=function(e){var t=r.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):a(a({},t),e)),n},l=function(e){var t=i(e.components);return r.createElement(p.Provider,{value:t},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},h=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,s=e.originalType,p=e.parentName,l=c(e,["components","mdxType","originalType","parentName"]),u=i(n),h=o,m=u["".concat(p,".").concat(h)]||u[h]||d[h]||s;return n?r.createElement(m,a(a({ref:t},l),{},{components:n})):r.createElement(m,a({ref:t},l))}));function m(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var s=n.length,a=new Array(s);a[0]=h;var c={};for(var p in t)hasOwnProperty.call(t,p)&&(c[p]=t[p]);c.originalType=e,c[u]="string"==typeof e?e:o,a[1]=c;for(var i=2;i<s;i++)a[i]=n[i];return r.createElement.apply(null,a)}return r.createElement.apply(null,n)}h.displayName="MDXCreateElement"},48585:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>a,default:()=>d,frontMatter:()=>s,metadata:()=>c,toc:()=>i});var r=n(87462),o=(n(67294),n(3905));const s={},a=void 0,c={unversionedId:"React/\u5e93-redux-connect-useSelector",id:"React/\u5e93-redux-connect-useSelector",title:"\u5e93-redux-connect-useSelector",description:"redux \u548c context",source:"@site/programming-tech/React/\u5e93-redux-connect-useSelector.md",sourceDirName:"React",slug:"/React/\u5e93-redux-connect-useSelector",permalink:"/React/\u5e93-redux-connect-useSelector",draft:!1,editUrl:"https://github.com/huiruo/programming-tech-website/edit/main/programming-tech/React/\u5e93-redux-connect-useSelector.md",tags:[],version:"current",frontMatter:{},sidebar:"docs",previous:{title:"\u5e93-redux-mobx",permalink:"/React/\u5e93-redux-mobx"},next:{title:"\u6e32\u67d3\u5230html-\u539f\u751fDOM\u4e8b\u4ef6\u4ee3\u7406",permalink:"/React/\u6e32\u67d3\u5230html-\u539f\u751fDOM\u4e8b\u4ef6\u4ee3\u7406"}},p={},i=[{value:"redux \u548c context",id:"redux-\u548c-context",level:2},{value:"pureFinalPropsSelectorFactory",id:"purefinalpropsselectorfactory",level:2},{value:"\u603b\u7ed3\uff1achildPropsSelector\u5c31\u662f\u8fd4\u56de selector",id:"\u603b\u7ed3childpropsselector\u5c31\u662f\u8fd4\u56de-selector",level:3},{value:"connect\u51fd\u6570",id:"connect\u51fd\u6570",level:2},{value:"ConnectFunction\u8ba2\u9605\u7684\u91cd\u70b9",id:"connectfunction\u8ba2\u9605\u7684\u91cd\u70b9",level:3},{value:"\u4e0b\u9762\u770b\u770b\u8ba2\u9605\u51fd\u6570 subscribeForReact \u505a\u4e86\u4ec0\u4e48",id:"\u4e0b\u9762\u770b\u770b\u8ba2\u9605\u51fd\u6570-subscribeforreact-\u505a\u4e86\u4ec0\u4e48",level:3},{value:"useSelector",id:"useselector",level:2},{value:"\u884d\u751f\u51fa\u6765\u7684 React \u539f\u7406",id:"\u884d\u751f\u51fa\u6765\u7684-react-\u539f\u7406",level:3},{value:"\u6700\u540e\u7684\u90e8\u5206\u662fuseDispatch",id:"\u6700\u540e\u7684\u90e8\u5206\u662fusedispatch",level:2}],l={toc:i},u="wrapper";function d(e){let{components:t,...n}=e;return(0,o.kt)(u,(0,r.Z)({},l,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"redux-\u548c-context"},"redux \u548c context"),(0,o.kt)("p",null,"App\u6839\u8282\u70b9\u7ec4\u4ef6\u63d0\u4f9b\u7684",(0,o.kt)("inlineCode",{parentName:"p"},"Context"),"\u5bf9\u8c61\u53ef\u4ee5\u770b\u6210\u662fApp\u7ea7\u7684\u5168\u5c40\u4f5c\u7528\u57df\uff0c\u6240\u4ee5\uff0c\u6211\u4eec\u5229\u7528App\u6839\u8282\u70b9\u7ec4\u4ef6\u63d0\u4f9b\u7684",(0,o.kt)("inlineCode",{parentName:"p"},"Context"),"\u5bf9\u8c61\u521b\u5efa\u4e00\u4e9bApp\u7ea7\u7684\u5168\u5c40\u6570\u636e\u3002\u73b0\u6210\u7684\u4f8b\u5b50\u53ef\u4ee5\u53c2\u8003react-redux\uff0c\u4ee5\u4e0b\u662f",(0,o.kt)("inlineCode",{parentName:"p"},"<Provider />"),"\u7ec4\u4ef6\u6e90\u7801\u7684\u6838\u5fc3\u5b9e\u73b0\uff1a"),(0,o.kt)("p",null,"App\u7684\u6839\u7ec4\u4ef6\u7528",(0,o.kt)("inlineCode",{parentName:"p"},"<Provider />"),"\u7ec4\u4ef6\u5305\u88f9\u540e\uff0c\u672c\u8d28\u4e0a\u5c31\u4e3aApp\u63d0\u4f9b\u4e86\u4e00\u4e2a\u5168\u5c40\u7684\u5c5e\u6027",(0,o.kt)("inlineCode",{parentName:"p"},"store"),"\uff0c\u76f8\u5f53\u4e8e\u5728\u6574\u4e2aApp\u8303\u56f4\u5185\uff0c\u5171\u4eab",(0,o.kt)("inlineCode",{parentName:"p"},"store"),"\u5c5e\u6027\u3002\u5f53\u7136\uff0c",(0,o.kt)("inlineCode",{parentName:"p"},"<Provider />"),"\u7ec4\u4ef6\u4e5f\u53ef\u4ee5\u5305\u88f9\u5728\u5176\u4ed6\u7ec4\u4ef6\u4e2d\uff0c\u5728\u7ec4\u4ef6\u7ea7\u7684\u5168\u5c40\u8303\u56f4\u5185\u5171\u4eab",(0,o.kt)("inlineCode",{parentName:"p"},"store"),"\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"export function createProvider(storeKey = 'store', subKey) {\n    const subscriptionKey = subKey || `${storeKey}Subscription`\n\n    class Provider extends Component {\n        getChildContext() {\n          return { [storeKey]: this[storeKey], [subscriptionKey]: null }\n        }\n\n        constructor(props, context) {\n          super(props, context)\n          this[storeKey] = props.store;\n        }\n\n        render() {\n          return Children.only(this.props.children)\n        }\n    }\n\n    // ......\n\n    Provider.propTypes = {\n        store: storeShape.isRequired,\n        children: PropTypes.element.isRequired,\n    }\n    Provider.childContextTypes = {\n        [storeKey]: storeShape.isRequired,\n        [subscriptionKey]: subscriptionShape,\n    }\n\n    return Provider\n}\n\nexport default createProvider()\n")),(0,o.kt)("p",null,"selectorFactoryOptions\u7684\u5bf9\u8c61\u6700\u7ec8\u4ea4\u7ed9 defaultSelectorFactory \u4f7f\u7528"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"const childPropsSelector = useMemo(() => {\n  // The child props selector needs the store reference as an input.\n  // Re-create this selector whenever the store changes.\n  return defaultSelectorFactory(store.dispatch, selectorFactoryOptions);\n}, [store]);\n")),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"childPropsSelector\u5c31\u662f\u6700\u7ec8\u8fd4\u56de\u771f\u6b63\u9700\u8981\u503c\u7684\u51fd\u6570\uff08\u5b83\u771f\u7684\u662f\u9ad8\u9636\u51fd\u6570\u7684\u7ec8\u70b9\u4e86~\uff09"),(0,o.kt)("li",{parentName:"ol"},"defaultSelectorFactory\u51fd\u6570\u505a\u4e86\u4ec0\u4e48\uff0c\u5b83\u5b9e\u9645\u53ebfinalPropsSelectorFactory")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function defaultSelectorFactory(dispatch, _ref) {\n  let {\n    initMapStateToProps,\n    initMapDispatchToProps,\n    initMergeProps\n  } = _ref,\n    options = _objectWithoutPropertiesLoose(_ref, _excluded_selectorFactory);\n\n  const mapStateToProps = initMapStateToProps(dispatch, options);\n  const mapDispatchToProps = initMapDispatchToProps(dispatch, options);\n  const mergeProps = initMergeProps(dispatch, options);\n\n  if (process.env.NODE_ENV !== 'production') {\n    verifySubselectors(mapStateToProps, mapDispatchToProps, mergeProps);\n  }\n\n  return pureFinalPropsSelectorFactory(mapStateToProps, mapDispatchToProps, mergeProps, dispatch, options);\n}\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function pureFinalPropsSelectorFactory(mapStateToProps, mapDispatchToProps, mergeProps, dispatch, {\n  areStatesEqual,\n  areOwnPropsEqual,\n  areStatePropsEqual\n}) {\n  let hasRunAtLeastOnce = false;\n  let state;\n  let ownProps;\n  let stateProps;\n  let dispatchProps;\n  let mergedProps;\n\n  function handleFirstCall(firstState, firstOwnProps) {\n    state = firstState;\n    ownProps = firstOwnProps;\n    stateProps = mapStateToProps(state, ownProps);\n    dispatchProps = mapDispatchToProps(dispatch, ownProps);\n    mergedProps = mergeProps(stateProps, dispatchProps, ownProps);\n    hasRunAtLeastOnce = true;\n    return mergedProps;\n  }\n\n  function handleNewPropsAndNewState() {\n    stateProps = mapStateToProps(state, ownProps);\n    if (mapDispatchToProps.dependsOnOwnProps) dispatchProps = mapDispatchToProps(dispatch, ownProps);\n    mergedProps = mergeProps(stateProps, dispatchProps, ownProps);\n    return mergedProps;\n  }\n\n  function handleNewProps() {\n    if (mapStateToProps.dependsOnOwnProps) stateProps = mapStateToProps(state, ownProps);\n    if (mapDispatchToProps.dependsOnOwnProps) dispatchProps = mapDispatchToProps(dispatch, ownProps);\n    mergedProps = mergeProps(stateProps, dispatchProps, ownProps);\n    return mergedProps;\n  }\n\n  function handleNewState() {\n    const nextStateProps = mapStateToProps(state, ownProps);\n    const statePropsChanged = !areStatePropsEqual(nextStateProps, stateProps);\n    stateProps = nextStateProps;\n    if (statePropsChanged) mergedProps = mergeProps(stateProps, dispatchProps, ownProps);\n    return mergedProps;\n  }\n\n  function handleSubsequentCalls(nextState, nextOwnProps) {\n    const propsChanged = !areOwnPropsEqual(nextOwnProps, ownProps);\n    const stateChanged = !areStatesEqual(nextState, state, nextOwnProps, ownProps);\n    state = nextState;\n    ownProps = nextOwnProps;\n    if (propsChanged && stateChanged) return handleNewPropsAndNewState();\n    if (propsChanged) return handleNewProps();\n    if (stateChanged) return handleNewState();\n    return mergedProps;\n  }\n\n  return function pureFinalPropsSelector(nextState, nextOwnProps) {\n    return hasRunAtLeastOnce ? handleSubsequentCalls(nextState, nextOwnProps) : handleFirstCall(nextState, nextOwnProps);\n  };\n}\n")),(0,o.kt)("h2",{id:"purefinalpropsselectorfactory"},"pureFinalPropsSelectorFactory"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"mapStateToProps\u3001mapDispatchToProps\u3001mergeProps\u662f\u4f1a\u8fd4\u56de\u5404\u81ea\u6700\u7ec8\u503c\u7684\u51fd\u6570\u3002\u66f4\u591a\u5e94\u8be5\u5173\u6ce8\u7684\u91cd\u70b9\u662f pureFinalPropsSelectorFactory \u51fd\u6570")),(0,o.kt)("p",null,"\u5b83\u7684\u95ed\u5305hasRunAtLeastOnce\u7528\u4ee5\u533a\u5206\u662f\u5426\u9996\u6b21\u8c03\u7528\uff0c\u9996\u6b21\u548c\u540e\u7eed\u662f\u4e0d\u540c\u7684\u51fd\u6570\uff0c\u5982\u679c\u662f\u9996\u6b21\u8c03\u7528\u5219\u662f\u4f7f\u7528handleFirstCall\u51fd\u6570\uff0c\u5b83\u91cc\u9762\u4ea7\u751fstateProps\u3001\u4ea7\u751fdispatchProps\uff0c\u7136\u540e\u5c06\u5b83\u4eec\u653e\u5165mergeProps\u8ba1\u7b97\u51fa\u6700\u7ec8\u7684 props\uff0c\u540c\u65f6\u628ahasRunAtLeastOnce\u8bbe\u7f6e\u4e3atrue\uff0c\u8868\u793a\u5df2\u7ecf\u4e0d\u662f\u7b2c\u4e00\u6b21\u6267\u884c\u4e86\u3002"),(0,o.kt)("p",null,"\u540e\u7eed\u8c03\u7528\u90fd\u8d70handleSubsequentCalls\uff0c\u5b83\u7684\u4e3b\u8981\u76ee\u7684\u662f\u5982\u679c state \u548c props \u90fd\u6ca1\u6709\u53d8\u5316\u5219\u4f7f\u7528\u7f13\u5b58\u6570\u636e\uff08state\u3001props \u662f\u5426\u53d8\u5316\u7684\u5224\u65ad\u65b9\u6cd5\u662f\u5916\u90e8\u4f20\u8fdb\u6765\u7684\uff0c\u7ec4\u4ef6\u5f53\u7136\u80fd\u77e5\u9053\u81ea\u5df1\u6709\u6ca1\u6709\u53d8\u5316\uff09\uff0c\u5982\u679c state\u3001props \u90fd\u6709\u53d8\u5316\u6216\u8005\u53ea\u662f\u5176\u4e2d\u4e00\u4e2a\u6709\u53d8\u5316\uff0c\u518d\u5206\u522b\u8c03\u7528\u5404\u81ea\u7684\u51fd\u6570\uff08\u91cc\u9762\u4e3b\u8981\u662f\u6839\u636e\u9759\u6001\u5c5e\u6027dependsOnOwnProps\u5224\u65ad\u662f\u5426\u8981\u91cd\u65b0\u6267\u884c\uff09\u5f97\u5230\u65b0\u503c\u3002"),(0,o.kt)("p",null,"\u4e8e\u662fchildPropsSelector\u51fd\u6570\u5c31\u662f\u8fd4\u56de\u7684pureFinalPropsSelector\u51fd\u6570\uff0c\u5185\u90e8\u8bbf\u95ee\u4e86\u95ed\u5305\uff0c\u95ed\u5305\u4fdd\u5b58\u4e86\u6301\u4e45\u503c\uff0c\u4ece\u800c\u5728\u7ec4\u4ef6\u591a\u6b21\u6267\u884c\u7684\u60c5\u51b5\u4e0b\uff0c\u53ef\u4ee5\u51b3\u5b9a\u662f\u5426\u9700\u8981\u4f7f\u7528\u7f13\u5b58\u6765\u4f18\u5316\u6027\u80fd\u3002"),(0,o.kt)("p",null,"selector \u76f8\u5173\u7684\u5206\u6790\u5b8c\u4e86\u3002"),(0,o.kt)("h3",{id:"\u603b\u7ed3childpropsselector\u5c31\u662f\u8fd4\u56de-selector"},"\u603b\u7ed3\uff1achildPropsSelector\u5c31\u662f\u8fd4\u56de selector"),(0,o.kt)("p",null,"\u603b\u7684\u6765\u8bf4\uff0c\u5982\u679c\u60f3\u5b9e\u73b0\u4e00\u4e2a\u6700\u7b80\u5355\u7684selector\uff0c\u53ea\u9700\u8981"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"const selector = (state, ownProps) => {\n  const stateProps = mapStateToProps(reduxState);\n  const dispatchProps = mapDispatchToProps(reduxDispatch);\n  const actualChildProps = mergeProps(stateProps, dispatchProps, ownProps);\n  return actualChildProps;\n};\n")),(0,o.kt)("p",null,"\u90a3\u4e3a\u4ec0\u4e48 react-redux \u4f1a\u5199\u7684\u5982\u6b64\u590d\u6742\u5462\u3002\u5c31\u662f\u4e3a\u4e86connect\u7ec4\u4ef6\u5728\u591a\u6b21\u6267\u884c\u65f6\u80fd\u5229\u7528\u7ec6\u7c92\u5ea6\u7f13\u5b58\u7684 mergedProps \u503c\u63d0\u5347\u6027\u80fd\uff0cReact \u53ea\u80fd\u505a\u5230\u5728wrapperProps\u4e0d\u53d8\u65f6\u4f7f\u7528 memo\uff0c\u4f46\u96be\u4ee5\u505a\u66f4\u7ec6\u7c92\u5ea6\u7684\u533a\u5206\uff0c\u6bd4\u5982\u77e5\u9053 selector \u662f\u5426\u4f9d\u8d56 props\uff0c\u4ece\u800c\u5c31\u7b97 props \u53d8\u5316\u4e86\u4e5f\u4e0d\u9700\u8981\u66f4\u65b0\u3002\u8981\u5b9e\u73b0\u8fd9\u4e00\u70b9\u9700\u8981\u5927\u91cf\u5d4c\u5957\u7684\u9ad8\u9636\u51fd\u6570\u50a8\u5b58\u6301\u4e45\u5316\u7684\u95ed\u5305\u4e2d\u95f4\u503c\uff0c\u624d\u80fd\u5728\u7ec4\u4ef6\u591a\u6b21\u6267\u884c\u65f6\u4e0d\u4e22\u5931\u72b6\u6001\u4ece\u800c\u5224\u65ad\u66f4\u65b0\u3002"),(0,o.kt)("p",null,"\u4e0b\u9762\u6211\u4eec\u51c6\u5907\u8bb2\u70b9\u522b\u7684\u4e86\uff0c\u5982\u679c\u4f60\u5bf9\u4e00\u7cfb\u5217\u8c03\u7528\u6808\u6709\u70b9\u5934\u6655\uff0c\u4f60\u53ea\u8981\u8bb0\u4f4f\u770b\u5230\u4e86childPropsSelector\u5c31\u662f\u8fd4\u56de selector \u540e\u7684\u503c\u5c31\u597d\u4e86"),(0,o.kt)("h2",{id:"connect\u51fd\u6570"},"connect\u51fd\u6570"),(0,o.kt)("p",null,"WrappedComponent \u5c31\u662f\u7528\u6237\u4f20\u5165\u7684\u4e1a\u52a1\u7ec4\u4ef6\uff0cContextToUse.Provider\u4f1a\u5c06\u8be5 connect \u7684subscription\u4f20\u7ed9\u4e0b\u5c42\uff0c\u5982\u679c\u4e1a\u52a1\u7ec4\u4ef6\u91cc\u8fd8\u6709 connect \u5c31\u53ef\u4ee5\u5d4c\u5957\u8ba2\u9605\u3002\u662f\u5426\u9700\u8981 context \u900f\u4f20\u662f\u7531shouldHandleStateChanges\u53d8\u91cf\u51b3\u5b9a\u7684\uff0c\u5982\u679c\u6ca1\u6709mapStateToProps\u7684\u8bdd\uff0c\u5b83\u5219\u662ffalse\u3002\u4e5f\u5c31\u662f\u8bf4\u5982\u679c\u8fdemapStateToProps\u90fd\u6ca1\u6709\uff0c\u90a3\u8fd9\u4e2a\u7ec4\u4ef6\u53ca\u5176\u5b50\u7ec4\u4ef6\u4e5f\u5c31\u6ca1\u6709\u8ba2\u9605 redux \u7684\u5fc5\u8981\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function connect(mapStateToProps, mapDispatchToProps, mergeProps, {\n  // The `pure` option has been removed, so TS doesn't like us destructuring this to check its existence.\n  // @ts-ignore\n  pure,\n  areStatesEqual = strictEqual,\n  areOwnPropsEqual = shallowEqual,\n  areStatePropsEqual = shallowEqual,\n  areMergedPropsEqual = shallowEqual,\n  // use React's forwardRef to expose a ref of the wrapped component\n  forwardRef = false,\n  // the context consumer to use\n  context = ReactReduxContext\n} = {}) {\n  // if (process.env.NODE_ENV !== 'production') {\n  if (pure !== undefined && !hasWarnedAboutDeprecatedPureOption) {\n    hasWarnedAboutDeprecatedPureOption = true;\n    warning('The `pure` option has been removed. `connect` is now always a \"pure/memoized\" component');\n  }\n  // }\n  const Context = context;\n  const initMapStateToProps = mapStateToPropsFactory(mapStateToProps);\n  const initMapDispatchToProps = mapDispatchToPropsFactory(mapDispatchToProps);\n  const initMergeProps = mergePropsFactory(mergeProps);\n  const shouldHandleStateChanges = Boolean(mapStateToProps);\n\n  console.log('%c=react-redux=connect\u6267\u884cwrapWithConnect', 'color:chartreuse')\n\n  const wrapWithConnect = WrappedComponent => {\n    // if (process.env.NODE_ENV !== 'production' && !isValidElementType(WrappedComponent)) {\n    //   throw new Error(`You must pass a component to the function returned by connect. Instead received ${stringifyComponent(WrappedComponent)}`);\n    // }\n\n    const wrappedComponentName = WrappedComponent.displayName || WrappedComponent.name || 'Component';\n    const displayName = `Connect(${wrappedComponentName})`;\n    const selectorFactoryOptions = {\n      shouldHandleStateChanges,\n      displayName,\n      wrappedComponentName,\n      WrappedComponent,\n      // @ts-ignore\n      initMapStateToProps,\n      // @ts-ignore\n      initMapDispatchToProps,\n      initMergeProps,\n      areStatesEqual,\n      areStatePropsEqual,\n      areOwnPropsEqual,\n      areMergedPropsEqual\n    };\n\n    console.log('%c=react-redux=connect\u8fd4\u56deselectorFactoryOptions', 'color:chartreuse', selectorFactoryOptions)\n\n    function ConnectFunction(props) {\n      console.log('%c=react-redux=ConnectFunction\u6b63\u5f0f\u6267\u884c', 'color:chartreuse')\n      const [propsContext, reactReduxForwardedRef, wrapperProps] = useMemo(() => {\n        // Distinguish between actual \"data\" props that were passed to the wrapper component,\n        // and values needed to control behavior (forwarded refs, alternate context instances).\n        // To maintain the wrapperProps object reference, memoize this destructuring.\n        const {\n          reactReduxForwardedRef\n        } = props,\n          wrapperProps = _objectWithoutPropertiesLoose(props, _excluded);\n\n        return [props.context, reactReduxForwardedRef, wrapperProps];\n      }, [props]);\n      const ContextToUse = useMemo(() => {\n        // Users may optionally pass in a custom context instance to use instead of our ReactReduxContext.\n        // Memoize the check that determines which context instance we should use.\n        return propsContext && propsContext.Consumer && // @ts-ignore\n          isContextConsumer( /*#__PURE__*/React.createElement(propsContext.Consumer, null)) ? propsContext : Context;\n      }, [propsContext, Context]); // Retrieve the store and ancestor subscription via context, if available\n\n      const contextValue = useContext(ContextToUse); // The store _must_ exist as either a prop or in context.\n      // We'll check to see if it _looks_ like a Redux store first.\n      // This allows us to pass through a `store` prop that is just a plain value.\n\n      const didStoreComeFromProps = Boolean(props.store) && Boolean(props.store.getState) && Boolean(props.store.dispatch);\n      const didStoreComeFromContext = Boolean(contextValue) && Boolean(contextValue.store);\n\n      if (process.env.NODE_ENV !== 'production' && !didStoreComeFromProps && !didStoreComeFromContext) {\n        throw new Error(`Could not find \"store\" in the context of ` + `\"${displayName}\". Either wrap the root component in a <Provider>, ` + `or pass a custom React context provider to <Provider> and the corresponding ` + `React context consumer to ${displayName} in connect options.`);\n      } // Based on the previous check, one of these must be true\n\n\n      const store = didStoreComeFromProps ? props.store : contextValue.store;\n      const getServerState = didStoreComeFromContext ? contextValue.getServerState : store.getState;\n      const childPropsSelector = useMemo(() => {\n        // The child props selector needs the store reference as an input.\n        // Re-create this selector whenever the store changes.\n        return defaultSelectorFactory(store.dispatch, selectorFactoryOptions);\n      }, [store]);\n      const [subscription, notifyNestedSubs] = useMemo(() => {\n        console.log('=react-redux=ConnectFunction=\u9605\u7684\u91cd\u70b9')\n        if (!shouldHandleStateChanges) return NO_SUBSCRIPTION_ARRAY; // This Subscription's source should match where store came from: props vs. context. A component\n        // connected to the store via props shouldn't use subscription from context, or vice versa.\n\n        const subscription = createSubscription(store, didStoreComeFromProps ? undefined : contextValue.subscription); // `notifyNestedSubs` is duplicated to handle the case where the component is unmounted in\n        // the middle of the notification loop, where `subscription` will then be null. This can\n        // probably be avoided if Subscription's listeners logic is changed to not call listeners\n        // that have been unsubscribed in the  middle of the notification loop.\n\n        const notifyNestedSubs = subscription.notifyNestedSubs.bind(subscription);\n        return [subscription, notifyNestedSubs];\n      }, [store, didStoreComeFromProps, contextValue]); // Determine what {store, subscription} value should be put into nested context, if necessary,\n      // and memoize that value to avoid unnecessary context updates.\n\n      const overriddenContextValue = useMemo(() => {\n        if (didStoreComeFromProps) {\n          // This component is directly subscribed to a store from props.\n          // We don't want descendants reading from this store - pass down whatever\n          // the existing context value is from the nearest connected ancestor.\n          return contextValue;\n        } // Otherwise, put this component's subscription instance into context, so that\n        // connected descendants won't update until after this component is done\n\n\n        return _extends({}, contextValue, {\n          subscription\n        });\n      }, [didStoreComeFromProps, contextValue, subscription]); // Set up refs to coordinate values between the subscription effect and the render logic\n\n      const lastChildProps = useRef();\n      const lastWrapperProps = useRef(wrapperProps);\n      const childPropsFromStoreUpdate = useRef();\n      const renderIsScheduled = useRef(false);\n      const isProcessingDispatch = useRef(false);\n      const isMounted = useRef(false);\n      const latestSubscriptionCallbackError = useRef();\n      useIsomorphicLayoutEffect(() => {\n        isMounted.current = true;\n        return () => {\n          isMounted.current = false;\n        };\n      }, []);\n      const actualChildPropsSelector = useMemo(() => {\n        const selector = () => {\n          // Tricky logic here:\n          // - This render may have been triggered by a Redux store update that produced new child props\n          // - However, we may have gotten new wrapper props after that\n          // If we have new child props, and the same wrapper props, we know we should use the new child props as-is.\n          // But, if we have new wrapper props, those might change the child props, so we have to recalculate things.\n          // So, we'll use the child props from store update only if the wrapper props are the same as last time.\n          if (childPropsFromStoreUpdate.current && wrapperProps === lastWrapperProps.current) {\n            return childPropsFromStoreUpdate.current;\n          } // TODO We're reading the store directly in render() here. Bad idea?\n          // This will likely cause Bad Things (TM) to happen in Concurrent Mode.\n          // Note that we do this because on renders _not_ caused by store updates, we need the latest store state\n          // to determine what the child props should be.\n\n\n          return childPropsSelector(store.getState(), wrapperProps);\n        };\n\n        return selector;\n      }, [store, wrapperProps]); // We need this to execute synchronously every time we re-render. However, React warns\n      // about useLayoutEffect in SSR, so we try to detect environment and fall back to\n      // just useEffect instead to avoid the warning, since neither will run anyway.\n\n      const subscribeForReact = useMemo(() => {\n        console.log('=react-redux=\u8fd9\u91cc\u8ba2\u9605\u4e86\u66f4\u65b0\uff0c\u5e76\u4e14\u8fd4\u56de\u4e00\u4e2a\u6ce8\u9500\u8ba2\u9605\u7684\u51fd\u6570')\n        const subscribe = reactListener => {\n          if (!subscription) {\n            return () => { };\n          }\n\n          return subscribeUpdates(shouldHandleStateChanges, store, subscription, // @ts-ignore\n            childPropsSelector, lastWrapperProps, lastChildProps, renderIsScheduled, isMounted, childPropsFromStoreUpdate, notifyNestedSubs, reactListener);\n        };\n\n        return subscribe;\n      }, [subscription]);\n      useIsomorphicLayoutEffectWithArgs(captureWrapperProps, [lastWrapperProps, lastChildProps, renderIsScheduled, wrapperProps, childPropsFromStoreUpdate, notifyNestedSubs]);\n      let actualChildProps;\n\n      try {\n        // console.log(\"actualChildProps = useSyncExternalStore_connect1:\", useSyncExternalStore)\n        actualChildProps = useSyncExternalStore( // TODO We're passing through a big wrapper that does a bunch of extra side effects besides subscribing\n          // actualChildProps = useSyncExternalStore_connect( // TODO We're passing through a big wrapper that does a bunch of extra side effects besides subscribing\n          subscribeForReact, // TODO This is incredibly hacky. We've already processed the store update and calculated new child props,\n          // TODO and we're just passing that through so it triggers a re-render for us rather than relying on `uSES`.\n          actualChildPropsSelector, getServerState ? () => childPropsSelector(getServerState(), wrapperProps) : actualChildPropsSelector);\n      } catch (err) {\n        if (latestSubscriptionCallbackError.current) {\n          ;\n          err.message += `\\nThe error may be correlated with this previous error:\\n${latestSubscriptionCallbackError.current.stack}\\n\\n`;\n        }\n\n        throw err;\n      }\n\n      useIsomorphicLayoutEffect(() => {\n        latestSubscriptionCallbackError.current = undefined;\n        childPropsFromStoreUpdate.current = undefined;\n        lastChildProps.current = actualChildProps;\n      }); // Now that all that's done, we can finally try to actually render the child component.\n      // We memoize the elements for the rendered child component as an optimization.\n\n      const renderedWrappedComponent = useMemo(() => {\n        return (\n          /*#__PURE__*/\n          // @ts-ignore\n          React.createElement(WrappedComponent, _extends({}, actualChildProps, {\n            ref: reactReduxForwardedRef\n          }))\n        );\n      }, [reactReduxForwardedRef, WrappedComponent, actualChildProps]); // If React sees the exact same element reference as last time, it bails out of re-rendering\n      // that child, same as if it was wrapped in React.memo() or returned false from shouldComponentUpdate.\n\n      const renderedChild = useMemo(() => {\n        if (shouldHandleStateChanges) {\n          // If this component is subscribed to store updates, we need to pass its own\n          // subscription instance down to our descendants. That means rendering the same\n          // Context instance, and putting a different value into the context.\n          return /*#__PURE__*/React.createElement(ContextToUse.Provider, {\n            value: overriddenContextValue\n          }, renderedWrappedComponent);\n        }\n\n        return renderedWrappedComponent;\n      }, [ContextToUse, renderedWrappedComponent, overriddenContextValue]);\n      return renderedChild;\n    }\n\n    const _Connect = React.memo(ConnectFunction);\n\n    // Add a hacky cast to get the right output type\n    const Connect = _Connect;\n    Connect.WrappedComponent = WrappedComponent;\n    Connect.displayName = ConnectFunction.displayName = displayName;\n\n    if (forwardRef) {\n      const _forwarded = React.forwardRef(function forwardConnectRef(props, ref) {\n\n        console.log('%c=react-redux=ConnectFunction\u6ce8\u5165ConnectFunction1=createElement(Connect)', 'color:chartreuse')\n        // @ts-ignore\n        return /*#__PURE__*/React.createElement(Connect, _extends({}, props, {\n          reactReduxForwardedRef: ref\n        }));\n      });\n\n      const forwarded = _forwarded;\n      forwarded.displayName = displayName;\n      forwarded.WrappedComponent = WrappedComponent;\n      // return hoistStatics(forwarded, WrappedComponent);\n      return hoistNonReactStatics(forwarded, WrappedComponent);\n    }\n\n    // return hoistStatics(Connect, WrappedComponent);\n    console.log('%c=react-redux=ConnectFunction\u6ce8\u5165ConnectFunction2=hoistNonReactStatics(Connect', 'color:chartreuse')\n    return hoistNonReactStatics(Connect, WrappedComponent);\n  };\n  console.log('%c=react-redux=Connect\u51fd\u6570\u8fd4\u56de', 'color:chartreuse', { wrapWithConnect })\n  return wrapWithConnect;\n}\n")),(0,o.kt)("h3",{id:"connectfunction\u8ba2\u9605\u7684\u91cd\u70b9"},"ConnectFunction\u8ba2\u9605\u7684\u91cd\u70b9"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function ConnectFunction(props) {\n  // \u7701\u7565\u4ee3\u7801\n  const [subscription, notifyNestedSubs] = useMemo(() => {\n    console.log('=react-redux=ConnectFunction=\u9605\u7684\u91cd\u70b9')\n    if (!shouldHandleStateChanges) return NO_SUBSCRIPTION_ARRAY; // This Subscription's source should match where store came from: props vs. context. A component\n    // connected to the store via props shouldn't use subscription from context, or vice versa.\n\n    const subscription = createSubscription(store, didStoreComeFromProps ? undefined : contextValue.subscription); // `notifyNestedSubs` is duplicated to handle the case where the component is unmounted in\n    // the middle of the notification loop, where `subscription` will then be null. This can\n    // probably be avoided if Subscription's listeners logic is changed to not call listeners\n    // that have been unsubscribed in the  middle of the notification loop.\n\n    const notifyNestedSubs = subscription.notifyNestedSubs.bind(subscription);\n    return [subscription, notifyNestedSubs];\n  }, [store, didStoreComeFromProps, contextValue]); // Determine what {store, subscription} value should be put into nested context, if necessary,\n}\n")),(0,o.kt)("p",null,"\u901a\u8fc7 createSubscription \u51fd\u6570\u521b\u5efa\u4e86\u4e00\u4e2a\u8ba2\u9605\u5b9e\u4f8b\uff0ccreateSubscription \u7684\u7ec6\u8282\u4e0a\u9762\u8bb2\u8fc7\u4e86\uff0c\u5b83\u91cc\u9762\u6709\u4e00\u4e2a\u5d4c\u5957\u8ba2\u9605\u7684\u903b\u8f91\uff0c\u8fd9\u91cc\u5c31\u4f1a\u7528\u5230\u3002createSubscription \u7684\u7b2c 3 \u4e2a\u53c2\u6570\u4f20\u5165\u4e86 context \u91cc\u7684 subscription \u8ba2\u9605\u5b9e\u4f8b\uff0c\u6839\u636e\u5d4c\u5957\u8ba2\u9605\u903b\u8f91\uff08\u5fd8\u4e86\u7684\u53ef\u4ee5\u56de\u5934\u770b\u770b\u51fd\u6570\u521b\u5efa\u4e86\u4e00\u4e2a\u8ba2\u9605\u5b9e\u4f8b\uff0ccreateSubscription \u7684\u7b2c 3 \u4e2a\u53c2\u6570\u8d77\u5230\u4e86\u4ec0\u4e48\u4f5c\u7528\uff09\uff0c\u8fd9\u4e2a connect \u91cc\u7684\u8ba2\u9605\u56de\u8c03\u5b9e\u9645\u4e0a\u662f\u6ce8\u518c\u7ed9\u7236\u7ea7\u7684\u8fd9\u4e2acontextValue.subscription\u7684\uff0c\u5982\u679c\u8fd9\u4e2a\u7236\u7ea7\u662f\u9876\u5c42\u7684 Provider\uff0c\u90a3\u4e48\u5b83\u7684\u8ba2\u9605\u56de\u8c03\u624d\u771f\u6b63\u6ce8\u518c\u7ed9redux\uff0c\u5982\u679c\u7236\u7ea7\u8fd8\u4e0d\u662f\u9876\u5c42\u7684\u8bdd\uff0c\u90a3\u4e48\u8fd8\u662f\u4f1a\u50cf\u8fd9\u6837\u4e00\u5c42\u5c42\u7684\u5d4c\u5957\u6ce8\u518c\u56de\u8c03\u3002\u901a\u8fc7\u8fd9\u4e2a\u5b9e\u73b0\u4e86\u300e\u7236\u7ea7\u5148\u66f4\u65b0-\u5b50\u7ea7\u540e\u66f4\u65b0\u300f\u4ece\u800c\u907f\u514d\u8fc7\u671f props \u548c\u50f5\u5c38\u8282\u70b9\u95ee\u9898\u3002"),(0,o.kt)("p",null,"\u4e3a\u4e86\u8ba9\u5b50\u7ea7 connect \u7684\u8ba2\u9605\u56de\u8c03\u6ce8\u518c\u7ed9\u81ea\u5df1\uff0c\u4e8e\u662f\u7528\u81ea\u5df1\u7684 subscription \u751f\u6210\u4e86\u4e00\u4e2a\u65b0\u7684 ReactReduxContextValue: overriddenContextValue\uff0c\u4ee5\u4fbf\u540e\u7eed\u7684\u5d4c\u5957\u6ce8\u518c\u3002"),(0,o.kt)("p",null,"\u7136\u540e\u5b9a\u4e49\u4e86\u4e00\u6279\u300e\u6301\u4e45\u5316\u6570\u636e\u300f\uff08\u4e0d\u4f1a\u968f\u7740\u7ec4\u4ef6\u91cd\u590d\u6267\u884c\u800c\u521d\u59cb\u5316\uff09\uff0c\u8fd9\u4e9b\u6570\u636e\u4e3b\u8981\u4e3a\u4e86\u5c06\u6765\u7684\u300e\u66f4\u65b0\u5224\u65ad\u300f\u548c\u300e\u7531\u7236\u7ec4\u4ef6\u5e26\u52a8\u7684\u66f4\u65b0\u3001\u6765\u81ea store \u7684\u66f4\u65b0\u4e0d\u91cd\u590d\u53d1\u751f\u300f\uff0c\u540e\u9762\u4f1a\u7528\u5230\u5b83\u4eec\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function ConnectFunction(props) {\n  // \u7701\u7565\u4ee3\u7801\n  const lastChildProps = useRef();\n  const lastWrapperProps = useRef(wrapperProps);\n  const childPropsFromStoreUpdate = useRef();\n  const renderIsScheduled = useRef(false);\n  const isProcessingDispatch = useRef(false);\n  const isMounted = useRef(false);\n  const latestSubscriptionCallbackError = useRef();\n}\n")),(0,o.kt)("p",null,"\u524d\u9762\u53ea\u770b\u5230\u4e86 subscription \u7684\u521b\u5efa\uff0c\u5e76\u6ca1\u6709\u5177\u4f53\u66f4\u65b0\u76f8\u5173\u7684\uff0c\u63a5\u4e0b\u6765\u7684\u4ee3\u7801\u4f1a\u8d70\u5230\u3002\nsubscribeForReact\u540e\u9762\u518d\u770b\uff0c\u91cc\u9762\u4e3b\u8981\u662f\u5224\u65ad\u662f\u5426\u8981\u66f4\u65b0\u7684\uff0c\u5b83\u662f\u53d1\u8d77\u66f4\u65b0\u7684\u4e3b\u8981\u5165\u53e3\u3002"),(0,o.kt)("p",null,"useIsomorphicLayoutEffectWithArgs \u662f\u4e00\u4e2a\u5de5\u5177\u51fd\u6570\uff0c\u5185\u90e8\u662fuseIsomorphicLayoutEffect\uff0c\u8fd9\u4e2a\u51fd\u6570\u524d\u9762\u4e5f\u8bb2\u8fc7\u3002\u5b83\u4eec\u6700\u7ec8\u505a\u7684\u662f\uff1a\u5c06\u7b2c 2 \u4e2a\u6570\u7ec4\u53c2\u6570\u7684\u6bcf\u9879\u4f5c\u4e3a\u53c2\u6570\u7ed9\u7b2c\u4e00\u4e2a\u53c2\u6570\u8c03\u7528\uff0c\u7b2c 3 \u4e2a\u53c2\u6570\u662fuseIsomorphicLayoutEffect\u7684\u7f13\u5b58\u4f9d\u8d56\u3002"),(0,o.kt)("p",null,"\u88ab\u6267\u884c\u7684\u7b2c\u4e00\u4e2a\u53c2\u6570captureWrapperProps\uff0c\u5b83\u4e3b\u8981\u529f\u80fd\u662f\u5224\u65ad\u5982\u679c\u662f\u6765\u81ea store \u7684\u66f4\u65b0\uff0c\u5219\u5728\u66f4\u65b0\u5b8c\u6210\u540e\uff08\u6bd4\u5982 useEffect\uff09\u89e6\u53d1subscription.notifyNestedSubs\uff0c\u901a\u77e5\u5b50\u8ba2\u9605\u66f4\u65b0\u3002"),(0,o.kt)("p",null,"\u63a5\u7740\u5b83\u60f3\u751f\u6210actualChildProps\uff0c\u4e5f\u5c31\u662f select \u51fa\u6765\u7684\u4e1a\u52a1\u7ec4\u4ef6\u9700\u8981\u7684 props\uff0c\u5176\u4e2d\u4e3b\u8981\u4f7f\u7528\u4e86useSyncExternalStore\uff0c\u5982\u679c\u4f60\u8ffd\u5230useSyncExternalStore\u7684\u4ee3\u7801\u91cc\u770b\uff0c\u4f1a\u53d1\u73b0\u5b83\u662f\u4e00\u4e2a\u7a7a\u65b9\u6cd5\uff0c\u76f4\u63a5\u8c03\u7528\u4f1a\u629b\u51fa\u9519\u8bef\uff0c\u6240\u4ee5\u5b83\u662f\u7531\u5916\u90e8\u6ce8\u5165\u7684\u3002\u5728\u5165\u53e3index.ts\u91cc\uff0cinitializeConnect(useSyncExternalStore)\u5bf9\u5b83\u8fdb\u884c\u521d\u59cb\u5316\u4e86\uff0cuseSyncExternalStore\u6765\u81ea React \u3002\u6240\u4ee5actualChildProps\u5b9e\u9645\u662fReact.useSyncExternalStore( subscribeForReact, actualChildPropsSelector, getServerState ? () => childPropsSelector(getServerState(), wrapperProps) : actualChildPropsSelector)\u7684\u7ed3\u679c\u3002"),(0,o.kt)("p",null,"useSyncExternalStore\u662f react18 \u7684\u65b0 API\uff0c\u524d\u8eab\u662fuseMutableSource\uff0c\u4e3a\u4e86\u9632\u6b62\u5728 concurrent \u6a21\u5f0f\u4e0b\uff0c\u4efb\u52a1\u4e2d\u65ad\u540e\u7b2c\u4e09\u65b9 store \u88ab\u4fee\u6539\uff0c\u6062\u590d\u4efb\u52a1\u65f6\u51fa\u73b0tearing\u4ece\u800c\u6570\u636e\u4e0d\u4e00\u81f4\u3002\u5916\u90e8 store \u7684\u66f4\u65b0\u53ef\u4ee5\u901a\u8fc7\u5b83\u5f15\u8d77\u7ec4\u4ef6\u7684\u66f4\u65b0\u3002\u5728react-redux8\u4e4b\u524d\uff0c\u662f\u7531useReducer\u624b\u52a8\u5b9e\u73b0\u7684\uff0c\u8fd9\u662freact-redux8\u9996\u6b21\u4f7f\u7528\u65b0 API\u3002\u8fd9\u4e5f\u610f\u5473\u7740\u4f60\u5fc5\u987b\u8ddf\u7740\u4f7f\u7528 React18+\u3002\u4f46\u6211\u8ba4\u4e3a\u5176\u5b9e react-redux8 \u53ef\u4ee5\u7528 shim: import { useSyncExternalStore } from 'use-syncexternal-store/shim';\u6765\u505a\u5230\u5411\u4e0b\u517c\u5bb9\u3002"),(0,o.kt)("p",null,"useSyncExternalStore\u7b2c\u4e00\u4e2a\u53c2\u6570\u662f\u4e00\u4e2a\u8ba2\u9605\u51fd\u6570\uff0c\u8ba2\u9605\u89e6\u53d1\u65f6\u4f1a\u5f15\u8d77\u8be5\u7ec4\u4ef6\u7684\u66f4\u65b0\uff0c\u7b2c\u4e8c\u4e2a\u51fd\u6570\u8fd4\u56de\u4e00\u4e2a immutable \u5feb\u7167\uff0c\u7528\u4e8e\u6807\u8bb0\u8be5\u4e0d\u8be5\u66f4\u65b0\uff0c\u4ee5\u53ca\u5f97\u5230\u8fd4\u56de\u7684\u7ed3\u679c\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function ConnectFunction(props) {\n  // \u7701\u7565\u4ee3\u7801\n  const subscribeForReact = useMemo(() => {\n  const subscribe = reactListener => {\n    if (!subscription) {\n      return () => { };\n    }\n\n    return subscribeUpdates(shouldHandleStateChanges, store, subscription, // @ts-ignore\n      childPropsSelector, lastWrapperProps, lastChildProps, renderIsScheduled, isMounted, childPropsFromStoreUpdate, notifyNestedSubs, reactListener);\n  };\n\n  return subscribe;\n}, [subscription]);\n\nuseIsomorphicLayoutEffectWithArgs(captureWrapperProps, [lastWrapperProps, lastChildProps, renderIsScheduled, wrapperProps, childPropsFromStoreUpdate, notifyNestedSubs]);\n\n}\n")),(0,o.kt)("h3",{id:"\u4e0b\u9762\u770b\u770b\u8ba2\u9605\u51fd\u6570-subscribeforreact-\u505a\u4e86\u4ec0\u4e48"},"\u4e0b\u9762\u770b\u770b\u8ba2\u9605\u51fd\u6570 subscribeForReact \u505a\u4e86\u4ec0\u4e48"),(0,o.kt)("p",null,"\u9996\u5148\u7528 useMemo \u7f13\u5b58\u4e86\u51fd\u6570\uff0c\u7528 useCallback \u4e5f\u53ef\u4ee5\uff0c\u800c\u4e14\u4e2a\u4eba\u89c9\u5f97useCallback\u66f4\u7b26\u5408\u8bed\u4e49\u3002\u8fd9\u4e2a\u51fd\u6570\u5b9e\u9645\u8c03\u7528\u7684\u662fsubscribeUpdates\uff0c\u90a3\u6211\u4eec\u518d\u770b\u770bsubscribeUpdates\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"const subscribeForReact = useMemo(() => {\n  console.log('=react-redux=\u8fd9\u91cc\u8ba2\u9605\u4e86\u66f4\u65b0\uff0c\u5e76\u4e14\u8fd4\u56de\u4e00\u4e2a\u6ce8\u9500\u8ba2\u9605\u7684\u51fd\u6570')\n  const subscribe = reactListener => {\n    if (!subscription) {\n      return () => { };\n    }\n\n    return subscribeUpdates(shouldHandleStateChanges, store, subscription, // @ts-ignore\n      childPropsSelector, lastWrapperProps, lastChildProps, renderIsScheduled, isMounted, childPropsFromStoreUpdate, notifyNestedSubs, reactListener);\n  };\n\n  return subscribe;\n}, [subscription]);\n")),(0,o.kt)("p",null,"\u5176\u4e2d\u7684\u91cd\u70b9\u662fcheckForUpdates\uff0c\u5b83\u91cc\u9762\u83b7\u53d6\u4e86\u6700\u65b0\u7684 Store \u72b6\u6001: latestStoreState\uff08\u6ce8\u610f\u8fd9\u91cc\u4f9d\u7136\u662f\u624b\u52a8\u83b7\u53d6\u7684\uff0c\u5c06\u6765 react-redux \u4f1a\u628a\u5b83\u4ea4\u7ed9uSES\u505a\uff09\u3001\u6700\u65b0\u7684\u8981\u4ea4\u7ed9\u4e1a\u52a1\u7ec4\u4ef6\u7684 props: newChildProps\uff0c\u5982\u679c childProps \u548c\u4e0a\u4e00\u6b21\u4e00\u6837\uff0c\u90a3\u4e48\u4e0d\u4f1a\u66f4\u65b0\uff0c\u53ea\u4f1a\u901a\u77e5\u5b50 connect \u5c1d\u8bd5\u66f4\u65b0\u3002\u5982\u679c childProps \u53d8\u4e86\uff0c\u5219\u4f1a\u8c03\u7528 React.useSyncExternalStore \u4f20\u5165\u7684\u66f4\u65b0\u65b9\u6cd5\uff0c\u8fd9\u91cc\u53ebadditionalSubscribeListener\uff0c\u5b83\u4f1a\u5f15\u8d77\u7ec4\u4ef6\u66f4\u65b0\u3002react-redux8 \u4ee5\u524d\u8fd9\u91cc\u7528\u7684\u662f useReducer \u7684 dispatch\u3002checkForUpdates\u4f1a\u88ab\u4ea4\u7ed9subscription.onStateChange\uff0c\u524d\u9762\u6211\u4eec\u5206\u6790\u8fc7\uff0csubscription.onStateChange\u6700\u7ec8\u4f1a\u5728 redux store \u66f4\u65b0\u7684\u65f6\u5019\u88ab\u5d4c\u5957\u8c03\u7528\u3002"),(0,o.kt)("p",null,"subscribeUpdates\u51fd\u6570\u91cc\u9762\u8fd8\u8c03\u7528\u4e86subscription.trySubscribe()\u5c06onStateChange\u6536\u96c6\u5230\u7236\u7ea7\u8ba2\u9605\u4e2d\u3002\u63a5\u7740\u8c03\u7528\u4e86 checkForUpdates \u4ee5\u9632\u9996\u6b21\u6e32\u67d3\u65f6\u6570\u636e\u5c31\u53d8\u4e86\u3002\u6700\u540e\u8fd4\u56de\u4e86\u4e00\u4e2a\u6ce8\u9500\u8ba2\u9605\u7684\u51fd\u6570\u3002"),(0,o.kt)("p",null,"\u7531\u4e0a\u8ff0\u5206\u6790\u53ef\u77e5\uff0c\u7ec4\u4ef6\u5b9e\u9645\u7684\u66f4\u65b0\u662fcheckForUpdates\u5b8c\u6210\u7684\u3002\u5b83\u4f1a\u7531\u4e24\u4e2a\u9014\u5f84\u8c03\u7528\uff1a"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"redux store \u66f4\u65b0\u540e\uff0c\u88ab\u7236\u7ea7\u7ea7\u8054\u8c03\u7528"),(0,o.kt)("li",{parentName:"ol"},"\u7ec4\u4ef6\u81ea\u8eab render\uff08\u7236\u7ea7 render \u5e26\u52a8\u3001\u7ec4\u4ef6\u81ea\u8eab state \u5e26\u52a8\uff09\uff0c\u540c\u65f6 useSyncExternalStore \u7684\u5feb\u7167\u53d1\u751f\u4e86\u53d8\u5316\uff0c\u5bfc\u81f4\u8c03\u7528")),(0,o.kt)("p",null,"\u6211\u4eec\u4f1a\u53d1\u73b0\u5728\u4e00\u6b21\u603b\u66f4\u65b0\u4e2d\uff0c\u5355\u4e2a connect \u7684 checkForUpdates \u662f\u4f1a\u88ab\u591a\u6b21\u8c03\u7528\u7684\u3002\u6bd4\u5982\u4e00\u6b21\u6765\u81ea redux \u7684\u66f4\u65b0\u5bfc\u81f4\u7236\u7ea7 render \u4e86\uff0c\u5b83\u7684\u5b50\u5143\u7d20\u6709 connect \u7ec4\u4ef6\uff0c\u4e00\u822c\u6211\u4eec\u4e0d\u4f1a\u5bf9 connect \u7ec4\u4ef6\u505a memo\uff0c\u4e8e\u662f\u5b83\u4e5f\u4f1a\u88ab render\uff0c\u6b63\u597d\u5b83\u7684 selectorProps \u4e5f\u53d8\u5316\u4e86\uff0c\u6240\u4ee5\u5728 render \u671f\u95f4checkForUpdates\u8c03\u7528\u3002\u5f53\u7236\u7ea7\u66f4\u65b0\u5b8c\u6210\u540e\uff0c\u89e6\u53d1\u81ea\u8eab listeners\uff0c\u5bfc\u81f4\u5b50 connect \u7684checkForUpdates\u518d\u6b21\u88ab\u8c03\u7528\u3002\u8fd9\u6837\u4e0d\u4f1a\u8ba9\u7ec4\u4ef6 re-render \u591a\u6b21\u5417\uff1f\u5f53\u521d\u6211\u9996\u6b21\u770b\u4ee3\u7801\u7684\u65f6\u5019\uff0c\u5c31\u6709\u8fd9\u6837\u7684\u7591\u95ee\u3002\u7ecf\u8fc7\u5927\u8111\u6a21\u62df\u5404\u79cd\u573a\u666f\u7684\u4ee3\u7801\u8c03\u5ea6\uff0c\u53d1\u73b0\u5b83\u662f\u8fd9\u6837\u907f\u514d\u91cd\u590d render \u7684\uff0c\u5f52\u7eb3\u8d77\u6765\u53ef\u4ee5\u5206\u4e3a\u8fd9\u51e0\u79cd\u573a\u666f\uff1a"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"\u6765\u81ea redux store \u66f4\u65b0\uff0c\u4e14\u81ea\u8eab\u7684 stateFromStore \u6709\u66f4\u65b0"),(0,o.kt)("li",{parentName:"ol"},"\u6765\u81ea redux store \u66f4\u65b0\uff0c\u4e14\u81ea\u8eab\u7684 stateFromStore \u6ca1\u6709\u66f4\u65b0"),(0,o.kt)("li",{parentName:"ol"},"\u6765\u81ea\u7236\u7ec4\u4ef6 render \u7684\u66f4\u65b0\uff0c\u4e14\u81ea\u8eab\u7684 stateFromStore \u6709\u66f4\u65b0"),(0,o.kt)("li",{parentName:"ol"},"\u6765\u81ea\u7236\u7ec4\u4ef6 render \u7684\u66f4\u65b0\uff0c\u4e14\u81ea\u8eab\u7684 stateFromStore \u6ca1\u6709\u66f4\u65b0"),(0,o.kt)("li",{parentName:"ol"},"\u6765\u81ea \u81ea\u8eab state \u7684\u66f4\u65b0\uff0c\u4e14\u81ea\u8eab\u7684 stateFromStore \u6709\u66f4\u65b0"),(0,o.kt)("li",{parentName:"ol"},"\u6765\u81ea \u81ea\u8eab state \u7684\u66f4\u65b0\uff0c\u4e14\u81ea\u8eab\u7684 stateFromStore \u6ca1\u6709\u66f4\u65b0")),(0,o.kt)("p",null,"\u5176\u4e2d 6 \u7684 stateFromStore \u548c props \u90fd\u6ca1\u6709\u53d8\u5316\uff0cactualChildProps\u76f4\u63a5\u4f7f\u7528\u7f13\u5b58\u7ed3\u679c\uff0c\u5e76\u4e0d\u4f1a\u8c03\u7528checkForUpdates\uff0c\u4e0d\u4f1a\u62c5\u5fc3\u591a\u6b21 render \u7684\u95ee\u9898"),(0,o.kt)("p",null,"1 \u548c 2 \u7684\u66f4\u65b0\u6765\u81ea redux store\uff0c\u6240\u4ee5\u5fc5\u7136\u662f\u7236\u7ec4\u4ef6\u5148\u66f4\u65b0\uff08\u9664\u975e\u8be5 connect \u662f\u9664 Provider \u7684\u9876\u5c42\uff09\u8be5 connect \u540e\u66f4\u65b0\uff0cconnect render \u65f6\uff0c\u6765\u81ea\u7236\u7ec4\u4ef6\u7684 props \u53ef\u80fd\u53d8\u4e86\uff0c\u81ea\u8eab\u7684 stateFromStore \u53ef\u80fd\u4e5f\u53d8\u4e86\uff0c\u4e8e\u662fcheckForUpdates\u88ab\u8c03\u7528\uff0cuseRef childPropsFromStoreUpdate\u88ab\u8bbe\u7f6e\u65b0\u7684 childProps\uff0c\u4e2d\u65ad\u5f53\u524d render\uff0c\u91cd\u65b0 render,\u7ec4\u4ef6\u5728 render \u4e2d\u83b7\u5f97\u65b0 childProps \u503c\u3002\u63a5\u7740\u7531\u7236 connect \u7ec4\u4ef6\u7684 useEffect \u5e26\u6765\u7b2c\u4e8c\u6ce2checkForUpdates\uff0c\u8fd9\u65f6 childProps \u5df2\u7ecf\u548c\u4e0a\u4e00\u6b21\u6ca1\u6709\u4e0d\u540c\u4e86\uff0c\u6240\u4ee5\u5e76\u4e0d\u4f1a\u66f4\u65b0\uff0c\u53ea\u662f\u89e6\u53d1\u66f4\u5e95\u5c42\u5b50 connect \u7684checkForUpdates\uff0c\u66f4\u5e95\u5c42 connect \u903b\u8f91\u540c\u7406\u3002"),(0,o.kt)("p",null,"3 \u548c 4 \u7c7b\u578b\u7684\u66f4\u65b0\u5176\u5b9e\u662f 1 \u548c 2 \u4e2d\u7684\u4e00\u90e8\u5206\uff0c\u5c31\u4e0d\u7ec6\u8bb2\u4e86\u3002"),(0,o.kt)("p",null,"5 \u7c7b\u578b\u7684\u66f4\u65b0\u53ef\u80fd\u53d1\u751f\u5728\u540c\u65f6\u8c03\u7528\u4e86 setState \u548c redux dispatch\uff0c\u6839\u636e react-redux \u7684\u5d4c\u5957\u7b56\u7565\uff0credux dispatch \u7684\u66f4\u65b0\u80af\u5b9a\u53d1\u751f\u5728 setState \u4e4b\u540e\u7684\uff0c\u5728 render \u8fc7\u7a0b\u4e2dchildPropsSelector(store.getState(), wrapperProps)\u83b7\u53d6\u5230\u6700\u65b0\u7684childProps\uff0c\u5b83\u663e\u7136\u662f\u53d8\u4e86\u3002\u4e8e\u662fcheckForUpdates\uff0c\u540e\u7eed\u7684 redux dispatch \u66f4\u65b0childProps\u5df2\u7ecf\u548c\u4e0a\u6b21\u76f8\u540c\u4e86\uff0c\u6240\u4ee5\u53ea\u8d70notifyNestedSubs\u3002"),(0,o.kt)("p",null,"\u81f3\u6b64\u6240\u6709\u573a\u666f\u6240\u6709\u94fe\u8def\u7684\u66f4\u65b0\u90fd\u6709\u4e86\u95ed\u73af\u3002"),(0,o.kt)("h2",{id:"useselector"},"useSelector"),(0,o.kt)("p",null,"\u7528\u6cd5\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"import { TypedUseSelectorHook, useDispatch, useSelector } from 'react-redux'\nimport type { AppDispatch, RootState } from './store'\n\nexport const useAppDispatch = () => useDispatch<AppDispatch>()\nexport const useAppSelector: TypedUseSelectorHook<RootState> = useSelector\n")),(0,o.kt)("p",null,"\u6e90\u7801:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function createSelectorHook(context = ReactReduxContext) {\n  const useReduxContext = context === ReactReduxContext ? useDefaultReduxContext : () => useContext(context);\n  return function useSelector(selector, equalityFn = refEquality) {\n    if (process.env.NODE_ENV !== 'production') {\n      if (!selector) {\n        throw new Error(`You must pass a selector to useSelector`);\n      }\n\n      if (typeof selector !== 'function') {\n        throw new Error(`You must pass a function as a selector to useSelector`);\n      }\n\n      if (typeof equalityFn !== 'function') {\n        throw new Error(`You must pass a function as an equality function to useSelector`);\n      }\n    }\n\n    const {\n      store,\n      subscription,\n      getServerState\n    } = useReduxContext();\n    const selectedState = useSyncExternalStoreWithSelector(subscription.addNestedSub, store.getState, getServerState || store.getState, selector, equalityFn);\n    useDebugValue(selectedState);\n    return selectedState;\n  };\n}\n\nconst useSelector = /*#__PURE__*/createSelectorHook();\n")),(0,o.kt)("p",null,"useSelector\u662f\u7531createSelectorHook()\u521b\u5efa\u7684"),(0,o.kt)("p",null,"\u548cconnect\u4e00\u6837\uff0c\u901a\u8fc7ReactReduxContext\u62ff\u5230 Provider \u7684 store \u7b49\u6570\u636e\u3002"),(0,o.kt)("p",null,"useSyncExternalStoreWithSelector\u540c\u6837\u662f\u7a7a\u65b9\u6cd5\uff0c\u88ab/src/index.ts\u8bbe\u7f6e\u4e3aimport { useSyncExternalStoreWithSelector } from 'use-sync-external-store/with-selector'\u7684useSyncExternalStoreWithSelector\uff0c\u548cuseSyncExternalStore\u4f5c\u7528\u7c7b\u4f3c\u3002\u5b83\u76f4\u63a5\u8ba2\u9605\u7ed9\u4e86redux.store.subscribe\u3002redux store \u66f4\u65b0\u65f6\uff0c\u4f1a\u89e6\u53d1\u4f7f\u7528\u5b83\u7684\u7ec4\u4ef6\u66f4\u65b0\uff0c\u4ece\u800c\u62ff\u5230\u65b0\u7684selectedState\u3002"),(0,o.kt)("p",null,"hooks \u53ea\u662f\u72b6\u6001\u903b\u8f91\uff0c\u5b83\u4e0d\u80fd\u50cfconnect\u7ec4\u4ef6\u90a3\u6837\u505a\u5230\u7ed9\u5b50\u7ec4\u4ef6\u63d0\u4f9b Context\uff0c\u4e8e\u662f\u5b83\u53ea\u80fd\u5e73\u7ea7\u7684\u76f4\u63a5\u8ba2\u9605\u5728 redux \u91cc\uff0c\u8fd9\u5c31\u662f\u6587\u7ae0\u5f00\u5934\u90e8\u5206\u8bb2\u5230\u7684\u300e\u50f5\u5c38\u8282\u70b9\u300f\u95ee\u9898\u65f6\u63d0\u5230\u7684\uff1ahooks \u6ca1\u6709\u5d4c\u5957\u8ba2\u9605\u7684\u539f\u56e0\u3002useSelector\u7684\u4ee3\u7801\u6bd4 7 \u7248\u672c\u7684\u7b80\u6d01\u591a\u4e86\uff0c\u53ef\u4ee5\u53d1\u73b0\u53bb\u9664\u4e86\u975e\u751f\u4ea7\u73af\u5883\u4ee3\u7801\u540e\u5e76\u6ca1\u6709\u591a\u5c11\uff0c\u76f8\u6bd4\u4e4b\u4e0b 7 \u7248\u672c\u7684\u8981\u5197\u957f\u4e0d\u5c11\uff08165 \u884c\uff09\uff0c\u6709\u5174\u8da3\u7684\u53ef\u4ee5\u53bb\u770b\u770b\u3002"),(0,o.kt)("h3",{id:"\u884d\u751f\u51fa\u6765\u7684-react-\u539f\u7406"},"\u884d\u751f\u51fa\u6765\u7684 React \u539f\u7406"),(0,o.kt)("p",null,"useSelector\u548c 7 \u7248\u672c\u8fd8\u6709\u4e00\u4e2a\u91cd\u8981\u533a\u522b\uff01\u4e86\u89e3\u5b83\u53ef\u4ee5\u5e2e\u52a9\u4f60\u77e5\u9053\u66f4\u591a React \u5185\u90e8\u7684\u7ec6\u8282\uff01"),(0,o.kt)("p",null,"\u5728 7 \u7248\u672c\u91cc\uff0c\u6ce8\u518c\u8ba2\u9605\u662f\u5728 useEffect/useLayoutEffect\u91cc\u6267\u884c\u7684\u3002\u800c\u6839\u636e React \u7684 fiber \u67b6\u6784\u903b\u8f91\uff0c\u5b83\u4f1a\u4ee5\u524d\u5e8f\u904d\u5386\u7684\u987a\u5e8f\u904d\u5386 fiber \u6811\uff0c\u9996\u5148\u4f7f\u7528 beginWork \u5904\u7406 fiber\uff0c\u5f53\u5230\u4e86\u53f6\u5b50\u8282\u70b9\u65f6\u8c03\u7528 completeWork\uff0c\u5176\u4e2d completeWork \u4f1a\u5c06\u8bf8\u5982 useEffect\u3001useLayoutEffect\u7b49\u653e\u5165 effectList\uff0c\u5c06\u6765\u5728 commit \u9636\u6bb5\u987a\u5e8f\u6267\u884c\u3002\u800c\u6309\u7167\u524d\u5e8f\u904d\u5386\u7684\u987a\u5e8f\uff0ccompleteWork\u662f\u81ea\u4e0b\u800c\u4e0a\u7684\uff0c\u4e5f\u5c31\u662f\u8bf4\u5b50\u8282\u70b9\u7684useEffect\u4f1a\u6bd4\u7236\u8282\u70b9\u5148\u6267\u884c\uff0c\u4e8e\u662f\u5728 7 \u7248\u672c\u91cc\uff0c\u5b50\u7ec4\u4ef6 hooks \u6bd4\u7236\u7ec4\u4ef6\u66f4\u65e9\u6ce8\u518c\uff0c\u5c06\u6765\u6267\u884c\u65f6\u4e5f\u66f4\u65e9\u6267\u884c\uff0c\u8fd9\u5c31\u5178\u578b\u5730\u9677\u5165\u4e86\u5f00\u5934\u8bf4\u7684\u300estale props\u300f\u3001\u300ezombie children\u300f\u95ee\u9898\u3002"),(0,o.kt)("p",null,"\u56e0\u4e3a\u6211\u77e5\u9053 React \u7684\u5185\u90e8\u673a\u5236\uff0c\u6240\u4ee5\u521a\u5f00\u59cb\u6211\u8ba4\u4e3a react-redux7 \u7684 hooks \u662f\u4f1a\u51fa bug \u7684\uff0c\u4e8e\u662f\u6211\u901a\u8fc7npm link\u7528\u51e0\u4e2a\u6d4b\u8bd5\u7528\u4f8b\u672c\u5730\u8dd1\u4e86\u4ee3\u7801\uff0c\u7ed3\u679c\u51fa\u4e4e\u6211\u610f\u6599\uff0clistener\u786e\u5b9e\u88ab\u8c03\u7528\u4e86\u591a\u6b21\uff0c\u8fd9\u610f\u5473\u7740\u6709\u591a\u4e2a connect \u7ec4\u4ef6\u5c06\u4f1a\u66f4\u65b0\uff0c\u5c31\u5f53\u6211\u4ee5\u4e3a\u5b50\u7ec4\u4ef6\u5c06\u5148\u4e8e\u7236\u7ec4\u4ef6\u88ab\u66f4\u65b0\u65f6\uff0c\u4f46\u6700\u7ec8 render \u53ea\u6709\u4e00\u6b21\uff0c\u662f\u7531\u6700\u4e0a\u5c42\u7684\u7236 connect render \u7684\uff0c\u5b83\u5c06\u5e26\u52a8\u4e0b\u9762\u7684\u5b50 connect \u66f4\u65b0\u3002"),(0,o.kt)("p",null,"\u8fd9\u5c31\u5f15\u51fa\u4e86 React \u7684\u6279\u91cf\u66f4\u65b0\u7b56\u7565\u3002\u6bd4\u5982 React16 \u91cc\u9762\uff0c\u6240\u6709\u7684 React \u4e8b\u4ef6\u3001\u751f\u547d\u5468\u671f\u90fd\u88ab\u88c5\u9970\u4e86\u4e00\u4e2a\u903b\u8f91\uff0c\u5f00\u5934\u4f1a\u8bbe\u7f6e\u4e00\u4e2a\u9501\uff0c\u4e8e\u662f\u91cc\u9762\u7684\u6240\u6709 setState \u8fd9\u6837\u7684\u66f4\u65b0\u64cd\u4f5c\u90fd\u4e0d\u4f1a\u771f\u7684\u53d1\u8d77\u66f4\u65b0\uff0c\u7b49\u4ee3\u7801\u7684\u6700\u540e\u653e\u5f00\u9501\uff0c\u518d\u6279\u91cf\u7684\u4e00\u8d77\u66f4\u65b0\u3002\u4e8e\u662f react-redux \u6b63\u597d\u501f\u7528\u8fd9\u4e2a\u7b56\u7565\uff0c\u8ba9\u9700\u8981\u66f4\u65b0\u7684\u7ec4\u4ef6\u6574\u4f53\u81ea\u4e0a\u800c\u4e0b\u7684\u6279\u91cf\u66f4\u65b0\u4e86\uff0c\u8fd9\u6e90\u4e8e\u5b83\u7684\u4e00\u5904\u4e0d\u8d77\u773c\u7684\u5730\u65b9\uff1asetBatch(batch)\uff0c\u800c\u6211\u4e5f\u662f\u56e0\u4e3a\u6ca1\u6ce8\u610f\u8fd9\u91cc\u7684\u7528\u5904\uff0c\u800c\u8bef\u5224\u5b83\u4f1a\u51fa\u95ee\u9898\uff0csetBatch(batch)\u5b9e\u9645\u505a\u4e86\u4ec0\u4e48\u540e\u9762\u4f1a\u8bb2\u5230\u3002"),(0,o.kt)("p",null,"\u5173\u4e8e\u6279\u91cf\u66f4\u65b0\uff0c\u518d\u4e3e\u4e2a\u4f8b\u5b50\uff0c\u6bd4\u5982 A \u6709\u5b50\u7ec4\u4ef6 B\uff0cB \u6709\u5b50\u7ec4\u4ef6 C\uff0c\u5206\u522b\u987a\u5e8f\u8c03\u7528 C\u3001B\u3001A \u7684 setState\uff0c\u6b63\u5e38\u6765\u8bf4 C\u3001B\u3001A \u4f1a\u88ab\u6309\u987a\u5e8f\u5404\u81ea\u66f4\u65b0\u4e00\u6b21\uff0c\u800c\u6279\u91cf\u66f4\u65b0\u4f1a\u5c06\u4e09\u6b21\u66f4\u65b0\u5408\u5e76\u6210\u4e00\u4e2a\uff0c\u76f4\u63a5\u4ece\u7ec4\u4ef6 A \u66f4\u65b0\u4e00\u6b21\uff0cB \u548c C \u5c31\u987a\u5e26\u88ab\u66f4\u65b0\u4e86\u3002"),(0,o.kt)("p",null,"\u4e0d\u8fc7\u8fd9\u4e2a\u6279\u91cf\u66f4\u65b0\u7b56\u7565\u7684\u300e\u9501\u300f\u662f\u5728\u540c\u4e00\u4e2a\u300e\u5b8f\u4efb\u52a1\u300f\u91cc\u7684\uff0c\u5982\u679c\u4ee3\u7801\u4e2d\u6709\u5f02\u6b65\u4efb\u52a1\uff0c\u90a3\u4e48\u5f02\u6b65\u4efb\u52a1\u4e2d\u7684 setState \u662f\u4f1a\u300e\u9003\u8131\u300f\u6279\u91cf\u66f4\u65b0\u7684\uff0c\u4e5f\u5c31\u662f\u8bf4\u8fd9\u79cd\u60c5\u51b5\u4e0b\u6bcf\u6b21 setState \u5c31\u4f1a\u8ba9\u7ec4\u4ef6\u66f4\u65b0\u4e00\u6b21\u3002\u6bd4\u5982 react-redux \u4e0d\u80fd\u4fdd\u8bc1\u7528\u6237\u4e0d\u4f1a\u5728\u4e00\u4e2a\u8bf7\u6c42\u56de\u8c03\u91cc\u8c03\u7528dispatch\uff08\u5b9e\u9645\u4e0a\u8fd9\u4e48\u505a\u592a\u666e\u904d\u4e86\uff09\uff0c\u6240\u4ee5 react-redux \u5728/src/index.ts\u4e2d\u505a\u4e86setBatch(batch)\u64cd\u4f5c\uff0cbatch\u6765\u81eaimport { unstable_batchedUpdates as batch } from './utils/reactBatchedUpdates'\uff0cunstable_batchedUpdates \u662f\u7531 react-dom \u63d0\u4f9b\u7684\u624b\u52a8\u6279\u91cf\u66f4\u65b0\u65b9\u6cd5\uff0c\u53ef\u4ee5\u5e2e\u52a9\u8131\u79bb\u7ba1\u63a7\u7684 setState \u91cd\u65b0\u6279\u91cf\u66f4\u65b0\u3002\u5728Subscription.ts\u4e2d\u7684createListenerCollection\u91cc\u7528\u5230\u4e86batch\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"const batch = getBatch();\n// ............\nreturn {\n  notify() {\n    batch(() => {\n      let listener = first;\n      while (listener) {\n        listener.callback();\n        listener = listener.next;\n      }\n    });\n  },\n};\n")),(0,o.kt)("p",null,"\u6240\u4ee5subscription\u91cc\u7684listeners\u7684notify\u65b9\u6cd5\uff0c\u662f\u4f1a\u5bf9\u6240\u6709\u7684\u66f4\u65b0\u8ba2\u9605\u624b\u52a8\u6279\u91cf\u66f4\u65b0\u7684\u3002\u4ece\u800c\u5728 react-redux7 \u4e2d\uff0c\u5c31\u7b97 hooks \u6ce8\u518c\u7684\u8ba2\u9605\u662f\u81ea\u4e0b\u800c\u4e0a\u7684\uff0c\u4e5f\u4e0d\u4f1a\u5f15\u8d77\u95ee\u9898\u3002"),(0,o.kt)("p",null,"\u800c react-redux8 \u76f4\u63a5\u4f7f\u7528\u65b0 API useSyncExternalStoreWithSelector\u8ba2\u9605\uff0c\u662f\u5728 render \u671f\u95f4\u53d1\u751f\u7684\uff0c\u6240\u4ee5\u8ba2\u9605\u7684\u987a\u5e8f\u662f\u81ea\u4e0a\u800c\u4e0b\u7684\uff0c\u907f\u514d\u4e86\u5b50\u8ba2\u9605\u5148\u6267\u884c\u7684\u95ee\u9898\u3002\u4f46\u662f 8 \u7248\u672c\u4f9d\u7136\u6709\u4e0a\u8ff0batch\u7684\u903b\u8f91\uff0c\u4ee3\u7801\u548c 7 \u4e00\u6a21\u4e00\u6837\uff0c\u56e0\u4e3a\u6279\u91cf\u66f4\u65b0\u80fd\u8282\u7701\u4e0d\u5c11\u6027\u80fd\u3002"),(0,o.kt)("h2",{id:"\u6700\u540e\u7684\u90e8\u5206\u662fusedispatch"},"\u6700\u540e\u7684\u90e8\u5206\u662fuseDispatch"),(0,o.kt)("p",null,"useDispatch\u975e\u5e38\u7b80\u5355\uff0c\u5c31\u662f\u901a\u8fc7useStore()\u62ff\u5230 redux store\uff0c\u7136\u540e\u8fd4\u56destore.dispatch\uff0c\u7528\u6237\u5c31\u80fd\u4f7f\u7528\u8fd9\u4e2adispatch\u6d3e\u53d1action\u4e86\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function createDispatchHook(context = ReactReduxContext) {\n  const useStore = // @ts-ignore\n  context === ReactReduxContext ? useDefaultStore : createStoreHook(context);\n  return function useDispatch() {\n    const store = useStore(); // @ts-ignore\n\n    return store.dispatch;\n  };\n}\n")))}d.isMDXComponent=!0}}]);